<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="XCTF2023 flagio"><meta name="keywords" content="CTF"><meta name="author" content="LamのCrow"><meta name="copyright" content="LamのCrow"><title>XCTF2023 flagio | LamのCrow</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#XCTF2023-flagio"><span class="toc-number">1.</span> <span class="toc-text">XCTF2023 flagio</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">2.</span> <span class="toc-text">前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#LUA%E6%96%87%E4%BB%B6%E7%BC%96%E8%AF%91%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.</span> <span class="toc-text">LUA文件编译流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFLuaJIT"><span class="toc-number">2.2.</span> <span class="toc-text">什么是LuaJIT</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LuaJIT%E4%B8%8Ecoco2d-x%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">2.3.</span> <span class="toc-text">LuaJIT与coco2d-x之间的关系</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E8%80%85%E5%85%B3%E7%B3%BB%E7%9A%84%E4%B8%80%E4%B8%AA%E4%BE%8B%E5%AD%90"><span class="toc-number">2.3.1.</span> <span class="toc-text">二者关系的一个例子</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LuaJIT%E5%AE%89%E8%A3%85"><span class="toc-number">2.4.</span> <span class="toc-text">LuaJIT安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.4.1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A6%81%E6%B1%82"><span class="toc-number">2.4.2.</span> <span class="toc-text">要求</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%A6%81%E6%B1%82"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">系统要求</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91LuaJIT"><span class="toc-number">2.4.3.</span> <span class="toc-text">交叉编译LuaJIT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%B9%E4%BA%8EAndroid"><span class="toc-number">2.4.3.1.</span> <span class="toc-text">对于Android</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%BC%96%E8%AF%91"><span class="toc-number">2.4.4.</span> <span class="toc-text">实现编译</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9ALuaJIT%E7%89%88%E6%9C%AC"><span class="toc-number">3.</span> <span class="toc-text">确定LuaJIT版本</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4"><span class="toc-number">3.1.</span> <span class="toc-text">步骤</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8D%E8%B0%83%E8%AF%95"><span class="toc-number">4.</span> <span class="toc-text">反调试</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JNI-OnLoad"><span class="toc-number">4.1.</span> <span class="toc-text">JNI_OnLoad</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E9%80%BB%E8%BE%91"><span class="toc-number">4.1.1.</span> <span class="toc-text">线程逻辑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E5%87%BD%E6%95%B0"><span class="toc-number">4.1.2.</span> <span class="toc-text">检测函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#init-array"><span class="toc-number">4.2.</span> <span class="toc-text">.init_array</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Hook"><span class="toc-number">5.</span> <span class="toc-text">Hook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%B2%E7%9F%A5%E7%9A%84Hook%E7%82%B9-%E6%9C%89%E9%94%99%E8%AF%AF-%E5%90%8E%E9%9D%A2%E2%80%9D%E6%81%A2%E5%A4%8D%E4%B9%B1%E5%BA%8Fopcode%E2%80%9D%E6%97%B6%E6%9B%B4%E6%94%B9"><span class="toc-number">5.1.</span> <span class="toc-text">已知的Hook点(有错误, 后面”恢复乱序opcode”时更改)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%81%A2%E5%A4%8D%E7%AC%A6%E5%8F%B7-%E5%B9%B6%E4%B8%8D%E6%98%AF%E8%BF%99%E4%B8%AA%E5%87%BD%E6%95%B0-%E5%90%8E%E9%9D%A2%E2%80%9D%E6%81%A2%E5%A4%8D%E4%B9%B1%E5%BA%8Fopcode%E2%80%9D%E6%97%B6%E6%9B%B4%E6%94%B9"><span class="toc-number">5.2.</span> <span class="toc-text">恢复符号(并不是这个函数, 后面”恢复乱序opcode”时更改)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#luaL-loadbuffer-%E5%8E%9F%E5%9E%8B"><span class="toc-number">5.2.1.</span> <span class="toc-text">luaL_loadbuffer()原型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hook-luaL-loadbuffer"><span class="toc-number">5.3.</span> <span class="toc-text">Hook luaL_loadbuffer()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%97%E5%88%B0%E5%87%BD%E6%95%B0%E5%9C%B0%E5%9D%80"><span class="toc-number">5.3.1.</span> <span class="toc-text">得到函数地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E5%86%99Hook%E8%84%9A%E6%9C%AC"><span class="toc-number">5.3.2.</span> <span class="toc-text">编写Hook脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B8%B8%E6%88%8F%E8%BF%9B%E5%85%A5%E4%B8%BB%E7%95%8C%E9%9D%A2%E5%90%8E%E8%BE%93%E5%87%BA"><span class="toc-number">5.3.3.</span> <span class="toc-text">游戏进入主界面后输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%82%B9%E5%87%BB%E5%BC%80%E5%A7%8B%E6%B8%B8%E6%88%8F%E5%90%8E%E8%BE%93%E5%87%BA"><span class="toc-number">5.3.4.</span> <span class="toc-text">点击开始游戏后输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B6%E9%97%AE%E5%8F%B7%E6%96%B9%E5%9D%97%E5%90%8E%E8%BE%93%E5%87%BA"><span class="toc-number">5.3.5.</span> <span class="toc-text">顶问号方块后输出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E6%96%87%E4%BB%B6%E7%B1%BB%E5%9E%8B"><span class="toc-number">5.4.</span> <span class="toc-text">确定文件类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9js%E4%BB%A3%E7%A0%81"><span class="toc-number">5.4.1.</span> <span class="toc-text">修改js代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%97%E5%88%B0%E8%BE%93%E5%87%BA"><span class="toc-number">5.4.2.</span> <span class="toc-text">得到输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#luac64%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.3.</span> <span class="toc-text">luac64文件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%BB%8F%E5%85%B8luac%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">一个经典luac文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dump%E5%86%85%E5%AD%98%E5%BE%97%E5%88%B0%E5%86%85%E5%AD%98%E4%B8%AD%E7%9A%84luac64%E6%96%87%E4%BB%B6"><span class="toc-number">5.5.</span> <span class="toc-text">Dump内存得到内存中的luac64文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#frida%E8%84%9A%E6%9C%AC"><span class="toc-number">5.5.1.</span> <span class="toc-text">frida脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%97%E5%88%B0luac64%E6%96%87%E4%BB%B6"><span class="toc-number">5.5.2.</span> <span class="toc-text">得到luac64文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%81%A2%E5%A4%8D%E4%B9%B1%E5%BA%8FOPcode"><span class="toc-number">6.</span> <span class="toc-text">恢复乱序OPcode</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#lj-obj-h"><span class="toc-number">6.1.</span> <span class="toc-text">lj_obj.h</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lua-State"><span class="toc-number">6.1.1.</span> <span class="toc-text">lua_State</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Global-State"><span class="toc-number">6.2.</span> <span class="toc-text">Global_State</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lua-newstate"><span class="toc-number">6.3.</span> <span class="toc-text">lua_newstate()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GG-State"><span class="toc-number">6.4.</span> <span class="toc-text">GG_State</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#luaL-loadbuffer"><span class="toc-number">6.5.</span> <span class="toc-text">luaL_loadbuffer()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lua-loadx"><span class="toc-number">6.6.</span> <span class="toc-text">lua_loadx()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lj-vm-cpcall"><span class="toc-number">6.7.</span> <span class="toc-text">lj_vm_cpcall()</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%87%E7%BC%96%E7%AC%A6%E5%8F%B7"><span class="toc-number">6.7.1.</span> <span class="toc-text">汇编符号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%87%E7%BC%96"><span class="toc-number">6.7.2.</span> <span class="toc-text">汇编</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%A0%87%E7%AD%BE"><span class="toc-number">6.8.</span> <span class="toc-text">3:标签</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%87%E7%BC%96%E7%AC%A6%E5%8F%B7-1"><span class="toc-number">6.8.1.</span> <span class="toc-text">汇编符号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%87%E7%BC%96-1"><span class="toc-number">6.8.2.</span> <span class="toc-text">汇编</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ins-call"><span class="toc-number">6.9.</span> <span class="toc-text">ins_call</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%87%E7%BC%96-2"><span class="toc-number">6.9.1.</span> <span class="toc-text">汇编</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ins-callt"><span class="toc-number">6.10.</span> <span class="toc-text">ins_callt</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B1%87%E7%BC%96-3"><span class="toc-number">6.10.1.</span> <span class="toc-text">汇编</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%9F%A5%E6%89%BE%E6%89%A7%E8%A1%8C%E9%80%BB%E8%BE%91%E5%9C%B0%E5%9D%80"><span class="toc-number">6.10.2.</span> <span class="toc-text">虚拟机查找执行逻辑地址</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%BE%E5%88%B0ins-call-%E5%AF%B9%E5%BA%94%E5%81%8F%E7%A7%BB%E5%9C%B0%E5%9D%80-%E7%A1%AE%E5%AE%9AGG-G2DISP"><span class="toc-number">6.11.</span> <span class="toc-text">找到ins_call()对应偏移地址, 确定GG_G2DISP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#lua-loadx-%E6%BA%90%E7%A0%81"><span class="toc-number">6.11.1.</span> <span class="toc-text">lua_loadx()源码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ida%E5%8F%8D%E7%BC%96%E8%AF%91"><span class="toc-number">6.11.2.</span> <span class="toc-text">ida反编译</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%A7%E7%BB%AD%E8%B7%9F%E8%BF%9Blua-loadx"><span class="toc-number">6.11.3.</span> <span class="toc-text">继续跟进lua_loadx()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sub-ACFEB4"><span class="toc-number">6.11.4.</span> <span class="toc-text">sub_ACFEB4()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%9F%E8%BF%9BJUMPOUT"><span class="toc-number">6.11.5.</span> <span class="toc-text">跟进JUMPOUT</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bopcode"><span class="toc-number">6.12.</span> <span class="toc-text">查看opcode</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hook%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81%E6%89%BE%E5%88%B0%E6%89%80%E6%9C%89%E7%9A%84opcode%E5%9C%B0%E5%9D%80"><span class="toc-number">6.13.</span> <span class="toc-text">Hook汇编代码找到所有的opcode地址</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hook%E6%8C%87%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">6.13.1.</span> <span class="toc-text">Hook指令执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Hook%E6%8E%89GL%E5%9C%B0%E5%9D%80-%E7%94%A8%E5%89%8D%E9%9D%A2%E7%9A%84GG-G2DISP%E5%81%8F%E7%A7%BB%E6%89%BE%E5%88%B0dispatch%E8%A1%A8-%E7%84%B6%E5%90%8E%E6%89%93%E5%8D%B0%E5%87%BA%E6%9D%A5"><span class="toc-number">6.13.2.</span> <span class="toc-text">Hook掉GL地址, 用前面的GG_G2DISP偏移找到dispatch表, 然后打印出来</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%BE%E5%88%B0%E5%AF%B9%E5%BA%94%E7%9A%84opcode"><span class="toc-number">6.14.</span> <span class="toc-text">找到对应的opcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B"><span class="toc-number">6.14.1.</span> <span class="toc-text">实例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#vm-arm64-dasc%E5%8E%9F%E5%A7%8B%E4%BB%A3%E7%A0%81"><span class="toc-number">6.14.1.1.</span> <span class="toc-text">vm_arm64.dasc原始代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E5%90%8Edasc%E4%BB%A3%E7%A0%81"><span class="toc-number">6.14.1.2.</span> <span class="toc-text">替换后dasc代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#IDA%E4%BB%A3%E7%A0%81"><span class="toc-number">6.14.1.3.</span> <span class="toc-text">IDA代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%97%E5%88%B0opcode%E9%A1%BA%E5%BA%8F"><span class="toc-number">6.14.2.</span> <span class="toc-text">得到opcode顺序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8D%E7%BC%96%E8%AF%91lua%E6%96%87%E4%BB%B6"><span class="toc-number">7.</span> <span class="toc-text">反编译lua文件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E5%A4%84%E4%BF%AE%E6%94%B9"><span class="toc-number">7.1.</span> <span class="toc-text">第一处修改</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%A4%84%E4%BF%AE%E6%94%B9"><span class="toc-number">7.2.</span> <span class="toc-text">第二处修改</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E5%A4%84%E4%BF%AE%E6%94%B9"><span class="toc-number">7.3.</span> <span class="toc-text">第三处修改</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E6%9E%90lua%E4%BB%A3%E7%A0%81"><span class="toc-number">8.</span> <span class="toc-text">分析lua代码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#GameScene-lua"><span class="toc-number">8.1.</span> <span class="toc-text">GameScene.lua</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#collisionH"><span class="toc-number">8.1.1.</span> <span class="toc-text">collisionH()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#slot0-collisionV"><span class="toc-number">8.1.2.</span> <span class="toc-text">slot0.collisionV()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#slot0-breakBrick"><span class="toc-number">8.1.3.</span> <span class="toc-text">slot0.breakBrick()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Util-create"><span class="toc-number">8.1.4.</span> <span class="toc-text">Util.create()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#slot0-OoO"><span class="toc-number">8.1.5.</span> <span class="toc-text">slot0.OoO()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%98%E5%8E%9F%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">8.1.6.</span> <span class="toc-text">还原虚拟机</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#main-cpp"><span class="toc-number">8.1.6.1.</span> <span class="toc-text">main.cpp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vm-h"><span class="toc-number">8.1.6.2.</span> <span class="toc-text">vm.h</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vm-cpp"><span class="toc-number">8.1.6.3.</span> <span class="toc-text">vm.cpp</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%97%E5%88%B0%E6%8C%87%E4%BB%A4%E8%BE%93%E5%87%BA"><span class="toc-number">8.1.7.</span> <span class="toc-text">得到指令输出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%97%E5%88%B0%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%8A%A0%E5%AF%86%E9%80%BB%E8%BE%91"><span class="toc-number">8.2.</span> <span class="toc-text">得到虚拟机加密逻辑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%97%E5%87%BA%E8%A7%A3%E5%AF%86%E9%80%BB%E8%BE%91"><span class="toc-number">8.3.</span> <span class="toc-text">得出解密逻辑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%97%E5%88%B0flag"><span class="toc-number">8.4.</span> <span class="toc-text">得到flag</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%88%B0%E8%98%91%E8%8F%87%E5%B9%B6%E8%A7%A3%E5%87%BA%E9%A2%98%E7%9B%AE"><span class="toc-number">9.</span> <span class="toc-text">获取到蘑菇并解出题目</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://s4.ax1x.com/2021/12/07/oyWTJA.jpg"></div><div class="author-info__name text-center">LamのCrow</div><div class="author-info__description text-center">欢迎交流!!!</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">40</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">5</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://space.bilibili.com/202089320">MyBIlibili</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://sma11cc.github.io/">smallcc</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s4.ax1x.com/2021/12/06/oy2VdH.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">LamのCrow</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">XCTF2023 flagio</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2023-05-13</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="XCTF2023-flagio"><a href="#XCTF2023-flagio" class="headerlink" title="XCTF2023 flagio"></a>XCTF2023 flagio</h1><span id="more"></span>
<p>原文链接: <a target="_blank" rel="noopener" href="https://in1t.top/2023/04/02/7th-XCTF-Final-Super-Flagio/">7th XCTF Final - Super Flagio</a><br>出题人给出的WP思路非常清晰, 非常值得学习复现!!!</p>
<h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><h2 id="LUA文件编译流程"><a href="#LUA文件编译流程" class="headerlink" title="LUA文件编译流程"></a>LUA文件编译流程</h2><p>跟很多虚拟机语言类似(比如Java虚拟机)</p>
<p><img src="/2023/05/13/flagio/B4742E59FEACA232715645E0A37665D1-20230427232902-p73wold.png" alt="B4742E59FEACA232715645E0A37665D1">​</p>
<h2 id="什么是LuaJIT"><a href="#什么是LuaJIT" class="headerlink" title="什么是LuaJIT"></a>什么是LuaJIT</h2><p>一个快速的Lua解释器, 支持JIT编译(即执行时编译为本地机器代码, 从而提高运行速率).</p>
<h2 id="LuaJIT与coco2d-x之间的关系"><a href="#LuaJIT与coco2d-x之间的关系" class="headerlink" title="LuaJIT与coco2d-x之间的关系"></a>LuaJIT与coco2d-x之间的关系</h2><p>cocos2d-x使用C++编写, 该游戏框架提供了众多C++接口来控制动画, 渲染, 物理引擎, 音频等, 同时将这些C++接口暴露给LuaJIT, 实现在执行Lua逻辑时可以控制游戏中的各种资源.</p>
<h3 id="二者关系的一个例子"><a href="#二者关系的一个例子" class="headerlink" title="二者关系的一个例子"></a>二者关系的一个例子</h3><p>在一个cocos2d-x游戏中, 角色的移动动画通常由cocos2d-x提供的C++接口实现, 比如:</p>
<ul>
<li>左: <code>left(); // 使用cocos2d-x的C++代码实现</code>​</li>
<li>右: <code>right(); // 同上</code>​</li>
<li>跳: <code>jump(); // 同上</code>​</li>
</ul>
<p>而实际的游戏逻辑是在lua中执行的, 而游戏逻辑要体现在动画上, 就需要把C++接口暴露给lua代码, 然后由lua代码控制动画.</p>
<h2 id="LuaJIT安装"><a href="#LuaJIT安装" class="headerlink" title="LuaJIT安装"></a>LuaJIT安装</h2><p>参考: <a target="_blank" rel="noopener" href="http://luajit.org/install.html">Installation (luajit.org)</a> </p>
<p>note: 下面自主题中的很多内容都是从官网上直接翻译过来使用的.</p>
<h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>LuaJIT仅以源码包的形式发布, 该页面介绍: 在不同的操作系统和C编译器下如何构建和安装LuaJIT.</p>
<h3 id="要求"><a href="#要求" class="headerlink" title="要求"></a>要求</h3><h4 id="系统要求"><a href="#系统要求" class="headerlink" title="系统要求"></a>系统要求</h4><p>LuaJIT在大多数系统上都是开箱即用</p>
<h3 id="交叉编译LuaJIT"><a href="#交叉编译LuaJIT" class="headerlink" title="交叉编译LuaJIT"></a>交叉编译LuaJIT</h3><p>基于GNU Makefile构建系统允许在任意宿主机上为任意支持的客户机进行交叉编译, 只要两个架构拥有相同大小的指针.如果你要在64位操作系统上为任意一个32位客户机交叉编译, 你需要安装multilib开发包, 然后构建32位的宿主机上的支持.</p>
<p>当宿主机和客户机的操作系统不同时, 你需要明确指出TARGET_SYS, 否则将在汇编或链接时报错.</p>
<p>例如: 如果你在Windows宿主机上为嵌入式Linux或Android编译时, 你需要在下面的示例中添加TARGET_SYS=Linux.</p>
<h4 id="对于Android"><a href="#对于Android" class="headerlink" title="对于Android"></a>对于Android</h4><p>对于Android, 你可以使用Android NDK来交叉编译. </p>
<h3 id="实现编译"><a href="#实现编译" class="headerlink" title="实现编译"></a>实现编译</h3><p>这里跳了, 先看确定LuaJIT版本[^1], 然后还需要按照android-ndk-r20b</p>
<p>改一下官网的脚本. LuaJIT-2.1.0-beta3编译没有成功, 就换了LuaJIT-2.1编译也能用. </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># environment: kali-linux-2022.1-vmware-amd64</span></span><br><span class="line"># Android/ARM, armeabi-<span class="built_in">v7a</span> (ARMv7 VFP), Android <span class="number">4.1</span>+ (JB)</span><br><span class="line"></span><br><span class="line">NDKDIR=/home/kali/Android/NDK/android-ndk-r20b</span><br><span class="line">NDKBIN=$NDKDIR/toolchains/llvm/prebuilt/linux-x86_64/bin</span><br><span class="line">NDKCROSS=$NDKBIN/arm-linux-androideabi-</span><br><span class="line">NDKCC=$NDKBIN/armv7a-linux-androideabi16-clang</span><br><span class="line">OUTPUT_DIR=output_dir</span><br><span class="line">make HOST_CC=<span class="string">&quot;gcc -m32&quot;</span> CROSS=$NDKCROSS \</span><br><span class="line">     STATIC_CC=$NDKCC DYNAMIC_CC=<span class="string">&quot;$NDKCC -fPIC&quot;</span> \</span><br><span class="line">     TARGET_LD=$NDKCC TARGET_AR=<span class="string">&quot;$NDKBIN/llvm-ar rcus&quot;</span> \</span><br><span class="line">     TARGET_STRIP=$NDKBIN/llvm-strip \</span><br><span class="line">     PREFIX=<span class="string">&quot;$OUTPUT_DIR&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="确定LuaJIT版本"><a href="#确定LuaJIT版本" class="headerlink" title="确定LuaJIT版本"></a>确定LuaJIT版本</h1><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ul>
<li>IDA打开libgame.so</li>
<li>字符串搜索<code>LuaJIT</code>​</li>
</ul>
<p>发现版本为LuaJIT 2.1.0-beta3</p>
<p><img src="/2023/05/13/flagio/image-20230428000639-5ei03yk.png" alt="image">​</p>
<h1 id="反调试"><a href="#反调试" class="headerlink" title="反调试"></a>反调试</h1><p>由于下一步需要使用frida进行调试, 所以需要先看看是否有frida的代码</p>
<p>Java已经看过了, 主要是root检测, 主要查看:</p>
<ul>
<li>JNI_OnLoad</li>
<li>.init_array</li>
</ul>
<h2 id="JNI-OnLoad"><a href="#JNI-OnLoad" class="headerlink" title="JNI_OnLoad"></a>JNI_OnLoad</h2><p>创建了一个线程</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">jint <span class="title">JNI_OnLoad</span><span class="params">(JavaVM *vm, <span class="keyword">void</span> *reserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// x0</span></span><br><span class="line">  __int64 v3; <span class="comment">// x0</span></span><br><span class="line">  <span class="keyword">pthread_t</span> v5[<span class="number">2</span>]; <span class="comment">// [xsp+0h] [xbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v5[<span class="number">1</span>] = *(_QWORD *)(_ReadStatusReg(<span class="built_in">ARM64_SYSREG</span>(<span class="number">3</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">2</span>)) + <span class="number">40</span>);</span><br><span class="line">  <span class="built_in">thread_key</span>(vm, reserved);</span><br><span class="line">  v2 = <span class="built_in">pthread_create</span>(v5, <span class="number">0LL</span>, (<span class="keyword">void</span> *(*)(<span class="keyword">void</span> *))sub_1D4E0C, <span class="number">0LL</span>);<span class="comment">// 创建线程</span></span><br><span class="line">  v3 = <span class="built_in">pthread_getspecific_</span>(v2);</span><br><span class="line">  <span class="built_in">sub_1D30F4</span>(v3);                               <span class="comment">// not important</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">65540</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="线程逻辑"><a href="#线程逻辑" class="headerlink" title="线程逻辑"></a>线程逻辑</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __noreturn <span class="title">sub_1D4E0C</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> pid; <span class="comment">// w19</span></span><br><span class="line">  __int64 flag; <span class="comment">// x0</span></span><br><span class="line"></span><br><span class="line">  pid = <span class="built_in">getpid</span>();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    flag = <span class="built_in">check_function</span>(pid); <span class="comment">// 第一个检测函数</span></span><br><span class="line">    <span class="built_in">sub_1D4CFC</span>(flag); <span class="comment">// 可能是检测函数</span></span><br><span class="line">    <span class="built_in">sleep</span>(<span class="number">1u</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="检测函数"><a href="#检测函数" class="headerlink" title="检测函数"></a>检测函数</h3><p>检测status文件, 如果有进程调试该应用, v5不为1, 所以我们的目的是让该函数返回0</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> __fastcall <span class="title">check_function</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  FILE *v1; <span class="comment">// x0</span></span><br><span class="line">  FILE *v2; <span class="comment">// x19</span></span><br><span class="line">  _BOOL4 v3; <span class="comment">// w20</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [xsp+14h] [xbp-53Ch] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> buffer[<span class="number">1024</span>]; <span class="comment">// [xsp+18h] [xbp-538h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">264</span>]; <span class="comment">// [xsp+418h] [xbp-138h] BYREF</span></span><br><span class="line"></span><br><span class="line">  _ReadStatusReg(<span class="built_in">ARM64_SYSREG</span>(<span class="number">3</span>, <span class="number">3</span>, <span class="number">13</span>, <span class="number">0</span>, <span class="number">2</span>));</span><br><span class="line">  <span class="built_in">snprintf</span>(s, <span class="number">0xFF</span>u, <span class="string">&quot;/proc/%d/status&quot;</span>, a1);    <span class="comment">// 检查status文件</span></span><br><span class="line">  v1 = <span class="built_in">fopen</span>(s, <span class="string">&quot;rt&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = v1;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="built_in">fgets</span>(buffer, <span class="number">1024</span>, v2) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(buffer, <span class="string">&quot;TracerPid:&quot;</span>, <span class="number">0xA</span>u) )<span class="comment">// 检查是否读取到TracerPid的那一行</span></span><br><span class="line">      &#123;</span><br><span class="line">        v5 = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">sscanf</span>(buffer, <span class="string">&quot;%*s%d&quot;</span>, &amp;v5);</span><br><span class="line">        v3 = v5 != <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buffer);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_8;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v3 = <span class="number">1</span>;</span><br><span class="line">LABEL_8:</span><br><span class="line">    <span class="built_in">fclose</span>(v2);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="init-array"><a href="#init-array" class="headerlink" title=".init_array"></a>.init_array</h2><p>没有什么检测函数的特征</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.init_array:<span class="number">0000000000E7</span>A708                               ; ELF Initialization Function Table</span><br><span class="line">.init_array:<span class="number">0000000000E7</span>A708                               ; ===========================================================================</span><br><span class="line">.init_array:<span class="number">0000000000E7</span>A708</span><br><span class="line">.init_array:<span class="number">0000000000E7</span>A708                               ; Segment type: Pure data</span><br><span class="line">.init_array:<span class="number">0000000000E7</span>A708                               AREA .init_array, DATA, ALIGN=<span class="number">3</span></span><br><span class="line">.init_array:<span class="number">0000000000E7</span>A708                               ; ORG <span class="number">0xE7A708</span></span><br><span class="line">.init_array:<span class="number">0000000000E7</span>A708 <span class="number">00</span> <span class="number">60</span> <span class="number">1</span>C <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       off_E7A708 DCQ start                    ; DATA XREF: LOAD:off_88↑o</span><br><span class="line">.init_array:<span class="number">0000000000E7</span>A708                                                                       ; LOAD:<span class="number">00000000000001</span>D8↑o</span><br><span class="line">.init_array:<span class="number">0000000000E7</span>A710 <span class="number">48</span> <span class="number">60</span> <span class="number">1</span>C <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       DCQ sub_1C6048</span><br><span class="line">.init_array:<span class="number">0000000000E7</span>A718 E8 <span class="number">60</span> <span class="number">1</span>C <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       DCQ sub_1C60E8</span><br><span class="line">.init_array:<span class="number">0000000000E7</span>A720 <span class="number">08</span> <span class="number">61</span> <span class="number">1</span>C <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       DCQ sub_1C6108</span><br><span class="line">.init_array:<span class="number">0000000000E7</span>A728 DC <span class="number">62</span> <span class="number">1</span>C <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       DCQ sub_1C62DC</span><br><span class="line"></span><br><span class="line">........</span><br><span class="line"></span><br><span class="line">.init_array:<span class="number">0000000000E7</span>AAF8                               ; .init_array ends</span><br></pre></td></tr></table></figure>

<h1 id="Hook"><a href="#Hook" class="headerlink" title="Hook"></a>Hook</h1><p>绕过后即可开始进行Hook操作</p>
<p>由于大部分的Lua字节码文件都经过加密处理, 而我们可以通过钩取加载Lua文件的函数, 从而找到实际加载的Lua字节码文件.</p>
<h2 id="已知的Hook点-有错误-后面”恢复乱序opcode”时更改"><a href="#已知的Hook点-有错误-后面”恢复乱序opcode”时更改" class="headerlink" title="已知的Hook点(有错误, 后面”恢复乱序opcode”时更改)"></a>已知的Hook点(有错误, 后面”恢复乱序opcode”时更改)</h2><p>已知的Hook点: luaL_loadbuffer(), 但是由于我们分析的libgame.so文件是去符号的, 所以需要恢复符号, 找到luaL_loadbuffer()的文件偏移.</p>
<h2 id="恢复符号-并不是这个函数-后面”恢复乱序opcode”时更改"><a href="#恢复符号-并不是这个函数-后面”恢复乱序opcode”时更改" class="headerlink" title="恢复符号(并不是这个函数, 后面”恢复乱序opcode”时更改)"></a>恢复符号(并不是这个函数, 后面”恢复乱序opcode”时更改)</h2><p>我们可以编译相同版本的libluajit.so, 然后通过bindiff[^2]插件来恢复符号.</p>
<p>关于版本我们前面已经知道了(确定LuaJIT版本[^1])</p>
<p>恢复后我们搜索得到了luaL_loadbuffer()</p>
<p>确定为第一个匹配项的原因:</p>
<ul>
<li>匹配度高, 且其他项的匹配度太低了</li>
<li>参数数量和类型与luaL_loadbuffer()相同 (类型长度相同, 需要自己修)</li>
</ul>
<p><img src="/2023/05/13/flagio/image-20230428193458-ig0gs23.png" alt="image">​</p>
<h3 id="luaL-loadbuffer-原型"><a href="#luaL-loadbuffer-原型" class="headerlink" title="luaL_loadbuffer()原型"></a>luaL_loadbuffer()原型</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LUALIB_API <span class="keyword">int</span> <span class="title">luaL_loadbuffer</span><span class="params">(lua_State *L, <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> size, <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>;</span><br></pre></td></tr></table></figure>

<p>参数</p>
<ul>
<li>L: Lua解释器状态</li>
<li>buf: 指向当前加载的Lua文件的二进制内容</li>
<li>size: buf的大小</li>
<li>name: 模块路径名称</li>
</ul>
<h2 id="Hook-luaL-loadbuffer"><a href="#Hook-luaL-loadbuffer" class="headerlink" title="Hook luaL_loadbuffer()"></a>Hook luaL_loadbuffer()</h2><h3 id="得到函数地址"><a href="#得到函数地址" class="headerlink" title="得到函数地址"></a>得到函数地址</h3><p>前面已经恢复了luaL_loadbuffer()函数, 只需要查看其文件偏移即可</p>
<p><img src="/2023/05/13/flagio/image-20230506105711-01se2eu.png" alt="image">​</p>
<h3 id="编写Hook脚本"><a href="#编写Hook脚本" class="headerlink" title="编写Hook脚本"></a>编写Hook脚本</h3><p>编写hook脚本, 就是通过module, 然后通过相对地址来Hook函数 (因为是去符号的, 所以只能用地址来Hook)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    var luaL_loadbuffer = base.<span class="built_in">add</span>(<span class="number">0xAC4E9C</span>);</span><br><span class="line">    Interceptor.<span class="built_in">attach</span>(luaL_loadbuffer, &#123;</span><br><span class="line">        onEnter: <span class="built_in">function</span>(args) &#123;</span><br><span class="line">            console.<span class="built_in">log</span>(<span class="string">&quot;[luaL_loadbuffer]: name = &quot;</span>, args[<span class="number">3</span>].<span class="built_in">readCString</span>());</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="built_in">function</span>(retval) &#123;</span><br><span class="line">  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="游戏进入主界面后输出"><a href="#游戏进入主界面后输出" class="headerlink" title="游戏进入主界面后输出"></a>游戏进入主界面后输出</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[luaL_loadbuffer]: name =  assets/src/<span class="number">537350069</span></span><br><span class="line">[luaL_loadbuffer]: name =  cocos/init.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/Cocos2d.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/Cocos2dConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/<span class="keyword">extern</span>.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/bitExtend.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/DrawPrimitives.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/Opengl.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/OpenglConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocosbuilder/CCBReaderLoad.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocosdenshion/AudioEngine.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocostudio/CocoStudio.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/json.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocostudio/StudioConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/ui/GuiConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/ui/experimentalUIConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/extension/ExtensionConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/network/NetworkConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/spine/SpineConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  core/Enums.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  core/Resources.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  scene/MainMenu.pyc</span><br></pre></td></tr></table></figure>

<h3 id="点击开始游戏后输出"><a href="#点击开始游戏后输出" class="headerlink" title="点击开始游戏后输出"></a>点击开始游戏后输出</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[luaL_loadbuffer]: name =  scene/GameScene.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  core/GameMap.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  entity/Enemy.pyc</span><br><span class="line">[luaL_loadbuffer]: name =  entity/Mario.pyc</span><br></pre></td></tr></table></figure>

<h3 id="顶问号方块后输出"><a href="#顶问号方块后输出" class="headerlink" title="顶问号方块后输出"></a>顶问号方块后输出</h3><p>我们知道顶到问号方块会给你一个无敌蘑菇, 所以最终输入检验的逻辑应该在这里, 所以<strong>core/Util.pyc文件应该包含检验逻辑</strong>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[luaL_loadbuffer]: name =  core/Util.pyc</span><br></pre></td></tr></table></figure>

<h2 id="确定文件类型"><a href="#确定文件类型" class="headerlink" title="确定文件类型"></a>确定文件类型</h2><p>根据luaL_loadbuffer()原型可以知道, 其中的buff参数是指向文件内容的指针, 我们可以读取前四个字节, 确定文件类型</p>
<h3 id="修改js代码"><a href="#修改js代码" class="headerlink" title="修改js代码"></a>修改js代码</h3><p>添加了一个文件前四字节的输出</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    var luaL_loadbuffer = base.<span class="built_in">add</span>(<span class="number">0xAC4E9C</span>);</span><br><span class="line">    Interceptor.<span class="built_in">attach</span>(luaL_loadbuffer, &#123;</span><br><span class="line">        onEnter: <span class="built_in">function</span>(args) &#123;</span><br><span class="line">            console.<span class="built_in">log</span>(<span class="string">&quot;[luaL_loadbuffer]: name = &quot;</span>, args[<span class="number">3</span>].<span class="built_in">readCString</span>());</span><br><span class="line">            var head = Memory.<span class="built_in">readByteArray</span>(args[<span class="number">1</span>], <span class="number">4</span>);</span><br><span class="line">            console.<span class="built_in">log</span>(<span class="string">&quot;[luaL_loadbuffer]: content = &quot;</span>, head);</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="built_in">function</span>(retval) &#123;</span><br><span class="line">  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="得到输出"><a href="#得到输出" class="headerlink" title="得到输出"></a>得到输出</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">[luaL_loadbuffer]: name =  assets/src/<span class="number">537350069</span></span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/init.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/Cocos2d.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/Cocos2dConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/<span class="keyword">extern</span>.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/bitExtend.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/DrawPrimitives.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/Opengl.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/OpenglConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocosbuilder/CCBReaderLoad.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocosdenshion/AudioEngine.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocostudio/CocoStudio.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocos2d/json.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/cocostudio/StudioConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/ui/GuiConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/ui/experimentalUIConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/extension/ExtensionConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/network/NetworkConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  cocos/spine/SpineConstants.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  core/Enums.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  core/Resources.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  scene/MainMenu.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span></span><br><span class="line">[luaL_loadbuffer]: name =  scene/GameScene.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  core/GameMap.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  entity/Enemy.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br><span class="line">[luaL_loadbuffer]: name =  entity/Mario.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span></span><br><span class="line">[luaL_loadbuffer]: name =  core/Util.pyc</span><br><span class="line">[luaL_loadbuffer]: content =             <span class="number">0</span>  <span class="number">1</span>  <span class="number">2</span>  <span class="number">3</span>  <span class="number">4</span>  <span class="number">5</span>  <span class="number">6</span>  <span class="number">7</span>  <span class="number">8</span>  <span class="number">9</span>  A  B  C  D  E  F  <span class="number">0123456789</span>ABCDEF</span><br><span class="line"><span class="number">00000000</span>  <span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">02</span>                                      .LJ.</span><br></pre></td></tr></table></figure>

<h3 id="luac64文件"><a href="#luac64文件" class="headerlink" title="luac64文件"></a>luac64文件</h3><p>输出的文件<strong>头五个字节</strong>都是: <strong>1b 4c 4a 02</strong> <strong>0A</strong>.</p>
<ul>
<li><strong>1b 4c 4a</strong>: LuaJIT魔数</li>
<li><strong>02</strong>: 版本号</li>
<li><strong>0A</strong>: <strong>标识64位luac64文件</strong></li>
</ul>
<h4 id="一个经典luac文件"><a href="#一个经典luac文件" class="headerlink" title="一个经典luac文件"></a>一个经典luac文件</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1b</span> <span class="number">4</span>c <span class="number">4</span>a <span class="number">01</span>             | Header LuaJIT <span class="number">2.0</span> BC</span><br><span class="line"><span class="number">00</span>                      | Flags: None</span><br><span class="line"><span class="number">11</span> <span class="number">40</span> <span class="number">74</span> <span class="number">65</span> <span class="number">73</span> <span class="number">74</span> <span class="number">73</span> <span class="number">2f</span> | Chunkname: @tests/test<span class="number">-1.lu</span>a</span><br><span class="line"><span class="number">74</span> <span class="number">65</span> <span class="number">73</span> <span class="number">74</span> <span class="number">2</span>d <span class="number">31</span> <span class="number">2</span>e <span class="number">6</span>c |</span><br><span class="line"><span class="number">75</span> <span class="number">61</span>                   |</span><br><span class="line">                        | .. prototype ..</span><br><span class="line"><span class="number">8</span>a <span class="number">01</span>                   | prototype length <span class="number">138</span></span><br><span class="line"><span class="number">02</span>                      | prototype flags PROTO_VARARG</span><br><span class="line"><span class="number">00</span>                      | parameters number <span class="number">0</span></span><br><span class="line"><span class="number">07</span>                      | framesize <span class="number">7</span></span><br><span class="line"><span class="number">00</span> <span class="number">01</span> <span class="number">01</span> <span class="number">12</span>             | size uv: <span class="number">0</span> kgc: <span class="number">1</span> kn: <span class="number">1</span> bc: <span class="number">19</span></span><br><span class="line"><span class="number">31</span>                      | debug size <span class="number">49</span></span><br><span class="line"><span class="number">00</span> <span class="number">07</span>                   | firstline: <span class="number">0</span> numline: <span class="number">7</span></span><br><span class="line">                        | .. bytecode ..</span><br><span class="line"><span class="number">32</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>             | <span class="number">0001</span>    TNEW     <span class="number">0</span>   <span class="number">0</span></span><br><span class="line"><span class="number">27</span> <span class="number">01</span> <span class="number">01</span> <span class="number">00</span>             | <span class="number">0002</span>    KSHORT   <span class="number">1</span>   <span class="number">1</span></span><br><span class="line"><span class="number">27</span> <span class="number">02</span> <span class="number">0</span>a <span class="number">00</span>             | <span class="number">0003</span>    KSHORT   <span class="number">2</span>  <span class="number">10</span></span><br><span class="line"><span class="number">27</span> <span class="number">03</span> <span class="number">01</span> <span class="number">00</span>             | <span class="number">0004</span>    KSHORT   <span class="number">3</span>   <span class="number">1</span></span><br><span class="line"><span class="number">49</span> <span class="number">01</span> <span class="number">04</span> <span class="number">80</span>             | <span class="number">0005</span>    FORI     <span class="number">1</span> =&gt; <span class="number">0010</span></span><br><span class="line"><span class="number">20</span> <span class="number">05</span> <span class="number">04</span> <span class="number">04</span>             | <span class="number">0006</span> =&gt; MULVV    <span class="number">5</span>   <span class="number">4</span>   <span class="number">4</span></span><br><span class="line"><span class="number">14</span> <span class="number">05</span> <span class="number">00</span> <span class="number">05</span>             | <span class="number">0007</span>    ADDVN    <span class="number">5</span>   <span class="number">5</span>   <span class="number">0</span>  ; <span class="number">1</span></span><br><span class="line"><span class="number">39</span> <span class="number">05</span> <span class="number">04</span> <span class="number">00</span>             | <span class="number">0008</span>    TSETV    <span class="number">5</span>   <span class="number">0</span>   <span class="number">4</span></span><br><span class="line"><span class="number">4b</span> <span class="number">01</span> fc <span class="number">7f</span>             | <span class="number">0009</span>    FORL     <span class="number">1</span> =&gt; <span class="number">0006</span></span><br><span class="line"><span class="number">27</span> <span class="number">01</span> <span class="number">01</span> <span class="number">00</span>             | <span class="number">0010</span> =&gt; KSHORT   <span class="number">1</span>   <span class="number">1</span></span><br><span class="line"><span class="number">27</span> <span class="number">02</span> <span class="number">0</span>a <span class="number">00</span>             | <span class="number">0011</span>    KSHORT   <span class="number">2</span>  <span class="number">10</span></span><br><span class="line"><span class="number">27</span> <span class="number">03</span> <span class="number">01</span> <span class="number">00</span>             | <span class="number">0012</span>    KSHORT   <span class="number">3</span>   <span class="number">1</span></span><br><span class="line"><span class="number">49</span> <span class="number">01</span> <span class="number">04</span> <span class="number">80</span>             | <span class="number">0013</span>    FORI     <span class="number">1</span> =&gt; <span class="number">0018</span></span><br><span class="line"><span class="number">34</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>             | <span class="number">0014</span> =&gt; GGET     <span class="number">5</span>   <span class="number">0</span>      ; <span class="string">&quot;print&quot;</span></span><br><span class="line"><span class="number">36</span> <span class="number">06</span> <span class="number">04</span> <span class="number">00</span>             | <span class="number">0015</span>    TGETV    <span class="number">6</span>   <span class="number">0</span>   <span class="number">4</span></span><br><span class="line"><span class="number">3</span>e <span class="number">05</span> <span class="number">02</span> <span class="number">01</span>             | <span class="number">0016</span>    CALL     <span class="number">5</span>   <span class="number">1</span>   <span class="number">2</span></span><br><span class="line"><span class="number">4b</span> <span class="number">01</span> fc <span class="number">7f</span>             | <span class="number">0017</span>    FORL     <span class="number">1</span> =&gt; <span class="number">0014</span></span><br><span class="line"><span class="number">47</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span>             | <span class="number">0018</span> =&gt; RET0     <span class="number">0</span>   <span class="number">1</span></span><br><span class="line">                        | .. uv ..</span><br><span class="line">                        | .. kgc ..</span><br><span class="line"><span class="number">0</span>a <span class="number">70</span> <span class="number">72</span> <span class="number">69</span> <span class="number">6</span>e <span class="number">74</span>       | kgc: <span class="string">&quot;print&quot;</span></span><br><span class="line">                        | .. knum ..</span><br><span class="line"><span class="number">02</span>                      | knum <span class="keyword">int</span>: <span class="number">1</span></span><br><span class="line">                        | .. debug ..</span><br><span class="line"><span class="number">01</span>                      | pc001: line <span class="number">1</span></span><br><span class="line"><span class="number">02</span>                      | pc002: line <span class="number">2</span></span><br><span class="line"><span class="number">02</span>                      | pc003: line <span class="number">2</span></span><br><span class="line"><span class="number">02</span>                      | pc004: line <span class="number">2</span></span><br><span class="line"><span class="number">02</span>                      | pc005: line <span class="number">2</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h2 id="Dump内存得到内存中的luac64文件"><a href="#Dump内存得到内存中的luac64文件" class="headerlink" title="Dump内存得到内存中的luac64文件"></a>Dump内存得到内存中的luac64文件</h2><h3 id="frida脚本"><a href="#frida脚本" class="headerlink" title="frida脚本"></a>frida脚本</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    var luaL_loadbuffer = base.<span class="built_in">add</span>(<span class="number">0xAC4E9C</span>);</span><br><span class="line">    Interceptor.<span class="built_in">attach</span>(luaL_loadbuffer, &#123;</span><br><span class="line">        onEnter: <span class="built_in">function</span>(args) &#123;</span><br><span class="line">            var chunk_addr = args[<span class="number">1</span>]; <span class="comment">// buffer pointer</span></span><br><span class="line">            var chunk_name = args[<span class="number">3</span>].<span class="built_in">readCString</span>();</span><br><span class="line">            var chunk_size = args[<span class="number">2</span>].<span class="built_in">toInt32</span>();</span><br><span class="line"></span><br><span class="line">            var new_name = chunk_name.<span class="built_in">slice</span>(chunk_name.<span class="built_in">lastIndexOf</span>(<span class="string">&#x27;/&#x27;</span>) + <span class="number">1</span>, <span class="number">-3</span>) + <span class="string">&quot;luac64&quot;</span>;</span><br><span class="line"></span><br><span class="line">            var currentApplication = Java.<span class="built_in">use</span>(<span class="string">&quot;android.app.ActivityThread&quot;</span>).<span class="built_in">currentApplication</span>();</span><br><span class="line">            var dir = currentApplication.<span class="built_in">getApplicationContext</span>().<span class="built_in">getFilesDir</span>().<span class="built_in">getPath</span>();</span><br><span class="line"></span><br><span class="line">            console.<span class="built_in">log</span>(dir + new_name);</span><br><span class="line">            var file = <span class="keyword">new</span> <span class="built_in">File</span>(dir + new_name, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">            file.<span class="built_in">write</span>(chunk_addr.<span class="built_in">readByteArray</span>(chunk_size));</span><br><span class="line">            file.close;</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="built_in">function</span>(retval) &#123;</span><br><span class="line">  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="得到luac64文件"><a href="#得到luac64文件" class="headerlink" title="得到luac64文件"></a>得到luac64文件</h3><p>adb pull只能一个一个拉</p>
<p><img src="/2023/05/13/flagio/image-20230506140734-2zld6vc.png" alt="image">​</p>
<h1 id="恢复乱序OPcode"><a href="#恢复乱序OPcode" class="headerlink" title="恢复乱序OPcode"></a>恢复乱序OPcode</h1><p>回头看一下LUA文件编译流程[^4], 如果我们<strong>修改了JIT引擎opcode的顺序</strong>, 那么用正常的lua反编译就无法获得正确的源码.</p>
<h2 id="lj-obj-h"><a href="#lj-obj-h" class="headerlink" title="lj_obj.h"></a>lj_obj.h</h2><p>使用VScode打开LuaJIT安装[^5]的源码, lj_obj.h文件位于src目录中, 其中的内容有:</p>
<ul>
<li>实现垃圾回收功能</li>
<li>定义JIT中使用的各种数据类型</li>
<li>定义一些函数, 实现垃圾回收, 控制各种类型操作</li>
</ul>
<p>其中最重要的是: <strong>lua_State结构体</strong>, 跟<strong>opcode解释有关</strong>, 所以我们需要跟进该结构体.</p>
<h3 id="lua-State"><a href="#lua-State" class="headerlink" title="lua_State"></a>lua_State</h3><p>来自: lj_obj.h</p>
<p>功能: 解释器执行解析时的<strong>状态结构体</strong>, 包含<strong>解析器的全部状态信息</strong>. 在JIT解释器运行时会实例化一个lua_State对象, 来<strong>管理堆栈/全局变量, 加载和执行代码, 管理内存</strong>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">lua_State</span> &#123;</span></span><br><span class="line">  GCHeader;</span><br><span class="line">  <span class="keyword">uint8_t</span> dummy_ffid;	<span class="comment">/* Fake FF_C for curr_funcisL() on dummy frames. */</span></span><br><span class="line">  <span class="keyword">uint8_t</span> status;	<span class="comment">/* Thread status. */</span> </span><br><span class="line">  MRef glref;		<span class="comment">/* Link to global state. */</span></span><br><span class="line">  GCRef gclist;		<span class="comment">/* GC chain. */</span></span><br><span class="line">  TValue *base;		<span class="comment">/* Base of currently executing function. */</span></span><br><span class="line">  TValue *top;		<span class="comment">/* First free slot in the stack. */</span></span><br><span class="line">  MRef maxstack;	<span class="comment">/* Last free slot in the stack. */</span></span><br><span class="line">  MRef stack;		<span class="comment">/* Stack base. */</span></span><br><span class="line">  GCRef openupval;	<span class="comment">/* List of open upvalues in the stack. */</span></span><br><span class="line">  GCRef env;		<span class="comment">/* Thread environment (table of globals). */</span></span><br><span class="line">  <span class="keyword">void</span> *cframe;		<span class="comment">/* End of C stack frame chain. */</span></span><br><span class="line">  MSize stacksize;	<span class="comment">/* True stack size (incl. LJ_STACK_EXTRA). */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>各个成员成员变量的功能:</p>
<ul>
<li><p>GCHeade: 不重要</p>
<ul>
<li>用于内存管理</li>
</ul>
</li>
<li><p>dummy_ffid: 不重要</p>
<ul>
<li>用于确定函数调用是否需要一个新的栈帧</li>
</ul>
</li>
<li><p>status: 不重要</p>
<ul>
<li>用于记录线程状态</li>
</ul>
</li>
<li><p><strong>glref: 重要</strong></p>
<ul>
<li><strong>全局状态结构体Global_State</strong>的指针(官方注释中有给出), 用于访问全局变量和全局状态信息.</li>
<li>其类型为<code>MRef</code>​​, 就是一个指针类型, 根据一个全局的Flag判断是64位还是32位. 重要的是运行时指向的是: <strong>全局状态结构体Global_State</strong>.</li>
</ul>
</li>
<li><p>gclist: 不重要</p>
<ul>
<li>即将被回收的对象的指针</li>
</ul>
</li>
<li><p>base:</p>
<ul>
<li>当前执行函数的栈帧</li>
</ul>
</li>
<li><p>top</p>
<ul>
<li>栈顶指针</li>
</ul>
</li>
<li><p>stack:</p>
<ul>
<li>栈的起始地址</li>
</ul>
</li>
<li><p>cframe:</p>
<ul>
<li>C语言栈的栈顶</li>
</ul>
</li>
</ul>
<h2 id="Global-State"><a href="#Global-State" class="headerlink" title="Global_State"></a>Global_State</h2><p>来自: lua_State的<strong>glref</strong>成员变量指向的内容.</p>
<p>功能: 保存了<strong>LuaJIT运行时的全局变量</strong>, 所有线程共享.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">global_State</span> &#123;</span></span><br><span class="line">  GCRef *strhash;	<span class="comment">/* String hash table (hash chain anchors). */</span></span><br><span class="line">  MSize strmask;	<span class="comment">/* String hash mask (size of hash table - 1). */</span></span><br><span class="line">  MSize strnum;		<span class="comment">/* Number of strings in hash table. */</span></span><br><span class="line">  lua_Alloc allocf;	<span class="comment">/* Memory allocator. */</span></span><br><span class="line">  <span class="keyword">void</span> *allocd;		<span class="comment">/* Memory allocator data. */</span></span><br><span class="line">  GCState gc;		<span class="comment">/* Garbage collector. */</span></span><br><span class="line">  <span class="keyword">volatile</span> <span class="keyword">int32_t</span> vmstate;  <span class="comment">/* VM state or current JIT code trace number. */</span></span><br><span class="line">  SBuf tmpbuf;		<span class="comment">/* Temporary string buffer. */</span></span><br><span class="line">  GCstr strempty;	<span class="comment">/* Empty string. */</span></span><br><span class="line">  <span class="keyword">uint8_t</span> stremptyz;	<span class="comment">/* Zero terminator of empty string. */</span></span><br><span class="line">  <span class="keyword">uint8_t</span> hookmask;	<span class="comment">/* Hook mask. */</span></span><br><span class="line">  <span class="keyword">uint8_t</span> dispatchmode;	<span class="comment">/* Dispatch mode. */</span></span><br><span class="line">  <span class="keyword">uint8_t</span> vmevmask;	<span class="comment">/* VM event mask. */</span></span><br><span class="line">  GCRef mainthref;	<span class="comment">/* Link to main thread. */</span></span><br><span class="line">  TValue registrytv;	<span class="comment">/* Anchor for registry. */</span></span><br><span class="line">  TValue tmptv, tmptv2;	<span class="comment">/* Temporary TValues. */</span></span><br><span class="line">  Node nilnode;		<span class="comment">/* Fallback 1-element hash part (nil key and value). */</span></span><br><span class="line">  GCupval uvhead;	<span class="comment">/* Head of double-linked list of all open upvalues. */</span></span><br><span class="line">  <span class="keyword">int32_t</span> hookcount;	<span class="comment">/* Instruction hook countdown. */</span></span><br><span class="line">  <span class="keyword">int32_t</span> hookcstart;	<span class="comment">/* Start count for instruction hook counter. */</span></span><br><span class="line">  lua_Hook hookf;	<span class="comment">/* Hook function. */</span></span><br><span class="line">  lua_CFunction wrapf;	<span class="comment">/* Wrapper for C function calls. */</span></span><br><span class="line">  lua_CFunction panic;	<span class="comment">/* Called as a last resort for errors. */</span></span><br><span class="line">  BCIns bc_cfunc_int;	<span class="comment">/* Bytecode for internal C function calls. */</span></span><br><span class="line">  BCIns bc_cfunc_ext;	<span class="comment">/* Bytecode for external C function calls. */</span></span><br><span class="line">  GCRef cur_L;		<span class="comment">/* Currently executing lua_State. */</span></span><br><span class="line">  MRef jit_base;	<span class="comment">/* Current JIT code L-&gt;base or NULL. */</span></span><br><span class="line">  MRef ctype_state;	<span class="comment">/* Pointer to C type state. */</span></span><br><span class="line">  GCRef gcroot[GCROOT_MAX];  <span class="comment">/* GC roots. */</span></span><br><span class="line">&#125; global_State;</span><br></pre></td></tr></table></figure>

<h2 id="lua-newstate"><a href="#lua-newstate" class="headerlink" title="lua_newstate()"></a>lua_newstate()</h2><p>来自: 通过交叉引用lua_State[^6]和Global_State[^7]可以找到.</p>
<p>功能: 在程序启动时调用, 用于初始化一个新的lua_State对象, 且该lua_State对象是<strong>唯一的全局lua_State对象</strong>. (后面新线程中会有专属的线程lua_State对象).</p>
<p>逻辑: 在其中又有一个新的<strong>GG_State结构体</strong>, 根据下面的代码可以发现lua_State[^6]<strong>和</strong>Global_State[^7]<strong>都是它的成员</strong>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LUA_API lua_State *<span class="title">lua_newstate</span><span class="params">(lua_Alloc f, <span class="keyword">void</span> *ud)</span></span></span><br><span class="line"><span class="function"><span class="meta">#<span class="meta-keyword">endif</span></span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  GG_State *GG = (GG_State *)<span class="built_in">f</span>(ud, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(GG_State)); <span class="comment">// 一个更上层的全局状态结构体</span></span><br><span class="line">  lua_State *L = &amp;GG-&gt;L; <span class="comment">// 包含了lua_State</span></span><br><span class="line">  global_State *g = &amp;GG-&gt;g; <span class="comment">// 包含了global_State</span></span><br><span class="line"></span><br><span class="line">  ..... <span class="comment">// lua_State和global_State的初始化操作</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="GG-State"><a href="#GG-State" class="headerlink" title="GG_State"></a>GG_State</h2><p>来自: lua_State中新出现的结构体类型</p>
<p>功能: 存储LuaJIT虚拟机的运行时数据</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">GG_State</span> &#123;</span></span><br><span class="line">  lua_State L;				<span class="comment">/* Main thread. */</span></span><br><span class="line">  global_State g;			<span class="comment">/* Global state. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LJ_TARGET_MIPS</span></span><br><span class="line">  ASMFunction got[LJ_GOT__MAX];		<span class="comment">/* Global offset table. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> LJ_HASJIT</span></span><br><span class="line">  jit_State J;				<span class="comment">/* JIT state. */</span></span><br><span class="line">  HotCount hotcount[HOTCOUNT_SIZE];	<span class="comment">/* Hot counters. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  ASMFunction dispatch[GG_LEN_DISP];	<span class="comment">/* Instruction dispatch tables. */</span></span><br><span class="line">  BCIns bcff[GG_NUM_ASMFF];		<span class="comment">/* Bytecode for ASM fast functions. */</span></span><br><span class="line">&#125; GG_State;</span><br></pre></td></tr></table></figure>

<p>各成员变量功能:</p>
<ul>
<li><p>L:</p>
<ul>
<li>主线程的lua_State, 访问读取线程的堆栈信息等</li>
</ul>
</li>
<li><p>g:</p>
<ul>
<li>全局State</li>
</ul>
</li>
<li><p>got:</p>
<ul>
<li>不重要</li>
</ul>
</li>
<li><p>J:</p>
<ul>
<li>记录JIT编译器状态</li>
</ul>
</li>
<li><p>hotcout:</p>
<ul>
<li>记录Lua函数的热点计数, 编译JIT编译器对高热点进行优化</li>
</ul>
</li>
<li><p><strong>dispatch: 重要重要重要</strong></p>
<ul>
<li>官方注释: Instruction dispatch tables, <strong>指令调度表</strong></li>
</ul>
</li>
<li><p>bcff:</p>
<ul>
<li>字节码</li>
</ul>
</li>
</ul>
<h2 id="luaL-loadbuffer"><a href="#luaL-loadbuffer" class="headerlink" title="luaL_loadbuffer()"></a>luaL_loadbuffer()</h2><p>从加载字节码的方向继续跟进查看LuaJIT虚拟机执行流程</p>
<p>调用顺序是: luaL_loadbuffer() -&gt; luaL_loadbufferx() -&gt; lua_loadx()</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function">LUALIB_API <span class="keyword">int</span> <span class="title">luaL_loadstring</span><span class="params">(lua_State *L, <span class="keyword">const</span> <span class="keyword">char</span> *s)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">luaL_loadbuffer</span>(L, s, <span class="built_in">strlen</span>(s), s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LUALIB_API <span class="keyword">int</span> <span class="title">luaL_loadbuffer</span><span class="params">(lua_State *L, <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">			       <span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">luaL_loadbufferx</span>(L, buf, size, name, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LUALIB_API <span class="keyword">int</span> <span class="title">luaL_loadbufferx</span><span class="params">(lua_State *L, <span class="keyword">const</span> <span class="keyword">char</span> *buf, <span class="keyword">size_t</span> size,</span></span></span><br><span class="line"><span class="params"><span class="function">				<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">const</span> <span class="keyword">char</span> *mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  StringReaderCtx ctx;</span><br><span class="line">  ctx.str = buf;</span><br><span class="line">  ctx.size = size;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">lua_loadx</span>(L, reader_string, &amp;ctx, name, mode);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">LUA_API <span class="keyword">int</span> <span class="title">lua_loadx</span><span class="params">(lua_State *L, lua_Reader reader, <span class="keyword">void</span> *data,</span></span></span><br><span class="line"><span class="params"><span class="function">		      <span class="keyword">const</span> <span class="keyword">char</span> *chunkname, <span class="keyword">const</span> <span class="keyword">char</span> *mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  LexState ls;</span><br><span class="line">  <span class="keyword">int</span> status;</span><br><span class="line">  ls.rfunc = reader;</span><br><span class="line">  ls.rdata = data; </span><br><span class="line">  ls.chunkarg = chunkname ? chunkname : <span class="string">&quot;?&quot;</span>;</span><br><span class="line">  ls.mode = mode;</span><br><span class="line">  <span class="built_in">lj_buf_init</span>(L, &amp;ls.sb);</span><br><span class="line">  status = <span class="built_in">lj_vm_cpcall</span>(L, <span class="literal">NULL</span>, &amp;ls, cpparser);</span><br><span class="line">  <span class="built_in">lj_lex_cleanup</span>(L, &amp;ls);</span><br><span class="line">  <span class="built_in">lj_gc_check</span>(L);</span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="lua-loadx"><a href="#lua-loadx" class="headerlink" title="lua_loadx()"></a>lua_loadx()</h2><p>继续跟进该函数</p>
<p>逻辑:</p>
<ul>
<li>前面结构体初始化(包括字节码)</li>
<li>调用<code>lj_vm_cpcall(L, NULL, &amp;ls, cpparser);</code>​启动虚拟机, 且传入了字节码</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LUA_API <span class="keyword">int</span> <span class="title">lua_loadx</span><span class="params">(lua_State *L, lua_Reader reader, <span class="keyword">void</span> *data,</span></span></span><br><span class="line"><span class="params"><span class="function">		      <span class="keyword">const</span> <span class="keyword">char</span> *chunkname, <span class="keyword">const</span> <span class="keyword">char</span> *mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  </span><br><span class="line">  LexState ls;</span><br><span class="line">  <span class="keyword">int</span> status;</span><br><span class="line">  ls.rfunc = reader;</span><br><span class="line">  ls.rdata = data;<span class="comment">// 含有字节码成员变量的结构体</span></span><br><span class="line">  ls.chunkarg = chunkname ? chunkname : <span class="string">&quot;?&quot;</span>;</span><br><span class="line">  ls.mode = mode;</span><br><span class="line">  <span class="built_in">lj_buf_init</span>(L, &amp;ls.sb);</span><br><span class="line">  <span class="comment">// 启动虚拟机</span></span><br><span class="line">  status = <span class="built_in">lj_vm_cpcall</span>(L, <span class="literal">NULL</span>, &amp;ls, cpparser);</span><br><span class="line">  <span class="built_in">lj_lex_cleanup</span>(L, &amp;ls);</span><br><span class="line">  <span class="built_in">lj_gc_check</span>(L);</span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="lj-vm-cpcall"><a href="#lj-vm-cpcall" class="headerlink" title="lj_vm_cpcall()"></a>lj_vm_cpcall()</h2><p>功能: 启动虚拟机</p>
<p>逻辑: </p>
<ul>
<li>由于性能要求, 虚拟机的功能逻辑很多直接使用汇编实现, 所以我们要找ARM64的dasc文件.</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LJ_ASMF <span class="keyword">int</span> <span class="title">lj_vm_cpcall</span><span class="params">(lua_State *L, lua_CFunction func, <span class="keyword">void</span> *ud,</span></span></span><br><span class="line"><span class="params"><span class="function">			 lua_CPFunction cp)</span></span>;</span><br></pre></td></tr></table></figure>

<p>参数: </p>
<ul>
<li>L: lua_State的指针</li>
<li>func: 要执行的C函数指针</li>
<li>ud: 用户数据指针</li>
<li>cp:</li>
</ul>
<h3 id="汇编符号"><a href="#汇编符号" class="headerlink" title="汇编符号"></a>汇编符号</h3><p>用到的符号(跟后面的汇编对照, “-&gt;”表示该寄存器的值发生变化, 变化后的值所具有的含义在后面给出):</p>
<ul>
<li><p>CARG1:</p>
<ul>
<li>寄存器: x0</li>
<li>功能: 参数寄存器args[0] -&gt; 一个栈偏移还是啥的</li>
</ul>
</li>
<li><p>L:</p>
<ul>
<li>类型: lua_State</li>
<li>寄存器: x23</li>
<li>功能: 表示lua_State变量</li>
</ul>
</li>
<li><p>LREG: </p>
<ul>
<li>寄存器: x23</li>
<li>功能: 保存lua_State地址</li>
</ul>
</li>
<li><p>RA: (调用保留寄存器)</p>
<ul>
<li>寄存器: x27</li>
<li>功能: 当前stack的起始地址 -&gt; stack长度</li>
</ul>
</li>
<li><p>SAVE_L:</p>
<ul>
<li>内存: [sp, #176]</li>
<li>功能: 保存参数的lua_State</li>
</ul>
</li>
<li><p>GL:</p>
<ul>
<li>类型: global_State</li>
<li>寄存器: x22</li>
<li>功能: 表示GG_State保留变量</li>
</ul>
</li>
<li><p>RB:</p>
<ul>
<li>寄存器: x17</li>
<li>功能: 栈顶指针</li>
</ul>
</li>
<li><p>SAVEPC:</p>
<ul>
<li>内存: [sp, #168]</li>
<li>功能: 还是保存lua_State指针(?)</li>
</ul>
</li>
<li><p>RC: (调用保留寄存器)</p>
<ul>
<li>寄存器: x28</li>
<li>功能: C语言栈顶指针</li>
</ul>
</li>
<li><p>SAVE_NRES</p>
<ul>
<li>内存: [sp, #200]</li>
<li>功能: 堆栈长度(?)</li>
</ul>
</li>
<li><p>SAVE_ERRF:</p>
<ul>
<li>内存: [sp, #196]</li>
<li>功能: 异常函数个数</li>
</ul>
</li>
<li><p>SAVE_CFRAME:</p>
<ul>
<li>内存: [sp, #160]</li>
<li>功能: C语言栈顶指针</li>
</ul>
</li>
<li><p>fp:</p>
<ul>
<li>寄存器: x29</li>
<li>功能: 栈帧</li>
</ul>
</li>
<li><p>CARG4</p>
<ul>
<li>寄存器: x3</li>
<li>功能: args[3]</li>
</ul>
</li>
<li><p>BASE</p>
<ul>
<li>寄存器: x19</li>
<li>功能: args[0]</li>
</ul>
</li>
</ul>
<h3 id="汇编"><a href="#汇编" class="headerlink" title="汇编"></a>汇编</h3><p>逻辑: 初始化初始化初始化….</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 该函数中所有用到的符号在文件开头的定义</span></span><br><span class="line"><span class="symbol">.type</span> L,		lua_State,	LREG</span><br><span class="line"><span class="symbol">.define</span> LREG,		x23	<span class="comment">// Register holding lua_State (also in SAVE_L).</span></span><br><span class="line"><span class="symbol">.define</span> CARG1,		x0</span><br><span class="line"><span class="symbol">.define</span> RA,		x27</span><br><span class="line"><span class="symbol">.define</span> SAVE_L,	[<span class="built_in">sp</span>, <span class="number">#176</span>]	<span class="comment">// 一段栈空间为SAVE_L</span></span><br><span class="line"><span class="symbol">.type</span> GL,		global_State,	GLREG</span><br><span class="line"><span class="symbol">.define</span> GLREG,		x22</span><br><span class="line"><span class="symbol">.define</span> RB,		x17</span><br><span class="line"><span class="symbol">.define</span> SAVE_PC,	[<span class="built_in">sp</span>, <span class="number">#168</span>]</span><br><span class="line"><span class="symbol">.define</span> RC,		x28</span><br><span class="line"><span class="symbol">.define</span> SAVE_NRES,	[<span class="built_in">sp</span>, <span class="number">#200</span>]</span><br><span class="line"><span class="symbol">.define</span> SAVE_ERRF,	[<span class="built_in">sp</span>, <span class="number">#196</span>]</span><br><span class="line"><span class="symbol">.define</span> SAVE_CFRAME,	[<span class="built_in">sp</span>, <span class="number">#160</span>]</span><br><span class="line"><span class="symbol">.define</span> <span class="built_in">fp</span>,		x29	<span class="comment">// Yes, we have to maintain a frame pointer.</span></span><br><span class="line"><span class="symbol">.define</span> CARG4,		x3</span><br><span class="line"><span class="symbol">.define</span> BASE,		x19</span><br></pre></td></tr></table></figure>

<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">|-&gt;vm_cpcall:				// Setup protected C frame, call C.</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// (lua_State *L, lua_CFunction func, void *ud, lua_CPFunction cp)</span></span><br><span class="line"><span class="title">|  saveregs</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// 获取传入的lua_State指针</span></span><br><span class="line"><span class="title">|  mov L, CARG1</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// 单独保存lua_State中的stack起始地址</span></span><br><span class="line"><span class="title">|   ldr RA, L:CARG1-&gt;stack</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// 将lua_State保存至栈中</span></span><br><span class="line"><span class="title">|  str CARG1, SAVE_L</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// 从lua_State中获取global_State指针</span></span><br><span class="line"><span class="title">|    ldr GL, L-&gt;glref			// Setup pointer to global state.</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// RB获取栈顶指针</span></span><br><span class="line"><span class="title">|   ldr RB, L-&gt;top</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// 保存lua_State指针到栈中</span></span><br><span class="line"><span class="title">|  str CARG1, SAVE_PC			// Any value outside of bytecode is ok.</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// RC保存C语言的栈顶指针</span></span><br><span class="line"><span class="title">|   ldr RC, L-&gt;cframe</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// RA = RA - RB, 堆栈起始地址 - 栈顶指针 = stack的长度</span></span><br><span class="line"><span class="title">|   sub RA, RA, RB			// Compute -savestack(L, L-&gt;top).</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// 去RA的地位部分, 保存到SAVE_NRES中</span></span><br><span class="line"><span class="title">|   str RAw, SAVE_NRES		// Neg. delta means cframe w/o frame.</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// wzr是通用零寄存器, 其64位全为零, SAVE_ERRF = 0表示没有异常函数</span></span><br><span class="line"><span class="title">|  str wzr, SAVE_ERRF			// No error function.</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// 将C栈顶指针保存到栈中</span></span><br><span class="line"><span class="title">|  str RC, SAVE_CFRAME</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// 保存C栈帧</span></span><br><span class="line"><span class="title">|  str fp, L-&gt;cframe			// Add our C frame to cframe chain.</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// 保存lua_State指针到global_State的成员中</span></span><br><span class="line"><span class="title">|    str L, GL-&gt;cur_L</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// 无条件跳转到CARG4</span></span><br><span class="line"><span class="title">|  blr CARG4			// (lua_State *L, lua_CFunction func, void *ud)</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// 存储lua_State</span></span><br><span class="line"><span class="title">|  mov BASE, CRET1</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// #FRAME_CP是一个宏定义, 表示当前栈帧的相等偏移量</span></span><br><span class="line"><span class="title">|   mov PC, #FRAME_CP</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// 测试BASE, 不为零跳转至&lt;3标签</span></span><br><span class="line"><span class="title">|  cbnz BASE, &lt;3			// Else continue with the call.</span></span><br><span class="line"><span class="title">|</span>  </span><br><span class="line"><span class="title">|  b -&gt;vm_leave_cp			// No base? Just remove C frame.</span></span><br></pre></td></tr></table></figure>

<h2 id="3-标签"><a href="#3-标签" class="headerlink" title="3:标签"></a>3:标签</h2><h3 id="汇编符号-1"><a href="#汇编符号-1" class="headerlink" title="汇编符号"></a>汇编符号</h3><ul>
<li><p>RB:</p>
<ul>
<li>寄存器: x17</li>
<li>功能: 栈顶指针 -&gt; old base</li>
</ul>
</li>
<li><p>LJ_TISNUM:</p>
<ul>
<li>功能: JIT虚拟机的表示数字类型的tag值, 用于区分不同的类型</li>
</ul>
</li>
<li><p>感觉都是一些初始化的操作, 后面就没有太仔细看了</p>
</li>
</ul>
<h3 id="汇编-1"><a href="#汇编-1" class="headerlink" title="汇编"></a>汇编</h3><p>主要任务是: 跟进后面的<strong>ins_call</strong>, 注意<strong>CARG3</strong>(因为在C调用中该参数传入的结构体中含有opcode)</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">|  // vm_cpcall的入口点</span></span><br><span class="line"><span class="title">|</span><span class="number">3</span>:  <span class="comment">// Entry point for vm_cpcall/vm_resume (BASE = base, PC = ftype).</span></span><br><span class="line"><span class="title">|  // glocal_State.cur_L = lua_State</span></span><br><span class="line"><span class="title">|</span>  <span class="keyword">str</span> L, GL-&gt;cur_L</span><br><span class="line"><span class="title">|  // RB保存之前的栈帧</span></span><br><span class="line"><span class="title">|</span>  ldp RB, CARG1, L-&gt;base		<span class="comment">// RB = old base (for vmeta_call).</span></span><br><span class="line"><span class="title">|  // TISNUM = ((LJ_TISNUM &gt;&gt; 1) &amp; 0xffff) &lt;&lt; 48;</span></span><br><span class="line"><span class="title">|</span>    movz TISNUM, #(LJ_TISNUM&gt;&gt;<span class="number">1</span>)&amp;<span class="number">0xffff</span>, <span class="keyword">lsl</span> <span class="number">#48</span></span><br><span class="line"><span class="title">|  // TIMSNUMhi = ((LJ_TISNUM &gt;&gt; 1) &amp; 0x0xffff) &lt;&lt; 16;</span></span><br><span class="line"><span class="title">|</span>    movz TISNUMhi, #(LJ_TISNUM&gt;&gt;<span class="number">1</span>)&amp;<span class="number">0xffff</span>, <span class="keyword">lsl</span> <span class="number">#16</span></span><br><span class="line"><span class="title">|  // </span></span><br><span class="line"><span class="title">|</span>  <span class="keyword">add</span> <span class="built_in">PC</span>, <span class="built_in">PC</span>, BASE</span><br><span class="line"><span class="title">|  // TISNIL = 0</span></span><br><span class="line"><span class="title">|</span>    movn TISNIL, <span class="number">#0</span></span><br><span class="line"><span class="title">|  // </span></span><br><span class="line"><span class="title">|</span>  <span class="keyword">sub</span> <span class="built_in">PC</span>, <span class="built_in">PC</span>, RB			<span class="comment">// PC = frame delta + frame type</span></span><br><span class="line"><span class="title">|  // </span></span><br><span class="line"><span class="title">|</span>   <span class="keyword">sub</span> NARGS8:RC, CARG1, BASE</span><br><span class="line"><span class="title">|  // </span></span><br><span class="line"><span class="title">|</span>    st_vmstate ST_INTERP</span><br><span class="line"><span class="title">|  // </span></span><br><span class="line"><span class="title">|</span>-&gt;vm_call_dispatch:</span><br><span class="line"><span class="title">|  // RB = old base, BASE = new base, RC = nargs*8, PC = caller PC</span></span><br><span class="line"><span class="title">|</span>  <span class="keyword">ldr</span> CARG3, [BASE, FRAME_FUNC]</span><br><span class="line"><span class="title">|  // </span></span><br><span class="line"><span class="title">|</span>  checkfunc CARG3, -&gt;vmeta_call</span><br><span class="line"><span class="title">|  // </span></span><br><span class="line"><span class="title">|</span>-&gt;vm_call_dispatch_f:</span><br><span class="line"><span class="title">|  // 调用ins_call</span></span><br><span class="line"><span class="title">|</span>  ins_call</span><br><span class="line"><span class="title">|  // </span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// BASE = new base, CARG3 = func, RC = nargs*8, PC = caller PC</span></span><br></pre></td></tr></table></figure>

<h2 id="ins-call"><a href="#ins-call" class="headerlink" title="ins_call"></a>ins_call</h2><h3 id="汇编-2"><a href="#汇编-2" class="headerlink" title="汇编"></a>汇编</h3><p>还是跟上面一样的思路: 继续跟进, 注意含有opcode的CARG3</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">|.macro ins_call</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// BASE = new base, CARG3 = LFUNC/CFUNC, RC = nargs*8, PC = caller PC</span></span><br><span class="line"><span class="title">|  str PC, [BASE, FRAME_PC]</span></span><br><span class="line"><span class="title">|</span>  ins_callt <span class="comment">// 继续跟进</span></span><br><span class="line"><span class="title">|.endmacro</span></span><br></pre></td></tr></table></figure>

<h2 id="ins-callt"><a href="#ins-callt" class="headerlink" title="ins_callt"></a>ins_callt</h2><h3 id="汇编-3"><a href="#汇编-3" class="headerlink" title="汇编"></a>汇编</h3><p>注意opcode的指针: <code>ls-&gt;rodata-&gt;str</code>​</p>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">|.macro ins_callt</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// BASE = new base, CARG3 = LFUNC/CFUNC, RC = nargs*8, FRAME_PC(BASE) = PC</span></span><br><span class="line"><span class="title">|  // 加载opcode的地址, 虽然不知道为啥结构体可以直接取pc字段, 而不是`ls-&gt;rodata-&gt;str`</span></span><br><span class="line"><span class="title">|</span>  <span class="keyword">ldr</span> <span class="built_in">PC</span>, LFUNC:CARG3-&gt;<span class="built_in">pc</span></span><br><span class="line"><span class="title">|  去除固定四字节长度的指令</span></span><br><span class="line"><span class="title">|</span>  <span class="keyword">ldr</span> INSw, [<span class="built_in">PC</span>], <span class="number">#4</span></span><br><span class="line"><span class="title">|  // TMP1 = (((uint_32)(INS &amp; 0xFF)) &lt;&lt; 3) + GL</span></span><br><span class="line"><span class="title">|</span>  <span class="keyword">add</span> TMP1, GL, INS, <span class="keyword">uxtb</span> <span class="number">#3</span></span><br><span class="line"><span class="title">|  // 译码解析操作数</span></span><br><span class="line"><span class="title">|</span>   decode_RA RA, INS</span><br><span class="line"><span class="title">|  // TMP0 = *(uint_64*)((void*)TMP1 + GG_G2DISP) </span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// TMP1加上GG常量值后, 从内存取出一个uint64的值出来, 该值就是对应指令的地址</span></span><br><span class="line"><span class="title">|  ldr TMP0, [TMP1, #GG_G2DISP]</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// 解析操作数</span></span><br><span class="line"><span class="title">|   add RA, BASE, RA, lsl #3</span></span><br><span class="line"><span class="title">|</span>  <span class="comment">// 跳转到对应的逻辑处执行</span></span><br><span class="line"><span class="title">|  br TMP0</span></span><br><span class="line"><span class="title">|</span>.endmacro</span><br></pre></td></tr></table></figure>

<h3 id="虚拟机查找执行逻辑地址"><a href="#虚拟机查找执行逻辑地址" class="headerlink" title="虚拟机查找执行逻辑地址"></a>虚拟机查找执行逻辑地址</h3><ul>
<li><p>找到patch</p>
<ul>
<li>TAMP1位指令值 * 8 (因为指令长度为8)</li>
<li>加上GL的值</li>
<li>原本GL的值 + GG_G2DISP = dispatch数组</li>
<li>加上指令序号 * 8就是最终的opcode的地址</li>
</ul>
</li>
</ul>
<figure class="highlight arm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define GG_OFS(field)	((int)offsetof(GG_State, field)) // 返回一个字段相对于GG_State起始的偏移</span></span><br><span class="line"><span class="comment">#define GG_G2DISP	(GG_OFS(dispatch) - GG_OFS(g)) // 计算得到了dispatch和g字段之间地址的差</span></span><br></pre></td></tr></table></figure>

<h2 id="找到ins-call-对应偏移地址-确定GG-G2DISP"><a href="#找到ins-call-对应偏移地址-确定GG-G2DISP" class="headerlink" title="找到ins_call()对应偏移地址, 确定GG_G2DISP"></a>找到ins_call()对应偏移地址, 确定GG_G2DISP</h2><p>作者并没有讲是怎么得到对应指令的文件偏移, 一开始试了特征代码查找, 但是筛出来的东西太多了.</p>
<p>于是回头看了一下源码, 发现前面<strong>bindiff找的luaL_loadbuffer()其实是lua_loadx()</strong>. (才发现编译的libluajit.so是32位的, 可能这就是bindiff匹配度比较低的原因吧)</p>
<p>根据下面的对比发现都有相同的字符串<code>&quot;?&quot;</code>​, 所以可以确定时lua_loadx().</p>
<h3 id="lua-loadx-源码"><a href="#lua-loadx-源码" class="headerlink" title="lua_loadx()源码"></a>lua_loadx()源码</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LUA_API <span class="keyword">int</span> <span class="title">lua_loadx</span><span class="params">(lua_State *L, lua_Reader reader, <span class="keyword">void</span> *data,</span></span></span><br><span class="line"><span class="params"><span class="function">		      <span class="keyword">const</span> <span class="keyword">char</span> *chunkname, <span class="keyword">const</span> <span class="keyword">char</span> *mode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  LexState ls;</span><br><span class="line">  <span class="keyword">int</span> status;</span><br><span class="line">  ls.rfunc = reader;</span><br><span class="line">  ls.rdata = data; </span><br><span class="line">  ls.chunkarg = chunkname ? chunkname : <span class="string">&quot;?&quot;</span>;</span><br><span class="line">  ls.mode = mode;</span><br><span class="line">  <span class="built_in">lj_buf_init</span>(L, &amp;ls.sb);</span><br><span class="line">  status = <span class="built_in">lj_vm_cpcall</span>(L, <span class="literal">NULL</span>, &amp;ls, cpparser);</span><br><span class="line">  <span class="built_in">lj_lex_cleanup</span>(L, &amp;ls);</span><br><span class="line">  <span class="built_in">lj_gc_check</span>(L);</span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ida反编译"><a href="#ida反编译" class="headerlink" title="ida反编译"></a>ida反编译</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">luaL_loadbuffer</span><span class="params">(__int64 a1, __int64 a2, __int64 a3, <span class="keyword">char</span> *a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// x8</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v6; <span class="comment">// w20</span></span><br><span class="line">  __int64 v8[<span class="number">2</span>]; <span class="comment">// [xsp+0h] [xbp-E0h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> v9[<span class="number">64</span>]; <span class="comment">// [xsp+10h] [xbp-D0h] BYREF</span></span><br><span class="line">  __int64 v10; <span class="comment">// [xsp+50h] [xbp-90h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [xsp+58h] [xbp-88h]</span></span><br><span class="line">  __int64 v12; <span class="comment">// [xsp+60h] [xbp-80h]</span></span><br><span class="line">  __int64 v13; <span class="comment">// [xsp+68h] [xbp-78h]</span></span><br><span class="line">  __int64 (__fastcall *v14)(); <span class="comment">// [xsp+70h] [xbp-70h]</span></span><br><span class="line">  __int64 *v15; <span class="comment">// [xsp+78h] [xbp-68h]</span></span><br><span class="line">  <span class="keyword">char</span> *v16; <span class="comment">// [xsp+90h] [xbp-50h]</span></span><br><span class="line">  __int64 v17; <span class="comment">// [xsp+98h] [xbp-48h]</span></span><br><span class="line"></span><br><span class="line">  v14 = sub_AC4E7C;</span><br><span class="line">  v15 = v8;</span><br><span class="line">  v4 = <span class="string">&quot;?&quot;</span>;                                     <span class="comment">// 特征字符串</span></span><br><span class="line">  <span class="keyword">if</span> ( a4 )</span><br><span class="line">    v4 = a4;</span><br><span class="line">  v8[<span class="number">0</span>] = a2;</span><br><span class="line">  v8[<span class="number">1</span>] = a3;</span><br><span class="line">  v16 = v4;</span><br><span class="line">  v17 = <span class="number">0LL</span>;</span><br><span class="line">  v12 = <span class="number">0LL</span>;</span><br><span class="line">  v13 = a1;</span><br><span class="line">  v10 = <span class="number">0LL</span>;</span><br><span class="line">  v11 = <span class="number">0LL</span>;</span><br><span class="line">  v6 = <span class="built_in">sub_ACFEB4</span>(a1, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">sub_ABA3AC</span>(a1, v9);</span><br><span class="line">  <span class="keyword">if</span> ( *(_QWORD *)(*(_QWORD *)(a1 + <span class="number">16</span>) + <span class="number">32LL</span>) &gt;= *(_QWORD *)(*(_QWORD *)(a1 + <span class="number">16</span>) + <span class="number">40LL</span>) )</span><br><span class="line">    <span class="built_in">sub_AD1D54</span>(a1);</span><br><span class="line">  <span class="keyword">return</span> v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="继续跟进lua-loadx"><a href="#继续跟进lua-loadx" class="headerlink" title="继续跟进lua_loadx()"></a>继续跟进lua_loadx()</h3><p>由于lua_loadx()最终会调用lj_vm_cpcall(), 可以尝试跟进找到对应的汇编代码.</p>
<p>跟进了上述IDA反编译代码的<code>v6 = sub_ACFEB4(a1, 0LL);</code>​</p>
<h3 id="sub-ACFEB4"><a href="#sub-ACFEB4" class="headerlink" title="sub_ACFEB4()"></a>sub_ACFEB4()</h3><p>其中有两个<strong>JUMPOUT</strong>, 这个是非常可疑的, 因为IDA分析出现JUMPOUT的一个原因就是<strong>无条件跳转</strong>, 而<strong>ins_call</strong>的代码是<strong>使用汇编实现的</strong>, 所以有理由怀疑这里可能是<strong>ins_call</strong>的具体逻辑</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">sub_ACFEB4</span><span class="params">(_QWORD *a1, __int64 a2, __int64 a3, __int64 (*a4)(<span class="keyword">void</span>))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// x27</span></span><br><span class="line">  __int64 v5; <span class="comment">// x22</span></span><br><span class="line">  __int64 v6; <span class="comment">// x17</span></span><br><span class="line">  __int64 v7; <span class="comment">// x28</span></span><br><span class="line">  __int64 v8[<span class="number">24</span>]; <span class="comment">// [xsp+0h] [xbp+0h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [xsp+C4h] [xbp+C4h]</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [xsp+C8h] [xbp+C8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = a1[<span class="number">7</span>];</span><br><span class="line">  v8[<span class="number">22</span>] = (__int64)a1;</span><br><span class="line">  v5 = a1[<span class="number">2</span>];</span><br><span class="line">  v6 = a1[<span class="number">5</span>];</span><br><span class="line">  v8[<span class="number">21</span>] = (__int64)a1;</span><br><span class="line">  v7 = a1[<span class="number">10</span>];</span><br><span class="line">  v10 = v4 - v6;</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  v8[<span class="number">20</span>] = v7;</span><br><span class="line">  a1[<span class="number">10</span>] = v8;</span><br><span class="line">  *(_QWORD *)(v5 + <span class="number">344</span>) = a1;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">a4</span>() )</span><br><span class="line">    <span class="built_in">JUMPOUT</span>(<span class="number">0xACFC10</span>LL);</span><br><span class="line">  <span class="built_in">JUMPOUT</span>(<span class="number">0xACFE5C</span>LL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="跟进JUMPOUT"><a href="#跟进JUMPOUT" class="headerlink" title="跟进JUMPOUT"></a>跟进JUMPOUT</h3><p>再第二个JUMPOUT找到了对应的汇编代码, 在倒数第五行的位置得到<strong>GG_G2DISP = 0xF30</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000</span>ACFE5C                               loc_ACFE5C                              ; CODE XREF: sub_ACFD34+<span class="number">5</span>C↑j</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE5C                                                                       ; sub_ACFEB4+<span class="number">6</span>C↓j</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE5C D7 AE <span class="number">00</span> F9                   STR             X23, [X22,#<span class="number">0x158</span>]</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE60 F1 <span class="number">02</span> <span class="number">42</span> A9                   LDP             X17, X0, [X23,#<span class="number">0x20</span>]</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE64 <span class="number">38</span> FF FF D2                   MOV             X24, #<span class="number">0xFFF9000000000000</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACFE68 <span class="number">39</span> FF BF D2                   MOV             X25, #<span class="number">0xFFF90000</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACFE6C B5 <span class="number">02</span> <span class="number">13</span> <span class="number">8B</span>                   ADD             X21, X21, X19</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE70 <span class="number">1</span>A <span class="number">00</span> <span class="number">80</span> <span class="number">92</span>                   MOV             X26, #<span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACFE74 B5 <span class="number">02</span> <span class="number">11</span> CB                   SUB             X21, X21, X17</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE78 <span class="number">1</span>C <span class="number">00</span> <span class="number">13</span> CB                   SUB             X28, X0, X19</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE7C DA <span class="number">82</span> <span class="number">00</span> B9                   STR             W26, [X22,#<span class="number">0x80</span>]</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE7C</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE80</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE80                               loc_ACFE80                              ; CODE XREF: sub_ACDAF0+<span class="number">2750</span>↓j</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE80                                                                       ; .text:<span class="number">0000000000</span>AD0644↓j</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE80                                                                       ; .text:<span class="number">0000000000</span>AD065C↓j</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE80                                                                       ; .text:<span class="number">0000000000</span>AD0690↓j</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE80                                                                       ; sub_ACFCA8+<span class="number">1624</span>↓j</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE80 <span class="number">62</span> <span class="number">02</span> <span class="number">5F</span> F8                   LDUR            X2, [X19,#<span class="number">-0x10</span>]</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE84 <span class="number">4F</span> FC <span class="number">6F</span> <span class="number">93</span>                   ASR             X15, X2, #<span class="number">0x2F</span> ; <span class="string">&#x27;/&#x27;</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACFE88 FF <span class="number">25</span> <span class="number">00</span> B1                   CMN             X15, #<span class="number">9</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACFE8C <span class="number">42</span> B8 <span class="number">40</span> <span class="number">92</span>                   AND             X2, X2, #<span class="number">0x7FFFFFFFFFFF</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACFE90 <span class="number">61</span> <span class="number">1</span>E <span class="number">00</span> <span class="number">54</span>                   B.NE            loc_AD025C</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE90</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE94</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE94                               loc_ACFE94                              ; CODE XREF: sub_ACEE20+<span class="number">1218</span>↓j</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE94                                                                       ; sub_ACEE20+<span class="number">12</span>CC↓j</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE94 <span class="number">75</span> <span class="number">82</span> <span class="number">1F</span> F8                   STUR            X21, [X19,#<span class="number">-8</span>]</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE98 <span class="number">55</span> <span class="number">10</span> <span class="number">40</span> F9                   LDR             X21, [X2,#<span class="number">0x20</span>]</span><br><span class="line">.text:<span class="number">0000000000</span>ACFE9C B0 <span class="number">46</span> <span class="number">40</span> B8                   LDR             W16, [X21],#<span class="number">4</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACFEA0 C9 <span class="number">0</span>E <span class="number">30</span> <span class="number">8B</span>                   ADD             X9, X22, W16,UXTB#<span class="number">3</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACFEA4 <span class="number">1B</span> <span class="number">3</span>E <span class="number">48</span> D3                   UBFX            X27, X16, #<span class="number">8</span>, #<span class="number">8</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACFEA8 <span class="number">28</span> <span class="number">99</span> <span class="number">47</span> F9                   LDR             X8, [X9,#<span class="number">0xF30</span>]</span><br><span class="line">.text:<span class="number">0000000000</span>ACFEAC <span class="number">7B</span> <span class="number">0</span>E <span class="number">1B</span> <span class="number">8B</span>                   ADD             X27, X19, X27,LSL#<span class="number">3</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACFEB0 <span class="number">00</span> <span class="number">01</span> <span class="number">1F</span> D6                   BR              X8</span><br><span class="line">.text:<span class="number">0000000000</span>ACFEB0</span><br><span class="line">.text:<span class="number">0000000000</span>ACFEB0                               ; End of function sub_ACFE08</span><br></pre></td></tr></table></figure>

<h2 id="查看opcode"><a href="#查看opcode" class="headerlink" title="查看opcode"></a>查看opcode</h2><p>在lj_bc.h中可以找到共有97种opcode</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_(ISLT,	var,	___,	var,	lt) \</span><br><span class="line">_(ISGE,	var,	___,	var,	lt) \</span><br><span class="line">_(ISLE,	var,	___,	var,	le) \</span><br><span class="line">_(ISGT,	var,	___,	var,	le) \</span><br><span class="line">\</span><br><span class="line">_(ISEQV,	var,	___,	var,	eq) \</span><br><span class="line">_(ISNEV,	var,	___,	var,	eq) \</span><br><span class="line">_(ISEQS,	var,	___,	str,	eq) \</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<h2 id="Hook汇编代码找到所有的opcode地址"><a href="#Hook汇编代码找到所有的opcode地址" class="headerlink" title="Hook汇编代码找到所有的opcode地址"></a>Hook汇编代码找到所有的opcode地址</h2><h3 id="Hook指令执行"><a href="#Hook指令执行" class="headerlink" title="Hook指令执行"></a>Hook指令执行</h3><p>一开始想直接Hook指令执行, 这样不行的原因是: </p>
<ul>
<li>指令执行会执行大量的代码, 且会有很多重复(我的hook下来的输出就是这样), 效率极低</li>
<li>有些指令没有被执行, 无法获取全部的指令</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误的脚本, hook的是跳转到指定指令的逻辑时的寄存器</span></span><br><span class="line">    &#123;</span><br><span class="line">        var load_opcode = base.<span class="built_in">add</span>(<span class="number">0xACFEB0</span>);</span><br><span class="line">        Interceptor.<span class="built_in">attach</span>(load_opcode, &#123;</span><br><span class="line">            onEnter: <span class="built_in">function</span>(args) &#123;</span><br><span class="line">                var opcode_addr = <span class="keyword">this</span>.context.x8;</span><br><span class="line">                console.<span class="built_in">log</span>(opcode_addr);</span><br><span class="line">            &#125;,</span><br><span class="line">            onLeave: <span class="built_in">function</span>(retval) &#123;&#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="Hook掉GL地址-用前面的GG-G2DISP偏移找到dispatch表-然后打印出来"><a href="#Hook掉GL地址-用前面的GG-G2DISP偏移找到dispatch表-然后打印出来" class="headerlink" title="Hook掉GL地址, 用前面的GG_G2DISP偏移找到dispatch表, 然后打印出来"></a>Hook掉GL地址, 用前面的GG_G2DISP偏移找到dispatch表, 然后打印出来</h3><p>这个的Hook点挺多的, 前面lj_vm_cpcall()里面的初始化操作多次用到lj_vm_cpcall(), GL对应的寄存器是<strong>x22</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    var load_opcode = base.<span class="built_in">add</span>(<span class="number">0xACFEA0</span>);</span><br><span class="line">    var GG_G2DISP = <span class="number">0xF30</span>;</span><br><span class="line">    Interceptor.<span class="built_in">attach</span>(load_opcode, &#123;</span><br><span class="line">        onEnter: <span class="built_in">function</span>(args) &#123;</span><br><span class="line">            var GG_State_addr = <span class="keyword">this</span>.context.x22;</span><br><span class="line">            var dispatch = GG_State_addr.<span class="built_in">add</span>(GG_G2DISP); <span class="comment">// 获取到dispatch字段偏移</span></span><br><span class="line">            <span class="keyword">for</span> (var i = <span class="number">0</span>; i &lt; <span class="number">97</span>; i++) &#123;</span><br><span class="line">                var p = dispatch.<span class="built_in">add</span>(i * <span class="number">8</span>).<span class="built_in">readPointer</span>(); <span class="comment">// 注意: 因为dispatch是以数组的形式直接在结构体中保存, 所以直接+8即可逐个读取各个指令的指针值</span></span><br><span class="line">                console.<span class="built_in">log</span>(<span class="string">&quot;[dispatch]: &quot;</span>, p.<span class="built_in">sub</span>(base)); <span class="comment">// 注意: 减去so的基址才是文件偏移</span></span><br><span class="line">            &#125;</span><br><span class="line">            console.<span class="built_in">log</span>(opcode_addr);</span><br><span class="line">        &#125;,</span><br><span class="line">        onLeave: <span class="built_in">function</span>(retval) &#123;&#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>得到了各个指令的文件偏移</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">[dispatch]:  <span class="number">0xacdaf0</span>;</span><br><span class="line">[dispatch]:  <span class="number">0xacdb70</span>;</span><br><span class="line">[dispatch]:  <span class="number">0xacdbf0</span>;</span><br><span class="line">[dispatch]:  <span class="number">0xacdc70</span>;</span><br><span class="line">[dispatch]:  <span class="number">0xacdcf0</span>;</span><br><span class="line">[dispatch]:  <span class="number">0xacdd74</span>;</span><br><span class="line">[dispatch]:  <span class="number">0xacddf4</span></span><br><span class="line">[dispatch]:  <span class="number">0xacde44</span></span><br><span class="line">[dispatch]:  <span class="number">0xacde94</span></span><br><span class="line">[dispatch]:  <span class="number">0xacdf20</span></span><br><span class="line">[dispatch]:  <span class="number">0xacdfac</span></span><br><span class="line">[dispatch]:  <span class="number">0xacdff0</span></span><br><span class="line">[dispatch]:  <span class="number">0xace034</span></span><br><span class="line">[dispatch]:  <span class="number">0xace060</span></span><br><span class="line">[dispatch]:  <span class="number">0xace08c</span></span><br><span class="line">[dispatch]:  <span class="number">0xace0b0</span></span><br><span class="line">[dispatch]:  <span class="number">0xace0d0</span></span><br><span class="line">[dispatch]:  <span class="number">0xace0f0</span></span><br><span class="line">[dispatch]:  <span class="number">0xace120</span></span><br><span class="line">[dispatch]:  <span class="number">0xace160</span></span><br><span class="line">[dispatch]:  <span class="number">0xace1a0</span></span><br><span class="line">[dispatch]:  <span class="number">0xace1d8</span></span><br><span class="line">[dispatch]:  <span class="number">0xace210</span></span><br><span class="line">[dispatch]:  <span class="number">0xace234</span></span><br><span class="line">[dispatch]:  <span class="number">0xace258</span></span><br><span class="line">[dispatch]:  <span class="number">0xace278</span></span><br><span class="line">[dispatch]:  <span class="number">0xace2a8</span></span><br><span class="line">[dispatch]:  <span class="number">0xace2ec</span></span><br><span class="line">[dispatch]:  <span class="number">0xace334</span></span><br><span class="line">[dispatch]:  <span class="number">0xace348</span></span><br><span class="line">[dispatch]:  <span class="number">0xace3f0</span></span><br><span class="line">[dispatch]:  <span class="number">0xace458</span></span><br><span class="line">[dispatch]:  <span class="number">0xace4c8</span></span><br><span class="line">[dispatch]:  <span class="number">0xace534</span></span><br><span class="line">[dispatch]:  <span class="number">0xace5a0</span></span><br><span class="line">[dispatch]:  <span class="number">0xace614</span></span><br><span class="line">[dispatch]:  <span class="number">0xace65c</span></span><br><span class="line">[dispatch]:  <span class="number">0xace6d0</span></span><br><span class="line">[dispatch]:  <span class="number">0xace73c</span></span><br><span class="line">[dispatch]:  <span class="number">0xace7a8</span></span><br><span class="line">[dispatch]:  <span class="number">0xace81c</span></span><br><span class="line">[dispatch]:  <span class="number">0xace864</span></span><br><span class="line">[dispatch]:  <span class="number">0xace8d8</span></span><br><span class="line">[dispatch]:  <span class="number">0xace944</span></span><br><span class="line">[dispatch]:  <span class="number">0xace9b0</span></span><br><span class="line">[dispatch]:  <span class="number">0xacea24</span></span><br><span class="line">[dispatch]:  <span class="number">0xacea6c</span></span><br><span class="line">[dispatch]:  <span class="number">0xaceae0</span></span><br><span class="line">[dispatch]:  <span class="number">0xaceb28</span></span><br><span class="line">[dispatch]:  <span class="number">0xaceb74</span></span><br><span class="line">[dispatch]:  <span class="number">0xaceba8</span></span><br><span class="line">[dispatch]:  <span class="number">0xacec18</span></span><br><span class="line">[dispatch]:  <span class="number">0xacec80</span></span><br><span class="line">[dispatch]:  <span class="number">0xacecb4</span></span><br><span class="line">[dispatch]:  <span class="number">0xacece8</span></span><br><span class="line">[dispatch]:  <span class="number">0xaced24</span></span><br><span class="line">[dispatch]:  <span class="number">0xaced6c</span></span><br><span class="line">[dispatch]:  <span class="number">0xacedcc</span></span><br><span class="line">[dispatch]:  <span class="number">0xacee20</span></span><br><span class="line">[dispatch]:  <span class="number">0xacee38</span></span><br><span class="line">[dispatch]:  <span class="number">0xacee50</span></span><br><span class="line">[dispatch]:  <span class="number">0xaceedc</span></span><br><span class="line">[dispatch]:  <span class="number">0xacef70</span></span><br><span class="line">[dispatch]:  <span class="number">0xacefdc</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf024</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf0d4</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf1d0</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf260</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf2f4</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf35c</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf36c</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf3b4</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf3c0</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf47c</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf4cc</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf570</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf62c</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf6a4</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf734</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf7ec</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf7ec</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf878</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf918</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf918</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf94c</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf998</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf998</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf9b0</span></span><br><span class="line">[dispatch]:  <span class="number">0xacf9d4</span></span><br><span class="line">[dispatch]:  <span class="number">0xacfa10</span></span><br><span class="line">[dispatch]:  <span class="number">0xacfa10</span></span><br><span class="line">[dispatch]:  <span class="number">0xacfa50</span></span><br><span class="line">[dispatch]:  <span class="number">0xacfa80</span></span><br><span class="line">[dispatch]:  <span class="number">0xacfa80</span></span><br><span class="line">[dispatch]:  <span class="number">0xacfb04</span></span><br><span class="line">[dispatch]:  <span class="number">0xacfb08</span></span><br><span class="line">[dispatch]:  <span class="number">0xacfb50</span></span><br></pre></td></tr></table></figure>

<h2 id="找到对应的opcode"><a href="#找到对应的opcode" class="headerlink" title="找到对应的opcode"></a>找到对应的opcode</h2><p>根据frida中的地址找到所有的opcode, 并对照vm_arm64.dasc中的build_ins()函数恢复指令. 主要根据特征的汇编代码找到.</p>
<p>vm_arm64.dasc中用到了很多的define符号, 使用替换功能换回寄存器的形式, 这样跟IDA做比较的时候更容易.</p>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><p>用第一个地址恢复作为实例</p>
<h4 id="vm-arm64-dasc原始代码"><a href="#vm-arm64-dasc原始代码" class="headerlink" title="vm_arm64.dasc原始代码"></a>vm_arm64.dasc原始代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> BC_ISLT: <span class="keyword">case</span> BC_ISGE: <span class="keyword">case</span> BC_ISLE: <span class="keyword">case</span> BC_ISGT:</span><br><span class="line">  |  <span class="comment">// RA = src1, RC = src2, JMP with RC = target</span></span><br><span class="line">  |  ldr CARG1, [BASE, RA, lsl #<span class="number">3</span>]</span><br><span class="line">  |    ldrh RBw, [PC, # OFS_RD]</span><br><span class="line">  |   ldr CARG2, [BASE, RC, lsl #<span class="number">3</span>]</span><br><span class="line">  |    add PC, PC, #<span class="number">4</span></span><br><span class="line">  |    add RB, PC, RB, lsl #<span class="number">2</span></span><br><span class="line">  |    sub RB, RB, #<span class="number">0x20000</span></span><br><span class="line">  |  checkint CARG1, &gt;<span class="number">3</span></span><br><span class="line">  |   checkint CARG2, &gt;<span class="number">4</span></span><br><span class="line">  |  cmp CARG1w, <span class="function">CARG2w</span></span><br><span class="line"><span class="function">  <span class="title">if</span> <span class="params">(op == BC_ISLT)</span> </span>&#123;</span><br><span class="line">    |  csel PC, RB, PC, lt</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == BC_ISGE) &#123;</span><br><span class="line">    |  csel PC, RB, PC, ge</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == BC_ISLE) &#123;</span><br><span class="line">    |  csel PC, RB, PC, le</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    |  csel PC, RB, PC, gt</span><br></pre></td></tr></table></figure>

<h4 id="替换后dasc代码"><a href="#替换后dasc代码" class="headerlink" title="替换后dasc代码"></a>替换后dasc代码</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> BC_ISLT: <span class="keyword">case</span> BC_ISGE: <span class="keyword">case</span> BC_ISLE: <span class="keyword">case</span> BC_ISGT:</span><br><span class="line">  |  <span class="comment">// x27 = src1, x28 = src2, JMP with x28 = target</span></span><br><span class="line">  |  ldr x0, [x19, x27, lsl #<span class="number">3</span>]</span><br><span class="line">  |    ldrh w17, [x21, #<span class="number">2</span>]</span><br><span class="line">  |   ldr x1, [x19, x28, lsl #<span class="number">3</span>]</span><br><span class="line">  |    add x21, x21, #<span class="number">4</span></span><br><span class="line">  |    add x17, x21, x17, lsl #<span class="number">2</span></span><br><span class="line">  |    sub x17, x17, #<span class="number">0x20000</span></span><br><span class="line">  |  checkint x0, &gt;<span class="number">3</span></span><br><span class="line">  |   checkint x1, &gt;<span class="number">4</span></span><br><span class="line">  |  cmp w0, <span class="function">w1</span></span><br><span class="line"><span class="function">  <span class="title">if</span> <span class="params">(op == BC_ISLT)</span> </span>&#123;</span><br><span class="line">    |  csel x21, x17, x21, lt</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == BC_ISGE) &#123;</span><br><span class="line">    |  csel x21, x17, x21, ge</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (op == BC_ISLE) &#123;</span><br><span class="line">    |  csel x21, x17, x21, le</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    |  csel x21, x17, x21, gt</span><br></pre></td></tr></table></figure>

<h4 id="IDA代码"><a href="#IDA代码" class="headerlink" title="IDA代码"></a>IDA代码</h4><p>几乎与替换后代码一样, 最后的代码是特征代码, 确定是BC_ISLT指令</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000</span>ACDAF0                               ; __unwind &#123; <span class="comment">// AAD020</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACDAF0 <span class="number">60</span> <span class="number">7</span>A <span class="number">7B</span> F8                   LDR             X0, [X19,X27,LSL#<span class="number">3</span>]</span><br><span class="line">.text:<span class="number">0000000000</span>ACDAF4 B1 <span class="number">06</span> <span class="number">40</span> <span class="number">79</span>                   LDRH            W17, [X21,#<span class="number">2</span>]</span><br><span class="line">.text:<span class="number">0000000000</span>ACDAF8 <span class="number">61</span> <span class="number">7</span>A <span class="number">7</span>C F8                   LDR             X1, [X19,X28,LSL#<span class="number">3</span>]</span><br><span class="line">.text:<span class="number">0000000000</span>ACDAFC B5 <span class="number">12</span> <span class="number">00</span> <span class="number">91</span>                   ADD             X21, X21, #<span class="number">4</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACDB00 B1 <span class="number">0</span>A <span class="number">11</span> <span class="number">8B</span>                   ADD             X17, X21, X17,LSL#<span class="number">2</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACDB04 <span class="number">31</span> <span class="number">82</span> <span class="number">40</span> D1                   SUB             X17, X17, #<span class="number">0x20</span>,LSL#<span class="number">12</span> ; <span class="string">&#x27; &#x27;</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACDB08 <span class="number">3F</span> <span class="number">83</span> <span class="number">40</span> EB                   CMP             X25, X0,LSR#<span class="number">32</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACDB0C <span class="number">61</span> <span class="number">01</span> <span class="number">00</span> <span class="number">54</span>                   B.NE            loc_ACDB38</span><br><span class="line">.text:<span class="number">0000000000</span>ACDB0C</span><br><span class="line">.text:<span class="number">0000000000</span>ACDB10 <span class="number">3F</span> <span class="number">83</span> <span class="number">41</span> EB                   CMP             X25, X1,LSR#<span class="number">32</span></span><br><span class="line">.text:<span class="number">0000000000</span>ACDB14 <span class="number">21</span> <span class="number">02</span> <span class="number">00</span> <span class="number">54</span>                   B.NE            loc_ACDB58</span><br><span class="line">.text:<span class="number">0000000000</span>ACDB14</span><br><span class="line">.text:<span class="number">0000000000</span>ACDB18 <span class="number">1F</span> <span class="number">00</span> <span class="number">01</span> <span class="number">6B</span>                   CMP             W0, W1</span><br><span class="line">.text:<span class="number">0000000000</span>ACDB1C <span class="number">35</span> B2 <span class="number">95</span> <span class="number">9</span>A                   CSEL            X21, X17, X21, LT       ; 特征代码</span><br></pre></td></tr></table></figure>

<h3 id="得到opcode顺序"><a href="#得到opcode顺序" class="headerlink" title="得到opcode顺序"></a>得到opcode顺序</h3><p>其中需要注意的点:</p>
<ul>
<li><p>代码中定义的符号使用文本替换, 前面讲过了</p>
</li>
<li><p>有些常量定义在其他文件中, 也是全局搜索然后替换就行了</p>
</li>
<li><p>.macro宏定义, 比如: 最常见的<strong>ins_next</strong>(几乎每个指令都有, 可以拿来确定end), mov_false, mov_true, 主要记住第一条特征指令, 能认出来即可.</p>
</li>
<li><p>还有~取反操作跟取负数的区别</p>
</li>
<li><p>有些指令会定义在宏定义中, 然后直接调用宏定义. (比如: BC_ADDVN, BC_ADDNV, BC_ADDVV)</p>
<ul>
<li>另外说一下, BC_ADDVN这类指令的识别, 主要通过其使用的宏定义<code>ins_arithdn adds, fadd</code>​传入的adds参数和fadd参数, 根据两个参数生成的vk来识别同类的具体指令.</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">[dispatch]:  <span class="number">0xacdaf0</span> = BC_ISLT</span><br><span class="line">[dispatch]:  <span class="number">0xacdb70</span> = BC_ISGE</span><br><span class="line">[dispatch]:  <span class="number">0xacdbf0</span> = BC_ISLE</span><br><span class="line">[dispatch]:  <span class="number">0xacdc70</span> = BC_ISGT</span><br><span class="line">[dispatch]:  <span class="number">0xacdcf0</span> = BC_ISEQV</span><br><span class="line">[dispatch]:  <span class="number">0xacdd74</span> = BC_ISNEV</span><br><span class="line">[dispatch]:  <span class="number">0xacddf4</span> = BC_ISEQS</span><br><span class="line">[dispatch]:  <span class="number">0xacde44</span> = BC_ISNES</span><br><span class="line">[dispatch]:  <span class="number">0xacde94</span> = BC_ISEQN</span><br><span class="line">[dispatch]:  <span class="number">0xacdf20</span> = BC_ISNEN</span><br><span class="line">[dispatch]:  <span class="number">0xacdfac</span> = BC_ISEQP</span><br><span class="line">[dispatch]:  <span class="number">0xacdff0</span> = BC_ISNEP</span><br><span class="line">[dispatch]:  <span class="number">0xace034</span> = BC_KSTR 确定该指令需要确定LJ_TSTR常量值, 该常量值在lj_obj.h中定义, 作用是区分指针的类型(比如: 字符串, 函数等)</span><br><span class="line">[dispatch]:  <span class="number">0xace060</span> = BC_KCDATA</span><br><span class="line">[dispatch]:  <span class="number">0xace08c</span> = BC_KSHORT</span><br><span class="line">[dispatch]:  <span class="number">0xace0b0</span> = BC_KNUM</span><br><span class="line">[dispatch]:  <span class="number">0xace0d0</span> = BC_KPRI</span><br><span class="line">[dispatch]:  <span class="number">0xace0f0</span> = BC_KNIL</span><br><span class="line">[dispatch]:  <span class="number">0xace120</span> = BC_ISTC</span><br><span class="line">[dispatch]:  <span class="number">0xace160</span> = BC_ISFC</span><br><span class="line">[dispatch]:  <span class="number">0xace1a0</span> = BC_IST</span><br><span class="line">[dispatch]:  <span class="number">0xace1d8</span> = BC_ISF</span><br><span class="line">[dispatch]:  <span class="number">0xace210</span> = BC_ISTYPE</span><br><span class="line">[dispatch]:  <span class="number">0xace234</span> = BC_ISNUM</span><br><span class="line">[dispatch]:  <span class="number">0xace258</span> = BC_MOV</span><br><span class="line">[dispatch]:  <span class="number">0xace278</span> = BC_NOT</span><br><span class="line">[dispatch]:  <span class="number">0xace2a8</span> = BC_UNM</span><br><span class="line">[dispatch]:  <span class="number">0xace2ec</span> = BC_LEN</span><br><span class="line">[dispatch]:  <span class="number">0xace334</span> = BC_RETM</span><br><span class="line">[dispatch]:  <span class="number">0xace348</span> = BC_RET</span><br><span class="line">[dispatch]:  <span class="number">0xace3f0</span> = BC_RET0</span><br><span class="line">[dispatch]:  <span class="number">0xace458</span> = BC_RET1</span><br><span class="line">[dispatch]:  <span class="number">0xace4c8</span> = BC_ADDVN</span><br><span class="line">[dispatch]:  <span class="number">0xace534</span> = BC_SUBVN</span><br><span class="line">[dispatch]:  <span class="number">0xace5a0</span> = BC_MULVN</span><br><span class="line">[dispatch]:  <span class="number">0xace614</span> = BC_DIVVN</span><br><span class="line">[dispatch]:  <span class="number">0xace65c</span> = BC_MODVN</span><br><span class="line">[dispatch]:  <span class="number">0xace6d0</span> = BC_ADDNV</span><br><span class="line">[dispatch]:  <span class="number">0xace73c</span> = BC_SUBNV</span><br><span class="line">[dispatch]:  <span class="number">0xace7a8</span> = BC_MULNV</span><br><span class="line">[dispatch]:  <span class="number">0xace81c</span> = BC_DIVNV</span><br><span class="line">[dispatch]:  <span class="number">0xace864</span> = BC_MODNV</span><br><span class="line">[dispatch]:  <span class="number">0xace8d8</span> = BC_ADDVV</span><br><span class="line">[dispatch]:  <span class="number">0xace944</span> = BC_SUBVV</span><br><span class="line">[dispatch]:  <span class="number">0xace9b0</span> = BC_MULVV</span><br><span class="line">[dispatch]:  <span class="number">0xacea24</span> = BC_DIVVV</span><br><span class="line">[dispatch]:  <span class="number">0xacea6c</span> = BC_MODVV</span><br><span class="line">[dispatch]:  <span class="number">0xaceae0</span> = BC_POW</span><br><span class="line">[dispatch]:  <span class="number">0xaceb28</span> = BC_CAT</span><br><span class="line">[dispatch]:  <span class="number">0xaceb74</span> = BC_UGET</span><br><span class="line">[dispatch]:  <span class="number">0xaceba8</span> = BC_USETV</span><br><span class="line">[dispatch]:  <span class="number">0xacec18</span> = BC_USETS</span><br><span class="line">[dispatch]:  <span class="number">0xacec80</span> = BC_USETN</span><br><span class="line">[dispatch]:  <span class="number">0xacecb4</span> = BC_USETP</span><br><span class="line">[dispatch]:  <span class="number">0xacece8</span> = BC_UCLO</span><br><span class="line">[dispatch]:  <span class="number">0xaced24</span> = BC_FNEW</span><br><span class="line">[dispatch]:  <span class="number">0xaced6c</span> = BC_TNEW</span><br><span class="line">[dispatch]:  <span class="number">0xacedcc</span> = BC_TDUP</span><br><span class="line">[dispatch]:  <span class="number">0xacee20</span> = BC_GGET</span><br><span class="line">[dispatch]:  <span class="number">0xacee38</span> = BC_GSET</span><br><span class="line">[dispatch]:  <span class="number">0xacee50</span> = BC_TGETV</span><br><span class="line">[dispatch]:  <span class="number">0xaceedc</span> = BC_TGETS</span><br><span class="line">[dispatch]:  <span class="number">0xacef70</span> = BC_TGETB</span><br><span class="line">[dispatch]:  <span class="number">0xacefdc</span> = BC_TGETR</span><br><span class="line">[dispatch]:  <span class="number">0xacf024</span> = BC_TSETV</span><br><span class="line">[dispatch]:  <span class="number">0xacf0d4</span> = BC_TSETS</span><br><span class="line">[dispatch]:  <span class="number">0xacf1d0</span> = BC_TSETB</span><br><span class="line">[dispatch]:  <span class="number">0xacf260</span> = BC_TSETM</span><br><span class="line">[dispatch]:  <span class="number">0xacf2f4</span> = BC_TSETR</span><br><span class="line">[dispatch]:  <span class="number">0xacf35c</span> = BC_CALLM</span><br><span class="line">[dispatch]:  <span class="number">0xacf36c</span> = BC_CALL</span><br><span class="line">[dispatch]:  <span class="number">0xacf3b4</span> = BC_CALLMT</span><br><span class="line">[dispatch]:  <span class="number">0xacf3c0</span> = BC_CALLT</span><br><span class="line">[dispatch]:  <span class="number">0xacf47c</span> = BC_ITERC</span><br><span class="line">[dispatch]:  <span class="number">0xacf4cc</span> = BC_ITERN</span><br><span class="line">[dispatch]:  <span class="number">0xacf570</span> = BC_VARG</span><br><span class="line">[dispatch]:  <span class="number">0xacf62c</span> = BC_ISNEXT</span><br><span class="line">[dispatch]:  <span class="number">0xacf6a4</span> = BC_FORI</span><br><span class="line">[dispatch]:  <span class="number">0xacf734</span> = BC_JFORI</span><br><span class="line">[dispatch]:  <span class="number">0xacf7ec</span> = BC_IFORL 相同</span><br><span class="line">[dispatch]:  <span class="number">0xacf7ec</span> = BC_IFORL 相同</span><br><span class="line">[dispatch]:  <span class="number">0xacf878</span> = BC_JFORL</span><br><span class="line">[dispatch]:  <span class="number">0xacf918</span> = BC_IITERL 相同</span><br><span class="line">[dispatch]:  <span class="number">0xacf918</span> = BC_IITERL 相同</span><br><span class="line">[dispatch]:  <span class="number">0xacf94c</span> = BC_JITERL</span><br><span class="line">[dispatch]:  <span class="number">0xacf998</span> = ins_NEXT 相同</span><br><span class="line">[dispatch]:  <span class="number">0xacf998</span> = ins_NEXT 相同</span><br><span class="line">[dispatch]:  <span class="number">0xacf9b0</span> = BC_JLOOP</span><br><span class="line">[dispatch]:  <span class="number">0xacf9d4</span> = BC_JMP</span><br><span class="line">[dispatch]:  <span class="number">0xacfa10</span> = BC_IFUNCF 相同</span><br><span class="line">[dispatch]:  <span class="number">0xacfa10</span> = BC_IFUNCF 相同</span><br><span class="line">[dispatch]:  <span class="number">0xacfa50</span> = BC_JFUNCF</span><br><span class="line">[dispatch]:  <span class="number">0xacfa80</span> = BC_IFUNCV 相同</span><br><span class="line">[dispatch]:  <span class="number">0xacfa80</span> = BC_IFUNCV 相同</span><br><span class="line">[dispatch]:  <span class="number">0xacfb04</span> = NYI</span><br><span class="line">[dispatch]:  <span class="number">0xacfb08</span> = BC_FUNCC</span><br><span class="line">[dispatch]:  <span class="number">0xacfb50</span> = BC_FUNCCW</span><br></pre></td></tr></table></figure>

<p>总体同类指令一般贴在一起, 顺序很少发生变化, 但是量是真大, 所以整体分析下来很耗时.</p>
<p>上述代码跟原文还有些出入, 原文中只有93和94指令出现相同, 但是这里有5组相同.</p>
<h1 id="反编译lua文件"><a href="#反编译lua文件" class="headerlink" title="反编译lua文件"></a>反编译lua文件</h1><p>使用luajit-decompiler, 是跟着原文的步骤做的.</p>
<h2 id="第一处修改"><a href="#第一处修改" class="headerlink" title="第一处修改"></a>第一处修改</h2><p>全局搜索**_OPCODES元组**, 替换为下面的内容</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0x0</span>, instructions.ISLT),</span><br><span class="line">(<span class="number">0x1</span>, instructions.ISGE),</span><br><span class="line">(<span class="number">0x2</span>, instructions.ISLE),</span><br><span class="line">(<span class="number">0x3</span>, instructions.ISGT),</span><br><span class="line">(<span class="number">0x4</span>, instructions.ISEQV),</span><br><span class="line">(<span class="number">0x5</span>, instructions.ISNEV),</span><br><span class="line">(<span class="number">0x6</span>, instructions.ISEQS),</span><br><span class="line">(<span class="number">0x7</span>, instructions.ISNES),</span><br><span class="line">(<span class="number">0x8</span>, instructions.ISEQN),</span><br><span class="line">(<span class="number">0x9</span>, instructions.ISNEN),</span><br><span class="line">(<span class="number">0xa</span>, instructions.ISEQP),</span><br><span class="line">(<span class="number">0xb</span>, instructions.ISNEP),</span><br><span class="line">(<span class="number">0xc</span>, instructions.KSTR),</span><br><span class="line">(<span class="number">0xd</span>, instructions.KCDATA),</span><br><span class="line">(<span class="number">0xe</span>, instructions.KSHORT),</span><br><span class="line">(<span class="number">0xf</span>, instructions.KNUM),</span><br><span class="line">(<span class="number">0x10</span>, instructions.KPRI),</span><br><span class="line">(<span class="number">0x11</span>, instructions.KNIL),</span><br><span class="line">(<span class="number">0x12</span>, instructions.ISTC),</span><br><span class="line">(<span class="number">0x13</span>, instructions.ISFC),</span><br><span class="line">(<span class="number">0x14</span>, instructions.IST),</span><br><span class="line">(<span class="number">0x15</span>, instructions.ISF),</span><br><span class="line">(<span class="number">0x16</span>, instructions.ISTYPE),</span><br><span class="line">(<span class="number">0x17</span>, instructions.ISNUM),</span><br><span class="line">(<span class="number">0x18</span>, instructions.MOV),</span><br><span class="line">(<span class="number">0x19</span>, instructions.NOT),</span><br><span class="line">(<span class="number">0x1a</span>, instructions.UNM),</span><br><span class="line">(<span class="number">0x1b</span>, instructions.LEN),</span><br><span class="line">(<span class="number">0x1c</span>, instructions.RETM),</span><br><span class="line">(<span class="number">0x1d</span>, instructions.RET),</span><br><span class="line">(<span class="number">0x1e</span>, instructions.RET0),</span><br><span class="line">(<span class="number">0x1f</span>, instructions.RET1),</span><br><span class="line">(<span class="number">0x20</span>, instructions.ADDVN),</span><br><span class="line">(<span class="number">0x21</span>, instructions.SUBVN),</span><br><span class="line">(<span class="number">0x22</span>, instructions.MULVN),</span><br><span class="line">(<span class="number">0x23</span>, instructions.DIVVN),</span><br><span class="line">(<span class="number">0x24</span>, instructions.MODVN),</span><br><span class="line">(<span class="number">0x25</span>, instructions.ADDNV),</span><br><span class="line">(<span class="number">0x26</span>, instructions.SUBNV),</span><br><span class="line">(<span class="number">0x27</span>, instructions.MULNV),</span><br><span class="line">(<span class="number">0x28</span>, instructions.DIVNV),</span><br><span class="line">(<span class="number">0x29</span>, instructions.MODNV),</span><br><span class="line">(<span class="number">0x2a</span>, instructions.ADDVV),</span><br><span class="line">(<span class="number">0x2b</span>, instructions.SUBVV),</span><br><span class="line">(<span class="number">0x2c</span>, instructions.MULVV),</span><br><span class="line">(<span class="number">0x2d</span>, instructions.DIVVV),</span><br><span class="line">(<span class="number">0x2e</span>, instructions.MODVV),</span><br><span class="line">(<span class="number">0x2f</span>, instructions.POW),</span><br><span class="line">(<span class="number">0x30</span>, instructions.CAT),</span><br><span class="line">(<span class="number">0x31</span>, instructions.UGET),</span><br><span class="line">(<span class="number">0x32</span>, instructions.USETV),</span><br><span class="line">(<span class="number">0x33</span>, instructions.USETS),</span><br><span class="line">(<span class="number">0x34</span>, instructions.USETN),</span><br><span class="line">(<span class="number">0x35</span>, instructions.USETP),</span><br><span class="line">(<span class="number">0x36</span>, instructions.UCLO),</span><br><span class="line">(<span class="number">0x37</span>, instructions.FNEW),</span><br><span class="line">(<span class="number">0x38</span>, instructions.TNEW),</span><br><span class="line">(<span class="number">0x39</span>, instructions.TDUP),</span><br><span class="line">(<span class="number">0x3a</span>, instructions.GGET),</span><br><span class="line">(<span class="number">0x3b</span>, instructions.GSET),</span><br><span class="line">(<span class="number">0x3c</span>, instructions.TGETV),</span><br><span class="line">(<span class="number">0x3d</span>, instructions.TGETS),</span><br><span class="line">(<span class="number">0x3e</span>, instructions.TGETB),</span><br><span class="line">(<span class="number">0x3f</span>, instructions.TGETR),</span><br><span class="line">(<span class="number">0x40</span>, instructions.TSETV),</span><br><span class="line">(<span class="number">0x41</span>, instructions.TSETS),</span><br><span class="line">(<span class="number">0x42</span>, instructions.TSETB),</span><br><span class="line">(<span class="number">0x43</span>, instructions.TSETM),</span><br><span class="line">(<span class="number">0x44</span>, instructions.TSETR),</span><br><span class="line">(<span class="number">0x45</span>, instructions.CALLM),</span><br><span class="line">(<span class="number">0x46</span>, instructions.CALL),</span><br><span class="line">(<span class="number">0x47</span>, instructions.CALLMT),</span><br><span class="line">(<span class="number">0x48</span>, instructions.CALLT),</span><br><span class="line">(<span class="number">0x49</span>, instructions.ITERC),</span><br><span class="line">(<span class="number">0x4a</span>, instructions.ITERN),</span><br><span class="line">(<span class="number">0x4b</span>, instructions.VARG),</span><br><span class="line">(<span class="number">0x4c</span>, instructions.ISNEXT),</span><br><span class="line">(<span class="number">0x4d</span>, instructions.FORI),</span><br><span class="line">(<span class="number">0x4e</span>, instructions.JFORI),</span><br><span class="line">(<span class="number">0x4f</span>, instructions.FORL),</span><br><span class="line">(<span class="number">0x50</span>, instructions.IFORL),</span><br><span class="line">(<span class="number">0x51</span>, instructions.JFORL),</span><br><span class="line">(<span class="number">0x52</span>, instructions.ITERL),</span><br><span class="line">(<span class="number">0x53</span>, instructions.IITERL),</span><br><span class="line">(<span class="number">0x54</span>, instructions.JITERL),</span><br><span class="line">(<span class="number">0x55</span>, instructions.LOOP),</span><br><span class="line">(<span class="number">0x56</span>, instructions.ILOOP),</span><br><span class="line">(<span class="number">0x57</span>, instructions.JLOOP),</span><br><span class="line">(<span class="number">0x58</span>, instructions.JMP),</span><br><span class="line">(<span class="number">0x59</span>, instructions.FUNCF),</span><br><span class="line">(<span class="number">0x5a</span>, instructions.IFUNCF),</span><br><span class="line">(<span class="number">0x5b</span>, instructions.JFUNCF),</span><br><span class="line">(<span class="number">0x5c</span>, instructions.FUNCV),</span><br><span class="line">(<span class="number">0x5d</span>, instructions.IFUNCV),</span><br><span class="line">(<span class="number">0x5e</span>, instructions.JFUNCV),</span><br><span class="line">(<span class="number">0x5f</span>, instructions.FUNCC),</span><br><span class="line">(<span class="number">0x60</span>, instructions.FUNCCW)</span><br></pre></td></tr></table></figure>

<h2 id="第二处修改"><a href="#第二处修改" class="headerlink" title="第二处修改"></a>第二处修改</h2><p>修改ljd/bytecode/instructions.py文件, 从97行开始替换</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line">ISLT = _IDef(<span class="string">&quot;ISLT&quot;</span>, 		T_VAR, 	None, 	T_VAR, 	<span class="string">&quot;if &#123;A&#125; &lt; &#123;D&#125;&quot;</span>)</span><br><span class="line">ISGE = _IDef(<span class="string">&quot;ISGE&quot;</span>, 		T_VAR, 	None, 	T_VAR, 	<span class="string">&quot;if &#123;A&#125; &gt;= &#123;D&#125;&quot;</span>)</span><br><span class="line">ISLE = _IDef(<span class="string">&quot;ISLE&quot;</span>, 		T_VAR, 	None, 	T_VAR, 	<span class="string">&quot;if &#123;A&#125; &lt;= &#123;D&#125;&quot;</span>)</span><br><span class="line">ISGT = _IDef(<span class="string">&quot;ISGT&quot;</span>, 		T_VAR, 	None, 	T_VAR, 	<span class="string">&quot;if &#123;A&#125; &gt; &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ISEQV = _IDef(<span class="string">&quot;ISEQV&quot;</span>, 		T_VAR, 	None, 	T_VAR, 	<span class="string">&quot;if &#123;A&#125; == &#123;D&#125;&quot;</span>)</span><br><span class="line">ISNEV = _IDef(<span class="string">&quot;ISNEV&quot;</span>, 		T_VAR, 	None, 	T_VAR, 	<span class="string">&quot;if &#123;A&#125; ~= &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ISEQS = _IDef(<span class="string">&quot;ISEQS&quot;</span>, 		T_VAR, 	None, 	T_STR, 	<span class="string">&quot;if &#123;A&#125; == &#123;D&#125;&quot;</span>)</span><br><span class="line">ISNES = _IDef(<span class="string">&quot;ISNES&quot;</span>, 		T_VAR, 	None, 	T_STR, 	<span class="string">&quot;if &#123;A&#125; ~= &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ISEQN = _IDef(<span class="string">&quot;ISEQN&quot;</span>, 		T_VAR, 	None, 	T_NUM, 	<span class="string">&quot;if &#123;A&#125; == &#123;D&#125;&quot;</span>)</span><br><span class="line">ISNEN = _IDef(<span class="string">&quot;ISNEN&quot;</span>, 		T_VAR, 	None, 	T_NUM, 	<span class="string">&quot;if &#123;A&#125; ~= &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ISEQP = _IDef(<span class="string">&quot;ISEQP&quot;</span>, 		T_VAR, 	None, 	T_PRI, 	<span class="string">&quot;if &#123;A&#125; == &#123;D&#125;&quot;</span>)</span><br><span class="line">ISNEP = _IDef(<span class="string">&quot;ISNEP&quot;</span>, 		T_VAR, 	None, 	T_PRI, 	<span class="string">&quot;if &#123;A&#125; ~= &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"># Constant ops.</span><br><span class="line"></span><br><span class="line">KSTR = _IDef(<span class="string">&quot;KSTR&quot;</span>, 		T_DST, 	None, 	T_STR, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">KCDATA = _IDef(<span class="string">&quot;KCDATA&quot;</span>, 	T_DST, 	None, 	T_CDT, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">KSHORT = _IDef(<span class="string">&quot;KSHORT&quot;</span>, 	T_DST, 	None, 	T_SLIT, <span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">KNUM = _IDef(<span class="string">&quot;KNUM&quot;</span>, 		T_DST, 	None, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">KPRI = _IDef(<span class="string">&quot;KPRI&quot;</span>, 		T_DST, 	None, 	T_PRI, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">KNIL = _IDef(<span class="string">&quot;KNIL&quot;</span>, 		T_BS, 	None, 	T_BS, 	<span class="string">&quot;&#123;from_A_to_D&#125; = nil&quot;</span>)</span><br><span class="line"></span><br><span class="line"># Unary test <span class="keyword">and</span> copy ops</span><br><span class="line"></span><br><span class="line">ISTC = _IDef(<span class="string">&quot;ISTC&quot;</span>, 		T_DST, 	None, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;; if &#123;D&#125;&quot;</span>)</span><br><span class="line">ISFC = _IDef(<span class="string">&quot;ISFC&quot;</span>, 		T_DST, 	None, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;; if not &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">IST = _IDef(<span class="string">&quot;IST&quot;</span>, 		None, 	None, 	T_VAR, 	<span class="string">&quot;if &#123;D&#125;&quot;</span>)</span><br><span class="line">ISF = _IDef(<span class="string">&quot;ISF&quot;</span>, 		None, 	None, 	T_VAR, 	<span class="string">&quot;if not &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ISTYPE = _IDef(<span class="string">&quot;ISTYPE&quot;</span>, 	T_VAR, 	None, 	T_LIT, 	<span class="string">&quot;ISTYPE unknow&quot;</span>)</span><br><span class="line">ISNUM = _IDef(<span class="string">&quot;ISNUM&quot;</span>, 		T_VAR, 	None, 	T_LIT, 	<span class="string">&quot;ISNUM unknow&quot;</span>)</span><br><span class="line"># Unary ops</span><br><span class="line"></span><br><span class="line">MOV = _IDef(<span class="string">&quot;MOV&quot;</span>, 		T_DST, 	None, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">NOT = _IDef(<span class="string">&quot;NOT&quot;</span>, 		T_DST, 	None, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = not &#123;D&#125;&quot;</span>)</span><br><span class="line">UNM = _IDef(<span class="string">&quot;UNM&quot;</span>, 		T_DST, 	None, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = -&#123;D&#125;&quot;</span>)</span><br><span class="line">LEN = _IDef(<span class="string">&quot;LEN&quot;</span>, 		T_DST, 	None, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = #&#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"># Returns.</span><br><span class="line"></span><br><span class="line">RETM = _IDef(<span class="string">&quot;RETM&quot;</span>, 		T_BS, 	None, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;return &#123;from_A_x_D_minus_one&#125;, ...MULTRES&quot;</span>)</span><br><span class="line"></span><br><span class="line">RET = _IDef(<span class="string">&quot;RET&quot;</span>, 	 	T_RBS, 	None, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;return &#123;from_A_x_D_minus_two&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">RET0 = _IDef(<span class="string">&quot;RET0&quot;</span>, 		T_RBS, 	None, 	T_LIT, 	<span class="string">&quot;return&quot;</span>)</span><br><span class="line">RET1 = _IDef(<span class="string">&quot;RET1&quot;</span>, 		T_RBS, 	None, 	T_LIT, 	<span class="string">&quot;return &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"># Binary ops</span><br><span class="line"></span><br><span class="line">ADDVN = _IDef(<span class="string">&quot;ADDVN&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; + &#123;C&#125;&quot;</span>)</span><br><span class="line">SUBVN = _IDef(<span class="string">&quot;SUBVN&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; - &#123;C&#125;&quot;</span>)</span><br><span class="line">MULVN = _IDef(<span class="string">&quot;MULVN&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; * &#123;C&#125;&quot;</span>)</span><br><span class="line">DIVVN = _IDef(<span class="string">&quot;DIVVN&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; / &#123;C&#125;&quot;</span>)</span><br><span class="line">MODVN = _IDef(<span class="string">&quot;MODVN&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; % &#123;C&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ADDNV = _IDef(<span class="string">&quot;ADDNV&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;C&#125; + &#123;B&#125;&quot;</span>)</span><br><span class="line">SUBNV = _IDef(<span class="string">&quot;SUBNV&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;C&#125; - &#123;B&#125;&quot;</span>)</span><br><span class="line">MULNV = _IDef(<span class="string">&quot;MULNV&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;C&#125; * &#123;B&#125;&quot;</span>)</span><br><span class="line">DIVNV = _IDef(<span class="string">&quot;DIVNV&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;C&#125; / &#123;B&#125;&quot;</span>)</span><br><span class="line">MODNV = _IDef(<span class="string">&quot;MODNV&quot;</span>, 		T_DST, 	T_VAR, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;C&#125; % &#123;B&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ADDVV = _IDef(<span class="string">&quot;ADDVV&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; + &#123;C&#125;&quot;</span>)</span><br><span class="line">SUBVV = _IDef(<span class="string">&quot;SUBVV&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; - &#123;C&#125;&quot;</span>)</span><br><span class="line">MULVV = _IDef(<span class="string">&quot;MULVV&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; * &#123;C&#125;&quot;</span>)</span><br><span class="line">DIVVV = _IDef(<span class="string">&quot;DIVVV&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; / &#123;C&#125;&quot;</span>)</span><br><span class="line">MODVV = _IDef(<span class="string">&quot;MODVV&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; % &#123;C&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">POW = _IDef(<span class="string">&quot;POW&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125; ^ &#123;C&#125; (pow)&quot;</span>)</span><br><span class="line">CAT = _IDef(<span class="string">&quot;CAT&quot;</span>, 		T_DST, 	T_RBS, 	T_RBS,</span><br><span class="line">		<span class="string">&quot;&#123;A&#125; = &#123;concat_from_B_to_C&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"># Upvalue <span class="keyword">and</span> function ops.</span><br><span class="line"></span><br><span class="line">UGET = _IDef(<span class="string">&quot;UGET&quot;</span>, 		T_DST, 	None, 	T_UV, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">USETV = _IDef(<span class="string">&quot;USETV&quot;</span>, 		T_UV, 	None, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">USETS = _IDef(<span class="string">&quot;USETS&quot;</span>, 		T_UV, 	None, 	T_STR, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">USETN = _IDef(<span class="string">&quot;USETN&quot;</span>, 		T_UV, 	None, 	T_NUM, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line">USETP = _IDef(<span class="string">&quot;USETP&quot;</span>, 		T_UV, 	None, 	T_PRI, 	<span class="string">&quot;&#123;A&#125; = &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">UCLO = _IDef(<span class="string">&quot;UCLO&quot;</span>, 		T_RBS, 	None, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;nil uvs &gt;= &#123;A&#125;; goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">FNEW = _IDef(<span class="string">&quot;FNEW&quot;</span>, 		T_DST, 	None, 	T_FUN, 	<span class="string">&quot;&#123;A&#125; = function &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"># Table ops.</span><br><span class="line"></span><br><span class="line">TNEW = _IDef(<span class="string">&quot;TNEW&quot;</span>, 		T_DST, 	None, 	T_LIT, 	<span class="string">&quot;&#123;A&#125; = new table(&quot;</span></span><br><span class="line">							<span class="string">&quot; array: &#123;D_array&#125;,&quot;</span></span><br><span class="line">							<span class="string">&quot; dict: &#123;D_dict&#125;)&quot;</span>)</span><br><span class="line"></span><br><span class="line">TDUP = _IDef(<span class="string">&quot;TDUP&quot;</span>, 		T_DST, 	None, 	T_TAB, 	<span class="string">&quot;&#123;A&#125; = copy &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">GGET = _IDef(<span class="string">&quot;GGET&quot;</span>, 		T_DST, 	None, 	T_STR, 	<span class="string">&quot;&#123;A&#125; = _env[&#123;D&#125;]&quot;</span>)</span><br><span class="line">GSET = _IDef(<span class="string">&quot;GSET&quot;</span>, 		T_VAR, 	None, 	T_STR, 	<span class="string">&quot;_env[&#123;D&#125;] = &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">TGETV = _IDef(<span class="string">&quot;TGETV&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125;[&#123;C&#125;]&quot;</span>)</span><br><span class="line">TGETS = _IDef(<span class="string">&quot;TGETS&quot;</span>, 		T_DST, 	T_VAR, 	T_STR, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125;.&#123;C&#125;&quot;</span>)</span><br><span class="line">TGETB = _IDef(<span class="string">&quot;TGETB&quot;</span>, 		T_DST, 	T_VAR, 	T_LIT, 	<span class="string">&quot;&#123;A&#125; = &#123;B&#125;[&#123;C&#125;]&quot;</span>)</span><br><span class="line">TGETR = _IDef(<span class="string">&quot;TGETR&quot;</span>, 		T_DST, 	T_VAR, 	T_VAR, 	<span class="string">&quot;unkown TGETR&quot;</span>)</span><br><span class="line"></span><br><span class="line">TSETV = _IDef(<span class="string">&quot;TSETV&quot;</span>, 		T_VAR, 	T_VAR, 	T_VAR, 	<span class="string">&quot;&#123;B&#125;[&#123;C&#125;] = &#123;A&#125;&quot;</span>)</span><br><span class="line">TSETS = _IDef(<span class="string">&quot;TSETS&quot;</span>, 		T_VAR, 	T_VAR, 	T_STR, 	<span class="string">&quot;&#123;B&#125;.&#123;C&#125; = &#123;A&#125;&quot;</span>)</span><br><span class="line">TSETB = _IDef(<span class="string">&quot;TSETB&quot;</span>, 		T_VAR, 	T_VAR, 	T_LIT, 	<span class="string">&quot;&#123;B&#125;[&#123;C&#125;] = &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">TSETM = _IDef(<span class="string">&quot;TSETM&quot;</span>, 	 	T_BS, 	None, 	T_NUM,</span><br><span class="line">		<span class="string">&quot;for i = 0, MULTRES, 1 do&quot;</span></span><br><span class="line">		<span class="string">&quot; &#123;A_minus_one&#125;[&#123;D_low&#125; + i] = slot(&#123;A&#125; + i)&quot;</span>)</span><br><span class="line"></span><br><span class="line">TSETR = _IDef(<span class="string">&quot;TSETR&quot;</span>, 		T_VAR, 	T_VAR, 	T_VAR, 	<span class="string">&quot;unkow TSETR&quot;</span>)</span><br><span class="line"># Calls <span class="keyword">and</span> vararg handling. T = tail call.</span><br><span class="line"></span><br><span class="line">CALLM = _IDef(<span class="string">&quot;CALLM&quot;</span>, 		T_BS, 	T_LIT, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;&#123;from_A_x_B_minus_two&#125; = &#123;A&#125;(&#123;from_A_plus_one_x_C&#125;, ...MULTRES)&quot;</span>)</span><br><span class="line"></span><br><span class="line">CALL = _IDef(<span class="string">&quot;CALL&quot;</span>, 		T_BS, 	T_LIT, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;&#123;from_A_x_B_minus_two&#125; = &#123;A&#125;(&#123;from_A_plus_one_x_C_minus_one&#125;)&quot;</span>)</span><br><span class="line"></span><br><span class="line">CALLMT = _IDef(<span class="string">&quot;CALLMT&quot;</span>, 	T_BS, 	None, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;return &#123;A&#125;(&#123;from_A_plus_one_x_D&#125;, ...MULTRES)&quot;</span>)</span><br><span class="line"></span><br><span class="line">CALLT = _IDef(<span class="string">&quot;CALLT&quot;</span>, 		T_BS, 	None, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;return &#123;A&#125;(&#123;from_A_plus_one_x_D_minus_one&#125;)&quot;</span>)</span><br><span class="line"></span><br><span class="line">ITERC = _IDef(<span class="string">&quot;ITERC&quot;</span>, 		T_BS, 	T_LIT, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;&#123;A&#125;, &#123;A_plus_one&#125;, &#123;A_plus_two&#125; =&quot;</span></span><br><span class="line">			<span class="string">&quot; &#123;A_minus_three&#125;, &#123;A_minus_two&#125;, &#123;A_minus_one&#125;;&quot;</span></span><br><span class="line">		<span class="string">&quot; &#123;from_A_x_B_minus_two&#125; =&quot;</span></span><br><span class="line">			<span class="string">&quot; &#123;A_minus_three&#125;(&#123;A_minus_two&#125;, &#123;A_minus_one&#125;)&quot;</span>)</span><br><span class="line"></span><br><span class="line">ITERN = _IDef(<span class="string">&quot;ITERN&quot;</span>, 		T_BS, 	T_LIT, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;&#123;A&#125;, &#123;A_plus_one&#125;, &#123;A_plus_two&#125; =&quot;</span></span><br><span class="line">			<span class="string">&quot; &#123;A_minus_three&#125;, &#123;A_minus_two&#125;, &#123;A_minus_one&#125;;&quot;</span></span><br><span class="line">		<span class="string">&quot; &#123;from_A_x_B_minus_two&#125; =&quot;</span></span><br><span class="line">			<span class="string">&quot; &#123;A_minus_three&#125;(&#123;A_minus_two&#125;, &#123;A_minus_one&#125;)&quot;</span>)</span><br><span class="line"></span><br><span class="line">VARG = _IDef(<span class="string">&quot;VARG&quot;</span>, 		T_BS, 	T_LIT, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;&#123;from_A_x_B_minus_two&#125; = ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">ISNEXT = _IDef(<span class="string">&quot;ISNEXT&quot;</span>, 	 T_BS, 	None, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;Verify ITERN at &#123;D&#125;; goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"># Loops <span class="keyword">and</span> branches. I/J = interp/JIT, I/C/L = init/call/loop.</span><br><span class="line"></span><br><span class="line">FORI = _IDef(<span class="string">&quot;FORI&quot;</span>, 		T_BS, 	None, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;for &#123;A_plus_three&#125; = &#123;A&#125;,&#123;A_plus_one&#125;,&#123;A_plus_two&#125;&quot;</span></span><br><span class="line">		<span class="string">&quot; else goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">JFORI = _IDef(<span class="string">&quot;JFORI&quot;</span>, 		T_BS, 	None, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;for &#123;A_plus_three&#125; = &#123;A&#125;,&#123;A_plus_one&#125;,&#123;A_plus_two&#125;&quot;</span></span><br><span class="line">		<span class="string">&quot; else goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">FORL = _IDef(<span class="string">&quot;FORL&quot;</span>, 		T_BS, 	None, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;&#123;A&#125; = &#123;A&#125; + &#123;A_plus_two&#125;;&quot;</span></span><br><span class="line">		<span class="string">&quot; if cmp(&#123;A&#125;, sign &#123;A_plus_two&#125;,  &#123;A_plus_one&#125;) goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">IFORL = _IDef(<span class="string">&quot;IFORL&quot;</span>, 	 	T_BS, 	None, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;&#123;A&#125; = &#123;A&#125; + &#123;A_plus_two&#125;;&quot;</span></span><br><span class="line">		<span class="string">&quot; if cmp(&#123;A&#125;, sign &#123;A_plus_two&#125;, &#123;A_plus_one&#125;) goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">JFORL = _IDef(<span class="string">&quot;JFORL&quot;</span>, 		T_BS, 	None, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;&#123;A&#125; = &#123;A&#125; + &#123;A_plus_two&#125;;&quot;</span></span><br><span class="line">		<span class="string">&quot; if cmp(&#123;A&#125;, sign &#123;A_plus_two&#125;, &#123;A_plus_one&#125;) goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">ITERL = _IDef(<span class="string">&quot;ITERL&quot;</span>, 		T_BS, 	None, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;&#123;A_minus_one&#125; = &#123;A&#125;; if &#123;A&#125; != nil goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">IITERL = _IDef(<span class="string">&quot;IITERL&quot;</span>, 	T_BS, 	None, 	T_JMP,</span><br><span class="line">		<span class="string">&quot;&#123;A_minus_one&#125; = &#123;A&#125;; if &#123;A&#125; != nil goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">JITERL = _IDef(<span class="string">&quot;JITERL&quot;</span>, 	T_BS, 	None, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;&#123;A_minus_one&#125; = &#123;A&#125;; if &#123;A&#125; != nil goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">LOOP = _IDef(<span class="string">&quot;LOOP&quot;</span>, 		T_RBS, 	None, 	T_JMP, 	<span class="string">&quot;Noop&quot;</span>)</span><br><span class="line">ILOOP = _IDef(<span class="string">&quot;ILOOP&quot;</span>, 		T_RBS, 	None, 	T_JMP, 	<span class="string">&quot;Noop&quot;</span>)</span><br><span class="line">JLOOP = _IDef(<span class="string">&quot;JLOOP&quot;</span>, 		T_RBS, 	None, 	T_LIT, 	<span class="string">&quot;Noop&quot;</span>)</span><br><span class="line"></span><br><span class="line">JMP = _IDef(<span class="string">&quot;JMP&quot;</span>, 		T_RBS, 	None, 	T_JMP, 	<span class="string">&quot;	goto &#123;D&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"># Function headers. I/J = interp/JIT, F/V/C = fixarg/vararg/C func.</span><br><span class="line"># Shouldn<span class="number">&#x27;</span>t be ever seen - they are <span class="keyword">not</span> stored in raw dump?</span><br><span class="line"></span><br><span class="line">FUNCF = _IDef(<span class="string">&quot;FUNCF&quot;</span>, 		T_RBS, 	None, 	None,</span><br><span class="line">		<span class="string">&quot;Fixed-arg function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">IFUNCF = _IDef(<span class="string">&quot;IFUNCF&quot;</span>, 	T_RBS, 	None, 	None,</span><br><span class="line">		<span class="string">&quot;Interpreted fixed-arg function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">JFUNCF = _IDef(<span class="string">&quot;JFUNCF&quot;</span>, 	T_RBS, 	None, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;JIT compiled fixed-arg function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">FUNCV = _IDef(<span class="string">&quot;FUNCV&quot;</span>, 		T_RBS, 	None, 	None,</span><br><span class="line">		<span class="string">&quot;Var-arg function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">IFUNCV = _IDef(<span class="string">&quot;IFUNCV&quot;</span>, 	T_RBS, 	None, 	None,</span><br><span class="line">		<span class="string">&quot;Interpreted var-arg function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">JFUNCV = _IDef(<span class="string">&quot;JFUNCV&quot;</span>, 	T_RBS, 	None, 	T_LIT,</span><br><span class="line">		<span class="string">&quot;JIT compiled var-arg function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">FUNCC = _IDef(<span class="string">&quot;FUNCC&quot;</span>, 		T_RBS, 	None, 	None,</span><br><span class="line">		<span class="string">&quot;C function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line">FUNCCW = _IDef(<span class="string">&quot;FUNCCW&quot;</span>, 	T_RBS, 	None, 	None,</span><br><span class="line">		<span class="string">&quot;Wrapped C function with frame size &#123;A&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">UNKNW = _IDef(<span class="string">&quot;UNKNW&quot;</span>, 		T_LIT, 	T_LIT, 	T_LIT, <span class="string">&quot;Unknown instruction&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="第三处修改"><a href="#第三处修改" class="headerlink" title="第三处修改"></a>第三处修改</h2><p>修改ljd/ast/builder.py</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">diff -urNa ljd-old/ast/builder.py ljd-<span class="keyword">new</span>/ast/builder.py</span><br><span class="line">--- ljd-old/ast/builder.py	<span class="number">2020</span><span class="number">-05</span><span class="number">-09</span> <span class="number">03</span>:<span class="number">43</span>:<span class="number">27.000000000</span> <span class="number">-0700</span></span><br><span class="line">+++ ljd-<span class="keyword">new</span>/ast/builder.py	<span class="number">2022</span><span class="number">-09</span><span class="number">-20</span> <span class="number">02</span>:<span class="number">04</span>:<span class="number">53.955771000</span> <span class="number">-0700</span></span><br><span class="line">@@ <span class="number">-276</span>,<span class="number">7</span> +<span class="number">276</span>,<span class="number">7</span> @@</span><br><span class="line">     last = instructions[<span class="number">-1</span>]</span><br><span class="line">     opcode = <span class="number">256</span> <span class="keyword">if</span> <span class="built_in">len</span>(instructions) == <span class="number">1</span> <span class="keyword">else</span> instructions[<span class="number">-2</span>].opcode</span><br><span class="line"> </span><br><span class="line">-    <span class="keyword">if</span> opcode &lt;= ins.ISF.opcode:</span><br><span class="line">+    <span class="keyword">if</span> opcode <span class="built_in">in</span> (ins.ISLT.opcode, ins.ISGE.opcode, ins.ISLE.opcode, ins.ISGT.opcode, ins.ISEQV.opcode, ins.ISNEV.opcode, ins.ISEQS.opcode, ins.ISNES.opcode, ins.ISEQN.opcode, ins.ISNEN.opcode, ins.ISEQP.opcode, ins.ISNEP.opcode, ins.ISTC.opcode, ins.ISFC.opcode, ins.IST.opcode, ins.ISF.opcode):</span><br><span class="line">         assert last.opcode != ins.ISNEXT.opcode</span><br><span class="line">         <span class="keyword">return</span> _build_conditional_warp(state, last_addr, instructions)</span><br><span class="line">     <span class="keyword">else</span>:</span><br><span class="line">@@ <span class="number">-507</span>,<span class="number">7</span> +<span class="number">507</span>,<span class="number">7</span> @@</span><br><span class="line">         expression = _build_unary_expression(state, addr, instruction)</span><br><span class="line"> </span><br><span class="line">     # Binary assignment <span class="built_in">operators</span> (A = B op C)</span><br><span class="line">-    elif opcode &lt;= ins.POW.opcode:</span><br><span class="line">+    elif ins.ADDVN.opcode &lt;= opcode &lt;= ins.POW.opcode:</span><br><span class="line">         expression = _build_binary_expression(state, addr, instruction)</span><br><span class="line"> </span><br><span class="line">     # Concat assignment <span class="built_in">type</span> (A = B .. B + <span class="number">1</span> .. ... .. C - <span class="number">1</span> .. C)</span><br><span class="line">@@ <span class="number">-515</span>,<span class="number">7</span> +<span class="number">515</span>,<span class="number">7</span> @@</span><br><span class="line">         expression = _build_concat_expression(state, addr, instruction)</span><br><span class="line"> </span><br><span class="line">     # Constant assignment operators except KNIL, which is weird anyway</span><br><span class="line">-    elif opcode &lt;= ins.KPRI.opcode:</span><br><span class="line">+    elif ins.KSTR.opcode &lt;= opcode &lt;= ins.KPRI.opcode:</span><br><span class="line">         expression = _build_const_expression(state, addr, instruction)</span><br><span class="line"> </span><br><span class="line">     elif opcode == ins.UGET.opcode:</span><br><span class="line">@@ <span class="number">-524</span>,<span class="number">7</span> +<span class="number">524</span>,<span class="number">7</span> @@</span><br><span class="line">     elif opcode == ins.USETV.opcode:</span><br><span class="line">         expression = _build_slot(state, addr, instruction.CD)</span><br><span class="line"> </span><br><span class="line">-    elif opcode &lt;= ins.USETP.opcode:</span><br><span class="line">+    elif ins.USETS.opcode &lt;= opcode &lt;= ins.USETP.opcode:</span><br><span class="line">         expression = _build_const_expression(state, addr, instruction)</span><br><span class="line"> </span><br><span class="line">     elif opcode == ins.FNEW.opcode:</span><br></pre></td></tr></table></figure>

<p>然后按照readme文件中的参数进行反编译即可</p>
<h1 id="分析lua代码"><a href="#分析lua代码" class="headerlink" title="分析lua代码"></a>分析lua代码</h1><h2 id="GameScene-lua"><a href="#GameScene-lua" class="headerlink" title="GameScene.lua"></a>GameScene.lua</h2><h3 id="collisionH"><a href="#collisionH" class="headerlink" title="collisionH()"></a>collisionH()</h3><p>首先分析该文件的原因是当我们最后顶到问号方格的时候才加载的, 说明是最终的验证函数.</p>
<p>分析找到了最终赢得游戏的逻辑, 主要的判断依据就是两个成员函数onWin()和doMarioDie(). 应该是最后碰到板栗仔, 如果是NORMAL状态就胜利, 否则马里奥死亡.</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">slot0.collisionH</span><span class="params">(slot0)</span></span></span><br><span class="line">	<span class="keyword">if</span> slot0.curPos.x &lt;= slot0.marioSize.width / <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">		slot2.x = slot1</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> slot2.x &gt;= slot0.mapSize.width - slot1 <span class="keyword">then</span></span><br><span class="line">		slot2.x = slot0.mapSize.width - slot1</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (slot0.mario.face == MarioState.RIGHT <span class="keyword">or</span> slot3 == MarioState.JUMP_RIGHT) <span class="keyword">and</span> slot0.mainMap.enemyList[<span class="number">1</span>] <span class="keyword">and</span> slot4.position.x &lt;= slot2.x + slot0.marioSize.width <span class="keyword">and</span> slot2.y &lt;= slot4.position.y + <span class="number">10</span> <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">if</span> slot0.mario.bodyType == MarioBodyState.NORMAL <span class="keyword">then</span> <span class="comment">-- 马里奥的身体状态为NORMAL</span></span><br><span class="line">			slot0.win = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">			slot0.mainMap:onWin() <span class="comment">--胜利</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			slot0:doMarioDie() <span class="comment">-- 死亡</span></span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> slot0.mainMap.flagPos.x &lt;= slot2.x + slot0.marioSize.width <span class="keyword">then</span></span><br><span class="line">		slot0:stopForWin()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	slot0.curPos = slot2</span><br><span class="line"></span><br><span class="line">	slot0.mario:setPosition(slot2)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="slot0-collisionV"><a href="#slot0-collisionV" class="headerlink" title="slot0.collisionV()"></a>slot0.collisionV()</h3><p>知道了最终结果的判断跟<code>slot0.mario.bodyType</code>​有关, 则取查找与该字段相关的函数, 只有slot0.collisionV()与此相关.</p>
<p>同时有两个关键的逻辑:</p>
<ul>
<li>slot0.mario:changeForGotMushroom()</li>
<li>slot0.mainMap:breakBrick(slot8, slot0.mario.bodyType) – 与该字段相关逻辑</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">slot0.collisionV</span><span class="params">(slot0)</span></span></span><br><span class="line">	<span class="keyword">if</span> slot0.curPos.y &lt;= <span class="number">0</span> <span class="keyword">then</span> <span class="comment">-- 跳下悬崖</span></span><br><span class="line">		slot0:doMarioDie() <span class="comment">-- 死亡</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	.....</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> slot6 = <span class="number">6</span>, slot0.marioSize.width - <span class="number">7</span> <span class="keyword">do</span></span><br><span class="line">		<span class="comment">-- 如果吃了蘑菇</span></span><br><span class="line">		<span class="keyword">if</span> slot0.mainMap:isMarioEatMushroom(slot0.mainMap:pointToTileCoord(cc.p(slot1.x - slot0.marioSize.width / <span class="number">2</span> + slot6, slot1.y + slot0.marioSize.height))) <span class="keyword">then</span></span><br><span class="line">			<span class="comment">--调用该函数</span></span><br><span class="line">			slot0.mario:changeForGotMushroom()</span><br><span class="line">			cc.SimpleAudioEngine:getInstance():playEffect(music_eatmushroomOrFlower)</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">		slot9 = cc.p(slot1.x, slot0.mainMap:tileCoordToPoint(slot8).y - slot0.marioSize.height)</span><br><span class="line">		slot11 = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> TileType.BRICK == slot0.mainMap:tileTypeAtCoord(slot8) <span class="keyword">or</span> TileType.LAND == slot10 <span class="keyword">or</span> TileType.INPUT == slot10 <span class="keyword">then</span></span><br><span class="line">			<span class="keyword">if</span> slot0.jumpOffset &gt; <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">				slot0.mainMap:breakBrick(slot8, slot0.mario.bodyType) <span class="comment">-- 与该字段相关逻辑</span></span><br><span class="line"></span><br><span class="line">				slot0.jumpOffset = <span class="number">0</span></span><br><span class="line">				slot0.curPos = slot9</span><br><span class="line"></span><br><span class="line">				slot0.mario:setPosition(slot9)</span><br><span class="line"></span><br><span class="line">				slot11 = <span class="literal">true</span></span><br><span class="line">			<span class="keyword">end</span></span><br><span class="line">		<span class="keyword">elseif</span> TileType.TRAP == slot10 <span class="keyword">then</span></span><br><span class="line">			slot0:doMarioDie()</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	.....</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="slot0-breakBrick"><a href="#slot0-breakBrick" class="headerlink" title="slot0.breakBrick()"></a>slot0.breakBrick()</h3><p>一开始首先查找的是<code>changeForGotMushroom()</code>​函数, 但是并没有什么结果.</p>
<p>再次查找breakBrick()函数找到了其定义</p>
<p>关键:</p>
<ul>
<li>slot0:showNewMushroom(slot1, slot2): 出现蘑菇</li>
</ul>
<p>于是我们从该函数出发, 找出执行到这里的条件</p>
<ul>
<li><p>第一层的if需要执行到elseif</p>
</li>
<li><p>第二层:</p>
<ul>
<li>slot5获取input, 并转换成字符串</li>
<li>传入slot5到core.Util的create()方法中, 并返回slot6</li>
<li>调用slot6:OoO() (注意跟下面的函数不一样, 大小写相反, 是两个函数)</li>
<li>根据slot6:oOo()的返回值判断是否执行<code>slot0:showNewMushroom(slot1, slot2)</code>​</li>
</ul>
</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">slot0.breakBrick</span><span class="params">(slot0, slot1, slot2)</span></span></span><br><span class="line">	<span class="keyword">if</span> slot0:getPropertiesForGID(slot0.brickLayer:getTileGIDAt(slot1)) == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">		slot0:chageBlockState(slot1)</span><br><span class="line">	<span class="keyword">elseif</span> slot4 == <span class="number">601</span> <span class="keyword">and</span> slot0:itemInList(slot0.mushroomCoordList, slot1) <span class="keyword">then</span></span><br><span class="line">		<span class="keyword">for</span> slot9 = <span class="number">0</span>, <span class="number">31</span> <span class="keyword">do</span></span><br><span class="line">			slot5 = <span class="string">&quot;&quot;</span> .. slot0.labelList[<span class="string">&quot;input&quot;</span> .. <span class="built_in">tostring</span>(slot9)]:getString()</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">		slot6 = <span class="built_in">require</span>(<span class="string">&quot;core.Util&quot;</span>).<span class="built_in">create</span>(slot5)</span><br><span class="line"></span><br><span class="line">		slot6:OoO()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> slot6:oOo() <span class="keyword">then</span></span><br><span class="line">			slot0:showNewMushroom(slot1, slot2)</span><br><span class="line">			slot0:removeItem(slot0.mushroomCoordList, slot1)</span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="Util-create"><a href="#Util-create" class="headerlink" title="Util.create()"></a>Util.create()</h3><p>根据上面的逻辑继续跟进, 全局搜索找到create()函数.</p>
<p>note: lua中数组下标从1开始, 所以在还原虚拟机的时候需要关注下标的转换, 分为两类:</p>
<ul>
<li>相对距离: 比如<code>slot1.slot[2][slot6] = string.byte(slot0, slot6 - 32)</code>​中的<code>slot6-32</code>​就是一个相对距离, 无需修改</li>
<li>绝对距离: 比如<code>slot1.slot[2][slot6 + 96] = slot2[slot6 - 32]</code>​中的<code>[slot6 + 96]</code>​就是一个绝对距离, 需要减一</li>
</ul>
<p>逻辑: 根据slot2可以看出来是一个虚拟机, create()函数主要执行初始化操作, 执行逻辑在下面的OoO()中.</p>
<p>‍</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">slot0.create</span><span class="params">(slot0)</span></span></span><br><span class="line">	slot2 = &#123;</span><br><span class="line">		<span class="number">94</span>,</span><br><span class="line">		<span class="number">106</span>,</span><br><span class="line">		<span class="number">91</span>,</span><br><span class="line">		<span class="number">110</span>,</span><br><span class="line">		<span class="number">86</span>,</span><br><span class="line">		<span class="number">100</span>,</span><br><span class="line">		<span class="number">82</span>,</span><br><span class="line">		<span class="number">20</span>,</span><br><span class="line">		<span class="number">32</span>,</span><br><span class="line">		<span class="number">20</span>,</span><br><span class="line">		<span class="number">80</span>,</span><br><span class="line">		<span class="number">21</span>,</span><br><span class="line">		<span class="number">83</span>,</span><br><span class="line">		<span class="number">107</span>,</span><br><span class="line">		<span class="number">88</span>,</span><br><span class="line">		<span class="number">98</span>,</span><br><span class="line">		<span class="number">81</span>,</span><br><span class="line">		<span class="number">19</span>,</span><br><span class="line">		<span class="number">79</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">117</span>,</span><br><span class="line">		<span class="number">68</span>,</span><br><span class="line">		<span class="number">120</span>,</span><br><span class="line">		<span class="number">61</span>,</span><br><span class="line">		<span class="number">13</span>,</span><br><span class="line">		<span class="number">75</span>,</span><br><span class="line">		<span class="number">115</span>,</span><br><span class="line">		<span class="number">48</span>,</span><br><span class="line">		<span class="number">8</span>,</span><br><span class="line">		<span class="number">76</span>,</span><br><span class="line">		<span class="number">123</span></span><br><span class="line">	&#125;</span><br><span class="line">	uv0.new().slot[<span class="number">1</span>] = &#123;</span><br><span class="line">		<span class="number">65</span>,</span><br><span class="line">		<span class="number">30</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">191</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">1</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">1</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">192</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">2</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">2</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">193</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">3</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">3</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">194</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">4</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">4</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">195</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">5</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">5</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">196</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">6</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">6</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">197</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">7</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">7</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">198</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">8</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">8</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">199</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">9</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">9</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">200</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">201</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">202</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">12</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">12</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">203</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">13</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">13</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">204</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">14</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">14</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">205</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">15</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">15</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">206</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">16</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">16</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">207</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">17</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">17</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">208</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">18</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">18</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">209</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">19</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">19</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">210</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">20</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">20</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">211</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">21</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">21</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">212</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">22</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">22</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">213</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">23</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">23</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">214</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">24</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">24</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">215</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">25</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">25</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">216</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">26</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">26</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">217</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">27</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">27</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">218</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">28</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">28</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">219</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">29</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">33</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">29</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">220</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">30</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">30</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">221</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">50</span>,</span><br><span class="line">		<span class="number">31</span>,</span><br><span class="line">		<span class="number">37</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">36</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">11</span>,</span><br><span class="line">		<span class="number">34</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">66</span>,</span><br><span class="line">		<span class="number">10</span>,</span><br><span class="line">		<span class="number">49</span>,</span><br><span class="line">		<span class="number">31</span>,</span><br><span class="line">		<span class="number">144</span>,</span><br><span class="line">		<span class="number">144</span>,</span><br><span class="line">		<span class="number">144</span>,</span><br><span class="line">		<span class="number">144</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> slot6 = <span class="number">1</span>, <span class="number">256</span> <span class="keyword">do</span></span><br><span class="line">		slot1.slot[<span class="number">2</span>][slot6] = <span class="number">0</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> slot6 = <span class="number">33</span>, <span class="number">65</span> <span class="keyword">do</span></span><br><span class="line">		slot1.slot[<span class="number">2</span>][slot6] = <span class="built_in">string</span>.<span class="built_in">byte</span>(slot0, slot6 - <span class="number">32</span>) <span class="comment">-- slot0是传入的字符串</span></span><br><span class="line">		slot1.slot[<span class="number">2</span>][slot6 + <span class="number">96</span>] = slot2[slot6 - <span class="number">32</span>]</span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">	slot1.slot[<span class="number">3</span>] = <span class="number">0</span></span><br><span class="line">	slot1.slot[<span class="number">4</span>] = <span class="number">0</span></span><br><span class="line">	slot1.slot[<span class="number">5</span>] = <span class="number">1</span></span><br><span class="line">	slot1.slot[<span class="number">6</span>] = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> slot1</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">slot0.OoO</span><span class="params">(slot0)</span></span></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">		opcode = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>]]</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> opcode == <span class="number">17</span> <span class="keyword">then</span></span><br><span class="line">			slot1 = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]</span><br><span class="line">			slot0.slot[<span class="number">1</span>][<span class="number">33</span> + slot1] = slot0:lil(slot0.slot[<span class="number">1</span>][<span class="number">33</span> + slot1] + <span class="number">1</span>, <span class="number">255</span>)</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">33</span> <span class="keyword">then</span></span><br><span class="line">			slot1 = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]</span><br><span class="line">			slot0.slot[slot1 - <span class="number">7</span>] = slot0:lil(slot0.slot[slot1 - <span class="number">7</span>] + <span class="number">1</span>, <span class="number">255</span>)</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">65</span> <span class="keyword">then</span></span><br><span class="line">			slot0.slot[<span class="number">6</span>] = slot0.slot[<span class="number">6</span>] + <span class="number">1</span></span><br><span class="line">			slot0.slot[<span class="number">2</span>][slot0.slot[<span class="number">6</span>]] = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">18</span> <span class="keyword">then</span></span><br><span class="line">			slot1 = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]</span><br><span class="line">			slot0.slot[<span class="number">1</span>][<span class="number">33</span> + slot1] = slot0:lil(slot0.slot[<span class="number">1</span>][<span class="number">33</span> + slot1] - <span class="number">1</span>, <span class="number">255</span>)</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">35</span> <span class="keyword">then</span></span><br><span class="line">			slot1 = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]</span><br><span class="line">			slot0.slot[slot1 - <span class="number">7</span>] = slot0:ili(slot0.slot[slot1 - <span class="number">7</span>], slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">2</span>])</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">3</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">50</span> <span class="keyword">then</span></span><br><span class="line">			slot0.slot[<span class="number">6</span>] = slot0.slot[<span class="number">6</span>] + <span class="number">1</span></span><br><span class="line">			slot0.slot[<span class="number">2</span>][slot0.slot[<span class="number">6</span>]] = slot0.slot[<span class="number">2</span>][<span class="number">33</span> + slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]]</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">36</span> <span class="keyword">then</span></span><br><span class="line">			slot1 = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]</span><br><span class="line">			slot0.slot[slot1 - <span class="number">7</span>] = slot0:ili(slot0.slot[slot1 - <span class="number">7</span>], slot0.slot[slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">2</span>] - <span class="number">7</span>])</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">3</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">49</span> <span class="keyword">then</span></span><br><span class="line">			slot0.slot[<span class="number">2</span>][<span class="number">224</span> + slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]] = slot0.slot[<span class="number">2</span>][slot0.slot[<span class="number">6</span>]]</span><br><span class="line">			slot0.slot[<span class="number">6</span>] = slot0.slot[<span class="number">6</span>] - <span class="number">1</span></span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">34</span> <span class="keyword">then</span></span><br><span class="line">			slot1 = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]</span><br><span class="line">			slot0.slot[slot1 - <span class="number">7</span>] = slot0:lil(slot0.slot[slot1 - <span class="number">7</span>] - <span class="number">1</span>, <span class="number">255</span>)</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">66</span> <span class="keyword">then</span></span><br><span class="line">			slot0.slot[<span class="number">6</span>] = slot0.slot[<span class="number">6</span>] + <span class="number">1</span></span><br><span class="line">			slot0.slot[<span class="number">2</span>][slot0.slot[<span class="number">6</span>]] = slot0.slot[slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>] - <span class="number">7</span>]</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">37</span> <span class="keyword">then</span></span><br><span class="line">			slot0.slot[slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>] - <span class="number">7</span>] = slot0.slot[<span class="number">2</span>][slot0.slot[<span class="number">6</span>]]</span><br><span class="line">			slot0.slot[<span class="number">6</span>] = slot0.slot[<span class="number">6</span>] - <span class="number">1</span></span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">144</span> <span class="keyword">then</span></span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="slot0-OoO"><a href="#slot0-OoO" class="headerlink" title="slot0.OoO()"></a>slot0.OoO()</h3><p>分析时需要注意的点:</p>
<ul>
<li>使用C++还原的时候<code>lil(arg0, 255)</code>​是可以省略的, 该函数主要是避免溢出问题, 而C++可以直接使用unsigned char</li>
<li>使用文本替换的时候<strong>不要直接全部替换</strong>了, 该反编译器多个函数间统一使用slotx, 直接替换会把其他函数的变量也改名了, 最好一个一个换</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">slot0.OoO</span><span class="params">(slot0)</span></span></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">		opcode = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>]]</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> opcode == <span class="number">17</span> <span class="keyword">then</span></span><br><span class="line">			slot1 = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]</span><br><span class="line">			slot0.slot[<span class="number">1</span>][<span class="number">33</span> + slot1] = slot0:lil(slot0.slot[<span class="number">1</span>][<span class="number">33</span> + slot1] + <span class="number">1</span>, <span class="number">255</span>)</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">33</span> <span class="keyword">then</span></span><br><span class="line">			slot1 = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]</span><br><span class="line">			slot0.slot[slot1 - <span class="number">7</span>] = slot0:lil(slot0.slot[slot1 - <span class="number">7</span>] + <span class="number">1</span>, <span class="number">255</span>)</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">65</span> <span class="keyword">then</span></span><br><span class="line">			slot0.slot[<span class="number">6</span>] = slot0.slot[<span class="number">6</span>] + <span class="number">1</span></span><br><span class="line">			slot0.slot[<span class="number">2</span>][slot0.slot[<span class="number">6</span>]] = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">18</span> <span class="keyword">then</span></span><br><span class="line">			slot1 = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]</span><br><span class="line">			slot0.slot[<span class="number">1</span>][<span class="number">33</span> + slot1] = slot0:lil(slot0.slot[<span class="number">1</span>][<span class="number">33</span> + slot1] - <span class="number">1</span>, <span class="number">255</span>)</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">35</span> <span class="keyword">then</span></span><br><span class="line">			slot1 = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]</span><br><span class="line">			slot0.slot[slot1 - <span class="number">7</span>] = slot0:ili(slot0.slot[slot1 - <span class="number">7</span>], slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">2</span>])</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">3</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">50</span> <span class="keyword">then</span></span><br><span class="line">			slot0.slot[<span class="number">6</span>] = slot0.slot[<span class="number">6</span>] + <span class="number">1</span></span><br><span class="line">			slot0.slot[<span class="number">2</span>][slot0.slot[<span class="number">6</span>]] = slot0.slot[<span class="number">2</span>][<span class="number">33</span> + slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]]</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">36</span> <span class="keyword">then</span></span><br><span class="line">			slot1 = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]</span><br><span class="line">			slot0.slot[slot1 - <span class="number">7</span>] = slot0:ili(slot0.slot[slot1 - <span class="number">7</span>], slot0.slot[slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">2</span>] - <span class="number">7</span>])</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">3</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">49</span> <span class="keyword">then</span></span><br><span class="line">			slot0.slot[<span class="number">2</span>][<span class="number">224</span> + slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]] = slot0.slot[<span class="number">2</span>][slot0.slot[<span class="number">6</span>]]</span><br><span class="line">			slot0.slot[<span class="number">6</span>] = slot0.slot[<span class="number">6</span>] - <span class="number">1</span></span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">34</span> <span class="keyword">then</span></span><br><span class="line">			slot1 = slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>]</span><br><span class="line">			slot0.slot[slot1 - <span class="number">7</span>] = slot0:lil(slot0.slot[slot1 - <span class="number">7</span>] - <span class="number">1</span>, <span class="number">255</span>)</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">66</span> <span class="keyword">then</span></span><br><span class="line">			slot0.slot[<span class="number">6</span>] = slot0.slot[<span class="number">6</span>] + <span class="number">1</span></span><br><span class="line">			slot0.slot[<span class="number">2</span>][slot0.slot[<span class="number">6</span>]] = slot0.slot[slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>] - <span class="number">7</span>]</span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">37</span> <span class="keyword">then</span></span><br><span class="line">			slot0.slot[slot0.slot[<span class="number">1</span>][slot0.slot[<span class="number">5</span>] + <span class="number">1</span>] - <span class="number">7</span>] = slot0.slot[<span class="number">2</span>][slot0.slot[<span class="number">6</span>]]</span><br><span class="line">			slot0.slot[<span class="number">6</span>] = slot0.slot[<span class="number">6</span>] - <span class="number">1</span></span><br><span class="line">			slot0.slot[<span class="number">5</span>] = slot0.slot[<span class="number">5</span>] + <span class="number">2</span></span><br><span class="line">		<span class="keyword">elseif</span> opcode == <span class="number">144</span> <span class="keyword">then</span></span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">end</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="还原虚拟机"><a href="#还原虚拟机" class="headerlink" title="还原虚拟机"></a>还原虚拟机</h3><p>使用了C++还原虚拟机逻辑, 分为</p>
<ul>
<li>main.cpp</li>
<li>vm.h</li>
<li>vm.cpp</li>
</ul>
<h4 id="main-cpp"><a href="#main-cpp" class="headerlink" title="main.cpp"></a>main.cpp</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;vm.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::cout, std::cin, std::endl;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> input[] = <span class="string">&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>;</span><br><span class="line">    <span class="function">VM <span class="title">vm0</span><span class="params">(input)</span></span>;</span><br><span class="line">    vm0.<span class="built_in">OoO_run</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="vm-h"><a href="#vm-h" class="headerlink" title="vm.h"></a>vm.h</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> VM_H_</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VM_H_</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VM</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> ins_values[<span class="number">32</span>] = &#123;<span class="number">94</span>,<span class="number">106</span>,<span class="number">91</span>,<span class="number">110</span>,<span class="number">86</span>,<span class="number">100</span>,<span class="number">82</span>,<span class="number">20</span>,<span class="number">32</span>,<span class="number">20</span>,</span><br><span class="line">                                    <span class="number">80</span>,<span class="number">21</span>,<span class="number">83</span>,<span class="number">107</span>,<span class="number">88</span>,<span class="number">98</span>,<span class="number">81</span>,<span class="number">19</span>,<span class="number">79</span>,<span class="number">10</span>,</span><br><span class="line">                                    <span class="number">49</span>,<span class="number">117</span>,<span class="number">68</span>,<span class="number">120</span>,<span class="number">61</span>,<span class="number">13</span>,<span class="number">75</span>,<span class="number">115</span>,<span class="number">48</span>,<span class="number">8</span>,</span><br><span class="line">                                    <span class="number">76</span>,<span class="number">123</span>&#125;;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> opcodes[<span class="number">548</span>] = &#123;</span><br><span class="line">            <span class="number">65</span>, <span class="number">30</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">0</span>, <span class="number">50</span>, <span class="number">191</span>, <span class="number">37</span>,</span><br><span class="line">            <span class="number">10</span>, <span class="number">50</span>, <span class="number">1</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">1</span>, <span class="number">50</span>, <span class="number">192</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">2</span>,</span><br><span class="line">            <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>,</span><br><span class="line">            <span class="number">2</span>, <span class="number">50</span>, <span class="number">193</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">3</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>,</span><br><span class="line">            <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">3</span>, <span class="number">50</span>, <span class="number">194</span>,</span><br><span class="line">            <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">4</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>,</span><br><span class="line">            <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">4</span>, <span class="number">50</span>, <span class="number">195</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>,</span><br><span class="line">            <span class="number">5</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">49</span>, <span class="number">5</span>, <span class="number">50</span>, <span class="number">196</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">6</span>, <span class="number">37</span>, <span class="number">11</span>,</span><br><span class="line">            <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">6</span>, <span class="number">50</span>,</span><br><span class="line">            <span class="number">197</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">7</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>,</span><br><span class="line">            <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">7</span>, <span class="number">50</span>, <span class="number">198</span>, <span class="number">37</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">50</span>, <span class="number">8</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>,</span><br><span class="line">            <span class="number">10</span>, <span class="number">49</span>, <span class="number">8</span>, <span class="number">50</span>, <span class="number">199</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">9</span>, <span class="number">37</span>,</span><br><span class="line">            <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">9</span>,</span><br><span class="line">            <span class="number">50</span>, <span class="number">200</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">10</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">201</span>, <span class="number">37</span>,</span><br><span class="line">            <span class="number">10</span>, <span class="number">50</span>, <span class="number">11</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">11</span>, <span class="number">50</span>, <span class="number">202</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">12</span>,</span><br><span class="line">            <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>,</span><br><span class="line">            <span class="number">12</span>, <span class="number">50</span>, <span class="number">203</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">13</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>,</span><br><span class="line">            <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">13</span>, <span class="number">50</span>, <span class="number">204</span>,</span><br><span class="line">            <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">14</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>,</span><br><span class="line">            <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">14</span>, <span class="number">50</span>, <span class="number">205</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>,</span><br><span class="line">            <span class="number">15</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">49</span>, <span class="number">15</span>, <span class="number">50</span>, <span class="number">206</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">16</span>, <span class="number">37</span>, <span class="number">11</span>,</span><br><span class="line">            <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">16</span>, <span class="number">50</span>,</span><br><span class="line">            <span class="number">207</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">17</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>,</span><br><span class="line">            <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">17</span>, <span class="number">50</span>, <span class="number">208</span>, <span class="number">37</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">50</span>, <span class="number">18</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>,</span><br><span class="line">            <span class="number">10</span>, <span class="number">49</span>, <span class="number">18</span>, <span class="number">50</span>, <span class="number">209</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">19</span>, <span class="number">37</span>,</span><br><span class="line">            <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">19</span>,</span><br><span class="line">            <span class="number">50</span>, <span class="number">210</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">20</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">20</span>, <span class="number">50</span>, <span class="number">211</span>, <span class="number">37</span>,</span><br><span class="line">            <span class="number">10</span>, <span class="number">50</span>, <span class="number">21</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">21</span>, <span class="number">50</span>, <span class="number">212</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">22</span>,</span><br><span class="line">            <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>,</span><br><span class="line">            <span class="number">22</span>, <span class="number">50</span>, <span class="number">213</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">23</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>,</span><br><span class="line">            <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">23</span>, <span class="number">50</span>, <span class="number">214</span>,</span><br><span class="line">            <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">24</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>,</span><br><span class="line">            <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">24</span>, <span class="number">50</span>, <span class="number">215</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>,</span><br><span class="line">            <span class="number">25</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">49</span>, <span class="number">25</span>, <span class="number">50</span>, <span class="number">216</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">26</span>, <span class="number">37</span>, <span class="number">11</span>,</span><br><span class="line">            <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">26</span>, <span class="number">50</span>,</span><br><span class="line">            <span class="number">217</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">27</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>,</span><br><span class="line">            <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">27</span>, <span class="number">50</span>, <span class="number">218</span>, <span class="number">37</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">50</span>, <span class="number">28</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>,</span><br><span class="line">            <span class="number">10</span>, <span class="number">49</span>, <span class="number">28</span>, <span class="number">50</span>, <span class="number">219</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">29</span>, <span class="number">37</span>,</span><br><span class="line">            <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">33</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">29</span>,</span><br><span class="line">            <span class="number">50</span>, <span class="number">220</span>, <span class="number">37</span>, <span class="number">10</span>, <span class="number">50</span>, <span class="number">30</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>, <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">30</span>, <span class="number">50</span>, <span class="number">221</span>, <span class="number">37</span>,</span><br><span class="line">            <span class="number">10</span>, <span class="number">50</span>, <span class="number">31</span>, <span class="number">37</span>, <span class="number">11</span>, <span class="number">36</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">34</span>, <span class="number">10</span>,</span><br><span class="line">            <span class="number">66</span>, <span class="number">10</span>, <span class="number">49</span>, <span class="number">31</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span>, <span class="number">144</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> memory[<span class="number">256</span>] = &#123;<span class="number">0</span>&#125;; <span class="comment">// 前32个字节是栈空间, 随后33个字节是input输入, 中间空了一些空间, 95开始时ins_values, 最后33个字节用于存储output</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> eax; <span class="comment">// slot[3]; 判断是通用寄存器, 判断依据: 通过指令码选取的寄存器, 没有直接调用过. (像是SP都有在vm.cpp中直接出现过的, 且功能明确)</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> ebx; <span class="comment">// slot[4]; 判断是通用寄存器, 判断依据: 同上</span></span><br><span class="line">    <span class="keyword">int</span> PC; <span class="comment">// slot[5]; 判断是PC寄存器, 判断依据: 每个指令都对其执行固定长度的自增操作.</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> SP; <span class="comment">// slot[6]; 判断该寄存器应该是栈顶指针, 判断依据: 多次自增和自检操作, 且涉及的指令逻辑都是出栈入栈的操作.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">VM</span>(<span class="keyword">const</span> <span class="keyword">char</span> input[<span class="number">32</span>]); <span class="comment">// 构造方法相当于create()</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OoO_run</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> * <span class="title">getRegister</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> operand)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">char</span> * <span class="title">registerString</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> operand)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h4 id="vm-cpp"><a href="#vm-cpp" class="headerlink" title="vm.cpp"></a>vm.cpp</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;vm.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::cout, std::cin, std::endl;</span><br><span class="line"></span><br><span class="line">VM::<span class="built_in">VM</span>(<span class="keyword">const</span> <span class="keyword">char</span> *input) &#123;</span><br><span class="line">    <span class="comment">// 初始化内存</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">32</span>; i &lt;= <span class="number">64</span>; i++) &#123; <span class="comment">// &lt;=64: 模仿lua的for循环</span></span><br><span class="line">        memory[i] = input[i - <span class="number">32</span>];</span><br><span class="line">        memory[i + <span class="number">95</span>] = ins_values[i - <span class="number">32</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 初始化寄存器</span></span><br><span class="line">    eax = <span class="number">0</span>; <span class="comment">// </span></span><br><span class="line">    ebx = <span class="number">0</span>; <span class="comment">// </span></span><br><span class="line">    PC = <span class="number">0</span>; <span class="comment">// 补充: Lua下标从1开始, C++下标从0开始</span></span><br><span class="line">    SP = <span class="number">-1</span>; <span class="comment">// 补充: 因为Lua起始下标为1, 所以在C++中SP初始化要从0变为-1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">VM::OoO_run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> head;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> operand1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> operand2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// 读取指令头</span></span><br><span class="line">        head = opcodes[PC];</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[PC: &quot;</span> &lt;&lt; PC &lt;&lt; <span class="string">&quot;] &quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in"><span class="keyword">switch</span></span>(head) &#123;</span><br><span class="line">            <span class="comment">// 特定内存自增</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">17</span>: &#123;</span><br><span class="line">                operand1 = opcodes[PC + <span class="number">1</span>];</span><br><span class="line">                opcodes[<span class="number">32</span> + operand1] += <span class="number">1</span>;</span><br><span class="line">                PC += <span class="number">2</span>;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;add [&quot;</span> &lt;&lt; (<span class="keyword">int</span>)operand1 &lt;&lt; <span class="string">&quot;, 0x20], 1&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 指定寄存器自增</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">33</span>: &#123;</span><br><span class="line">                operand1 = opcodes[PC + <span class="number">1</span>];</span><br><span class="line">                *<span class="built_in">getRegister</span>(operand1) += <span class="number">1</span>;</span><br><span class="line">                PC += <span class="number">2</span>;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;add &quot;</span> &lt;&lt; <span class="built_in">registerString</span>(operand1) &lt;&lt; <span class="string">&quot;, 1&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 立即数入栈</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">65</span>: &#123;</span><br><span class="line">                SP += <span class="number">1</span>;</span><br><span class="line">                memory[SP] = opcodes[PC + <span class="number">1</span>];</span><br><span class="line">                PC += <span class="number">2</span>;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;push &quot;</span> &lt;&lt; (<span class="keyword">int</span>)opcodes[PC + <span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 特定内存自减</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">18</span>: &#123;</span><br><span class="line">                operand1= opcodes[PC + <span class="number">1</span>];</span><br><span class="line">                opcodes[<span class="number">32</span> + operand1] -= <span class="number">1</span>;</span><br><span class="line">                PC += <span class="number">2</span>;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;sub [&quot;</span> &lt;&lt; (<span class="keyword">int</span>)operand1 &lt;&lt; <span class="string">&quot;, 0x20], 1&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 寄存器与立即数异或</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">35</span>: &#123;</span><br><span class="line">                operand1 = opcodes[PC + <span class="number">1</span>];</span><br><span class="line">                *<span class="built_in">getRegister</span>(operand1) ^= opcodes[PC + <span class="number">2</span>];</span><br><span class="line">                PC += <span class="number">3</span>;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;xor &quot;</span> &lt;&lt; <span class="built_in">registerString</span>(operand1) &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; (<span class="keyword">int</span>)opcodes[PC + <span class="number">2</span>] &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 特定内存的数据入栈</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">50</span>: &#123;</span><br><span class="line">                SP += <span class="number">1</span>;</span><br><span class="line">                memory[SP] = memory[<span class="number">32</span> + opcodes[PC + <span class="number">1</span>]];</span><br><span class="line">                PC += <span class="number">2</span>;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;push [&quot;</span> &lt;&lt; (<span class="keyword">int</span>)opcodes[PC + <span class="number">1</span>] &lt;&lt; <span class="string">&quot;, 0x20]&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 两寄存器异或</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">36</span>: &#123;</span><br><span class="line">                operand1 = opcodes[PC + <span class="number">1</span>];</span><br><span class="line">                operand2 = opcodes[PC + <span class="number">2</span>];</span><br><span class="line">                *<span class="built_in">getRegister</span>(operand1) = operand1 ^ operand2;</span><br><span class="line">                PC += <span class="number">3</span>;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;xor &quot;</span> &lt;&lt; <span class="built_in">registerString</span>(operand1) &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; <span class="built_in">registerString</span>(operand2) &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 栈数据弹出到指定内存</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">49</span>: &#123;</span><br><span class="line">                operand1 = opcodes[PC + <span class="number">1</span>];</span><br><span class="line">                memory[<span class="number">224</span> + operand1] = memory[SP];</span><br><span class="line">                SP -= <span class="number">1</span>;</span><br><span class="line">                PC += <span class="number">2</span>;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;pop [&quot;</span> &lt;&lt; (<span class="keyword">int</span>)operand1 &lt;&lt; <span class="string">&quot;, 0xE0]&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 寄存器自减</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">34</span>: &#123;</span><br><span class="line">                operand1 = opcodes[PC + <span class="number">1</span>];</span><br><span class="line">                *<span class="built_in">getRegister</span>(operand1) -= <span class="number">1</span>;</span><br><span class="line">                PC += <span class="number">2</span>;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;sub &quot;</span> &lt;&lt; <span class="built_in">registerString</span>(operand1) &lt;&lt; <span class="string">&quot;, 1&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 寄存器入栈</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">66</span>: &#123;</span><br><span class="line">                operand1 = opcodes[PC + <span class="number">1</span>];</span><br><span class="line">                SP += <span class="number">1</span>;</span><br><span class="line">                memory[SP] = *<span class="built_in">getRegister</span>(operand1);</span><br><span class="line">                PC += <span class="number">2</span>;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;push &quot;</span> &lt;&lt; <span class="built_in">registerString</span>(operand1) &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 栈数据弹出到指定寄存器</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">37</span>: &#123;</span><br><span class="line">                operand1 = opcodes[PC + <span class="number">1</span>];</span><br><span class="line">                *<span class="built_in">getRegister</span>(operand1) = memory[SP];</span><br><span class="line">                SP -= <span class="number">1</span>;</span><br><span class="line">                PC += <span class="number">2</span>;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;pop &quot;</span> &lt;&lt; <span class="built_in">registerString</span>(operand1) &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">144</span>: &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="title">VM::getRegister</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> operand)</span> </span>&#123;</span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span>(operand - <span class="number">7</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> &amp;eax;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">return</span> &amp;ebx;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="string">&quot;expected PC register&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">return</span> &amp;SP;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="string">&quot;expected register index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">VM::registerString</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> operand)</span> </span>&#123;</span><br><span class="line">    <span class="built_in"><span class="keyword">switch</span></span>(operand - <span class="number">7</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;eax&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;ebx&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;PC&quot;</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;SP&quot;</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="string">&quot;expected register index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="得到指令输出"><a href="#得到指令输出" class="headerlink" title="得到指令输出"></a>得到指令输出</h3><p>分析前三个, 为相邻位异或和加减1, 注意最后一个加密减去了两次</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br></pre></td><td class="code"><pre><span class="line">push <span class="number">1</span>e</span><br><span class="line">pop eax                  <span class="comment">// eax = 0x1e</span></span><br><span class="line">push [<span class="number">0</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx                  <span class="comment">// ebx = input[0]</span></span><br><span class="line"><span class="keyword">xor</span> eax, ebx             <span class="comment">// eax = input[0] ^ 0x1e</span></span><br><span class="line">sub eax, <span class="number">1</span>               <span class="comment">// eab = (input[0] ^ 0x1e) - 1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">0</span>, <span class="number">0xDF</span>]            <span class="comment">// output[0] = input[0]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push [bf, <span class="number">0x20</span>]</span><br><span class="line">pop eax                  <span class="comment">// eax = output[0]</span></span><br><span class="line">push [<span class="number">1</span>, <span class="number">0x20</span>]         </span><br><span class="line">pop ebx                  <span class="comment">// ebx = input[1]</span></span><br><span class="line"><span class="keyword">xor</span> eax, ebx             <span class="comment">// eax = output[0] ^ input[1] = ((input[0] ^ 0x1e) - 1) ^ input[1]</span></span><br><span class="line">add eax, <span class="number">1</span>               <span class="comment">// eax = (((input[0] ^ 0x1e) - 1) ^ input[1]) + 1</span></span><br><span class="line">push eax               </span><br><span class="line">pop [<span class="number">1</span>, <span class="number">0xDF</span>]            <span class="comment">// output[1] = (((input[0] ^ 0x1e) - 1) ^ input[1]) + 1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push [c0, <span class="number">0x20</span>]        </span><br><span class="line">pop eax                  <span class="comment">// eax = output[1]</span></span><br><span class="line">push [<span class="number">2</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx                  <span class="comment">// ebx = input[2]</span></span><br><span class="line"><span class="keyword">xor</span> eax, ebx             <span class="comment">// eax = output[1] ^ input[2]</span></span><br><span class="line">sub eax, <span class="number">1</span>               <span class="comment">// eax = (output[1] ^ input[2]) - 1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">2</span>, <span class="number">0xDF</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push [c1, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">3</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">add eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">3</span>, <span class="number">0xDF</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push [c2, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">4</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">4</span>, <span class="number">0xDF</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push [c3, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">5</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">add eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">5</span>, <span class="number">0xDF</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push [c4, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">6</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">6</span>, <span class="number">0xDF</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push [c5, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">7</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">add eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">7</span>, <span class="number">0xDF</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push [c6, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">8</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">8</span>, <span class="number">0xDF</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push [c7, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">9</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">add eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">9</span>, <span class="number">0xDF</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push [c8, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [a, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [a, <span class="number">0xDF</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push [c9, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [b, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">add eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [b, <span class="number">0xDF</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push [ca, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [c, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [c, <span class="number">0xDF</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">push [cb, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [d, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">add eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [d, <span class="number">0xDF</span>]</span><br><span class="line">push [cc, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [e, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [e, <span class="number">0xDF</span>]</span><br><span class="line">push [cd, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [f, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">add eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [f, <span class="number">0xDF</span>]</span><br><span class="line">push [ce, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">10</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">10</span>, <span class="number">0xDF</span>]</span><br><span class="line">push [cf, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">11</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">add eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">11</span>, <span class="number">0xDF</span>]</span><br><span class="line">push [d0, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">12</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">12</span>, <span class="number">0xDF</span>]</span><br><span class="line">push [d1, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">13</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">add eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">13</span>, <span class="number">0xDF</span>]</span><br><span class="line">push [d2, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">14</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">14</span>, <span class="number">0xDF</span>]</span><br><span class="line">push [d3, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">15</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">add eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">15</span>, <span class="number">0xDF</span>]</span><br><span class="line">push [d4, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">16</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">16</span>, <span class="number">0xDF</span>]</span><br><span class="line">push [d5, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">17</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">add eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">17</span>, <span class="number">0xDF</span>]</span><br><span class="line">push [d6, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">18</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">18</span>, <span class="number">0xDF</span>]</span><br><span class="line">push [d7, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">19</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">add eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">19</span>, <span class="number">0xDF</span>]</span><br><span class="line">push [d8, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">1</span>a, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">1</span>a, <span class="number">0xDF</span>]</span><br><span class="line">push [d9, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">1b</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">add eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">1b</span>, <span class="number">0xDF</span>]</span><br><span class="line">push [da, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">1</span>c, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">1</span>c, <span class="number">0xDF</span>]</span><br><span class="line">push [db, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">1</span>d, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">add eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">1</span>d, <span class="number">0xDF</span>]</span><br><span class="line">push [dc, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">1</span>e, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">1</span>e, <span class="number">0xDF</span>]</span><br><span class="line">push [dd, <span class="number">0x20</span>]</span><br><span class="line">pop eax</span><br><span class="line">push [<span class="number">1f</span>, <span class="number">0x20</span>]</span><br><span class="line">pop ebx</span><br><span class="line"><span class="keyword">xor</span> eax, ebx</span><br><span class="line">sub eax, <span class="number">1</span></span><br><span class="line">push eax</span><br><span class="line">pop [<span class="number">1f</span>, <span class="number">0xDF</span>]</span><br><span class="line"></span><br><span class="line">进程已结束,退出代码<span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="得到虚拟机加密逻辑"><a href="#得到虚拟机加密逻辑" class="headerlink" title="得到虚拟机加密逻辑"></a>得到虚拟机加密逻辑</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">VM::encrypt</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *input)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* output = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">            output[i] = input[i] ^ <span class="number">0x1e</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            output[i] = input[i] ^ output[i - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span> || i == <span class="number">31</span>)</span><br><span class="line">            output[i] -= <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            output[i] += <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; (<span class="keyword">int</span>)output[i] &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span>[] output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="得出解密逻辑"><a href="#得出解密逻辑" class="headerlink" title="得出解密逻辑"></a>得出解密逻辑</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">VM::decrypt</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span>* output = <span class="keyword">new</span> <span class="keyword">char</span>[<span class="number">32</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">31</span>; i &gt; <span class="number">-1</span>; i--) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span> || i == <span class="number">31</span>)</span><br><span class="line">            ins_values[i] += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            ins_values[i] -= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">            output[i] = ins_values[i] ^ <span class="number">0x1e</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            output[i] = ins_values[i - <span class="number">1</span>] ^ ins_values[i];</span><br><span class="line"></span><br><span class="line">        cout &lt;&lt; (<span class="keyword">int</span>)output[i] &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; output &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">delete</span>[] output;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="得到flag"><a href="#得到flag" class="headerlink" title="得到flag"></a>得到flag</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A76 <span class="number">6957</span> A53ED A929</span><br><span class="line"><span class="number">0</span>CC F8E0 <span class="number">3F</span>1A9 B7E0</span><br></pre></td></tr></table></figure>

<h1 id="获取到蘑菇并解出题目"><a href="#获取到蘑菇并解出题目" class="headerlink" title="获取到蘑菇并解出题目"></a>获取到蘑菇并解出题目</h1><p><img src="/2023/05/13/flagio/1BC2571D712893B54F4386114E1FFEB8-20230513122429-373rfkv.png" alt="1BC2571D712893B54F4386114E1FFEB8">​</p>
<p>[^1]: # 确定LuaJIT版本</p>
<p>[^2]: # bindiff</p>
<pre><code>通过比较两个IDA数据库(本质上应该就是比较具体的逻辑), 从而恢复函数符号.

# 使用

## IDA打开比较文件

两个文件都是用IDA打开:

* 要恢复符号的文件保留
* 函数库关闭IDA并保存数据库

## 使用BinDiff

* 点击file -&gt; BinDiff
* 选择要比较的数据库

​![image](flagio1/image-20230428191458-e1l2k33.png)​

## 符号恢复

* 比较完成后会新建四个窗口

  * ​![image](flagio1/image-20230428191659-ooqxn6y.png)​
  * Matched Function (匹配成功的函数)
  * Statistics (统计)
  * primary unmatched (首次不匹配的函数)
  * secondary unmatched (第二次仍不匹配的函数)

## 如何打开分析的窗口

BinDiff总共四个窗口, 如果需要重新打开点击 View -&gt; BinDiff -&gt; ....

​![image](flagio1/image-20230504202243-3xz2slk.png)​

## Matched Function窗口

该窗口用于查看匹配的函数

### 背景颜色

背景颜色代表相似度(绿-&gt;红, 相似度逐渐下降), 具体数值可以看字段Similarity

​![image](flagio1/image-20230428191940-rnk9e4k.png)​

## 如何载入对比文件

使用BinDiff进行对比后, 退出IDA会提示是否保存对比结果, 点击是会保存一个`libgame.so_vs_libluajit.so.BinDiff`​文件, 下一次使用的时候可以加载该文件.

如何载入该文件: 点击 File -&gt; Load file -&gt; BinDiff results.

​![image](flagio1/image-20230504201848-au4ot0p.png)​

# 注意

## 函数名

匹配后没有直接修改函数名 (因为是按照相似度匹配, 所以是否需要改名需要分析者做出判断)

所以只能在Matched Function窗口[^3]中搜索

‍
</code></pre>
<p>[^3]: ## Matched Function窗口</p>
<pre><code>该窗口用于查看匹配的函数

### 背景颜色

背景颜色代表相似度(绿-&gt;红, 相似度逐渐下降), 具体数值可以看字段Similarity

​![image](flagio1/image-20230428191940-rnk9e4k.png)​
</code></pre>
<p>[^4]: ## LUA文件编译流程</p>
<p>[^5]: ## LuaJIT安装</p>
<p>[^6]: ### lua_State</p>
<p>[^7]: ## Global_State</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">LamのCrow</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2023/05/13/flagio/">http://example.com/2023/05/13/flagio/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com">LamのCrow</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2023/06/09/MagiskPrinciple/"><i class="fa fa-chevron-left">  </i><span>Magisk原理分析(未完待续)</span></a></div><div class="next-post pull-right"><a href="/2022/05/18/AngrLab2c872/"><span>Angr_Lab</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s4.ax1x.com/2021/12/06/oy2VdH.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2023 By LamのCrow</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">追求幸福</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"right","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>