<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Angr_Lab"><meta name="keywords" content="逆向"><meta name="author" content="LamのCrow"><meta name="copyright" content="LamのCrow"><title>Angr_Lab | LamのCrow</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Angr-Lab"><span class="toc-number">1.</span> <span class="toc-text">Angr_Lab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%87%86%E5%A4%87"><span class="toc-number">2.</span> <span class="toc-text">实验准备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91"><span class="toc-number">2.1.</span> <span class="toc-text">编译</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C"><span class="toc-number">2.2.</span> <span class="toc-text">运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">2.3.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98"><span class="toc-number">2.4.</span> <span class="toc-text">使用Angr解题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#00-angr-find"><span class="toc-number">3.</span> <span class="toc-text">00_angr_find</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#main"><span class="toc-number">3.1.</span> <span class="toc-text">main()</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#complex-function-int-a1-int-a2"><span class="toc-number">3.2.</span> <span class="toc-text">complex_function(int a1, int a2)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B1%87%E7%BC%96%E6%9F%A5%E7%9C%8B%E2%80%9DGood-Job%E2%80%9D%E7%9A%84%E5%9C%B0%E5%9D%80"><span class="toc-number">3.3.</span> <span class="toc-text">汇编查看”Good Job”的地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-1"><span class="toc-number">3.4.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81"><span class="toc-number">3.4.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%8A%E6%B3%A8%E9%87%8A%E5%8E%BB%E6%8E%89%E4%BB%A5%E5%90%8E"><span class="toc-number">3.4.2.</span> <span class="toc-text">把注释去掉以后</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="toc-number">3.5.</span> <span class="toc-text">使用的流程</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#01-angr-avoid"><span class="toc-number">4.</span> <span class="toc-text">01_angr_avoid</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E6%89%A7%E8%A1%8C"><span class="toc-number">4.1.</span> <span class="toc-text">编译并执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-1"><span class="toc-number">4.2.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%80%9CGood-Job%E2%80%9D%E6%89%80%E5%9C%A8%E5%9C%B0%E5%9D%80"><span class="toc-number">4.2.1.</span> <span class="toc-text">“Good Job”所在地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mian-%E5%87%BD%E6%95%B0"><span class="toc-number">4.2.2.</span> <span class="toc-text">mian()函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%9F%E8%BF%9B%E8%B7%B3%E8%BD%AC"><span class="toc-number">4.2.3.</span> <span class="toc-text">跟进跳转</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E8%A6%81%E9%81%BF%E5%BC%80%E7%9A%84%E5%9C%B0%E5%9D%80"><span class="toc-number">4.2.4.</span> <span class="toc-text">需要避开的地址</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-2"><span class="toc-number">4.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-1"><span class="toc-number">4.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E"><span class="toc-number">4.3.2.</span> <span class="toc-text">去掉注释后</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#02-angr-find-codition"><span class="toc-number">5.</span> <span class="toc-text">02_angr_find_codition</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E8%BF%90%E8%A1%8C"><span class="toc-number">5.1.</span> <span class="toc-text">编译并运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-2"><span class="toc-number">5.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-3"><span class="toc-number">5.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-2"><span class="toc-number">5.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E-1"><span class="toc-number">5.3.2.</span> <span class="toc-text">去掉注释后</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#03-angr-symbolic-registers"><span class="toc-number">6.</span> <span class="toc-text">03_angr_symbolic_registers</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E8%BF%90%E8%A1%8C-1"><span class="toc-number">6.1.</span> <span class="toc-text">编译并运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-3"><span class="toc-number">6.2.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#main%E5%87%BD%E6%95%B0"><span class="toc-number">6.2.1.</span> <span class="toc-text">main函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#get-user-input"><span class="toc-number">6.2.2.</span> <span class="toc-text">get_user_input()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#complex-function-1"><span class="toc-number">6.2.3.</span> <span class="toc-text">complex_function_1()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-4"><span class="toc-number">6.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8B%E9%9D%A2%E6%98%AF%E4%BB%A3%E7%A0%81"><span class="toc-number">6.3.1.</span> <span class="toc-text">下面是代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E-2"><span class="toc-number">6.3.2.</span> <span class="toc-text">去掉注释后</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#04-angr-symbolic-stack"><span class="toc-number">7.</span> <span class="toc-text">04_angr_symbolic_stack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E8%BF%90%E8%A1%8C-2"><span class="toc-number">7.1.</span> <span class="toc-text">编译并运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-4"><span class="toc-number">7.2.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mian"><span class="toc-number">7.2.1.</span> <span class="toc-text">mian()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#handle-user"><span class="toc-number">7.2.2.</span> <span class="toc-text">handle_user()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-5"><span class="toc-number">7.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5%E4%B8%8B%E6%98%AF%E8%A7%A3%E9%A2%98%E4%BB%A3%E7%A0%81"><span class="toc-number">7.3.1.</span> <span class="toc-text">以下是解题代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E-3"><span class="toc-number">7.3.2.</span> <span class="toc-text">去掉注释后</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E4%B8%80-%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E7%9A%84%E8%B5%B7%E7%82%B9%E6%98%AF%E5%9C%A8add-esp-10h%E5%89%8D%E9%9D%A2%E8%BF%98%E6%98%AF%E5%90%8E%E9%9D%A2"><span class="toc-number">7.3.3.</span> <span class="toc-text">问题一: 符号执行的起点是在add     esp, 10h前面还是后面</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E%E6%A0%88%E6%B3%A8%E5%85%A5%E7%AC%A6%E5%8F%B7%E7%9A%84%E7%90%86%E8%A7%A3"><span class="toc-number">7.3.4.</span> <span class="toc-text">关于栈注入符号的理解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%B3%A8%E5%85%A5"><span class="toc-number">7.3.5.</span> <span class="toc-text">如何注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%9E%84%E9%80%A0%E6%A0%88"><span class="toc-number">7.3.5.1.</span> <span class="toc-text">1. 构造栈</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%91%E6%A0%88%E4%B8%AD%E6%B3%A8%E5%85%A5%E7%AC%A6%E5%8F%B7"><span class="toc-number">7.3.5.2.</span> <span class="toc-text">向栈中注入符号</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C"><span class="toc-number">7.3.5.3.</span> <span class="toc-text">符号执行</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#05-angr-symbolic-memory"><span class="toc-number">8.</span> <span class="toc-text">05_angr_symbolic_memory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E6%89%A7%E8%A1%8C-1"><span class="toc-number">8.1.</span> <span class="toc-text">编译并执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-5"><span class="toc-number">8.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-6"><span class="toc-number">8.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-3"><span class="toc-number">8.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">8.3.2.</span> <span class="toc-text">去掉注释后的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E7%9A%84%E5%9C%B0%E5%9D%80%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="toc-number">8.3.3.</span> <span class="toc-text">符号执行的地址的位置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#memset"><span class="toc-number">8.3.3.1.</span> <span class="toc-text">memset()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#scanf"><span class="toc-number">8.3.3.2.</span> <span class="toc-text">scanf()</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#add-esp-10h"><span class="toc-number">8.3.3.3.</span> <span class="toc-text">add     esp, 10h</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#06-angr-symbolic-dynamic-memory"><span class="toc-number">9.</span> <span class="toc-text">06_angr_symbolic_dynamic_memory</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E8%BF%90%E8%A1%8C-3"><span class="toc-number">9.1.</span> <span class="toc-text">编译并运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-6"><span class="toc-number">9.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-7"><span class="toc-number">9.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-4"><span class="toc-number">9.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81-1"><span class="toc-number">9.3.2.</span> <span class="toc-text">去掉注释后的代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E5%9C%B0%E5%9D%80"><span class="toc-number">9.3.3.</span> <span class="toc-text">确定符号执行地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%AC%A6%E5%8F%B7"><span class="toc-number">9.3.4.</span> <span class="toc-text">创建符号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%BF%E6%8D%A2%E5%86%85%E5%AD%98"><span class="toc-number">9.3.5.</span> <span class="toc-text">替换内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5%E7%AC%A6%E5%8F%B7"><span class="toc-number">9.3.6.</span> <span class="toc-text">注入符号</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C-1"><span class="toc-number">9.3.7.</span> <span class="toc-text">符号执行</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%93%E6%9E%9C"><span class="toc-number">9.4.</span> <span class="toc-text">结果</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#07-angr-symbolic-file"><span class="toc-number">10.</span> <span class="toc-text">07_angr_symbolic_file</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E8%BF%90%E8%A1%8C-4"><span class="toc-number">10.1.</span> <span class="toc-text">编译并运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-7"><span class="toc-number">10.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E6%B1%82%E8%A7%A3"><span class="toc-number">10.3.</span> <span class="toc-text">使用Angr求解</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-5"><span class="toc-number">10.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81-2"><span class="toc-number">10.3.2.</span> <span class="toc-text">去掉注释后的代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0%E6%A8%A1%E6%8B%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E6%AD%A5%E9%AA%A4"><span class="toc-number">10.4.</span> <span class="toc-text">构造模拟文件系统的步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%87%86%E5%A4%87%E6%96%87%E4%BB%B6%E5%8F%82%E6%95%B0"><span class="toc-number">10.4.1.</span> <span class="toc-text">1. 准备文件参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BA%E7%AC%A6%E5%8F%B7%E4%BD%8D%E5%90%91%E9%87%8F"><span class="toc-number">10.4.2.</span> <span class="toc-text">2. 创建符号位向量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA%E7%AC%A6%E5%8F%B7%E6%96%87%E4%BB%B6"><span class="toc-number">10.4.3.</span> <span class="toc-text">3. 创建符号文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%B0%86%E7%AC%A6%E5%8F%B7%E6%96%87%E4%BB%B6%E6%B7%BB%E5%8A%A0%E5%88%B0%E6%A8%A1%E6%8B%9F%E7%B3%BB%E7%BB%9F%E4%B8%AD"><span class="toc-number">10.4.4.</span> <span class="toc-text">4. 将符号文件添加到模拟系统中</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#08-angr-constraints"><span class="toc-number">11.</span> <span class="toc-text">08_angr_constraints</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E8%BF%90%E8%A1%8C-5"><span class="toc-number">11.1.</span> <span class="toc-text">编译并运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-8"><span class="toc-number">11.2.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E5%87%BD%E6%95%B0"><span class="toc-number">11.2.1.</span> <span class="toc-text">主函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B7%9F%E8%BF%9Bcheck-equals-HXUITWOAPNESFFEG"><span class="toc-number">11.2.2.</span> <span class="toc-text">跟进check_equals_HXUITWOAPNESFFEG()</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-8"><span class="toc-number">11.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-6"><span class="toc-number">11.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81-3"><span class="toc-number">11.3.2.</span> <span class="toc-text">去掉注释后的代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E6%B7%BB%E5%8A%A0%E7%BA%A6%E6%9D%9F%E6%9D%A1%E4%BB%B6%E7%9A%84%E6%AD%A5%E9%AA%A4"><span class="toc-number">11.4.</span> <span class="toc-text">手动添加约束条件的步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%A1%AE%E5%AE%9A%E7%BA%A6%E6%9D%9F%E4%BB%80%E4%B9%88-%E6%80%8E%E4%B9%88%E7%BA%A6%E6%9D%9F"><span class="toc-number">11.4.1.</span> <span class="toc-text">1. 确定约束什么, 怎么约束</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%A1%AE%E5%AE%9A%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E4%BD%8D%E7%BD%AE"><span class="toc-number">11.4.1.1.</span> <span class="toc-text">2. 确定符号执行位置</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA%E7%AC%A6%E5%8F%B7%E5%B9%B6%E6%B3%A8%E5%85%A5"><span class="toc-number">11.4.2.</span> <span class="toc-text">3. 创建符号并注入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%8E%BB%E6%8E%89%E5%8E%9F%E6%9C%AC%E7%9A%84%E7%BA%A6%E6%9D%9F%E6%9D%A1%E4%BB%B6"><span class="toc-number">11.4.3.</span> <span class="toc-text">4. 去掉原本的约束条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E6%B7%BB%E5%8A%A0%E8%87%AA%E5%B7%B1%E7%9A%84%E7%BA%A6%E6%9D%9F%E6%9D%A1%E4%BB%B6"><span class="toc-number">11.4.4.</span> <span class="toc-text">5. 添加自己的约束条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E6%B1%82%E8%A7%A3"><span class="toc-number">11.4.5.</span> <span class="toc-text">6. 求解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#09-angr-hooks"><span class="toc-number">12.</span> <span class="toc-text">09_angr_hooks</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E8%BF%90%E8%A1%8C-6"><span class="toc-number">12.1.</span> <span class="toc-text">编译并运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-9"><span class="toc-number">12.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E6%9D%A5%E8%A7%A3%E9%A2%98"><span class="toc-number">12.3.</span> <span class="toc-text">使用Angr来解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-7"><span class="toc-number">12.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81-4"><span class="toc-number">12.3.2.</span> <span class="toc-text">去掉注释后的代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E5%AE%9E%E7%8E%B0Hook%E8%BF%87%E7%A8%8B"><span class="toc-number">12.4.</span> <span class="toc-text">使用Angr实现Hook过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%A1%AE%E5%AE%9A%E8%A6%81Hook%E5%87%BD%E6%95%B0%E7%9A%84%E8%B0%83%E7%94%A8%E5%9C%B0%E5%9D%80"><span class="toc-number">12.4.1.</span> <span class="toc-text">1. 确定要Hook函数的调用地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%BC%80%E5%A7%8BHook-%E5%B9%B6%E4%BF%9D%E8%AF%81Hook%E5%90%8E%E7%A8%8B%E5%BA%8F%E8%83%BD%E5%A4%9F%E6%AD%A3%E5%B8%B8%E8%BF%90%E8%A1%8C"><span class="toc-number">12.4.2.</span> <span class="toc-text">2. 开始Hook, 并保证Hook后程序能够正常运行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%AE%9A%E4%B9%89Hook%E5%87%BD%E6%95%B0"><span class="toc-number">12.4.3.</span> <span class="toc-text">3. 定义Hook函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10-angr-simprocedures"><span class="toc-number">13.</span> <span class="toc-text">10_angr_simprocedures</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E8%BF%90%E8%A1%8C-7"><span class="toc-number">13.1.</span> <span class="toc-text">编译并运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-10"><span class="toc-number">13.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-9"><span class="toc-number">13.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-8"><span class="toc-number">13.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81-5"><span class="toc-number">13.3.2.</span> <span class="toc-text">去掉注释后的代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E5%AE%9E%E7%8E%B0Hook%E5%87%BD%E6%95%B0%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">13.4.</span> <span class="toc-text">使用Angr实现Hook函数的过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E7%BB%A7%E6%89%BFangr-SimProcedure%E7%9A%84%E7%B1%BB-%E4%BB%A5%E6%AD%A4%E4%BD%BF%E7%94%A8SimProcedure"><span class="toc-number">13.4.1.</span> <span class="toc-text">1. 定义一个继承angr.SimProcedure的类, 以此使用SimProcedure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%9A%E4%B9%89%E6%88%91%E4%BB%AC%E8%87%AA%E5%B7%B1%E7%9A%84Hook%E5%87%BD%E6%95%B0"><span class="toc-number">13.4.2.</span> <span class="toc-text">2. 定义我们自己的Hook函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%89%A7%E8%A1%8CHook%E5%87%BD%E6%95%B0"><span class="toc-number">13.4.3.</span> <span class="toc-text">3. 执行Hook函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11-angr-sim-scanf"><span class="toc-number">14.</span> <span class="toc-text">11_angr_sim_scanf</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E8%BF%90%E8%A1%8C-8"><span class="toc-number">14.1.</span> <span class="toc-text">编译并运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-11"><span class="toc-number">14.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-10"><span class="toc-number">14.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-9"><span class="toc-number">14.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81-6"><span class="toc-number">14.3.2.</span> <span class="toc-text">去掉注释后的代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hook%E6%B5%81%E7%A8%8B"><span class="toc-number">14.4.</span> <span class="toc-text">Hook流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%85%A5"><span class="toc-number">14.4.1.</span> <span class="toc-text">存入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%96%E5%87%BA%E5%B9%B6%E7%BA%A6%E6%9D%9F"><span class="toc-number">14.4.2.</span> <span class="toc-text">取出并约束</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12-angr-veritesting"><span class="toc-number">15.</span> <span class="toc-text">12_angr_veritesting</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E8%BF%90%E8%A1%8C-9"><span class="toc-number">15.1.</span> <span class="toc-text">编译并运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-12"><span class="toc-number">15.2.</span> <span class="toc-text">分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#veritesting"><span class="toc-number">15.2.1.</span> <span class="toc-text">veritesting</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-11"><span class="toc-number">15.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-10"><span class="toc-number">15.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81-7"><span class="toc-number">15.3.2.</span> <span class="toc-text">去掉注释后的代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13-angr-static-binary"><span class="toc-number">16.</span> <span class="toc-text">13_angr_static_binary</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E8%BF%90%E8%A1%8C-10"><span class="toc-number">16.1.</span> <span class="toc-text">编译并运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-13"><span class="toc-number">16.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-12"><span class="toc-number">16.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-11"><span class="toc-number">16.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81-8"><span class="toc-number">16.3.2.</span> <span class="toc-text">去掉注释后的代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14-angr-shared-library"><span class="toc-number">17.</span> <span class="toc-text">14_angr_shared_library</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91-%E5%8A%A8%E6%80%81%E5%BA%93%E7%9B%B4%E6%8E%A5%E8%BF%90%E8%A1%8C%E4%B8%8D%E4%BA%86"><span class="toc-number">17.1.</span> <span class="toc-text">编译(动态库直接运行不了)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-14"><span class="toc-number">17.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-13"><span class="toc-number">17.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-12"><span class="toc-number">17.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81-9"><span class="toc-number">17.3.2.</span> <span class="toc-text">去掉注释后的代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8Cso%E6%96%87%E4%BB%B6%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">17.4.</span> <span class="toc-text">符号执行so文件的过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%BE%E5%88%B0%E8%A6%81%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E7%9A%84%E5%87%BD%E6%95%B0%E7%9A%84%E5%9C%B0%E5%9D%80-%E8%AE%B0%E5%BE%97%E5%8A%A0%E4%B8%8A%E5%9F%BA%E5%9D%80"><span class="toc-number">17.4.1.</span> <span class="toc-text">找到要符号执行的函数的地址(记得加上基址)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%8F%82%E6%95%B0-%E7%AC%A6%E5%8F%B7%E4%BD%8D%E5%90%91%E9%87%8F-%E5%B9%B6%E6%A8%A1%E6%8B%9F%E8%B0%83%E7%94%A8validate"><span class="toc-number">17.4.2.</span> <span class="toc-text">创建参数(符号位向量), 并模拟调用validate</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E5%85%A5buffer%E7%9A%84%E7%AC%A6%E5%8F%B7%E4%BD%8D%E5%90%91%E9%87%8F"><span class="toc-number">17.4.3.</span> <span class="toc-text">注入buffer的符号位向量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C-2"><span class="toc-number">17.4.4.</span> <span class="toc-text">符号执行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#15-angr-arbitrary-read"><span class="toc-number">18.</span> <span class="toc-text">15_angr_arbitrary_read</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E8%BF%90%E8%A1%8C-11"><span class="toc-number">18.1.</span> <span class="toc-text">编译并运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-15"><span class="toc-number">18.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-14"><span class="toc-number">18.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-13"><span class="toc-number">18.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81-10"><span class="toc-number">18.3.2.</span> <span class="toc-text">去掉注释后的代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E6%89%BE%E6%BC%8F%E6%B4%9E%E6%80%9D%E8%B7%AF"><span class="toc-number">18.4.</span> <span class="toc-text">查找漏洞思路</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Hook-scanf"><span class="toc-number">18.4.1.</span> <span class="toc-text">Hook scanf()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89check-puts"><span class="toc-number">18.4.2.</span> <span class="toc-text">定义check_puts()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%BE%E5%88%B0%E7%9B%AE%E6%A0%87%E6%89%93%E5%8D%B0%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">18.4.3.</span> <span class="toc-text">找到目标打印字符串</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E7%8A%B6%E6%80%81-%E6%A3%80%E9%AA%8C%E6%98%AF%E5%90%A6%E6%BB%A1%E8%B6%B3%E6%9D%A1%E4%BB%B6"><span class="toc-number">18.4.4.</span> <span class="toc-text">复制状态, 检验是否满足条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E5%8F%AF%E6%BB%A1%E8%B6%B3-%E5%88%99%E7%BB%99%E5%BD%93%E5%89%8D%E7%8A%B6%E6%80%81%E6%B7%BB%E5%8A%A0%E7%BA%A6%E6%9D%9F"><span class="toc-number">18.4.5.</span> <span class="toc-text">如果可满足, 则给当前状态添加约束</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E9%83%A8%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C-%E5%B9%B6%E7%BA%A6%E6%9D%9F%E6%B1%82%E8%A7%A3"><span class="toc-number">18.4.6.</span> <span class="toc-text">外部符号执行, 并约束求解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#16-angr-arbitrary-write"><span class="toc-number">19.</span> <span class="toc-text">16_angr_arbitrary_write</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E6%89%A7%E8%A1%8C-2"><span class="toc-number">19.1.</span> <span class="toc-text">编译并执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-16"><span class="toc-number">19.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-15"><span class="toc-number">19.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-14"><span class="toc-number">19.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81-11"><span class="toc-number">19.3.2.</span> <span class="toc-text">去掉注释后的代码</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B"><span class="toc-number">19.4.</span> <span class="toc-text">解题过程:</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Hook%E6%8E%89scanf-%E5%AE%9E%E7%8E%B0%E4%B8%A4%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E7%AC%A6%E5%8F%B7%E5%8C%96"><span class="toc-number">19.4.1.</span> <span class="toc-text">1. Hook掉scanf, 实现两个参数的符号化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%AE%9A%E4%B9%89check-strncpy-state"><span class="toc-number">19.4.2.</span> <span class="toc-text">2. 定义check_strncpy(state)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%A0%B9%E6%8D%AE%E5%BD%93%E5%89%8D%E7%9A%84state%E8%8E%B7%E5%8F%96esp-%E4%BB%8E%E8%80%8C%E8%8E%B7%E5%8F%96%E5%8F%82%E6%95%B0%E5%80%BC"><span class="toc-number">19.4.3.</span> <span class="toc-text">3. 根据当前的state获取esp, 从而获取参数值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E8%8E%B7%E5%8F%96src%E7%9A%84%E5%86%85%E5%AE%B9-%E5%8D%B3%E6%88%91%E4%BB%AC%E4%B8%BA%E6%BA%A2%E5%87%BA%E7%9A%84%E8%BE%93%E5%85%A5"><span class="toc-number">19.4.4.</span> <span class="toc-text">4. 获取src的内容(即我们为溢出的输入)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E9%AA%8C%E8%AF%81%E7%AC%A6%E5%8F%B7%E5%8C%96-%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E6%BA%A2%E5%87%BA"><span class="toc-number">19.4.5.</span> <span class="toc-text">5. 验证符号化(验证是否溢出)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E8%BF%9B%E4%B8%80%E6%AD%A5%E7%BA%A6%E6%9D%9F"><span class="toc-number">19.4.6.</span> <span class="toc-text">6. 进一步约束</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E6%A3%80%E9%AA%8C%E6%98%AF%E5%90%A6%E6%BB%A1%E8%B6%B3%E6%9D%A1%E4%BB%B6"><span class="toc-number">19.4.7.</span> <span class="toc-text">7. 检验是否满足条件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#17-angr-arbitrary-jump"><span class="toc-number">20.</span> <span class="toc-text">17_angr_arbitrary_jump</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E5%B9%B6%E8%BF%90%E8%A1%8C-12"><span class="toc-number">20.1.</span> <span class="toc-text">编译并运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90-17"><span class="toc-number">20.2.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8Angr%E8%A7%A3%E9%A2%98-16"><span class="toc-number">20.3.</span> <span class="toc-text">使用Angr解题</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81-15"><span class="toc-number">20.3.1.</span> <span class="toc-text">代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%BB%E6%8E%89%E6%B3%A8%E9%87%8A%E5%90%8E%E7%9A%84%E4%BB%A3%E7%A0%81-12"><span class="toc-number">20.3.2.</span> <span class="toc-text">去掉注释后的代码</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Angr-Lab%E5%B8%B8%E7%94%A8%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">21.</span> <span class="toc-text">Angr_Lab常用的函数</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#angr-Project-path-to-binary"><span class="toc-number">21.1.</span> <span class="toc-text">angr.Project(path_to_binary)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B"><span class="toc-number">21.1.1.</span> <span class="toc-text">使用示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#project-factory-entry-state-add-options"><span class="toc-number">21.2.</span> <span class="toc-text">project.factory.entry_state(add_options &#x3D; {})</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">21.2.1.</span> <span class="toc-text">使用示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#project-factory-blank-state-addr-add-options"><span class="toc-number">21.3.</span> <span class="toc-text">project.factory.blank_state(addr &#x3D; , add_options &#x3D; {})</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-2"><span class="toc-number">21.3.1.</span> <span class="toc-text">使用示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#claripy-BVS-%E2%80%98%E2%80%99-num"><span class="toc-number">21.4.</span> <span class="toc-text">claripy.BVS(‘’, num)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-3"><span class="toc-number">21.4.1.</span> <span class="toc-text">使用示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#simulation-explore-find-avoid"><span class="toc-number">21.5.</span> <span class="toc-text">simulation.explore(find&#x3D; , avoid&#x3D;)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9C%B0%E5%9D%80%E4%B8%BA%E5%8F%82%E6%95%B0"><span class="toc-number">21.5.1.</span> <span class="toc-text">使用地址为参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E4%BD%9C%E4%B8%BA%E5%8F%82%E6%95%B0"><span class="toc-number">21.5.2.</span> <span class="toc-text">使用回调函数作为参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#solution-state-posix-dumps-sys-stdin-fileno"><span class="toc-number">21.6.</span> <span class="toc-text">solution_state.posix.dumps(sys.stdin.fileno())</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-4"><span class="toc-number">21.6.1.</span> <span class="toc-text">使用示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#solution-state-add-constraints-solution-state-xx"><span class="toc-number">21.7.</span> <span class="toc-text">solution_state.add_constraints( solution_state.xx)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-5"><span class="toc-number">21.7.1.</span> <span class="toc-text">使用示例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#solution-state-solver-eval-symbol"><span class="toc-number">21.8.</span> <span class="toc-text">solution_state.solver.eval(symbol)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%A4%BA%E4%BE%8B-6"><span class="toc-number">21.8.1.</span> <span class="toc-text">使用示例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E6%95%B0"><span class="toc-number">21.8.1.1.</span> <span class="toc-text">整数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">21.8.1.2.</span> <span class="toc-text">字符串</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://s4.ax1x.com/2021/12/07/oyWTJA.jpg"></div><div class="author-info__name text-center">LamのCrow</div><div class="author-info__description text-center">欢迎交流!!!</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">39</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">4</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://space.bilibili.com/202089320">MyBIlibili</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://sma11cc.github.io/">smallcc</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s4.ax1x.com/2021/12/06/oy2VdH.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">LamのCrow</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Angr_Lab</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-18</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="Angr-Lab"><a href="#Angr-Lab" class="headerlink" title="Angr_Lab"></a>Angr_Lab</h1><span id="more"></span>

<h1 id="实验准备"><a href="#实验准备" class="headerlink" title="实验准备"></a>实验准备</h1><h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>首先是每个关卡都有一个独立的文件夹, 里面会有一个形似<code>00_angr_find.c.jinja</code>的文件, 这是还未编译的文件, 我们需要手动编译, 而Angr_Lab提供了编译生成脚本<code>generate.py</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python generate.py 1234 00_angr_find</span><br><span class="line">其中1234是我们输入的一个随机数, 最后一个参数就是我们要输出编译的文件</span><br></pre></td></tr></table></figure>

<h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><p>在编译得到可执行文件后, 我们可以先尝试运行.</p>
<p>在WSL上运行生成的可执行文件(为32位程序, 需要安装32位运行库, 同时需要WSL2)</p>
<p>可以看到是输入flag, 正确则为Good Job, 错误则为Try again</p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>使用IDA分析程序逻辑, 找到接收的执行路径地址等等…</p>
<h2 id="使用Angr解题"><a href="#使用Angr解题" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><p>在同文件下有一个<code>scaffold00.py</code>文件, 里面有Angr解题的基本框架, 同时还有很多的提示以及知识点.我们根据这些去解题.</p>
<h1 id="00-angr-find"><a href="#00-angr-find" class="headerlink" title="00_angr_find"></a>00_angr_find</h1><p>我们在编译得到了可执行文件后首先分析</p>
<h2 id="main"><a href="#main" class="headerlink" title="main()"></a>main()</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  int i; // [esp+1Ch] [ebp-1Ch]</span><br><span class="line">  char s1[9]; // [esp+23h] [ebp-15h] BYREF</span><br><span class="line">  unsigned int v6; // [esp+2Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v6 = __readgsdword(0x14u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%8s&quot;</span>, s1);</span><br><span class="line">  <span class="keyword">for</span> ( i = 0; i &lt;= 7; ++i )</span><br><span class="line">    s1[i] = complex_function(s1[i], i);</span><br><span class="line">  <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;HXUITWOA&quot;</span>) )</span><br><span class="line">    puts(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    puts(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>找到加密函数后跟进查看</p>
<h2 id="complex-function-int-a1-int-a2"><a href="#complex-function-int-a1-int-a2" class="headerlink" title="complex_function(int a1, int a2)"></a>complex_function(int a1, int a2)</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl complex_function(int a1, int a2)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1 &lt;= 64 || a1 &gt; 90 )                    // 首先判断是否是小写字母以及@</span><br><span class="line">  &#123;</span><br><span class="line">    puts(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(1);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">return</span> (3 * a2 + a1 - 65) % 26 + 65;          // 然后进行运算</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="汇编查看”Good-Job”的地址"><a href="#汇编查看”Good-Job”的地址" class="headerlink" title="汇编查看”Good Job”的地址"></a>汇编查看”Good Job”的地址</h2><p>最终打印”Good Job”字符串的汇编语句在mian()函数中, 我们查看mian()反汇编</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">; <span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function">.text:08049242                 <span class="keyword">public</span> main</span></span><br><span class="line"><span class="function">.text:08049242 main            proc near               </span>; DATA XREF: _start+<span class="number">2</span>A↑o</span><br><span class="line">.text:<span class="number">08049242</span></span><br><span class="line">.text:<span class="number">08049242</span> var_2C          = dword ptr <span class="number">-2</span>Ch</span><br><span class="line">.text:<span class="number">08049242</span> var_1C          = dword ptr <span class="number">-1</span>Ch</span><br><span class="line">.text:<span class="number">08049242</span> s1              = byte ptr <span class="number">-15</span>h</span><br><span class="line">.text:<span class="number">08049242</span> var_C           = dword ptr <span class="number">-0</span>Ch</span><br><span class="line">.text:<span class="number">08049242</span> var_4           = dword ptr <span class="number">-4</span></span><br><span class="line">.text:<span class="number">08049242</span> argc            = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">08049242</span> argv            = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049242</span> envp            = dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049242</span></span><br><span class="line">.text:<span class="number">08049242</span> ; __unwind &#123;</span><br><span class="line">.text:<span class="number">08049242</span>                 lea     ecx, [esp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">08049246</span>                 <span class="keyword">and</span>     esp, <span class="number">0F</span>FFFFFF0h</span><br><span class="line">.text:<span class="number">08049249</span>                 push    dword ptr [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">0804924</span>C                 push    ebp</span><br><span class="line">.text:<span class="number">0804924</span>D                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">0804924F</span>                 push    ecx</span><br><span class="line">.text:<span class="number">08049250</span>                 sub     esp, <span class="number">34</span>h</span><br><span class="line">.text:<span class="number">08049253</span>                 mov     eax, ecx</span><br><span class="line">.text:<span class="number">08049255</span>                 mov     eax, [eax+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">08049258</span>                 mov     [ebp+var_2C], eax</span><br><span class="line">.text:<span class="number">0804925B</span>                 mov     eax, large gs:<span class="number">14</span>h</span><br><span class="line">.text:<span class="number">08049261</span>                 mov     [ebp+var_C], eax</span><br><span class="line">.text:<span class="number">08049264</span>                 <span class="keyword">xor</span>     eax, eax</span><br><span class="line">.text:<span class="number">08049266</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049269</span>                 push    offset aEnterThePasswo ; <span class="string">&quot;Enter the password: &quot;</span></span><br><span class="line">.text:<span class="number">0804926</span>E                 call    _printf</span><br><span class="line">.text:<span class="number">08049273</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049276</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">08049279</span>                 lea     eax, [ebp+s1]</span><br><span class="line">.text:<span class="number">0804927</span>C                 push    eax</span><br><span class="line">.text:<span class="number">0804927</span>D                 push    offset a8s      ; <span class="string">&quot;%8s&quot;</span></span><br><span class="line">.text:<span class="number">08049282</span>                 call    ___isoc99_scanf</span><br><span class="line">.text:<span class="number">08049287</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804928</span>A                 mov     [ebp+var_1C], <span class="number">0</span></span><br><span class="line">.text:<span class="number">08049291</span>                 jmp     <span class="keyword">short</span> loc_80492C0</span><br><span class="line">.text:<span class="number">08049293</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049293</span></span><br><span class="line">.text:<span class="number">08049293</span> loc_8049293:                            ; CODE XREF: main+<span class="number">82</span>↓j</span><br><span class="line">.text:<span class="number">08049293</span>                 lea     edx, [ebp+s1]</span><br><span class="line">.text:<span class="number">08049296</span>                 mov     eax, [ebp+var_1C]</span><br><span class="line">.text:<span class="number">08049299</span>                 add     eax, edx</span><br><span class="line">.text:<span class="number">0804929B</span>                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">0804929</span>E                 movsx   eax, al</span><br><span class="line">.text:<span class="number">080492</span>A1                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080492</span>A4                 push    [ebp+var_1C]</span><br><span class="line">.text:<span class="number">080492</span>A7                 push    eax</span><br><span class="line">.text:<span class="number">080492</span>A8                 call    complex_function</span><br><span class="line">.text:<span class="number">080492</span>AD                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080492B</span>0                 mov     ecx, eax</span><br><span class="line">.text:<span class="number">080492B</span>2                 lea     edx, [ebp+s1]</span><br><span class="line">.text:<span class="number">080492B</span>5                 mov     eax, [ebp+var_1C]</span><br><span class="line">.text:<span class="number">080492B</span>8                 add     eax, edx</span><br><span class="line">.text:<span class="number">080492B</span>A                 mov     [eax], cl</span><br><span class="line">.text:<span class="number">080492B</span>C                 add     [ebp+var_1C], <span class="number">1</span></span><br><span class="line">.text:<span class="number">080492</span>C0</span><br><span class="line">.text:<span class="number">080492</span>C0 loc_80492C0:                            ; CODE XREF: main+<span class="number">4F</span>↑j</span><br><span class="line">.text:<span class="number">080492</span>C0                 cmp     [ebp+var_1C], <span class="number">7</span></span><br><span class="line">.text:<span class="number">080492</span>C4                 jle     <span class="keyword">short</span> loc_8049293</span><br><span class="line">.text:<span class="number">080492</span>C6                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080492</span>C9                 push    offset s2       ; <span class="string">&quot;HXUITWOA&quot;</span></span><br><span class="line">.text:<span class="number">080492</span>CE                 lea     eax, [ebp+s1]</span><br><span class="line">.text:<span class="number">080492</span>D1                 push    eax             ; s1</span><br><span class="line">.text:<span class="number">080492</span>D2                 call    _strcmp</span><br><span class="line">.text:<span class="number">080492</span>D7                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080492</span>DA                 test    eax, eax</span><br><span class="line">.text:<span class="number">080492</span>DC                 jz      <span class="keyword">short</span> loc_80492F0</span><br><span class="line">.text:<span class="number">080492</span>DE                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080492E1</span>                 push    offset s        ; <span class="string">&quot;Try again.&quot;</span></span><br><span class="line">.text:<span class="number">080492E6</span>                 call    _puts</span><br><span class="line">.text:<span class="number">080492</span>EB                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080492</span>EE                 jmp     <span class="keyword">short</span> loc_8049300</span><br><span class="line">.text:<span class="number">080492F</span>0 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">080492F</span>0</span><br><span class="line">.text:<span class="number">080492F</span>0 loc_80492F0:                            ; CODE XREF: main+<span class="number">9</span>A↑j</span><br><span class="line">.text:<span class="number">080492F</span>0                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080492F</span>3                 push    offset aGoodJob ; <span class="string">&quot;Good Job.&quot;</span></span><br><span class="line">.text:<span class="number">080492F</span>8                 call    _puts</span><br><span class="line">.text:<span class="number">080492F</span>D                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049300</span></span><br><span class="line">.text:<span class="number">08049300</span> loc_8049300:                            ; CODE XREF: main+AC↑j</span><br><span class="line">.text:<span class="number">08049300</span>                 mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">08049305</span>                 mov     ecx, [ebp+var_C]</span><br><span class="line">.text:<span class="number">08049308</span>                 <span class="keyword">xor</span>     ecx, large gs:<span class="number">14</span>h</span><br><span class="line">.text:<span class="number">0804930F</span>                 jz      <span class="keyword">short</span> loc_8049316</span><br><span class="line">.text:<span class="number">08049311</span>                 call    ___stack_chk_fail</span><br><span class="line">.text:<span class="number">08049316</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049316</span></span><br><span class="line">.text:<span class="number">08049316</span> loc_8049316:                            ; CODE XREF: main+CD↑j</span><br><span class="line">.text:<span class="number">08049316</span>                 mov     ecx, [ebp+var_4]</span><br><span class="line">.text:<span class="number">08049319</span>                 leave</span><br><span class="line">.text:<span class="number">0804931</span>A                 lea     esp, [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">0804931</span>D                 retn</span><br><span class="line">.text:<span class="number">0804931</span>D ; &#125; <span class="comment">// starts at 8049242</span></span><br><span class="line">.text:<span class="number">0804931</span>D main            endp</span><br><span class="line">.text:<span class="number">0804931</span>D</span><br><span class="line">.text:<span class="number">0804931</span>D ; ---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>可以看到我们要找的是: <code>.text:080492F3                 push    offset aGoodJob ; &quot;Good Job.&quot;</code></p>
<h2 id="使用Angr解题-1"><a href="#使用Angr解题-1" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><p>在了解了程序的大致逻辑以后, 我们打开<code>scaffold00.py</code>使用Angr来解题</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Before you begin, here are a few notes about these capture-the-flag</span></span><br><span class="line"><span class="comment"># challenges.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Each binary, when run, will ask for a password, which can be entered via stdin</span></span><br><span class="line"><span class="comment"># (typing it into the console.) Many of the levels will accept many different</span></span><br><span class="line"><span class="comment"># passwords. Your goal is to find a single password that works for each binary.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you enter an incorrect password, the program will print &quot;Try again.&quot; If you</span></span><br><span class="line"><span class="comment"># enter a correct password, the program will print &quot;Good Job.&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Each challenge will be accompanied by a file like this one, named</span></span><br><span class="line"><span class="comment"># &quot;scaffoldXX.py&quot;. It will offer guidance as well as the skeleton of a possible</span></span><br><span class="line"><span class="comment"># solution. You will have to edit each file. In some cases, you will have to</span></span><br><span class="line"><span class="comment"># edit it significantly. While use of these files is recommended, you can write</span></span><br><span class="line"><span class="comment"># a solution without them, if you find that they are too restrictive.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Places in the scaffoldXX.py that require a simple substitution will be marked</span></span><br><span class="line"><span class="comment"># with three question marks (???). Places that require more code will be marked</span></span><br><span class="line"><span class="comment"># with an ellipsis (...). Comments will document any new concepts, but will be</span></span><br><span class="line"><span class="comment"># omitted for concepts that have already been covered (you will need to use</span></span><br><span class="line"><span class="comment"># previous scaffoldXX.py files as a reference to solve the challenges.) If a</span></span><br><span class="line"><span class="comment"># comment documents a part of the code that needs to be changed, it will be</span></span><br><span class="line"><span class="comment"># marked with an exclamation point at the end, on a separate line (!).</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在开始之前, 这里有一些关于CTF挑战的注意事项</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#每个二进制文件在运行时都会要求输入密码, 不同关卡有不同的密码(flag), 你的目标就是找到flag</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#如果输入flag是错误的, 打印&quot;Try again&quot;; 如果输入flag正确, 则打印&quot;Good Job&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#每个挑战都会附带一个类似&quot;scaffoldXX.py&quot;, 它将提供指导以及可能的解决方案的框架.你必须取编辑每个文件.</span></span><br><span class="line"><span class="comment">#在某些情况下, 你将必须去进行大量的编辑. 虽然建议使用这些文件, 但是如果你发现它们限制了你, 你用自己</span></span><br><span class="line"><span class="comment">#的方式去编写</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#&quot;???&quot;表示这里需要替换为其他内容, &quot;...&quot;表示这里需要跟多代码, &quot;!&quot;表示下面的代码将需要修改</span></span><br><span class="line"><span class="comment">#有新概念的地方会有注释, 但是已经讲过的概念不会再重复(你需要将以前的scaffoldXX.py的内容作为参考来解决)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  <span class="comment"># Create an Angr project.创建一个Angr项目</span></span><br><span class="line">  <span class="comment"># If you want to be able to point to the binary from the command line, you can</span></span><br><span class="line">  <span class="comment"># use argv[1] as the parameter. Then, you can run the script from the command</span></span><br><span class="line">  <span class="comment"># line as follows:</span></span><br><span class="line">  <span class="comment">#如果你想能够从命令行指向二进制文件, 可以使用argv[1]作为参数. 然后你从命令行运行脚本, 如下所示:</span></span><br><span class="line">  <span class="comment"># python ./scaffold00.py [binary]</span></span><br><span class="line">  <span class="comment">#意思就是你可以在打开文件的时候在后面加上一个参数, 这个参数是需要解的文件, 然后path_to_binary = argv[1]</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]  <span class="comment"># :string</span></span><br><span class="line">  project = angr.Project(path_to_binary)<span class="comment">#创建Angr项目, 参数一个文件路径</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Tell Angr where to start executing (should it start from the main()</span></span><br><span class="line">  <span class="comment"># function or somewhere else?) For now, use the entry_state function</span></span><br><span class="line">  <span class="comment"># to instruct Angr to start from the main() function.</span></span><br><span class="line">  <span class="comment">#告诉Angr应该从哪里开始执行(应该从main()函数还是其他地方开始执行), 下面使用entry_state函数指示Angr从main()函数开始</span></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,<span class="comment">#符号 填充 不受限制的 内存</span></span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;<span class="comment">#符号 填充 不受限制的 寄存器</span></span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Create a simulation manager initialized with the starting state. It provides</span></span><br><span class="line">  <span class="comment"># a number of useful tools to search and execute the binary.</span></span><br><span class="line">  <span class="comment"># 创建一个初始化为&quot;起始状态&quot;的模拟管理器. 它提供了大量的工具去搜索和执行二进制文件</span></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Explore the binary to attempt to find the address that prints &quot;Good Job.&quot;</span></span><br><span class="line">  <span class="comment"># You will have to find the address you want to find and insert it here. </span></span><br><span class="line">  <span class="comment"># This function will keep executing until it either finds a solution or it </span></span><br><span class="line">  <span class="comment"># has explored every possible path through the executable.</span></span><br><span class="line">  <span class="comment"># 探索二进制文件以尝试找到打印&quot;Good Job&quot;的地址. 你必须找到你想要搜索的地址并将该地址赋给print_good_address变量</span></span><br><span class="line">  <span class="comment"># 此函数将继续执行, 直到找到解决方案或探索了可执行文件的所有可能路径</span></span><br><span class="line">  <span class="comment"># (!)下面有需要修改的地址</span></span><br><span class="line">  print_good_address = <span class="number">0x080492F3</span>  <span class="comment"># :integer (probably in hexadecimal)</span></span><br><span class="line">  simulation.explore(find=print_good_address)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Check that we have found a solution. The simulation.explore() method will</span></span><br><span class="line">  <span class="comment"># set simulation.found to a list of the states that it could find that reach</span></span><br><span class="line">  <span class="comment"># the instruction we asked it to search for. Remember, in Python, if a list</span></span><br><span class="line">  <span class="comment"># is empty, it will be evaluated as false, otherwise true.</span></span><br><span class="line">  <span class="comment"># 检查我们是否找到了解决方案, simulation.explore()方法把simulation.found设置为一个&lt;状态列表&gt;</span></span><br><span class="line">  <span class="comment"># 它可以找到我们要求它搜索的指令的状态. 请记住: 在Python中, 如果列表为空, 它将被判断为false, 否则为true</span></span><br><span class="line">  <span class="keyword">if</span> simulation.found:<span class="comment">#类似于全局变量在simulation.explore中被设置成了我们想要的执行状态</span></span><br><span class="line">    <span class="comment"># The explore method stops after it finds a single state that arrives at the</span></span><br><span class="line">    <span class="comment"># target address.</span></span><br><span class="line">    <span class="comment"># explore方法找到目标地址的单个状态后停止</span></span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Print the string that Angr wrote to stdin to follow solution_state. This </span></span><br><span class="line">    <span class="comment"># is our solution.</span></span><br><span class="line">    <span class="comment"># 打印Angr写入标准输入的字符串以跟随solution_state, 这就是我们的解决方案</span></span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="comment"># If Angr could not find a path that reaches print_good_address, throw an</span></span><br><span class="line">    <span class="comment"># error. Perhaps you mistyped the print_good_address?</span></span><br><span class="line">    <span class="comment"># 如果Angr不能找到一条到达print_good_address, 则抛出一个error.</span></span><br><span class="line">    <span class="comment">#也许是你写错了print_good_address</span></span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="把注释去掉以后"><a href="#把注释去掉以后" class="headerlink" title="把注释去掉以后"></a>把注释去掉以后</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  print_good_address = <span class="number">0x080492F3</span></span><br><span class="line">  simulation.explore(find=print_good_address)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="使用的流程"><a href="#使用的流程" class="headerlink" title="使用的流程"></a>使用的流程</h2><ul>
<li>找到目标程序, 并在该程序的基础上创建Angr项目</li>
<li>指定执行起点(符号应该是默认为标准输入了)</li>
<li>创建一个simulation来提供工具(方法)去搜索和执行二进制文件</li>
<li>通过上面的分析我们找到了”Good Job”的地址, 我们使用simulation提供的explore来设定”接受的执行路径”</li>
<li>explore后开始符号执行</li>
<li>最后搜索到的结果放在simulation.found(有点像是全局变量)中, 如果没搜索到found则为空对于if来讲就是false, 成功则为非空对于if来讲就是true.</li>
</ul>
<h1 id="01-angr-avoid"><a href="#01-angr-avoid" class="headerlink" title="01_angr_avoid"></a>01_angr_avoid</h1><h2 id="编译并执行"><a href="#编译并执行" class="headerlink" title="编译并执行"></a>编译并执行</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/<span class="number">01</span>_angr_avoid$ python3 generate.py <span class="number">1234</span> <span class="number">01</span>_angr_avoid</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/<span class="number">01</span>_angr_avoid$ ./<span class="number">01</span>_angr_avoid</span><br><span class="line">Enter the password: aaaaaaaaa</span><br><span class="line">Try again.</span><br></pre></td></tr></table></figure>

<h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><p>使用IDA查看</p>
<p>来到mian()函数, 可以看到很多的”应该避免的路径”, mian()代码非常庞大以至于IDA给出无法显示的警告</p>
<p><img src="/2022/05/18/AngrLab2c872/image1.png" alt="Untitled"></p>
<h3 id="“Good-Job”所在地址"><a href="#“Good-Job”所在地址" class="headerlink" title="“Good Job”所在地址"></a>“Good Job”所在地址</h3><p>我们使用字符串查找可以找到我们需要的”接受的执行路径”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">080492</span>CC ; <span class="function"><span class="keyword">int</span> __cdecl <span class="title">maybe_good</span><span class="params">(<span class="keyword">char</span> *s1, <span class="keyword">char</span> *s2)</span></span></span><br><span class="line"><span class="function">.text:080492CC                 <span class="keyword">public</span> maybe_good</span></span><br><span class="line"><span class="function">.text:080492CC maybe_good      proc near               </span>; CODE XREF: main+<span class="number">31</span>E↓p</span><br><span class="line">.text:<span class="number">080492</span>CC                                         ; main+<span class="number">336</span>↓p ...</span><br><span class="line">.text:<span class="number">080492</span>CC</span><br><span class="line">.text:<span class="number">080492</span>CC s1              = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">080492</span>CC s2              = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080492</span>CC</span><br><span class="line">.text:<span class="number">080492</span>CC ; __unwind &#123;</span><br><span class="line">.text:<span class="number">080492</span>CC                 endbr32</span><br><span class="line">.text:<span class="number">080492</span>D0                 push    ebp</span><br><span class="line">.text:<span class="number">080492</span>D1                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">080492</span>D3                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080492</span>D6                 movzx   eax, should_succeed</span><br><span class="line">.text:<span class="number">080492</span>DD                 test    al, al</span><br><span class="line">.text:<span class="number">080492</span>DF                 jz      <span class="keyword">short</span> loc_804930A</span><br><span class="line">.text:<span class="number">080492E1</span>                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">080492E4</span>                 push    <span class="number">8</span>               ; n</span><br><span class="line">.text:<span class="number">080492E6</span>                 push    [ebp+s2]        ; s2</span><br><span class="line">.text:<span class="number">080492E9</span>                 push    [ebp+s1]        ; s1</span><br><span class="line">.text:<span class="number">080492</span>EC                 call    _strncmp</span><br><span class="line">.text:<span class="number">080492F</span>1                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080492F</span>4                 test    eax, eax</span><br><span class="line">.text:<span class="number">080492F</span>6                 jnz     <span class="keyword">short</span> loc_804930A</span><br><span class="line">.text:<span class="number">080492F</span>8                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080492F</span>B                 push    offset aGoodJob ; <span class="string">&quot;Good Job.&quot;</span></span><br><span class="line">.text:<span class="number">08049300</span>                 call    _puts</span><br><span class="line">.text:<span class="number">08049305</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049308</span>                 jmp     <span class="keyword">short</span> loc_804931B</span><br><span class="line">.text:<span class="number">0804930</span>A ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0804930</span>A</span><br><span class="line">.text:<span class="number">0804930</span>A loc_804930A:                            ; CODE XREF: maybe_good+<span class="number">13</span>↑j</span><br><span class="line">.text:<span class="number">0804930</span>A                                         ; maybe_good+<span class="number">2</span>A↑j</span><br><span class="line">.text:<span class="number">0804930</span>A                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804930</span>D                 push    offset s        ; <span class="string">&quot;Try again.&quot;</span></span><br><span class="line">.text:<span class="number">08049312</span>                 call    _puts</span><br><span class="line">.text:<span class="number">08049317</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804931</span>A                 nop</span><br><span class="line">.text:<span class="number">0804931B</span></span><br><span class="line">.text:<span class="number">0804931B</span> loc_804931B:                            ; CODE XREF: maybe_good+<span class="number">3</span>C↑j</span><br><span class="line">.text:<span class="number">0804931B</span>                 nop</span><br><span class="line">.text:<span class="number">0804931</span>C                 leave</span><br><span class="line">.text:<span class="number">0804931</span>D                 retn</span><br><span class="line">.text:<span class="number">0804931</span>D ; &#125; <span class="comment">// starts at 80492CC</span></span><br><span class="line">.text:<span class="number">0804931</span>D maybe_good      endp</span><br></pre></td></tr></table></figure>

<p>可以看到我们要找的是:  <code>.text:080492FB                 push    offset aGoodJob ; &quot;Good Job.&quot;</code></p>
<h3 id="mian-函数"><a href="#mian-函数" class="headerlink" title="mian()函数"></a>mian()函数</h3><p>我们稍微分析以下main函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">; <span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function">.text:0804931E                 <span class="keyword">public</span> main</span></span><br><span class="line"><span class="function">.text:0804931E main            proc near               </span>; DATA XREF: _start+<span class="number">2</span>A↑o</span><br><span class="line">.text:<span class="number">0804931</span>E</span><br><span class="line">.text:<span class="number">0804931</span>E var_4C          = dword ptr <span class="number">-4</span>Ch</span><br><span class="line">.text:<span class="number">0804931</span>E j               = dword ptr <span class="number">-3</span>Ch</span><br><span class="line">.text:<span class="number">0804931</span>E i               = dword ptr <span class="number">-38</span>h</span><br><span class="line">.text:<span class="number">0804931</span>E input           = byte ptr <span class="number">-34</span>h</span><br><span class="line">.text:<span class="number">0804931</span>E s2              = byte ptr <span class="number">-20</span>h</span><br><span class="line">.text:<span class="number">0804931</span>E var_C           = dword ptr <span class="number">-0</span>Ch</span><br><span class="line">.text:<span class="number">0804931</span>E var_4           = dword ptr <span class="number">-4</span></span><br><span class="line">.text:<span class="number">0804931</span>E argc            = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">0804931</span>E argv            = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804931</span>E envp            = dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804931</span>E</span><br><span class="line">.text:<span class="number">0804931</span>E ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0804931</span>E                 endbr32</span><br><span class="line">.text:<span class="number">08049322</span>                 lea     ecx, [esp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">08049326</span>                 <span class="keyword">and</span>     esp, <span class="number">0F</span>FFFFFF0h</span><br><span class="line">.text:<span class="number">08049329</span>                 push    dword ptr [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">0804932</span>C                 push    ebp</span><br><span class="line">.text:<span class="number">0804932</span>D                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">0804932F</span>                 push    ecx</span><br><span class="line">.text:<span class="number">08049330</span>                 sub     esp, <span class="number">54</span>h</span><br><span class="line">.text:<span class="number">08049333</span>                 mov     eax, ecx</span><br><span class="line">.text:<span class="number">08049335</span>                 mov     eax, [eax+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">08049338</span>                 mov     [ebp+var_4C], eax</span><br><span class="line">.text:<span class="number">0804933B</span>                 mov     eax, large gs:<span class="number">14</span>h</span><br><span class="line">.text:<span class="number">08049341</span>                 mov     [ebp+var_C], eax</span><br><span class="line">.text:<span class="number">08049344</span>                 <span class="keyword">xor</span>     eax, eax</span><br><span class="line">.text:<span class="number">08049346</span>                 mov     [ebp+j], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0804934</span>D                 jmp     <span class="keyword">short</span> loc_804935E</span><br><span class="line">.text:<span class="number">0804934F</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0804934F</span></span><br><span class="line">.text:<span class="number">0804934F</span> loc_804934F:                            ; CODE XREF: main+<span class="number">44</span>↓j</span><br><span class="line">.text:<span class="number">0804934F</span>                 lea     edx, [ebp+s2]   ; s2数组初始化为<span class="number">0</span></span><br><span class="line">.text:<span class="number">08049352</span>                 mov     eax, [ebp+j]</span><br><span class="line">.text:<span class="number">08049355</span>                 add     eax, edx</span><br><span class="line">.text:<span class="number">08049357</span>                 mov     byte ptr [eax], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0804935</span>A                 add     [ebp+j], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0804935</span>E</span><br><span class="line">.text:<span class="number">0804935</span>E loc_804935E:                            ; CODE XREF: main+<span class="number">2F</span>↑j</span><br><span class="line">.text:<span class="number">0804935</span>E                 cmp     [ebp+j], <span class="number">13</span>h</span><br><span class="line">.text:<span class="number">08049362</span>                 jle     <span class="keyword">short</span> loc_804934F ; s2数组初始化为<span class="number">0</span></span><br><span class="line">.text:<span class="number">08049364</span>                 lea     eax, [ebp+s2]</span><br><span class="line">.text:<span class="number">08049367</span>                 mov     dword ptr [eax], <span class="number">57514</span>A4Dh</span><br><span class="line">.text:<span class="number">0804936</span>D                 mov     dword ptr [eax+<span class="number">4</span>], <span class="number">454</span>C4441h</span><br><span class="line">.text:<span class="number">08049374</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049377</span>                 push    offset aEnterThePasswo ; <span class="string">&quot;Enter the password: &quot;</span></span><br><span class="line">.text:<span class="number">0804937</span>C                 call    _printf</span><br><span class="line">.text:<span class="number">08049381</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049384</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">08049387</span>                 lea     eax, [ebp+input]</span><br><span class="line">.text:<span class="number">0804938</span>A                 push    eax             ; input</span><br><span class="line">.text:<span class="number">0804938B</span>                 push    offset a8s      ; <span class="string">&quot;%8s&quot;</span></span><br><span class="line">.text:<span class="number">08049390</span>                 call    ___isoc99_scanf</span><br><span class="line">.text:<span class="number">08049395</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049398</span>                 mov     [ebp+i], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0804939F</span>                 jmp     <span class="keyword">short</span> loc_80493CE ; i的初始值为<span class="number">0</span></span><br><span class="line">.text:<span class="number">080493</span>A1 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">080493</span>A1</span><br><span class="line">.text:<span class="number">080493</span>A1 loc_80493A1:                            ; CODE XREF: main+B4↓j</span><br><span class="line">.text:<span class="number">080493</span>A1                 lea     edx, [ebp+input]</span><br><span class="line">.text:<span class="number">080493</span>A4                 mov     eax, [ebp+i]</span><br><span class="line">.text:<span class="number">080493</span>A7                 add     eax, edx        ; i + input</span><br><span class="line">.text:<span class="number">080493</span>A9                 movzx   eax, byte ptr [eax] ; input[i]</span><br><span class="line">.text:<span class="number">080493</span>AC                 movsx   eax, al         ; 取单字节</span><br><span class="line">.text:<span class="number">080493</span>AF                 sub     esp, <span class="number">8</span>          ; 开辟栈空间</span><br><span class="line">.text:<span class="number">080493B</span>2                 push    [ebp+i]         ; 将i压入栈中</span><br><span class="line">.text:<span class="number">080493B</span>5                 push    eax             ; 将push[i]压入栈中</span><br><span class="line">.text:<span class="number">080493B</span>6                 call    complex_function ; complex_function(input[i], i);这个函数跟<span class="number">00</span>_angr_find是一样的</span><br><span class="line">.text:<span class="number">080493B</span>B                 add     esp, <span class="number">10</span>h        ; 调用者清理栈</span><br><span class="line">.text:<span class="number">080493B</span>E                 mov     ecx, eax        ; 返回值就是加密后的数据</span><br><span class="line">.text:<span class="number">080493</span>C0                 lea     edx, [ebp+input]</span><br><span class="line">.text:<span class="number">080493</span>C3                 mov     eax, [ebp+i]</span><br><span class="line">.text:<span class="number">080493</span>C6                 add     eax, edx        ; input + i</span><br><span class="line">.text:<span class="number">080493</span>C8                 mov     [eax], cl       ; input[i] = complex_function(input[i], i)</span><br><span class="line">.text:<span class="number">080493</span>CA                 add     [ebp+i], <span class="number">1</span></span><br><span class="line">.text:<span class="number">080493</span>CE</span><br><span class="line">.text:<span class="number">080493</span>CE loc_80493CE:                            ; CODE XREF: main+<span class="number">81</span>↑j</span><br><span class="line">.text:<span class="number">080493</span>CE                 cmp     [ebp+i], <span class="number">7</span>      ; i的初始值为<span class="number">0</span></span><br><span class="line">.text:<span class="number">080493</span>D2                 jle     <span class="keyword">short</span> loc_80493A1 ; <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; i++)</span><br><span class="line">.text:<span class="number">080493</span>D4                 lea     eax, [ebp+input] ; <span class="number">8</span>个数据加密完成后来到这里</span><br><span class="line">.text:<span class="number">080493</span>D7                 add     eax, <span class="number">1</span>          ; input + <span class="number">1</span></span><br><span class="line">.text:<span class="number">080493</span>DA                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">080493</span>DD                 movzx   eax, al         ; input[<span class="number">1</span>]</span><br><span class="line">.text:<span class="number">080493E0</span>                 <span class="keyword">and</span>     eax, <span class="number">10</span>h        ; input[<span class="number">1</span>] &amp; <span class="number">0x10</span>, 取高<span class="number">4</span>位</span><br><span class="line">.text:<span class="number">080493E3</span>                 test    eax, eax</span><br><span class="line">.text:<span class="number">080493E5</span>                 setz    dl              ; 如果高<span class="number">4</span>位为<span class="number">0</span>的话dl为<span class="number">1</span></span><br><span class="line">.text:<span class="number">080493E8</span>                 lea     eax, [ebp+s2]</span><br><span class="line">.text:<span class="number">080493</span>EB                 add     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">080493</span>EE                 movzx   eax, byte ptr [eax] ; s2[<span class="number">1</span>]</span><br><span class="line">.text:<span class="number">080493F</span>1                 movzx   eax, al</span><br><span class="line">.text:<span class="number">080493F</span>4                 <span class="keyword">and</span>     eax, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493F</span>7                 test    eax, eax</span><br><span class="line">.text:<span class="number">080493F</span>9                 setnz   al              ; 看s2[<span class="number">1</span>]高位是否为<span class="number">0</span></span><br><span class="line">.text:<span class="number">080493F</span>C                 <span class="keyword">xor</span>     eax, edx        ; s2[<span class="number">1</span>]必为<span class="number">0</span>, 所以input[<span class="number">1</span>]高位不为<span class="number">0</span>的话</span><br><span class="line">.text:<span class="number">080493F</span>E                 test    al, al          ; 则不跳转</span><br><span class="line">.text:<span class="number">08049400</span>                 jz      loc_808F34F     ; 可以看到跳转的地址就是avoidme</span><br></pre></td></tr></table></figure>

<h3 id="跟进跳转"><a href="#跟进跳转" class="headerlink" title="跟进跳转"></a>跟进跳转</h3><p>我们跟进地址为0x08049400地址处的条件跳转</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">loc_808F34F:                            ; CODE XREF: main+E2↑j</span><br><span class="line">.text:<span class="number">0808F</span>34F                 call    avoid_me</span><br><span class="line">.text:<span class="number">0808F</span>354                 lea     eax, [ebp+input]</span><br><span class="line">.text:<span class="number">0808F</span>357                 add     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0808F</span>35A                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">0808F</span>35D                 movzx   eax, al</span><br><span class="line">.text:<span class="number">0808F</span>360                 <span class="keyword">and</span>     eax, <span class="number">8</span></span><br><span class="line">.text:<span class="number">0808F</span>363                 test    eax, eax</span><br><span class="line">.text:<span class="number">0808F</span>365                 setz    dl</span><br><span class="line">.text:<span class="number">0808F</span>368                 lea     eax, [ebp+s2]</span><br><span class="line">.text:<span class="number">0808F</span>36B                 add     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0808F</span>36E                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">0808F</span>371                 movzx   eax, al</span><br><span class="line">.text:<span class="number">0808F</span>374                 <span class="keyword">and</span>     eax, <span class="number">8</span></span><br><span class="line">.text:<span class="number">0808F</span>377                 test    eax, eax</span><br><span class="line">.text:<span class="number">0808F</span>379                 setnz   al</span><br><span class="line">.text:<span class="number">0808F</span>37C                 <span class="keyword">xor</span>     eax, edx</span><br><span class="line">.text:<span class="number">0808F</span>37E                 test    al, al</span><br><span class="line">.text:<span class="number">0808F</span>380                 jz      loc_80B230F</span><br><span class="line">.text:<span class="number">0808F</span>386                 lea     eax, [ebp+input]</span><br><span class="line">.text:<span class="number">0808F</span>389                 add     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0808F</span>38C                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">0808F</span>38F                 movzx   eax, al</span><br><span class="line">.text:<span class="number">0808F</span>392                 <span class="keyword">and</span>     eax, <span class="number">4</span></span><br><span class="line">.text:<span class="number">0808F</span>395                 test    eax, eax</span><br><span class="line">.text:<span class="number">0808F</span>397                 setnz   dl</span><br><span class="line">.text:<span class="number">0808F</span>39A                 lea     eax, [ebp+s2]</span><br><span class="line">.text:<span class="number">0808F</span>39D                 add     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0808F</span>3A0                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">0808F</span>3A3                 movzx   eax, al</span><br><span class="line">.text:<span class="number">0808F</span>3A6                 <span class="keyword">and</span>     eax, <span class="number">4</span></span><br><span class="line">.text:<span class="number">0808F</span>3A9                 test    eax, eax</span><br><span class="line">.text:<span class="number">0808F</span>3AB                 setnz   al</span><br><span class="line">.text:<span class="number">0808F</span>3AE                 <span class="keyword">xor</span>     eax, edx</span><br><span class="line">.text:<span class="number">0808F</span>3B0                 test    al, al</span><br><span class="line">.text:<span class="number">0808F</span>3B2                 jz      loc_80A0B66</span><br><span class="line">.text:<span class="number">0808F</span>3B8                 call    avoid_me</span><br><span class="line">.text:<span class="number">0808F</span>3BD                 lea     eax, [ebp+input]</span><br><span class="line">.text:<span class="number">0808F</span>3C0                 add     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0808F</span>3C3                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">0808F</span>3C6                 movzx   eax, al</span><br><span class="line">.text:<span class="number">0808F</span>3C9                 <span class="keyword">and</span>     eax, <span class="number">2</span></span><br><span class="line">.text:<span class="number">0808F</span>3CC                 test    eax, eax</span><br><span class="line">.text:<span class="number">0808F</span>3CE                 setnz   dl</span><br><span class="line">.text:<span class="number">0808F</span>3D1                 lea     eax, [ebp+s2]</span><br><span class="line">.text:<span class="number">0808F</span>3D4                 add     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">0808F</span>3D7                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">0808F</span>3DA                 movzx   eax, al</span><br><span class="line">.text:<span class="number">0808F</span>3DD                 <span class="keyword">and</span>     eax, <span class="number">2</span></span><br><span class="line">.text:<span class="number">0808F</span>3E0                 test    eax, eax</span><br><span class="line">.text:<span class="number">0808F</span>3E2                 setnz   al</span><br><span class="line">.text:<span class="number">0808F</span>3E5                 <span class="keyword">xor</span>     eax, edx</span><br><span class="line">.text:<span class="number">0808F</span>3E7                 test    al, al</span><br><span class="line">.text:<span class="number">0808F</span>3E9                 jz      loc_8097FAD</span><br><span class="line">.text:<span class="number">0808F</span>3EF                 call    avoid_me</span><br></pre></td></tr></table></figure>

<h3 id="需要避开的地址"><a href="#需要避开的地址" class="headerlink" title="需要避开的地址"></a>需要避开的地址</h3><p>可以看到调用了很多个avoid_me()函数, 每一个都是需要避开的路径, 一个一个避开肯定不显示, 所以我们跟进avoid_me()函数, 直接避开这个函数本身就好了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">080492B</span>B ; <span class="function"><span class="keyword">void</span> <span class="title">avoid_me</span><span class="params">()</span></span></span><br><span class="line"><span class="function">.text:080492BB                 <span class="keyword">public</span> avoid_me</span></span><br><span class="line"><span class="function">.text:080492BB avoid_me        proc near               </span>; CODE XREF: main+<span class="number">14</span>C↓p</span><br><span class="line">.text:<span class="number">080492B</span>B                                         ; main+<span class="number">183</span>↓p ...</span><br><span class="line">.text:<span class="number">080492B</span>B ; __unwind &#123;</span><br><span class="line">.text:<span class="number">080492B</span>B                 endbr32</span><br><span class="line">.text:<span class="number">080492B</span>F                 push    ebp</span><br><span class="line">.text:<span class="number">080492</span>C0                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">080492</span>C2                 mov     should_succeed, <span class="number">0</span></span><br><span class="line">.text:<span class="number">080492</span>C9                 nop</span><br><span class="line">.text:<span class="number">080492</span>CA                 pop     ebp</span><br><span class="line">.text:<span class="number">080492</span>CB                 retn</span><br><span class="line">.text:<span class="number">080492</span>CB ; &#125; <span class="comment">// starts at 80492BB</span></span><br><span class="line">.text:<span class="number">080492</span>CB avoid_me        endp</span><br></pre></td></tr></table></figure>

<p>我们选择避开: <code>.text:080492C2                 mov     should_succeed, 0</code></p>
<h2 id="使用Angr解题-2"><a href="#使用Angr解题-2" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><p>与上一个关卡相比, 这里这一关添加了大量的”应避开的路径”, 如果只有”接收路径”而没有”避开路径”的话, 时间成本会大很多.</p>
<h3 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">import</span> angr</span></span><br><span class="line"><span class="function"><span class="keyword">import</span> sys</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">def <span class="title">main</span><span class="params">(argv)</span>:</span></span><br><span class="line"><span class="function">  #获取二进制文件, 并在此基础上创建一个Angr项目</span></span><br><span class="line"><span class="function">  path_to_binary </span>= argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  #指定执行的起始状态, 这里表示从main函数开始</span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line">  #创建一个模拟管理器, 提供搜索和执行的工具(方法), 注意其参数为起始状态</span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  # Explore the binary, but <span class="keyword">this</span> time, instead of only looking <span class="keyword">for</span> a state that</span><br><span class="line">  <span class="meta"># reaches the print_good_address, also find a state that does not reach </span></span><br><span class="line">  # will_not_succeed_address. The binary is pretty large, to save you some time,</span><br><span class="line">  <span class="meta"># everything you will need to look at is near the beginning of the address </span></span><br><span class="line">  <span class="meta"># space.</span></span><br><span class="line">  # 尝试分析二进制文件, 但是这一次, 除了要找到我们的<span class="string">&quot;接收的路径&quot;</span>print_good_address, </span><br><span class="line">  # 还要找到一个<span class="string">&quot;避免的路径&quot;</span>will_not_succeed_address. 二进制文件非常大, 为了节省你的</span><br><span class="line">  # 时间, 你需要找的所有内容都在地址内容的开头附近</span><br><span class="line">  # (!)</span><br><span class="line">  print_good_address = <span class="number">0x080492FB</span></span><br><span class="line">  will_not_succeed_address = <span class="number">0x080492C2</span></span><br><span class="line">  # 使用模拟管理器的探索: 开始符号执行, 并搜索find地址, 避开avoid地址</span><br><span class="line">  simulation.explore(find=print_good_address, avoid=will_not_succeed_address)</span><br><span class="line"></span><br><span class="line">  #最终的结果会存储在simulation的found位向量中</span><br><span class="line">  <span class="keyword">if</span> simulation.found:#根据found是否为空来判断是否找到了我们想要的符号值</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]#获取符号值</span><br><span class="line">    print(solution_state.posix.dumps(sys.<span class="built_in">stdin</span>.fileno()).decode())#解码为字符串并打印</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    raise Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后"><a href="#去掉注释后" class="headerlink" title="去掉注释后"></a>去掉注释后</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">import</span> angr</span></span><br><span class="line"><span class="function"><span class="keyword">import</span> sys</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">def <span class="title">main</span><span class="params">(argv)</span>:</span></span><br><span class="line"><span class="function">  path_to_binary </span>= argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  print_good_address = <span class="number">0x080492FB</span></span><br><span class="line">  will_not_succeed_address = <span class="number">0x080492C2</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=print_good_address, avoid=will_not_succeed_address)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    print(solution_state.posix.dumps(sys.<span class="built_in">stdin</span>.fileno()).decode())</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    raise Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>整个的执行流程跟上一题差不多, 要学习的是</p>
<p><code>simulation.explore(find=print_good_address, avoid=will_not_succeed_address)</code></p>
<h1 id="02-angr-find-codition"><a href="#02-angr-find-codition" class="headerlink" title="02_angr_find_codition"></a>02_angr_find_codition</h1><h2 id="编译并运行"><a href="#编译并运行" class="headerlink" title="编译并运行"></a>编译并运行</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/<span class="number">02</span>_angr_find_condition$ python3 generate.py <span class="number">1234</span> <span class="number">02</span>_angr_find_condition</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/<span class="number">02</span>_angr_find_condition$ ./<span class="number">02</span>_angr_find_condition</span><br><span class="line">Enter the password: aaa</span><br><span class="line">Try again.</span><br></pre></td></tr></table></figure>

<h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><p>使用IDA分析</p>
<p>分析mian函数的部分</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">; <span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function">.text:080492BB                 <span class="keyword">public</span> main</span></span><br><span class="line"><span class="function">.text:080492BB main            proc near               </span>; DATA XREF: _start+<span class="number">2</span>A↑o</span><br><span class="line">.text:<span class="number">080492B</span>B</span><br><span class="line">.text:<span class="number">080492B</span>B var_4C          = dword ptr <span class="number">-4</span>Ch</span><br><span class="line">.text:<span class="number">080492B</span>B var_40          = dword ptr <span class="number">-40</span>h</span><br><span class="line">.text:<span class="number">080492B</span>B var_3C          = dword ptr <span class="number">-3</span>Ch</span><br><span class="line">.text:<span class="number">080492B</span>B var_38          = dword ptr <span class="number">-38</span>h</span><br><span class="line">.text:<span class="number">080492B</span>B s1              = byte ptr <span class="number">-34</span>h</span><br><span class="line">.text:<span class="number">080492B</span>B s2              = byte ptr <span class="number">-20</span>h</span><br><span class="line">.text:<span class="number">080492B</span>B var_C           = dword ptr <span class="number">-0</span>Ch</span><br><span class="line">.text:<span class="number">080492B</span>B var_4           = dword ptr <span class="number">-4</span></span><br><span class="line">.text:<span class="number">080492B</span>B argc            = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">080492B</span>B argv            = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080492B</span>B envp            = dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080492B</span>B</span><br><span class="line">.text:<span class="number">080492B</span>B ; __unwind &#123;</span><br><span class="line">.text:<span class="number">080492B</span>B                 endbr32</span><br><span class="line">.text:<span class="number">080492B</span>F                 lea     ecx, [esp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">080492</span>C3                 <span class="keyword">and</span>     esp, <span class="number">0F</span>FFFFFF0h</span><br><span class="line">.text:<span class="number">080492</span>C6                 push    dword ptr [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">080492</span>C9                 push    ebp</span><br><span class="line">.text:<span class="number">080492</span>CA                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">080492</span>CC                 push    ecx</span><br><span class="line">.text:<span class="number">080492</span>CD                 sub     esp, <span class="number">54</span>h</span><br><span class="line">.text:<span class="number">080492</span>D0                 mov     eax, ecx</span><br><span class="line">.text:<span class="number">080492</span>D2                 mov     eax, [eax+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">080492</span>D5                 mov     [ebp+var_4C], eax</span><br><span class="line">.text:<span class="number">080492</span>D8                 mov     eax, large gs:<span class="number">14</span>h</span><br><span class="line">.text:<span class="number">080492</span>DE                 mov     [ebp+var_C], eax</span><br><span class="line">.text:<span class="number">080492E1</span>                 <span class="keyword">xor</span>     eax, eax</span><br><span class="line">.text:<span class="number">080492E3</span>                 mov     [ebp+var_38], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">080492</span>EA                 mov     [ebp+var_40], <span class="number">0</span></span><br><span class="line">.text:<span class="number">080492F</span>1                 jmp     <span class="keyword">short</span> loc_8049302</span><br><span class="line">.text:<span class="number">080492F</span>3 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">080492F</span>3</span><br><span class="line">.text:<span class="number">080492F</span>3 loc_80492F3:                            ; CODE XREF: main+<span class="number">4B</span>↓j</span><br><span class="line">.text:<span class="number">080492F</span>3                 lea     edx, [ebp+s2]</span><br><span class="line">.text:<span class="number">080492F</span>6                 mov     eax, [ebp+var_40]</span><br><span class="line">.text:<span class="number">080492F</span>9                 add     eax, edx</span><br><span class="line">.text:<span class="number">080492F</span>B                 mov     byte ptr [eax], <span class="number">0</span></span><br><span class="line">.text:<span class="number">080492F</span>E                 add     [ebp+var_40], <span class="number">1</span></span><br><span class="line">.text:<span class="number">08049302</span></span><br><span class="line">.text:<span class="number">08049302</span> loc_8049302:                            ; CODE XREF: main+<span class="number">36</span>↑j</span><br><span class="line">.text:<span class="number">08049302</span>                 cmp     [ebp+var_40], <span class="number">13</span>h</span><br><span class="line">.text:<span class="number">08049306</span>                 jle     <span class="keyword">short</span> loc_80492F3</span><br><span class="line">.text:<span class="number">08049308</span>                 lea     eax, [ebp+s2]</span><br><span class="line">.text:<span class="number">0804930B</span>                 mov     dword ptr [eax], <span class="number">57514</span>A4Dh</span><br><span class="line">.text:<span class="number">08049311</span>                 mov     dword ptr [eax+<span class="number">4</span>], <span class="number">454</span>C4441h</span><br><span class="line">.text:<span class="number">08049318</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804931B</span>                 push    offset aEnterThePasswo ; <span class="string">&quot;Enter the password: &quot;</span></span><br><span class="line">.text:<span class="number">08049320</span>                 call    _printf</span><br><span class="line">.text:<span class="number">08049325</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049328</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">0804932B</span>                 lea     eax, [ebp+s1]</span><br><span class="line">.text:<span class="number">0804932</span>E                 push    eax</span><br><span class="line">.text:<span class="number">0804932F</span>                 push    offset a8s      ; <span class="string">&quot;%8s&quot;</span></span><br><span class="line">.text:<span class="number">08049334</span>                 call    ___isoc99_scanf</span><br><span class="line">.text:<span class="number">08049339</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804933</span>C                 mov     [ebp+var_3C], <span class="number">0</span></span><br><span class="line">.text:<span class="number">08049343</span>                 jmp     <span class="keyword">short</span> loc_8049376</span><br><span class="line">.text:<span class="number">08049345</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049345</span></span><br><span class="line">.text:<span class="number">08049345</span> loc_8049345:                            ; CODE XREF: main+BF↓j</span><br><span class="line">.text:<span class="number">08049345</span>                 mov     eax, [ebp+var_3C]</span><br><span class="line">.text:<span class="number">08049348</span>                 lea     edx, [eax+<span class="number">8</span>]</span><br><span class="line">.text:<span class="number">0804934B</span>                 lea     ecx, [ebp+s1]</span><br><span class="line">.text:<span class="number">0804934</span>E                 mov     eax, [ebp+var_3C]</span><br><span class="line">.text:<span class="number">08049351</span>                 add     eax, ecx</span><br><span class="line">.text:<span class="number">08049353</span>                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">08049356</span>                 movsx   eax, al</span><br><span class="line">.text:<span class="number">08049359</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">0804935</span>C                 push    edx</span><br><span class="line">.text:<span class="number">0804935</span>D                 push    eax</span><br><span class="line">.text:<span class="number">0804935</span>E                 call    complex_function</span><br><span class="line">.text:<span class="number">08049363</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049366</span>                 mov     ecx, eax</span><br><span class="line">.text:<span class="number">08049368</span>                 lea     edx, [ebp+s1]</span><br><span class="line">.text:<span class="number">0804936B</span>                 mov     eax, [ebp+var_3C]</span><br><span class="line">.text:<span class="number">0804936</span>E                 add     eax, edx</span><br><span class="line">.text:<span class="number">08049370</span>                 mov     [eax], cl</span><br><span class="line">.text:<span class="number">08049372</span>                 add     [ebp+var_3C], <span class="number">1</span></span><br><span class="line">.text:<span class="number">08049376</span></span><br><span class="line">.text:<span class="number">08049376</span> loc_8049376:                            ; CODE XREF: main+<span class="number">88</span>↑j</span><br><span class="line">.text:<span class="number">08049376</span>                 cmp     [ebp+var_3C], <span class="number">7</span></span><br><span class="line">.text:<span class="number">0804937</span>A                 jle     <span class="keyword">short</span> loc_8049345</span><br><span class="line">.text:<span class="number">0804937</span>C                 cmp     [ebp+var_38], <span class="number">0</span>DEADBEEFh ; 因为var_38的值一直都没有改变, 所以一旦第一个跳转了, 就说明后面的跳转会一直跳转到错误的位置</span><br><span class="line">.text:<span class="number">08049383</span>                 jz      loc_804B97C     ; 这里最终跳转到了Try again, 应该从这里跳转到的位置时设为<span class="string">&quot;避开路径&quot;</span></span><br><span class="line">.text:<span class="number">08049389</span>                 cmp     [ebp+var_38], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">08049390</span>                 jz      loc_804A689</span><br><span class="line">.text:<span class="number">08049396</span>                 cmp     [ebp+var_38], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">0804939</span>D                 jz      loc_8049D16</span><br><span class="line">.text:<span class="number">080493</span>A3                 cmp     [ebp+var_38], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">080493</span>AA                 jnz     loc_8049863</span><br><span class="line">.text:<span class="number">080493B</span>0                 cmp     [ebp+var_38], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">080493B</span>7                 jz      loc_8049610</span><br><span class="line">.text:<span class="number">080493B</span>D                 cmp     [ebp+var_38], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">080493</span>C4                 jnz     loc_80494ED</span><br><span class="line">.text:<span class="number">080493</span>CA                 cmp     [ebp+var_38], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">080493</span>D1                 jnz     loc_8049462</span><br><span class="line">.text:<span class="number">080493</span>D7                 cmp     [ebp+var_38], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">080493</span>DE                 jnz     <span class="keyword">short</span> loc_8049421</span><br><span class="line">.text:<span class="number">080493E0</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080493E3</span>                 lea     eax, [ebp+s2]</span><br><span class="line">.text:<span class="number">080493E6</span>                 push    eax             ; s2</span><br><span class="line">.text:<span class="number">080493E7</span>                 lea     eax, [ebp+s1]</span><br><span class="line">.text:<span class="number">080493</span>EA                 push    eax             ; s1</span><br><span class="line">.text:<span class="number">080493</span>EB                 call    _strcmp</span><br><span class="line">.text:<span class="number">080493F</span>0                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493F</span>3                 test    eax, eax</span><br><span class="line">.text:<span class="number">080493F</span>5                 jz      <span class="keyword">short</span> loc_804940C</span><br><span class="line">.text:<span class="number">080493F</span>7                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080493F</span>A                 push    offset s        ; <span class="string">&quot;Try again.&quot;</span></span><br><span class="line">.text:<span class="number">080493F</span>F                 call    _puts</span><br><span class="line">.text:<span class="number">08049404</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049407</span>                 jmp     loc_804DF5E</span><br><span class="line">.text:<span class="number">0804940</span>C ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0804940</span>C</span><br><span class="line">.text:<span class="number">0804940</span>C loc_804940C:                            ; CODE XREF: main+<span class="number">13</span>A↑j</span><br><span class="line">.text:<span class="number">0804940</span>C                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804940F</span>                 push    offset aGoodJob ; <span class="string">&quot;Good Job.&quot;</span></span><br><span class="line">.text:<span class="number">08049414</span>                 call    _puts</span><br><span class="line">.text:<span class="number">08049419</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804941</span>C                 jmp     loc_804DF5E</span><br><span class="line">.text:<span class="number">08049421</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049421</span></span><br><span class="line">.text:<span class="number">08049421</span> loc_8049421:                            ; CODE XREF: main+<span class="number">123</span>↑j</span><br><span class="line">.text:<span class="number">08049421</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">08049424</span>                 lea     eax, [ebp+s2]</span><br><span class="line">.text:<span class="number">08049427</span>                 push    eax             ; s2</span><br><span class="line">.text:<span class="number">08049428</span>                 lea     eax, [ebp+s1]</span><br><span class="line">.text:<span class="number">0804942B</span>                 push    eax             ; s1</span><br><span class="line">.text:<span class="number">0804942</span>C                 call    _strcmp</span><br><span class="line">.text:<span class="number">08049431</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049434</span>                 test    eax, eax</span><br><span class="line">.text:<span class="number">08049436</span>                 jz      <span class="keyword">short</span> loc_804944D</span><br><span class="line">.text:<span class="number">08049438</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804943B</span>                 push    offset s        ; <span class="string">&quot;Try again.&quot;</span></span><br><span class="line">.text:<span class="number">08049440</span>                 call    _puts</span><br><span class="line">.text:<span class="number">08049445</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049448</span>                 jmp     loc_804DF5E</span><br><span class="line">.text:<span class="number">0804944</span>D ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0804944</span>D</span><br><span class="line">.text:<span class="number">0804944</span>D loc_804944D:                            ; CODE XREF: main+<span class="number">17B</span>↑j</span><br><span class="line">.text:<span class="number">0804944</span>D                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049450</span>                 push    offset aGoodJob ; <span class="string">&quot;Good Job.&quot;</span></span><br><span class="line">.text:<span class="number">08049455</span>                 call    _puts</span><br><span class="line">.text:<span class="number">0804945</span>A                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804945</span>D                 jmp     loc_804DF5E</span><br><span class="line">.text:<span class="number">08049462</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049462</span></span><br><span class="line">.text:<span class="number">08049462</span> loc_8049462:                            ; CODE XREF: main+<span class="number">116</span>↑j</span><br><span class="line">.text:<span class="number">08049462</span>                 cmp     [ebp+var_38], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">08049469</span>                 jz      <span class="keyword">short</span> loc_80494AC</span><br><span class="line">.text:<span class="number">0804946B</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">0804946</span>E                 lea     eax, [ebp+s2]</span><br><span class="line">.text:<span class="number">08049471</span>                 push    eax             ; s2</span><br><span class="line">.text:<span class="number">08049472</span>                 lea     eax, [ebp+s1]</span><br><span class="line">.text:<span class="number">08049475</span>                 push    eax             ; s1</span><br><span class="line">.text:<span class="number">08049476</span>                 call    _strcmp</span><br><span class="line">.text:<span class="number">0804947B</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804947</span>E                 test    eax, eax</span><br><span class="line">.text:<span class="number">08049480</span>                 jz      <span class="keyword">short</span> loc_8049497</span><br><span class="line">.text:<span class="number">08049482</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049485</span>                 push    offset s        ; <span class="string">&quot;Try again.&quot;</span></span><br><span class="line">.text:<span class="number">0804948</span>A                 call    _puts</span><br><span class="line">.text:<span class="number">0804948F</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049492</span>                 jmp     loc_804DF5E</span><br><span class="line">.text:<span class="number">08049497</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049497</span></span><br><span class="line">.text:<span class="number">08049497</span> loc_8049497:                            ; CODE XREF: main+<span class="number">1</span>C5↑j</span><br><span class="line">.text:<span class="number">08049497</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804949</span>A                 push    offset aGoodJob ; <span class="string">&quot;Good Job.&quot;</span></span><br><span class="line">.text:<span class="number">0804949F</span>                 call    _puts</span><br><span class="line">.text:<span class="number">080494</span>A4                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080494</span>A7                 jmp     loc_804DF5E</span><br></pre></td></tr></table></figure>

<p>mian函数非常的大, 而且这个关卡与前面不同的地方在于它的&lt;接受路径&gt;和&lt;避免路径&gt;都有非常多条, 这样的结果就是我们很难通过以约束地址的方式来找到真正的路径, 即便能这样的效率也非常的低. 所以Angr提供多样的约束方式, 而这也是通过本关卡所需要的.</p>
<p>本题要用的是识别每个&lt;状态&gt;的标准输出中是否含有”Good Job.”字符串来判断是否是&lt;接受路径&gt;, 而其载体则是&lt;函数&gt;.</p>
<h2 id="使用Angr解题-3"><a href="#使用Angr解题-3" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><h3 id="代码-2"><a href="#代码-2" class="headerlink" title="代码"></a>代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># It is very useful to be able to search for a state that reaches a certain</span></span><br><span class="line"><span class="comment"># instruction. However, in some cases, you may not know the address of the</span></span><br><span class="line"><span class="comment"># specific instruction you want to reach (or perhaps there is no single</span></span><br><span class="line"><span class="comment"># instruction goal.) In this challenge, you don&#x27;t know which instruction</span></span><br><span class="line"><span class="comment"># grants you success. Instead, you just know that you want to find a state where</span></span><br><span class="line"><span class="comment"># the binary prints &quot;Good Job.&quot;</span></span><br><span class="line"><span class="comment"># 能够搜索到一个到达特定指令的状态是非常有用的. 但是, 在某些情况下, 你可能不知道要到达的特定指令的地址</span></span><br><span class="line"><span class="comment"># (或者可能没有单一的指令目标). 在这个关卡中, 你不知道那条指令可以让你成功. 相反, 你只知道你想找的是打印</span></span><br><span class="line"><span class="comment"># &quot;Good Job&quot;的状态</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Angr is powerful in that it allows you to search for a states that meets an </span></span><br><span class="line"><span class="comment"># arbitrary condition that you specify in Python, using a predicate you define</span></span><br><span class="line"><span class="comment"># as a function that takes a state and returns True if you have found what you</span></span><br><span class="line"><span class="comment"># are looking for, and False otherwise.</span></span><br><span class="line"><span class="comment"># Angr的强大之处在于它允许你去搜索一个满足你已经在Python中声明了的任意条件的状态</span></span><br><span class="line"><span class="comment"># 使用你定义为函数的谓词, 该函数接收状态并在找到所需内容时返回True, 否则为False</span></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  <span class="comment">#在二进制文件建立Angr项目</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#指定执行的起始状态, 这里是main()函数</span></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">#创建模拟管理器, 提供搜索和执行的工具</span></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Define a function that checks if you have found the state you are looking</span></span><br><span class="line">  <span class="comment"># for.</span></span><br><span class="line">  <span class="comment"># 定义一个函数来检查你是否找到了你正在寻找的状态</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="comment"># Dump whatever has been printed out by the binary so far into a string.</span></span><br><span class="line">    <span class="comment"># 将目前二进制文件打印出来的任何内容转储到一个字符串中</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Return whether &#x27;Good Job.&#x27; has been printed yet.</span></span><br><span class="line">    <span class="comment"># 返回是否已经打印出&quot;Good Job&quot;</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output<span class="comment">#如果&quot;Good Job.&quot;字符串在标准输出中, 则返回真</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Same as above, but this time check if the state should abort. If you return</span></span><br><span class="line">  <span class="comment"># False, Angr will continue to step the state. In this specific challenge, the</span></span><br><span class="line">  <span class="comment"># only time at which you will know you should abort is when the program prints</span></span><br><span class="line">  <span class="comment"># &quot;Try again.&quot;</span></span><br><span class="line">  <span class="comment"># 与上面相同, 但这次检查状态是否应该终止, 如果返回False, Angr将继续步入状态, 在</span></span><br><span class="line">  <span class="comment"># 这个特殊的挑战中, 你应该知道终止的唯一可能是在程序打印&quot;Try again&quot;的时候.</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output<span class="comment">#如果&quot;Tyr again.&quot;字符串在标准输出中, 则返回真</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Tell Angr to explore the binary and find any state that is_successful identfies</span></span><br><span class="line">  <span class="comment"># as a successful state by returning True.</span></span><br><span class="line">  <span class="comment"># 让Angr探索二进制文件, 并通过返回True找到is_successful状态并识别为成功状态</span></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后-1"><a href="#去掉注释后-1" class="headerlink" title="去掉注释后"></a>去掉注释后</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line"></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output<span class="comment">#如果&quot;Good Job.&quot;字符串在标准输出中, 则返回真</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output<span class="comment">#如果&quot;Tyr again.&quot;字符串在标准输出中, 则返回真</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">    <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们可以看到explore的参数类型发生了改变<code>simulation.explore(find=is_successful, avoid=should_abort)</code>, 从具体的地址变成了回调函数, 而<code>find</code>和<code>avoid</code>就是通过回调函数的返回值来判断是&lt;接受路径&gt;还是&lt;避免路径&gt;</p>
<h1 id="03-angr-symbolic-registers"><a href="#03-angr-symbolic-registers" class="headerlink" title="03_angr_symbolic_registers"></a>03_angr_symbolic_registers</h1><h2 id="编译并运行-1"><a href="#编译并运行-1" class="headerlink" title="编译并运行"></a>编译并运行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/03_angr_symbolic_registers$ python3 generate.py 1234 03_angr_symbolic_registers</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/03_angr_symbolic_registers$ ./03_angr_symbolic_registers</span><br><span class="line">Enter the password: aaaa</span><br><span class="line">a</span><br><span class="line">a</span><br><span class="line">Try again.</span><br></pre></td></tr></table></figure>

<h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><h3 id="main函数"><a href="#main函数" class="headerlink" title="main函数"></a>main函数</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"> ; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:080495CF                 public main</span><br><span class="line">.text:080495CF main            proc near               ; DATA XREF: _start+2A↑o</span><br><span class="line">.text:080495CF</span><br><span class="line">.text:080495CF var_14          = dword ptr -14h</span><br><span class="line">.text:080495CF var_10          = dword ptr -10h</span><br><span class="line">.text:080495CF var_C           = dword ptr -0Ch</span><br><span class="line">.text:080495CF var_4           = dword ptr -4</span><br><span class="line">.text:080495CF argc            = dword ptr  8</span><br><span class="line">.text:080495CF argv            = dword ptr  0Ch</span><br><span class="line">.text:080495CF envp            = dword ptr  10h</span><br><span class="line">.text:080495CF</span><br><span class="line">.text:080495CF ; __unwind &#123;</span><br><span class="line">.text:080495CF                 endbr32</span><br><span class="line">.text:080495D3                 lea     ecx, [esp+4]</span><br><span class="line">.text:080495D7                 and     esp, 0FFFFFFF0h</span><br><span class="line">.text:080495DA                 push    dword ptr [ecx-4]</span><br><span class="line">.text:080495DD                 push    ebp</span><br><span class="line">.text:080495DE                 mov     ebp, esp</span><br><span class="line">.text:080495E0                 push    ecx</span><br><span class="line">.text:080495E1                 sub     esp, 14h</span><br><span class="line">.text:080495E4                 sub     esp, 0Ch</span><br><span class="line">.text:080495E7                 push    offset aEnterThePasswo ; <span class="string">&quot;Enter the password: &quot;</span></span><br><span class="line">.text:080495EC                 call    _printf</span><br><span class="line">.text:080495F1                 add     esp, 10h</span><br><span class="line">.text:080495F4                 call    get_user_input</span><br><span class="line">.text:080495F9                 mov     [ebp+var_14], eax</span><br><span class="line">.text:080495FC                 mov     [ebp+var_10], ebx</span><br><span class="line">.text:080495FF                 mov     [ebp+var_C], edx</span><br><span class="line">.text:08049602                 sub     esp, 0Ch</span><br><span class="line">.text:08049605                 push    [ebp+var_14]</span><br><span class="line">.text:08049608                 call    complex_function_1</span><br><span class="line">.text:0804960D                 add     esp, 10h</span><br><span class="line">.text:08049610                 mov     [ebp+var_14], eax</span><br><span class="line">.text:08049613                 sub     esp, 0Ch</span><br><span class="line">.text:08049616                 push    [ebp+var_10]</span><br><span class="line">.text:08049619                 call    complex_function_2</span><br><span class="line">.text:0804961E                 add     esp, 10h</span><br><span class="line">.text:08049621                 mov     [ebp+var_10], eax</span><br><span class="line">.text:08049624                 sub     esp, 0Ch</span><br><span class="line">.text:08049627                 push    [ebp+var_C]</span><br><span class="line">.text:0804962A                 call    complex_function_3</span><br><span class="line">.text:0804962F                 add     esp, 10h</span><br><span class="line">.text:08049632                 mov     [ebp+var_C], eax</span><br><span class="line">.text:08049635                 cmp     [ebp+var_14], 0</span><br><span class="line">.text:08049639                 jnz     short loc_8049647</span><br><span class="line">.text:0804963B                 cmp     [ebp+var_10], 0</span><br><span class="line">.text:0804963F                 jnz     short loc_8049647</span><br><span class="line">.text:08049641                 cmp     [ebp+var_C], 0</span><br><span class="line">.text:08049645                 jz      short loc_8049659</span><br><span class="line">.text:08049647</span><br><span class="line">.text:08049647 loc_8049647:                            ; CODE XREF: main+6A↑j</span><br><span class="line">.text:08049647                                         ; main+70↑j</span><br><span class="line">.text:08049647                 sub     esp, 0Ch</span><br><span class="line">.text:0804964A                 push    offset s        ; <span class="string">&quot;Try again.&quot;</span></span><br><span class="line">.text:0804964F                 call    _puts</span><br><span class="line">.text:08049654                 add     esp, 10h</span><br><span class="line">.text:08049657                 jmp     short loc_8049669</span><br><span class="line">.text:08049659 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:08049659</span><br><span class="line">.text:08049659 loc_8049659:                            ; CODE XREF: main+76↑j</span><br><span class="line">.text:08049659                 sub     esp, 0Ch</span><br><span class="line">.text:0804965C                 push    offset aGoodJob ; <span class="string">&quot;Good Job.&quot;</span></span><br><span class="line">.text:08049661                 call    _puts</span><br><span class="line">.text:08049666                 add     esp, 10h</span><br><span class="line">.text:08049669</span><br><span class="line">.text:08049669 loc_8049669:                            ; CODE XREF: main+88↑j</span><br><span class="line">.text:08049669                 mov     eax, 0</span><br><span class="line">.text:0804966E                 mov     ecx, [ebp+var_4]</span><br><span class="line">.text:08049671                 leave</span><br><span class="line">.text:08049672                 lea     esp, [ecx-4]</span><br><span class="line">.text:08049675                 retn</span><br><span class="line">.text:08049675 ; &#125; // starts at 80495CF</span><br><span class="line">.text:08049675 main            endp</span><br></pre></td></tr></table></figure>

<br>

<p>在读取了用户输入后, 进行了三次判断, 且只有一个&lt;接受路径&gt;和&lt;避免路径&gt;, &lt;接受路径&gt;和&lt;避免路径&gt;都只有一个, 可以用地址来表示, 但是还是用回调函数判断输出的方式会更通用一些, 我们先跟进<code>get_user_input()</code>, 然后跟进加密函数<code>complex_function_1()</code></p>
<h3 id="get-user-input"><a href="#get-user-input" class="headerlink" title="get_user_input()"></a>get_user_input()</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">; __unwind &#123;</span><br><span class="line">.text:08049582                 endbr32</span><br><span class="line">.text:08049586                 push    ebp</span><br><span class="line">.text:08049587                 mov     ebp, esp</span><br><span class="line">.text:08049589                 sub     esp, 18h</span><br><span class="line">.text:0804958C                 mov     eax, large gs:14h</span><br><span class="line">.text:08049592                 mov     [ebp+var_C], eax</span><br><span class="line">.text:08049595                 xor     eax, eax</span><br><span class="line">.text:08049597                 lea     ecx, [ebp+var_10]</span><br><span class="line">.text:0804959A                 push    ecx</span><br><span class="line">.text:0804959B                 lea     ecx, [ebp+var_14]</span><br><span class="line">.text:0804959E                 push    ecx</span><br><span class="line">.text:0804959F                 lea     ecx, [ebp+var_18]</span><br><span class="line">.text:080495A2                 push    ecx</span><br><span class="line">.text:080495A3                 push    offset aXXX     ; 读取三个整数</span><br><span class="line">.text:080495A8                 call    ___isoc99_scanf</span><br><span class="line">.text:080495AD                 add     esp, 10h</span><br><span class="line">.text:080495B0                 mov     eax, [ebp+var_18]</span><br><span class="line">.text:080495B3                 mov     edx, [ebp+var_14]</span><br><span class="line">.text:080495B6                 mov     ebx, edx</span><br><span class="line">.text:080495B8                 mov     edx, [ebp+var_10]</span><br><span class="line">.text:080495BB                 nop</span><br><span class="line">.text:080495BC                 mov     ecx, [ebp+var_C]</span><br><span class="line">.text:080495BF                 xor     ecx, large gs:14h</span><br><span class="line">.text:080495C6                 jz      short locret_80495CD</span><br><span class="line">.text:080495C8                 call    ___stack_chk_fail</span><br></pre></td></tr></table></figure>

<p>aXXX字符串常量是<code>&quot;%x %x %x&quot;</code>, 是读取三个整数</p>
<h3 id="complex-function-1"><a href="#complex-function-1" class="headerlink" title="complex_function_1()"></a>complex_function_1()</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"> __unwind &#123;</span><br><span class="line">.text:08049218                 endbr32</span><br><span class="line">.text:0804921C                 push    ebp</span><br><span class="line">.text:0804921D                 mov     ebp, esp</span><br><span class="line">.text:0804921F                 xor     [ebp+arg_0], 0B47ECDE5h</span><br><span class="line">.text:08049226                 add     [ebp+arg_0], 7C34CCE5h</span><br><span class="line">.text:0804922D                 mov     eax, [ebp+arg_0]</span><br><span class="line">.text:08049230                 sub     eax, 68313899h</span><br><span class="line">.text:08049235                 mov     [ebp+arg_0], eax</span><br><span class="line">.text:08049238                 add     [ebp+arg_0], 25546EB0h</span><br><span class="line">.text:0804923F                 xor     [ebp+arg_0], 667C4B5Fh</span><br><span class="line">.text:08049246                 add     [ebp+arg_0], 5218863Ah</span><br><span class="line">.text:0804924D                 add     [ebp+arg_0], 4A61A7C0h</span><br><span class="line">.text:08049254                 xor     [ebp+arg_0], 0D81E98A1h</span><br><span class="line">.text:0804925B                 add     [ebp+arg_0], 0EA4480Ah</span><br><span class="line">.text:08049262                 xor     [ebp+arg_0], 0FA091CC9h</span><br><span class="line">.text:08049269                 xor     [ebp+arg_0], 0BB654A8Dh</span><br><span class="line">.text:08049270                 xor     [ebp+arg_0], 518DA374h</span><br><span class="line">.text:08049277                 mov     eax, [ebp+arg_0]</span><br><span class="line">.text:0804927A                 sub     eax, 573A9DA6h</span><br><span class="line">.text:0804927F                 mov     [ebp+arg_0], eax</span><br><span class="line">.text:08049282                 mov     eax, [ebp+arg_0]</span><br><span class="line">.text:08049285                 sub     eax, 720B986Bh</span><br><span class="line">.text:0804928A                 mov     [ebp+arg_0], eax</span><br><span class="line">.text:0804928D                 xor     [ebp+arg_0], 62F378CAh</span><br><span class="line">.text:08049294                 mov     eax, [ebp+arg_0]</span><br><span class="line">.text:08049297                 sub     eax, 7C6D5375h</span><br><span class="line">.text:0804929C                 mov     [ebp+arg_0], eax</span><br><span class="line">.text:0804929F                 xor     [ebp+arg_0], 5073ECCAh</span><br><span class="line">.text:080492A6                 xor     [ebp+arg_0], 1E57541Dh</span><br><span class="line">.text:080492AD                 mov     eax, [ebp+arg_0]</span><br><span class="line">.text:080492B0                 sub     eax, 5EDD295Ch</span><br><span class="line">.text:080492B5                 mov     [ebp+arg_0], eax</span><br><span class="line">.text:080492B8                 mov     eax, [ebp+arg_0]</span><br><span class="line">.text:080492BB                 sub     eax, 70D80AE9h</span><br><span class="line">.text:080492C0                 mov     [ebp+arg_0], eax</span><br><span class="line">.text:080492C3                 add     [ebp+arg_0], 41CE452Bh</span><br><span class="line">.text:080492CA                 xor     [ebp+arg_0], 2CB9F02h</span><br><span class="line">.text:080492D1                 xor     [ebp+arg_0], 1DA8339Eh</span><br><span class="line">.text:080492D8                 add     [ebp+arg_0], 1708A4A7h</span><br><span class="line">.text:080492DF                 xor     [ebp+arg_0], 0CCAC92A7h</span><br><span class="line">.text:080492E6                 mov     eax, [ebp+arg_0]</span><br><span class="line">.text:080492E9                 sub     eax, 3D111768h</span><br><span class="line">.text:080492EE                 mov     [ebp+arg_0], eax</span><br><span class="line">.text:080492F1                 mov     eax, [ebp+arg_0]</span><br><span class="line">.text:080492F4                 sub     eax, 2369D87Bh</span><br><span class="line">.text:080492F9                 mov     [ebp+arg_0], eax</span><br><span class="line">.text:080492FC                 xor     [ebp+arg_0], 184BE27Fh</span><br><span class="line">.text:08049303                 add     [ebp+arg_0], 281A05Eh</span><br><span class="line">.text:0804930A                 add     [ebp+arg_0], 66205B90h</span><br><span class="line">.text:08049311                 xor     [ebp+arg_0], 3C3B90F5h</span><br><span class="line">.text:08049318                 mov     eax, [ebp+arg_0]</span><br><span class="line">.text:0804931B                 pop     ebp</span><br><span class="line">.text:0804931C                 retn</span><br></pre></td></tr></table></figure>

<p>可以看到是不断的与常量xor, and, sub和add运算最终返回运算结果, 需要注意的是运算过程中间<code>arg_0</code>变量的值会传送给eax寄存器<code>mov     eax, [ebp+arg_0]</code>, 而且最后返回时也会将值传送给eax寄存器.</p>
<p>再看看最终到达&lt;接受路径&gt;的条件</p>
<p><code>.text:08049635                 cmp     [ebp+var_14], 0 .text:08049639                 jnz     short loc_8049647 .text:0804963B                 cmp     [ebp+var_10], 0 .text:0804963F                 jnz     short loc_8049647 .text:08049641                 cmp     [ebp+var_C], 0 .text:08049645                 jz      short loc_8049659</code></p>
<p>比较转换后的三个输入整数是否为0</p>
<h2 id="使用Angr解题-4"><a href="#使用Angr解题-4" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><p>首先因为Angr不支持scanf读取多个内容, 所以本题中读取三个十六进制整数的符号我们无法让Angr自动完成注入. 所以我们要在合适的执行位置, 找到注入点.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:080495F9                 mov     [ebp+var_14], eax</span><br><span class="line">.text:080495FC                 mov     [ebp+var_10], ebx</span><br><span class="line">.text:080495FF                 mov     [ebp+var_C], edx</span><br></pre></td></tr></table></figure>

<p>这里就是我们所需要的注入点, 我们是以寄存器作为符号.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">password0_size_in_bits = 32  <span class="comment"># :integer, 这个是符号位向量的位数</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password0_size_in_bits)<span class="comment"># 成功创建符号</span></span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password0_size_in_bits)</span><br><span class="line">  password2 = claripy.BVS(<span class="string">&#x27;password2&#x27;</span>, password0_size_in_bits)</span><br><span class="line">  initial_state.regs.eax = password0</span><br><span class="line">  initial_state.regs.ebx = password1</span><br><span class="line">  initial_state.regs.edx = password2</span><br></pre></td></tr></table></figure>

<p>注入符号并符号执行的过程我们可以理解为: [从符号执行的此刻开始, 你就是未知数了]. 在本题中的例子就是这样</p>
<p><img src="/2022/05/18/AngrLab2c872/image2.png" alt="image.png"></p>
<p>接下来是两种情况:</p>
<ul>
<li>如上图最上方的红框, 如果我们在这个位置开始符号执行, 那么我们就是以此刻的三个寄存器值来作为未知数. 最终Angr还原的符号就是此时的eax, ebx, edx, 可此时eax, ebx还有edx并不是我们所想要求得的flag, 所以不能想之前的关卡那样默认从mian()开头开始符号执行</li>
<li>另一种情况就是从第二个红框处开始符号执行, 最终Angr还原的符号就是此时的eax, ebx, edx. 而这三个数此时就是我们的flag, 所以从这里开始执行才是正确的.</li>
</ul>
<h3 id="下面是代码"><a href="#下面是代码" class="headerlink" title="下面是代码"></a>下面是代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Angr doesn&#x27;t currently support reading multiple things with scanf (Ex: </span></span><br><span class="line"><span class="comment"># scanf(&quot;%u %u).) You will have to tell the simulation engine to begin the</span></span><br><span class="line"><span class="comment"># program after scanf is called and manually inject the symbols into registers.</span></span><br><span class="line"><span class="comment"># Angr目前不支持使用scanf读取多个内容, (如: scanf(&quot;%u %u&quot;)), 你必须告诉模拟引擎在调用</span></span><br><span class="line"><span class="comment"># scanf后启动程序并手动将符号注入寄存器</span></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  <span class="comment"># 在二进制文件建立Angr项目</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Sometimes, you want to specify where the program should start. The variable</span></span><br><span class="line">  <span class="comment"># start_address will specify where the symbolic execution engine should begin.</span></span><br><span class="line">  <span class="comment"># Note that we are using blank_state, not entry_state.</span></span><br><span class="line">  <span class="comment"># 有时, 你想要明确指定程序应该从哪里开始. 变量start_address将指示符号引擎从哪里开始</span></span><br><span class="line">  <span class="comment"># 请注意, 我们使用的是blank_state()而不是entry_state()</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  start_address = <span class="number">0x080495F9</span>  <span class="comment"># :integer (probably hexadecimal)</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Create a symbolic bitvector (the datatype Angr uses to inject symbolic</span></span><br><span class="line">  <span class="comment"># values into the binary.) The first parameter is just a name Angr uses</span></span><br><span class="line">  <span class="comment"># to reference it. </span></span><br><span class="line">  <span class="comment"># You will have to construct multiple bitvectors. Copy the two lines below</span></span><br><span class="line">  <span class="comment"># and change the variable names. To figure out how many (and of what size)</span></span><br><span class="line">  <span class="comment"># you need, dissassemble the binary and determine the format parameter passed</span></span><br><span class="line">  <span class="comment"># to scanf.</span></span><br><span class="line">  <span class="comment"># 创建一个符号位向量(Angr用来将符号值注入二进制文件的数据类型), 第一个参数只是Angr用来引用它的名称</span></span><br><span class="line">  <span class="comment"># 你必须将多个寄存器设置为不同的位向量, 先声明一定数量的符号位向量, 然后在合适的位置, 合适的寄存器注入符号</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password0_size_in_bits = <span class="number">32</span>  <span class="comment"># :integer, 这个是符号位向量的位数</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password0_size_in_bits)<span class="comment"># 成功创建符号</span></span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password0_size_in_bits)</span><br><span class="line">  password2 = claripy.BVS(<span class="string">&#x27;password2&#x27;</span>, password0_size_in_bits)</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Set a register to a symbolic value. This is one way to inject symbols into</span></span><br><span class="line">  <span class="comment"># the program.</span></span><br><span class="line">  <span class="comment"># 将寄存器设置为符号值, 这是将符号注入程序的一种方法</span></span><br><span class="line">  <span class="comment"># initial_state.regs stores a number of convenient attributes that reference</span></span><br><span class="line">  <span class="comment"># registers by name. For example, to set eax to password0, use:</span></span><br><span class="line">  <span class="comment"># initial_state.regs存储了许多按名称引用寄存器的遍历属性.</span></span><br><span class="line">  <span class="comment"># 如, 将eax设置为password0, 请使用下面的语句</span></span><br><span class="line">  <span class="comment"># initial_state.regs.eax = password0</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># You will have to set multiple registers to distinct bitvectors. Copy and</span></span><br><span class="line">  <span class="comment"># paste the line below and change the register. To determine which registers</span></span><br><span class="line">  <span class="comment"># to inject which symbol, dissassemble the binary and look at the instructions</span></span><br><span class="line">  <span class="comment"># immediately following the call to scanf.</span></span><br><span class="line">  <span class="comment"># 你必须将多个寄存器设置为不同的位向量. </span></span><br><span class="line">  <span class="comment"># 复制并粘贴下面的行并更改寄存器.</span></span><br><span class="line">  <span class="comment"># 要确定哪些寄存器要注入哪些符号, 请反汇编二进制文件并查看调用scanf后立即执行的指令 </span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  initial_state.regs.eax = password0</span><br><span class="line">  initial_state.regs.ebx = password1</span><br><span class="line">  initial_state.regs.edx = password2</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 创建一个模拟管理器</span></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]<span class="comment"># 如果找到了&lt;接受路径&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Solve for the symbolic values. If there are multiple solutions, we only</span></span><br><span class="line">    <span class="comment"># care about one, so we can use eval, which returns any (but only one)</span></span><br><span class="line">    <span class="comment"># solution. Pass eval the bitvector you want to solve for.</span></span><br><span class="line">    <span class="comment"># 求解符号值. 如果有多个解决方案, 我们只关心一个, 所以我们可以使用eval()方法, 这个方法可以返回任何(但只有一个)</span></span><br><span class="line">    <span class="comment"># 解决方案, 将需要求解的位向量传递给eval()方法</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0)</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1)</span><br><span class="line">    solution2 = solution_state.solver.<span class="built_in">eval</span>(password2)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Aggregate and format the solutions you computed above, and then print</span></span><br><span class="line">    <span class="comment"># the full string. Pay attention to the order of the integers, and the</span></span><br><span class="line">    <span class="comment"># expected base (decimal, octal, hexadecimal, etc).</span></span><br><span class="line">    <span class="comment"># 合并, 格式话你在上面得到的答案, 然后打印完整的字符串. 注意整数的顺序, 以及预期的基数</span></span><br><span class="line">    <span class="comment"># </span></span><br><span class="line">    solution = <span class="built_in">str</span>(<span class="built_in">hex</span>(solution0)) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(solution1)) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(solution2))   <span class="comment"># :string, 注意这里要转换成十六进制, 因为scanf用的是%x</span></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后-2"><a href="#去掉注释后-2" class="headerlink" title="去掉注释后"></a>去掉注释后</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = <span class="number">0x080495F9</span>  <span class="comment"># :integer (probably hexadecimal)</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  password0_size_in_bits = <span class="number">32</span>  </span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password0_size_in_bits)</span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password0_size_in_bits)</span><br><span class="line">  password2 = claripy.BVS(<span class="string">&#x27;password2&#x27;</span>, password0_size_in_bits)</span><br><span class="line">  initial_state.regs.eax = password0</span><br><span class="line">  initial_state.regs.ebx = password1</span><br><span class="line">  initial_state.regs.edx = password2</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0)</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1)</span><br><span class="line">    solution2 = solution_state.solver.<span class="built_in">eval</span>(password2)</span><br><span class="line"></span><br><span class="line">    solution = <span class="built_in">str</span>(<span class="built_in">hex</span>(solution0)) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(solution1)) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(solution2))   <span class="comment"># :string, 注意这里要转换成十六进制, 因为scanf用的是%x</span></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="04-angr-symbolic-stack"><a href="#04-angr-symbolic-stack" class="headerlink" title="04_angr_symbolic_stack"></a>04_angr_symbolic_stack</h1><h2 id="编译并运行-2"><a href="#编译并运行-2" class="headerlink" title="编译并运行"></a>编译并运行</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/04_angr_symbolic_stack$ python3 generate.py <span class="number">1</span></span><br><span class="line"><span class="number">234</span> 04_angr_symbolic_stack</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/04_angr_symbolic_stack$ cp 04_angr_symbolic_s</span><br><span class="line">tack ./<span class="number">1</span></span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/04_angr_symbolic_stack$ ./04_angr_symbolic_st</span><br><span class="line">ack</span><br><span class="line">Enter the password: aaaaaaa</span><br><span class="line">Try again.</span><br></pre></td></tr></table></figure>

<h2 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h2><p>使用IDA分析</p>
<h3 id="mian"><a href="#mian" class="headerlink" title="mian()"></a>mian()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">08049450</span> ; __unwind &#123;</span><br><span class="line">.text:<span class="number">08049450</span>                 endbr32</span><br><span class="line">.text:<span class="number">08049454</span>                 lea     ecx, [esp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">08049458</span>                 <span class="keyword">and</span>     esp, <span class="number">0F</span>FFFFFF0h</span><br><span class="line">.text:<span class="number">0804945B</span>                 push    dword ptr [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">0804945</span>E                 push    ebp</span><br><span class="line">.text:<span class="number">0804945F</span>                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">08049461</span>                 push    ecx</span><br><span class="line">.text:<span class="number">08049462</span>                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">08049465</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049468</span>                 push    offset aEnterThePasswo ; <span class="string">&quot;Enter the password: &quot;</span></span><br><span class="line">.text:<span class="number">0804946</span>D                 call    _printf         ; 打印提示</span><br><span class="line">.text:<span class="number">08049472</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049475</span>                 call    handle_user     ; 主要函数</span><br><span class="line">.text:<span class="number">0804947</span>A                 mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">0804947F</span>                 mov     ecx, [ebp+var_4]</span><br><span class="line">.text:<span class="number">08049482</span>                 leave</span><br><span class="line">.text:<span class="number">08049483</span>                 lea     esp, [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">08049486</span>                 retn</span><br><span class="line">.text:<span class="number">08049486</span> ; &#125; <span class="comment">// starts at 8049450</span></span><br><span class="line">.text:<span class="number">08049486</span> main            endp</span><br></pre></td></tr></table></figure>

<h3 id="handle-user"><a href="#handle-user" class="headerlink" title="handle_user()"></a>handle_user()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">080493</span>D0 ; <span class="function"><span class="keyword">int</span> <span class="title">handle_user</span><span class="params">()</span></span></span><br><span class="line"><span class="function">.text:080493D0                 <span class="keyword">public</span> handle_user</span></span><br><span class="line"><span class="function">.text:080493D0 handle_user     proc near               </span>; CODE XREF: main+<span class="number">25</span>↓p</span><br><span class="line">.text:<span class="number">080493</span>D0</span><br><span class="line">.text:<span class="number">080493</span>D0 num_2           = dword ptr <span class="number">-10</span>h</span><br><span class="line">.text:<span class="number">080493</span>D0 num_1           = dword ptr <span class="number">-0</span>Ch</span><br><span class="line">.text:<span class="number">080493</span>D0</span><br><span class="line">.text:<span class="number">080493</span>D0 ; __unwind &#123;</span><br><span class="line">.text:<span class="number">080493</span>D0                 endbr32</span><br><span class="line">.text:<span class="number">080493</span>D4                 push    ebp</span><br><span class="line">.text:<span class="number">080493</span>D5                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">080493</span>D7                 sub     esp, <span class="number">18</span>h</span><br><span class="line">.text:<span class="number">080493</span>DA                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">080493</span>DD                 lea     eax, [ebp+num_2] ; 跟上题不同的是输入后不能用寄存器来作为符号了(一般题目都不会那样)</span><br><span class="line">.text:<span class="number">080493E0</span>                 push    eax</span><br><span class="line">.text:<span class="number">080493E1</span>                 lea     eax, [ebp+num_1] ; 同上</span><br><span class="line">.text:<span class="number">080493E4</span>                 push    eax</span><br><span class="line">.text:<span class="number">080493E5</span>                 push    offset aUU      ; <span class="string">&quot;%u %u&quot;</span></span><br><span class="line">.text:<span class="number">080493</span>EA                 call    ___isoc99_scanf</span><br><span class="line">.text:<span class="number">080493</span>EF                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493F</span>2                 mov     eax, [ebp+num_1]</span><br><span class="line">.text:<span class="number">080493F</span>5                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080493F</span>8                 push    eax</span><br><span class="line">.text:<span class="number">080493F</span>9                 call    complex_function0 ; 给num_1变换</span><br><span class="line">.text:<span class="number">080493F</span>E                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049401</span>                 mov     [ebp+num_1], eax</span><br><span class="line">.text:<span class="number">08049404</span>                 mov     eax, [ebp+num_2]</span><br><span class="line">.text:<span class="number">08049407</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804940</span>A                 push    eax</span><br><span class="line">.text:<span class="number">0804940B</span>                 call    complex_function1 ; 给num_2变换</span><br><span class="line">.text:<span class="number">08049410</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049413</span>                 mov     [ebp+num_2], eax</span><br><span class="line">.text:<span class="number">08049416</span>                 mov     eax, [ebp+num_1] ; 关键比较</span><br><span class="line">.text:<span class="number">08049419</span>                 cmp     eax, <span class="number">0</span>A63C9805h</span><br><span class="line">.text:<span class="number">0804941</span>E                 jnz     <span class="keyword">short</span> loc_804942A</span><br><span class="line">.text:<span class="number">08049420</span>                 mov     eax, [ebp+num_2]</span><br><span class="line">.text:<span class="number">08049423</span>                 cmp     eax, <span class="number">0B</span>47ECDE5h</span><br><span class="line">.text:<span class="number">08049428</span>                 jz      <span class="keyword">short</span> loc_804943C</span><br><span class="line">.text:<span class="number">0804942</span>A</span><br><span class="line">.text:<span class="number">0804942</span>A loc_804942A:                            ; CODE XREF: handle_user+<span class="number">4</span>E↑j</span><br><span class="line">.text:<span class="number">0804942</span>A                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804942</span>D                 push    offset s        ; <span class="string">&quot;Try again.&quot;</span></span><br><span class="line">.text:<span class="number">08049432</span>                 call    _puts</span><br><span class="line">.text:<span class="number">08049437</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804943</span>A                 jmp     <span class="keyword">short</span> loc_804944D</span><br><span class="line">.text:<span class="number">0804943</span>C ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0804943</span>C</span><br><span class="line">.text:<span class="number">0804943</span>C loc_804943C:                            ; CODE XREF: handle_user+<span class="number">58</span>↑j</span><br><span class="line">.text:<span class="number">0804943</span>C                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804943F</span>                 push    offset aGoodJob ; <span class="string">&quot;Good Job.&quot;</span></span><br><span class="line">.text:<span class="number">08049444</span>                 call    _puts</span><br><span class="line">.text:<span class="number">08049449</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804944</span>C                 nop</span><br><span class="line">.text:<span class="number">0804944</span>D</span><br><span class="line">.text:<span class="number">0804944</span>D loc_804944D:                            ; CODE XREF: handle_user+<span class="number">6</span>A↑j</span><br><span class="line">.text:<span class="number">0804944</span>D                 nop</span><br><span class="line">.text:<span class="number">0804944</span>E                 leave</span><br><span class="line">.text:<span class="number">0804944F</span>                 retn</span><br><span class="line">.text:<span class="number">0804944F</span> ; &#125; <span class="comment">// starts at 80493D0</span></span><br><span class="line">.text:<span class="number">0804944F</span> handle_user     endp</span><br></pre></td></tr></table></figure>

<p>根据题目的名字来判断, 我们要用堆栈的局部变量来作为符号.</p>
<p>同时前面有个误区就是我认为的符号执行起点类似于断点, 断点前的语句都执行过了, 然后在断点处注入符号, 而实际上的符号执行起点则是直接从该点开始执行, 前面的语句都没有作用.</p>
<p>所以这里我们要考虑栈存在的问题, 因为scanf以前的语句都没有执行, 所以局部变量其实也是不存在的, 要想通过scanf的两个参数(即两个局部变量)来注入符号, 就需要自己构造一个栈.</p>
<h2 id="使用Angr解题-5"><a href="#使用Angr解题-5" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><p>具体的分析还是先看Angr代码后再讲会清晰一些</p>
<h3 id="以下是解题代码"><a href="#以下是解题代码" class="headerlink" title="以下是解题代码"></a>以下是解题代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This challenge will be more challenging than the previous challenges that you</span></span><br><span class="line"><span class="comment"># have encountered thus far. Since the goal of this CTF is to teach symbolic</span></span><br><span class="line"><span class="comment"># execution and not how to construct stack frames, these comments will work you</span></span><br><span class="line"><span class="comment"># through understanding what is on the stack.</span></span><br><span class="line"><span class="comment">#   ! ! !</span></span><br><span class="line"><span class="comment"># IMPORTANT: Any addresses in this script aren&#x27;t necessarily right! Dissassemble</span></span><br><span class="line"><span class="comment">#            the binary yourself to determine the correct addresses!</span></span><br><span class="line"><span class="comment">#   ! ! !</span></span><br><span class="line"><span class="comment"># 这个挑战比之前的都要难一些. 由于这个CTF的目标是教你Angr而不是堆栈, 因此这些注释将</span></span><br><span class="line"><span class="comment"># 帮助你了解栈上的内容</span></span><br><span class="line"><span class="comment"># 重要提示: 此脚本中的任何地址都不一定是正确的, 需要自己反汇编二进制代码查看</span></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  <span class="comment"># 找到二进制文件并在此基础上建立Angr项目</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># For this challenge, we want to begin after the call to scanf. Note that this</span></span><br><span class="line">  <span class="comment"># is in the middle of a function.</span></span><br><span class="line">  <span class="comment">#针对这个关卡, 我们想要再调用完scanf以后开始符号执行. 记住这是在函数的中间完成的</span></span><br><span class="line">  <span class="comment"># This challenge requires dealing with the stack, so you have to pay extra</span></span><br><span class="line">  <span class="comment"># careful attention to where you start, otherwise you will enter a condition</span></span><br><span class="line">  <span class="comment"># where the stack is set up incorrectly. In order to determine where after</span></span><br><span class="line">  <span class="comment"># scanf to start, we need to look at the dissassembly of the call and the</span></span><br><span class="line">  <span class="comment"># instruction immediately following it:</span></span><br><span class="line">  <span class="comment"># 这个挑战需要处理堆栈, 所以你需要特别注意你从哪里开始, 否则你会进入错误的堆栈.</span></span><br><span class="line">  <span class="comment"># 为了确定scanf之后从哪里开始, 我们需要查看调用的反汇编和紧随其后的指令</span></span><br><span class="line">  <span class="comment">#   sub    $0x4,%esp</span></span><br><span class="line">  <span class="comment">#   lea    -0x10(%ebp),%eax</span></span><br><span class="line">  <span class="comment">#   push   %eax</span></span><br><span class="line">  <span class="comment">#   lea    -0xc(%ebp),%eax</span></span><br><span class="line">  <span class="comment">#   push   %eax</span></span><br><span class="line">  <span class="comment">#   push   $0x80489c3</span></span><br><span class="line">  <span class="comment">#   call   8048370 &lt;__isoc99_scanf@plt&gt;</span></span><br><span class="line">  <span class="comment">#   add    $0x10,%esp</span></span><br><span class="line">  <span class="comment"># Now, the question is: do we start on the instruction immediately following</span></span><br><span class="line">  <span class="comment"># scanf (add $0x10,%esp), or the instruction following that (not shown)?</span></span><br><span class="line">  <span class="comment"># Consider what the &#x27;add $0x10,%esp&#x27; is doing. Hint: it has to do with the</span></span><br><span class="line">  <span class="comment"># scanf parameters that are pushed to the stack before calling the function.</span></span><br><span class="line">  <span class="comment"># Given that we are not calling scanf in our Angr simulation, where should we</span></span><br><span class="line">  <span class="comment"># start?</span></span><br><span class="line">  <span class="comment"># 现在的问题是: 我们是从scanf之后(add $0x10, %esp)开始, 还是在这个指令之后的指令开始.</span></span><br><span class="line">  <span class="comment"># 提示: 它与调用函数之前被压入堆栈的scanf参数有关. </span></span><br><span class="line">  <span class="comment"># 鉴于我们没有在Angr模拟中调用scanf, 我们应该从哪里开始呢?</span></span><br><span class="line">  <span class="comment"># 答案是在add后面开始, 因为该语句负责清理scanf的堆栈, 如果直接在这条语句处开始, 那么使用要调用者函数的栈数据的话, 地址都需要加上0x10</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  start_address = <span class="number">0x80493F2</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># We are jumping into the middle of a function! Therefore, we need to account</span></span><br><span class="line">  <span class="comment"># for how the function constructs the stack. The second instruction of the</span></span><br><span class="line">  <span class="comment"># function is:</span></span><br><span class="line">  <span class="comment"># 我们正在跳入一个函数的中间! 因此, 我们需要知道堆栈的结构, 该函数的第二条指令是</span></span><br><span class="line">  <span class="comment">#   mov    %esp,%ebp这个是ATT风格的汇编语句</span></span><br><span class="line">  <span class="comment"># At which point it allocates the part of the stack frame we plan to target:</span></span><br><span class="line">  <span class="comment"># 在这里上, 它分配了我们计划起始的栈帧的一部分</span></span><br><span class="line">  <span class="comment">#   sub    $0x18,%esp</span></span><br><span class="line">  <span class="comment"># Note the value of esp relative to ebp. The space between them is (usually)</span></span><br><span class="line">  <span class="comment"># the stack space. Since esp was decreased by 0x18</span></span><br><span class="line">  <span class="comment"># 注意esp相对于ebp的值, 它们之间的空间是堆栈栈空间. 由于esp减少了0x18</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#                   高地址</span></span><br><span class="line">  <span class="comment">#        /-------- The stack --------\</span></span><br><span class="line">  <span class="comment"># ebp -&gt; |                           |</span></span><br><span class="line">  <span class="comment">#        |---------------------------|</span></span><br><span class="line">  <span class="comment">#        |                           |</span></span><br><span class="line">  <span class="comment">#        |---------------------------|</span></span><br><span class="line">  <span class="comment">#         . . . (total of 0x18 bytes)</span></span><br><span class="line">  <span class="comment">#         . . . Somewhere in here is</span></span><br><span class="line">  <span class="comment">#         . . . the data that stores</span></span><br><span class="line">  <span class="comment">#         . . . the result of scanf.</span></span><br><span class="line">  <span class="comment"># esp -&gt; |                           |</span></span><br><span class="line">  <span class="comment">#        \---------------------------/</span></span><br><span class="line">  <span class="comment">#                   低地址</span></span><br><span class="line">  <span class="comment"># Since we are starting after scanf, we are skipping this stack construction</span></span><br><span class="line">  <span class="comment"># step. To make up for this, we need to construct the stack ourselves. Let us</span></span><br><span class="line">  <span class="comment"># start by initializing ebp in the exact same way the program does.</span></span><br><span class="line">  <span class="comment"># 因为我们是在scanf之后开始的, 所以我们跳过了这个堆栈构建步骤.</span></span><br><span class="line">  <span class="comment"># 为了弥补这一点, 我们需要自己构建堆栈. 然我们以与程序完全相同的方式初始化ebp</span></span><br><span class="line">  initial_state.regs.ebp = initial_state.regs.esp</span><br><span class="line"></span><br><span class="line">  <span class="comment"># scanf(&quot;%u %u&quot;) needs to be replaced by injecting two bitvectors. The</span></span><br><span class="line">  <span class="comment"># reason for this is that Angr does not (currently) automatically inject</span></span><br><span class="line">  <span class="comment"># symbols if scanf has more than one input parameter. This means Angr can</span></span><br><span class="line">  <span class="comment"># handle &#x27;scanf(&quot;%u&quot;)&#x27;, but not &#x27;scanf(&quot;%u %u&quot;)&#x27;.</span></span><br><span class="line">  <span class="comment"># You can either copy and paste the line below or use a Python list.</span></span><br><span class="line">  <span class="comment"># scanf(&quot;%u %u&quot;)需要通过注入两个位向量来替换. 原因是如果scanf有多个输入参数, Angr不会自动注入符号</span></span><br><span class="line">  <span class="comment"># 这意味着Angr可以处理scanf(&quot;%u&quot;), 但不能处理scanf(&quot;%u %u&quot;).</span></span><br><span class="line">  <span class="comment"># 你可以复制粘贴下面的行或使用Python列表</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password_size_bits = <span class="number">32</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password_size_bits)</span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password_size_bits)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Here is the hard part. We need to figure out what the stack looks like, at</span></span><br><span class="line">  <span class="comment"># least well enough to inject our symbols where we want them. In order to do</span></span><br><span class="line">  <span class="comment"># that, let&#x27;s figure out what the parameters of scanf are:</span></span><br><span class="line">  <span class="comment"># 这是最难的部分, 我们需要能清楚堆栈长什么样, 至少能让我们的符号注入我们想要的地方.</span></span><br><span class="line">  <span class="comment"># 为了做到这一点, 让我们能清楚scanf的参数是什么</span></span><br><span class="line">  <span class="comment">#   sub    $0x4,%esp</span></span><br><span class="line">  <span class="comment">#   lea    -0x10(%ebp),%eax</span></span><br><span class="line">  <span class="comment">#   push   %eax</span></span><br><span class="line">  <span class="comment">#   lea    -0xc(%ebp),%eax</span></span><br><span class="line">  <span class="comment">#   push   %eax</span></span><br><span class="line">  <span class="comment">#   push   $0x80489c3</span></span><br><span class="line">  <span class="comment">#   call   8048370 &lt;__isoc99_scanf@plt&gt;</span></span><br><span class="line">  <span class="comment">#   add    $0x10,%esp </span></span><br><span class="line">  <span class="comment"># As you can see, the call to scanf looks like this:</span></span><br><span class="line">  <span class="comment"># 正如你所看见的, 对scanf的调用如下所示</span></span><br><span class="line">  <span class="comment"># scanf(  0x80489c3,   ebp - 0xc,   ebp - 0x10  )</span></span><br><span class="line">  <span class="comment">#      format_string    password0    password1</span></span><br><span class="line">  <span class="comment">#  From this, we can construct our new, more accurate stack diagram:</span></span><br><span class="line">  <span class="comment"># 由此, 我们可以构建新的, 更准确的堆栈图</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment">#            /-------- The stack --------\</span></span><br><span class="line">  <span class="comment"># ebp -&gt;     |          padding          |</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment"># ebp - 0x01 |       more padding        |</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment"># ebp - 0x02 |     even more padding     |</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment">#                        . . .               &lt;- How much padding? Hint: how</span></span><br><span class="line">  <span class="comment">#            |---------------------------|      many bytes is password0?  填充了9个字节, password0从9开始</span></span><br><span class="line">  <span class="comment"># ebp - 0x0b |   password0, second byte  |</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment"># ebp - 0x0c |   password0, first byte   |</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment"># ebp - 0x0d |   password1, last byte    |</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment">#                        . . .</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment"># ebp - 0x10 |   password1, first byte   |</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment">#                        . . .</span></span><br><span class="line">  <span class="comment">#            |---------------------------|</span></span><br><span class="line">  <span class="comment"># esp -&gt;     |                           |</span></span><br><span class="line">  <span class="comment">#            \---------------------------/</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Figure out how much space there is and allocate the necessary padding to</span></span><br><span class="line">  <span class="comment"># the stack by decrementing esp before you push the password bitvectors.</span></span><br><span class="line">  <span class="comment"># 计算出有多少空间, 并在你压入password位向量之前通过递减esp来分配栈空间</span></span><br><span class="line">  padding_length_in_bytes = <span class="number">0x8</span>  <span class="comment"># :integer</span></span><br><span class="line">  initial_state.regs.esp -= padding_length_in_bytes<span class="comment">#相当于汇编: sub    esp, 0x10</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Push the variables to the stack. Make sure to push them in the right order!</span></span><br><span class="line">  <span class="comment"># The syntax for the following function is:</span></span><br><span class="line">  <span class="comment">#将变量压入堆栈, 确保以正确的形式压入它们(正确的顺序), 以下函数的语法是:</span></span><br><span class="line">  <span class="comment"># initial_state.stack_push(bitvector)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># This will push the bitvector on the stack, and increment esp the correct</span></span><br><span class="line">  <span class="comment"># amount. You will need to push multiple bitvectors on the stack.</span></span><br><span class="line">  <span class="comment"># 这会将位向量压入栈中, 并给esp加上正确的值</span></span><br><span class="line">  <span class="comment"># 你将需要再栈中压入许多的位向量</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  initial_state.stack_push(password0)  <span class="comment"># :bitvector (claripy.BVS, claripy.BVV, claripy.BV)</span></span><br><span class="line">  initial_state.stack_push(password1)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0)</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1)</span><br><span class="line"></span><br><span class="line">    solution = <span class="built_in">str</span>((solution0)) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>((solution1))</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后-3"><a href="#去掉注释后-3" class="headerlink" title="去掉注释后"></a>去掉注释后</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = <span class="number">0x80493F2</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line">  initial_state.regs.ebp = initial_state.regs.esp</span><br><span class="line"></span><br><span class="line">  password_size_bits = <span class="number">32</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password_size_bits)</span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password_size_bits)</span><br><span class="line"></span><br><span class="line">  padding_length_in_bytes = <span class="number">0x8</span></span><br><span class="line">  initial_state.regs.esp -= padding_length_in_bytes</span><br><span class="line"></span><br><span class="line">  initial_state.stack_push(password0)</span><br><span class="line">  initial_state.stack_push(password1)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0)</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1)</span><br><span class="line"></span><br><span class="line">    solution = <span class="built_in">str</span>((solution0)) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>((solution1))</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="问题一-符号执行的起点是在add-esp-10h前面还是后面"><a href="#问题一-符号执行的起点是在add-esp-10h前面还是后面" class="headerlink" title="问题一: 符号执行的起点是在add     esp, 10h前面还是后面"></a>问题一: 符号执行的起点是在<code>add     esp, 10h</code>前面还是后面</h3><p>这里我们要知道的是: <strong>在符号执行之前, Angr就会完成符号注入</strong></p>
<p>如果在<code>add     esp, 10h</code>处注入, Angr会先获取该条指令处的state, 而当前的state的esp指针是经过了<code>___isoc99_scanf</code>的retn指令后的入口地址, 但是参数是在调用之前压入栈中的, 也就是说此时的esp是在传入三个参数后的位置. 此时注入了两个符号分别是<code>esp - 8</code> 和 <code>esp - 4</code>, <strong>在注入完成后才执行</strong><code>add     esp, 10h</code>, 这个指令的作用就是清理参数的栈回到调用者的栈顶, 所以前面注入的符号直接作废了.   下面的图像会直观一些</p>
<p>这是在<code>add     esp, 10h</code>命令的位置符号执行, <strong>符号注入发生在符号执行之前</strong><img src="/2022/05/18/AngrLab2c872/image3.png" alt="image.png"></p>
<p>下面是执行完<code>add     esp, 10h</code>命令后</p>
<p><img src="/2022/05/18/AngrLab2c872/image4.png" alt="image.png"></p>
<p>所以我们需要在<code>add     esp, 10h</code>后开始符号执行</p>
<h3 id="关于栈注入符号的理解"><a href="#关于栈注入符号的理解" class="headerlink" title="关于栈注入符号的理解"></a>关于栈注入符号的理解</h3><p>即假定一块栈的内容为x, 然后进行条件约束并求解.</p>
<h3 id="如何注入"><a href="#如何注入" class="headerlink" title="如何注入"></a>如何注入</h3><h4 id="1-构造栈"><a href="#1-构造栈" class="headerlink" title="1. 构造栈"></a>1. 构造栈</h4><p>可以看看引用password的方式<code>ebp - 0xc</code> 和 <code>ebp - 0x10</code>, 都是通过ebp加上偏移量来是实现的, 我们需要自己构造一个栈用来保存自己的符号. 同时保证后面的汇编语句能够正确引用到我们的符号</p>
<p><img src="/2022/05/18/AngrLab2c872/image5.png" alt="image.png"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initial_state.regs.ebp = initial_state.regs.esp</span><br></pre></td></tr></table></figure>

<p>当ebp改变时, 就是创建了一个新的栈帧, 也就是一个新的栈.</p>
<h4 id="向栈中注入符号"><a href="#向栈中注入符号" class="headerlink" title="向栈中注入符号"></a>向栈中注入符号</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">padding_length_in_bytes = <span class="number">0x8</span></span><br><span class="line">initial_state.regs.esp -= padding_length_in_bytes</span><br><span class="line"></span><br><span class="line">initial_state.stack_push(password0)</span><br><span class="line">initial_state.stack_push(password1)</span><br></pre></td></tr></table></figure>

<p>前两个语句是调整偏移, 为了模仿原本的栈结构, 使后面的汇编语句能够正确引用到这两个符号.</p>
<p>下面的两个语句就是注入符号到栈中了(源代码在前面申请了这两个32位的符号)</p>
<h4 id="符号执行"><a href="#符号执行" class="headerlink" title="符号执行"></a>符号执行</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simulation = project.factory.simgr(initial_state)</span><br></pre></td></tr></table></figure>

<h1 id="05-angr-symbolic-memory"><a href="#05-angr-symbolic-memory" class="headerlink" title="05_angr_symbolic_memory"></a>05_angr_symbolic_memory</h1><h2 id="编译并执行-1"><a href="#编译并执行-1" class="headerlink" title="编译并执行"></a>编译并执行</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/05_angr_symbolic_memory$ python3 generate.py <span class="number">1234</span> 05_angr_symbolic_memory</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/05_angr_symbolic_memory$ ./05_angr_symbolic_memory</span><br><span class="line">Enter the password: aaaaa</span><br><span class="line">aaaaa</span><br><span class="line">aaaaa</span><br><span class="line">aaaaa</span><br><span class="line">Try again.</span><br></pre></td></tr></table></figure>

<h2 id="分析-5"><a href="#分析-5" class="headerlink" title="分析"></a>分析</h2><p>使用IDA查看</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">080492B</span>B ; __unwind &#123;</span><br><span class="line">.text:<span class="number">080492B</span>B                 endbr32</span><br><span class="line">.text:<span class="number">080492B</span>F                 lea     ecx, [esp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">080492</span>C3                 <span class="keyword">and</span>     esp, <span class="number">0F</span>FFFFFF0h</span><br><span class="line">.text:<span class="number">080492</span>C6                 push    dword ptr [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">080492</span>C9                 push    ebp</span><br><span class="line">.text:<span class="number">080492</span>CA                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">080492</span>CC                 push    ecx</span><br><span class="line">.text:<span class="number">080492</span>CD                 sub     esp, <span class="number">14</span>h</span><br><span class="line">.text:<span class="number">080492</span>D0                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">080492</span>D3                 push    <span class="number">21</span>h ; <span class="string">&#x27;!&#x27;</span>       ; n</span><br><span class="line">.text:<span class="number">080492</span>D5                 push    <span class="number">0</span>               ; c</span><br><span class="line">.text:<span class="number">080492</span>D7                 push    offset user_input ; s</span><br><span class="line">.text:<span class="number">080492</span>DC                 call    _memset         ; 初始化内存</span><br><span class="line">.text:<span class="number">080492E1</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080492E4</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080492E7</span>                 push    offset aEnterThePasswo ; <span class="string">&quot;Enter the password: &quot;</span></span><br><span class="line">.text:<span class="number">080492</span>EC                 call    _printf</span><br><span class="line">.text:<span class="number">080492F</span>1                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080492F</span>4                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080492F</span>7                 push    offset unk_8134378</span><br><span class="line">.text:<span class="number">080492F</span>C                 push    offset unk_8134370</span><br><span class="line">.text:<span class="number">08049301</span>                 push    offset unk_8134368</span><br><span class="line">.text:<span class="number">08049306</span>                 push    offset user_input ; 将输入保存在上面申请的内存中</span><br><span class="line">.text:<span class="number">0804930B</span>                 push    offset a8s8s8s8s ; <span class="string">&quot;%8s %8s %8s %8s&quot;</span></span><br><span class="line">.text:<span class="number">08049310</span>                 call    ___isoc99_scanf</span><br><span class="line">.text:<span class="number">08049315</span>                 add     esp, <span class="number">20</span>h</span><br><span class="line">.text:<span class="number">08049318</span>                 mov     [ebp+var_C], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0804931F</span>                 jmp     <span class="keyword">short</span> loc_804934E</span><br><span class="line">.text:<span class="number">08049321</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049321</span></span><br><span class="line">.text:<span class="number">08049321</span> loc_8049321:                            ; CODE XREF: main+<span class="number">97</span>↓j</span><br><span class="line">.text:<span class="number">08049321</span>                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:<span class="number">08049324</span>                 add     eax, <span class="number">8134360</span>h</span><br><span class="line">.text:<span class="number">08049329</span>                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">0804932</span>C                 movsx   eax, al</span><br><span class="line">.text:<span class="number">0804932F</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">08049332</span>                 push    [ebp+var_C]</span><br><span class="line">.text:<span class="number">08049335</span>                 push    eax             ; 将内存中保存的输入进行变换</span><br><span class="line">.text:<span class="number">08049336</span>                 call    complex_function</span><br><span class="line">.text:<span class="number">0804933B</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804933</span>E                 mov     edx, eax</span><br><span class="line">.text:<span class="number">08049340</span>                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:<span class="number">08049343</span>                 add     eax, <span class="number">8134360</span>h</span><br><span class="line">.text:<span class="number">08049348</span>                 mov     [eax], dl</span><br><span class="line">.text:<span class="number">0804934</span>A                 add     [ebp+var_C], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0804934</span>E</span><br><span class="line">.text:<span class="number">0804934</span>E loc_804934E:                            ; CODE XREF: main+<span class="number">64</span>↑j</span><br><span class="line">.text:<span class="number">0804934</span>E                 cmp     [ebp+var_C], <span class="number">1F</span>h</span><br><span class="line">.text:<span class="number">08049352</span>                 jle     <span class="keyword">short</span> loc_8049321</span><br><span class="line">.text:<span class="number">08049354</span>                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">08049357</span>                 push    <span class="number">20</span>h ; <span class="string">&#x27; &#x27;</span>       ; n</span><br><span class="line">.text:<span class="number">08049359</span>                 push    offset s2       ; <span class="string">&quot;HXUITWOAPNESFFEGWWORQMFUTTYBKKFF&quot;</span></span><br><span class="line">.text:<span class="number">0804935</span>E                 push    offset user_input ; s1</span><br><span class="line">.text:<span class="number">08049363</span>                 call    _strncmp</span><br><span class="line">.text:<span class="number">08049368</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804936B</span>                 test    eax, eax</span><br><span class="line">.text:<span class="number">0804936</span>D                 jz      <span class="keyword">short</span> loc_8049381</span><br><span class="line">.text:<span class="number">0804936F</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049372</span>                 push    offset s        ; <span class="string">&quot;Try again.&quot;</span></span><br><span class="line">.text:<span class="number">08049377</span>                 call    _puts</span><br><span class="line">.text:<span class="number">0804937</span>C                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804937F</span>                 jmp     <span class="keyword">short</span> loc_8049391</span><br><span class="line">.text:<span class="number">08049381</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049381</span></span><br><span class="line">.text:<span class="number">08049381</span> loc_8049381:                            ; CODE XREF: main+B2↑j</span><br><span class="line">.text:<span class="number">08049381</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049384</span>                 push    offset aGoodJob ; <span class="string">&quot;Good Job.&quot;</span></span><br><span class="line">.text:<span class="number">08049389</span>                 call    _puts</span><br><span class="line">.text:<span class="number">0804938</span>E                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049391</span></span><br><span class="line">.text:<span class="number">08049391</span> loc_8049391:                            ; CODE XREF: main+C4↑j</span><br><span class="line">.text:<span class="number">08049391</span>                 mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">08049396</span>                 mov     ecx, [ebp+var_4]</span><br><span class="line">.text:<span class="number">08049399</span>                 leave</span><br><span class="line">.text:<span class="number">0804939</span>A                 lea     esp, [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">0804939</span>D                 retn</span><br><span class="line">.text:<span class="number">0804939</span>D ; &#125; <span class="comment">// starts at 80492BB</span></span><br><span class="line">.text:<span class="number">0804939</span>D main            endp</span><br><span class="line">.text:<span class="number">0804939</span>D</span><br><span class="line">.text:<span class="number">0804939</span>D ; ---------------------------------------------------------------------------</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到现在题目中有四个输入, 所以不能让Angr自动执行, 同时输入也没有保存在栈中, 而是在一段内存中.</p>
<p>查看complex_function()的调用处的汇编可以发现内存的地址是一个常量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">08049321</span>                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:<span class="number">08049324</span>                 add     eax, <span class="number">8134360</span>h</span><br><span class="line">.text:<span class="number">08049329</span>                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">0804932</span>C                 movsx   eax, al</span><br><span class="line">.text:<span class="number">0804932F</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">08049332</span>                 push    [ebp+var_C]</span><br><span class="line">.text:<span class="number">08049335</span>                 push    eax             ; 将内存中保存的输入进行变换</span><br><span class="line">.text:<span class="number">08049336</span>                 call    complex_function</span><br></pre></td></tr></table></figure>

<p>于是我们得到保存输入的内存地址为: 0x8134360</p>
<h2 id="使用Angr解题-6"><a href="#使用Angr解题-6" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><h3 id="代码-3"><a href="#代码-3" class="headerlink" title="代码"></a>代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  <span class="comment"># 获取二进制文件, 并在该二进制文件上建立Angr文件</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 符号执行的地址</span></span><br><span class="line">  start_address = <span class="number">0x08049315</span>     <span class="comment">#必要条件: 必须在memset后面, 如果在前面的话, 该段内存还未被用户使用, Angr复原的就是无用数据</span></span><br><span class="line">                                 <span class="comment">#必要条件: 要在scanf后面, 如果在前面的话, Angr还原的state就是在scanf前的处于初始化的数据了</span></span><br><span class="line">                                 <span class="comment">#问题: 是否还要再管那个栈空间, 经过验证是不用管的, 前面后面都可以</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># The binary is calling scanf(&quot;%8s %8s %8s %8s&quot;).</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password_len_bits = <span class="number">64</span> <span class="comment"># 8个字符, 一个字符8位, 总共64位</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password_len_bits)</span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password_len_bits)</span><br><span class="line">  password2 = claripy.BVS(<span class="string">&#x27;password2&#x27;</span>, password_len_bits)</span><br><span class="line">  password3 = claripy.BVS(<span class="string">&#x27;password3&#x27;</span>, password_len_bits)</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Determine the address of the global variable to which scanf writes the user</span></span><br><span class="line">  <span class="comment"># input. The function &#x27;initial_state.memory.store(address, value)&#x27; will write</span></span><br><span class="line">  <span class="comment"># &#x27;value&#x27; (a bitvector) to &#x27;address&#x27; (a memory location, as an integer.) The</span></span><br><span class="line">  <span class="comment"># &#x27;address&#x27; parameter can also be a bitvector (and can be symbolic!).</span></span><br><span class="line">  <span class="comment"># 确定scanf写入输入的全局变量的地址.</span></span><br><span class="line">  <span class="comment"># 函数initial_state.memory.store(address, value)的作用是</span></span><br><span class="line">  <span class="comment"># 将参数value(位向量)写入地址为address的内存</span></span><br><span class="line">  <span class="comment"># 参数address也可以是位向量(也可以是符号)</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password0_address = <span class="number">0x8134360</span></span><br><span class="line">  initial_state.memory.store(password0_address, password0)</span><br><span class="line">  initial_state.memory.store(password0_address + <span class="number">0x8</span>, password1)</span><br><span class="line">  initial_state.memory.store(password0_address + <span class="number">0x10</span>, password2)</span><br><span class="line">  initial_state.memory.store(password0_address + <span class="number">0x18</span>, password3)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Solve for the symbolic values. We are trying to solve for a string.</span></span><br><span class="line">    <span class="comment"># Therefore, we will use eval, with named parameter cast_to=bytes</span></span><br><span class="line">    <span class="comment"># which returns bytes that can be decoded to a string instead of an integer.</span></span><br><span class="line">    <span class="comment"># 求解符号值.</span></span><br><span class="line">    <span class="comment"># 我们正常是解出一个字符串, 因此, 我们将使用带有  命名参数cast_to=bytes的eval函数</span></span><br><span class="line">    <span class="comment"># 加上该参数后这个函数将返回解码为字符串的数据. 而不是整数的字节</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    <span class="comment"># cast_to = bytes表示切片成单字节, 然后外部用decode解码成unicode</span></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution2 = solution_state.solver.<span class="built_in">eval</span>(password2,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution3 = solution_state.solver.<span class="built_in">eval</span>(password3,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution = solution0 + solution1 + solution2 + solution3</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后的代码"><a href="#去掉注释后的代码" class="headerlink" title="去掉注释后的代码"></a>去掉注释后的代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = <span class="number">0x08049318</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  password_len_bits = <span class="number">64</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password_len_bits)</span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password_len_bits)</span><br><span class="line">  password2 = claripy.BVS(<span class="string">&#x27;password2&#x27;</span>, password_len_bits)</span><br><span class="line">  password3 = claripy.BVS(<span class="string">&#x27;password3&#x27;</span>, password_len_bits)</span><br><span class="line"></span><br><span class="line">  password0_address = <span class="number">0x8134360</span></span><br><span class="line">  initial_state.memory.store(password0_address, password0)</span><br><span class="line">  initial_state.memory.store(password0_address + <span class="number">0x8</span>, password1)</span><br><span class="line">  initial_state.memory.store(password0_address + <span class="number">0x10</span>, password2)</span><br><span class="line">  initial_state.memory.store(password0_address + <span class="number">0x18</span>, password3)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution2 = solution_state.solver.<span class="built_in">eval</span>(password2,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution3 = solution_state.solver.<span class="built_in">eval</span>(password3,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution = solution0 + solution1 + solution2 + solution3</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="符号执行的地址的位置"><a href="#符号执行的地址的位置" class="headerlink" title="符号执行的地址的位置"></a>符号执行的地址的位置</h3><h4 id="memset"><a href="#memset" class="headerlink" title="memset()"></a>memset()</h4><p>我们的用户输入是发生再memset()后面的, 所以要在memset()后面符号执行</p>
<h4 id="scanf"><a href="#scanf" class="headerlink" title="scanf()"></a>scanf()</h4><p>如果再scanf()之前注入符号的话, Angr还原的state也是scanf()之前的那段内存了, 而在scanf调用之前的内存还是00 00 00 00这样的形式, 所以必须要scanf()后面符号执行</p>
<h4 id="add-esp-10h"><a href="#add-esp-10h" class="headerlink" title="add     esp, 10h"></a><code>add     esp, 10h</code></h4><p>是否要在这条指令后面开始执行, 因为本题没有涉及栈的符号注入, 所以不用在意在前还是在后. 后面经过检验确实是这样.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start_address = <span class="number">0x08049315</span>   <span class="comment">#这是add     esp, 10h</span></span><br><span class="line">start_address = <span class="number">0x08049318</span>   <span class="comment">#这是add     esp, 10h的下一个汇编语句</span></span><br><span class="line"><span class="comment"># 二者都能得到正确的flag</span></span><br></pre></td></tr></table></figure>

<h1 id="06-angr-symbolic-dynamic-memory"><a href="#06-angr-symbolic-dynamic-memory" class="headerlink" title="06_angr_symbolic_dynamic_memory"></a>06_angr_symbolic_dynamic_memory</h1><h2 id="编译并运行-3"><a href="#编译并运行-3" class="headerlink" title="编译并运行"></a>编译并运行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/06_angr_symbolic_dynamic_memory$ python3 generate.py 1234 06_angr_symbolic_dynamic_memory</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/06_angr_symbolic_dynamic_memory$ ./06_angr_symbolic_dynamic_memory</span><br><span class="line">Enter the password: aaaaaaaaaaaa</span><br><span class="line">Try again.</span><br></pre></td></tr></table></figure>

<h2 id="分析-6"><a href="#分析-6" class="headerlink" title="分析"></a>分析</h2><p>使用IDA分析</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">; <span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function">.text:080492FF                 <span class="keyword">public</span> main</span></span><br><span class="line"><span class="function">.text:080492FF main            proc near               </span>; DATA XREF: _start+<span class="number">2</span>A↑o</span><br><span class="line">.text:<span class="number">080492F</span>F</span><br><span class="line">.text:<span class="number">080492F</span>F i               = dword ptr <span class="number">-0</span>Ch</span><br><span class="line">.text:<span class="number">080492F</span>F var_4           = dword ptr <span class="number">-4</span></span><br><span class="line">.text:<span class="number">080492F</span>F argc            = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">080492F</span>F argv            = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080492F</span>F envp            = dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080492F</span>F</span><br><span class="line">.text:<span class="number">080492F</span>F ; __unwind &#123;</span><br><span class="line">.text:<span class="number">080492F</span>F                 endbr32</span><br><span class="line">.text:<span class="number">08049303</span>                 lea     ecx, [esp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">08049307</span>                 <span class="keyword">and</span>     esp, <span class="number">0F</span>FFFFFF0h</span><br><span class="line">.text:<span class="number">0804930</span>A                 push    dword ptr [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">0804930</span>D                 push    ebp</span><br><span class="line">.text:<span class="number">0804930</span>E                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">08049310</span>                 push    ecx</span><br><span class="line">.text:<span class="number">08049311</span>                 sub     esp, <span class="number">14</span>h</span><br><span class="line">.text:<span class="number">08049314</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049317</span>                 push    <span class="number">9</span>               ; size</span><br><span class="line">.text:<span class="number">08049319</span>                 call    _malloc         ; 申请内存</span><br><span class="line">.text:<span class="number">0804931</span>E                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049321</span>                 mov     ds:buffer0, eax</span><br><span class="line">.text:<span class="number">08049326</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049329</span>                 push    <span class="number">9</span>               ; size</span><br><span class="line">.text:<span class="number">0804932B</span>                 call    _malloc         ; 申请内存</span><br><span class="line">.text:<span class="number">08049330</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049333</span>                 mov     ds:buffer1, eax</span><br><span class="line">.text:<span class="number">08049338</span>                 mov     eax, ds:buffer0</span><br><span class="line">.text:<span class="number">0804933</span>D                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">08049340</span>                 push    <span class="number">9</span>               ; n</span><br><span class="line">.text:<span class="number">08049342</span>                 push    <span class="number">0</span>               ; c</span><br><span class="line">.text:<span class="number">08049344</span>                 push    eax             ; s</span><br><span class="line">.text:<span class="number">08049345</span>                 call    _memset         ; 初始化内存</span><br><span class="line">.text:<span class="number">0804934</span>A                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804934</span>D                 mov     eax, ds:buffer1</span><br><span class="line">.text:<span class="number">08049352</span>                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">08049355</span>                 push    <span class="number">9</span>               ; n</span><br><span class="line">.text:<span class="number">08049357</span>                 push    <span class="number">0</span>               ; c</span><br><span class="line">.text:<span class="number">08049359</span>                 push    eax             ; s</span><br><span class="line">.text:<span class="number">0804935</span>A                 call    _memset         ; 初始化内存</span><br><span class="line">.text:<span class="number">0804935F</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049362</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049365</span>                 push    offset aEnterThePasswo ; <span class="string">&quot;Enter the password: &quot;</span></span><br><span class="line">.text:<span class="number">0804936</span>A                 call    _printf</span><br><span class="line">.text:<span class="number">0804936F</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049372</span>                 mov     edx, ds:buffer1</span><br><span class="line">.text:<span class="number">08049378</span>                 mov     eax, ds:buffer0</span><br><span class="line">.text:<span class="number">0804937</span>D                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">08049380</span>                 push    edx</span><br><span class="line">.text:<span class="number">08049381</span>                 push    eax</span><br><span class="line">.text:<span class="number">08049382</span>                 push    offset a8s8s    ; <span class="string">&quot;%8s %8s&quot;</span></span><br><span class="line">.text:<span class="number">08049387</span>                 call    ___isoc99_scanf ; 用户输入</span><br><span class="line">.text:<span class="number">0804938</span>C                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804938F</span>                 mov     [ebp+i], <span class="number">0</span></span><br><span class="line">.text:<span class="number">08049396</span>                 jmp     <span class="keyword">short</span> loc_8049402</span><br><span class="line">.text:<span class="number">08049398</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049398</span></span><br><span class="line">.text:<span class="number">08049398</span> loc_8049398:                            ; CODE XREF: main+<span class="number">107</span>↓j</span><br><span class="line">.text:<span class="number">08049398</span>                 mov     edx, ds:buffer0</span><br><span class="line">.text:<span class="number">0804939</span>E                 mov     eax, [ebp+i]</span><br><span class="line">.text:<span class="number">080493</span>A1                 add     eax, edx</span><br><span class="line">.text:<span class="number">080493</span>A3                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">080493</span>A6                 movsx   eax, al</span><br><span class="line">.text:<span class="number">080493</span>A9                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080493</span>AC                 push    [ebp+i]</span><br><span class="line">.text:<span class="number">080493</span>AF                 push    eax</span><br><span class="line">.text:<span class="number">080493B</span>0                 call    complex_function ; 对password0进行变换</span><br><span class="line">.text:<span class="number">080493B</span>5                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493B</span>8                 mov     ecx, eax</span><br><span class="line">.text:<span class="number">080493B</span>A                 mov     edx, ds:buffer0</span><br><span class="line">.text:<span class="number">080493</span>C0                 mov     eax, [ebp+i]</span><br><span class="line">.text:<span class="number">080493</span>C3                 add     eax, edx</span><br><span class="line">.text:<span class="number">080493</span>C5                 mov     edx, ecx</span><br><span class="line">.text:<span class="number">080493</span>C7                 mov     [eax], dl</span><br><span class="line">.text:<span class="number">080493</span>C9                 mov     eax, [ebp+i]</span><br><span class="line">.text:<span class="number">080493</span>CC                 lea     edx, [eax+<span class="number">20</span>h]</span><br><span class="line">.text:<span class="number">080493</span>CF                 mov     ecx, ds:buffer1</span><br><span class="line">.text:<span class="number">080493</span>D5                 mov     eax, [ebp+i]</span><br><span class="line">.text:<span class="number">080493</span>D8                 add     eax, ecx</span><br><span class="line">.text:<span class="number">080493</span>DA                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">080493</span>DD                 movsx   eax, al</span><br><span class="line">.text:<span class="number">080493E0</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080493E3</span>                 push    edx</span><br><span class="line">.text:<span class="number">080493E4</span>                 push    eax</span><br><span class="line">.text:<span class="number">080493E5</span>                 call    complex_function ; 对password1进行变换</span><br><span class="line">.text:<span class="number">080493</span>EA                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493</span>ED                 mov     ecx, eax</span><br><span class="line">.text:<span class="number">080493</span>EF                 mov     edx, ds:buffer1</span><br><span class="line">.text:<span class="number">080493F</span>5                 mov     eax, [ebp+i]</span><br><span class="line">.text:<span class="number">080493F</span>8                 add     eax, edx</span><br><span class="line">.text:<span class="number">080493F</span>A                 mov     edx, ecx</span><br><span class="line">.text:<span class="number">080493F</span>C                 mov     [eax], dl</span><br><span class="line">.text:<span class="number">080493F</span>E                 add     [ebp+i], <span class="number">1</span></span><br><span class="line">.text:<span class="number">08049402</span></span><br><span class="line">.text:<span class="number">08049402</span> loc_8049402:                            ; CODE XREF: main+<span class="number">97</span>↑j</span><br><span class="line">.text:<span class="number">08049402</span>                 cmp     [ebp+i], <span class="number">7</span></span><br><span class="line">.text:<span class="number">08049406</span>                 jle     <span class="keyword">short</span> loc_8049398</span><br><span class="line">.text:<span class="number">08049408</span>                 mov     eax, ds:buffer0</span><br><span class="line">.text:<span class="number">0804940</span>D                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">08049410</span>                 push    <span class="number">8</span>               ; n</span><br><span class="line">.text:<span class="number">08049412</span>                 push    offset s2       ; <span class="string">&quot;HXUITWOA&quot;</span></span><br><span class="line">.text:<span class="number">08049417</span>                 push    eax             ; s1</span><br><span class="line">.text:<span class="number">08049418</span>                 call    _strncmp        ; 检验</span><br><span class="line">.text:<span class="number">0804941</span>D                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049420</span>                 test    eax, eax</span><br><span class="line">.text:<span class="number">08049422</span>                 jnz     <span class="keyword">short</span> loc_8049440</span><br><span class="line">.text:<span class="number">08049424</span>                 mov     eax, ds:buffer1</span><br><span class="line">.text:<span class="number">08049429</span>                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">0804942</span>C                 push    <span class="number">8</span>               ; n</span><br><span class="line">.text:<span class="number">0804942</span>E                 push    offset aPnesffeg ; <span class="string">&quot;PNESFFEG&quot;</span></span><br><span class="line">.text:<span class="number">08049433</span>                 push    eax             ; s1</span><br><span class="line">.text:<span class="number">08049434</span>                 call    _strncmp        ; 检验</span><br><span class="line">.text:<span class="number">08049439</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804943</span>C                 test    eax, eax</span><br><span class="line">.text:<span class="number">0804943</span>E                 jz      <span class="keyword">short</span> loc_8049452</span><br><span class="line">.text:<span class="number">08049440</span></span><br><span class="line">.text:<span class="number">08049440</span> loc_8049440:                            ; CODE XREF: main+<span class="number">123</span>↑j</span><br><span class="line">.text:<span class="number">08049440</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049443</span>                 push    offset s        ; <span class="string">&quot;Try again.&quot;</span></span><br><span class="line">.text:<span class="number">08049448</span>                 call    _puts</span><br><span class="line">.text:<span class="number">0804944</span>D                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049450</span>                 jmp     <span class="keyword">short</span> loc_8049462</span><br><span class="line">.text:<span class="number">08049452</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049452</span></span><br><span class="line">.text:<span class="number">08049452</span> loc_8049452:                            ; CODE XREF: main+<span class="number">13F</span>↑j</span><br><span class="line">.text:<span class="number">08049452</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049455</span>                 push    offset aGoodJob ; <span class="string">&quot;Good Job.&quot;</span></span><br><span class="line">.text:<span class="number">0804945</span>A                 call    _puts</span><br><span class="line">.text:<span class="number">0804945F</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049462</span></span><br><span class="line">.text:<span class="number">08049462</span> loc_8049462:                            ; CODE XREF: main+<span class="number">151</span>↑j</span><br><span class="line">.text:<span class="number">08049462</span>                 mov     eax, ds:buffer0</span><br><span class="line">.text:<span class="number">08049467</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804946</span>A                 push    eax             ; ptr</span><br><span class="line">.text:<span class="number">0804946B</span>                 call    _free</span><br><span class="line">.text:<span class="number">08049470</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049473</span>                 mov     eax, ds:buffer1</span><br><span class="line">.text:<span class="number">08049478</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804947B</span>                 push    eax             ; ptr</span><br><span class="line">.text:<span class="number">0804947</span>C                 call    _free</span><br><span class="line">.text:<span class="number">08049481</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049484</span>                 mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">08049489</span>                 mov     ecx, [ebp+var_4]</span><br><span class="line">.text:<span class="number">0804948</span>C                 leave</span><br><span class="line">.text:<span class="number">0804948</span>D                 lea     esp, [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">08049490</span>                 retn</span><br><span class="line">.text:<span class="number">08049490</span> ; &#125; <span class="comment">// starts at 80492FF</span></span><br><span class="line">.text:<span class="number">08049490</span> main            endp</span><br><span class="line">.text:<span class="number">08049490</span></span><br><span class="line">.text:<span class="number">08049490</span> ; ---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>这一关跟上一关不同点在于所使用的内存不再是固定的了, 而是使用malloc申请内存.所以我们无法像上一题那样直接将符号注入到固定的内存中.</p>
<p>虽然malloc分配的内存地址是随机的, 但是这个地址会分配给一个指针变量中(全局/局部), 而这一个变量的地址是固定的, 所以我们可以通过这个地址来找到内存的地址.</p>
<p>而Angr给出了一个更加简单的方法, 我们使用malloc的目的就是为了获得一段内存空间, 那我们也可以使用(伪造)一段未被使用的内存空间来替换掉malloc所分配的内存空间(这样就保证后面使用的内存地址是固定的, 简便了许多), 直接将变量的内容改为我们伪造的内存空间地址即可.</p>
<h2 id="使用Angr解题-7"><a href="#使用Angr解题-7" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><h3 id="代码-4"><a href="#代码-4" class="headerlink" title="代码"></a>代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  <span class="comment">#建立Angr项目</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment">#符号执行地址</span></span><br><span class="line">  start_address = <span class="number">0x0804938F</span> <span class="comment">#scanf的后面</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># The binary is calling scanf(&quot;%8s %8s&quot;).</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password_len_bits = <span class="number">64</span> <span class="comment"># 八个字符, 每个字符8个位</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password_len_bits)</span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password_len_bits)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Instead of telling the binary to write to the address of the memory</span></span><br><span class="line">  <span class="comment"># allocated with malloc, we can simply fake an address to any unused block of</span></span><br><span class="line">  <span class="comment"># memory and overwrite the pointer to the data. This will point the pointer</span></span><br><span class="line">  <span class="comment"># with the address of pointer_to_malloc_memory_address0 to fake_heap_address.</span></span><br><span class="line">  <span class="comment"># Be aware, there is more than one pointer! Analyze the binary to determine</span></span><br><span class="line">  <span class="comment"># global location of each pointer.</span></span><br><span class="line">  <span class="comment"># Note: by default, Angr stores integers in memory with big-endianness. To</span></span><br><span class="line">  <span class="comment"># specify to use the endianness of your architecture, use the parameter</span></span><br><span class="line">  <span class="comment"># endness=project.arch.memory_endness. On x86, this is little-endian.</span></span><br><span class="line">  <span class="comment"># 我们可以轻松的伪造一个未被使用的内存的地址指针来覆盖指向原本数据的指针, 不是使用二进制文件从malloc那里得到的内存指针(这样比较麻烦)</span></span><br><span class="line">  <span class="comment"># 这会使得内容为pointer_to_malloc_memory_address0的指针指向fake_heap_address</span></span><br><span class="line">  <span class="comment"># 注意, 指针不止一个</span></span><br><span class="line">  <span class="comment"># 分析二进制文件来确定每个指针的全局位置.</span></span><br><span class="line">  <span class="comment"># 注意: 默认情况下, Angr以大端顺序将整数存储再内存中, 要指定使用架构的字节序, 请使用参数endness=project.arch.memory_endness. 在x86上, 这是小端</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  <span class="comment"># 简而言之, 主函数中会有一个变量(全局或是局部)来存储分配的内存的地址, 我们要先找到那个变量的地址, 然后直接修改存储的值(原本的值为malloc分配的内存地址, 现在我们要改成一段未被使用的内存地址)</span></span><br><span class="line">  fake_heap_address0 = <span class="number">0x0804C100</span> <span class="comment"># 我先使用的是.bss段的内存</span></span><br><span class="line">  pointer_to_malloc_memory_address0 = <span class="number">0x0BB9CE00</span>    <span class="comment">#这个是buffer0的地址, 而buffer0存储的是malloc分配的内存的地址, 现在我们要将buffer0的内容修改另一个内存的地址</span></span><br><span class="line">  initial_state.memory.store(pointer_to_malloc_memory_address0, fake_heap_address0, endness=project.arch.memory_endness)</span><br><span class="line">  fake_heap_address1 = <span class="number">0x804C108</span></span><br><span class="line">  pointer_to_malloc_memory_address1 = <span class="number">0x0BB9CE08</span></span><br><span class="line">  initial_state.memory.store(pointer_to_malloc_memory_address1, fake_heap_address1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Store our symbolic values at our fake_heap_address. Look at the binary to</span></span><br><span class="line">  <span class="comment"># determine the offsets from the fake_heap_address where scanf writes.</span></span><br><span class="line">  <span class="comment"># 将我们的符号值存储在我们的fake_heap_address中</span></span><br><span class="line">  <span class="comment"># 查看二进制文件来确定scanf写入的fake_heap_address的偏移量</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  initial_state.memory.store(fake_heap_address0, password0)</span><br><span class="line">  initial_state.memory.store(fake_heap_address1, password1)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution = solution0 + solution1</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后的代码-1"><a href="#去掉注释后的代码-1" class="headerlink" title="去掉注释后的代码"></a>去掉注释后的代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = <span class="number">0x0804938F</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># The binary is calling scanf(&quot;%8s %8s&quot;).</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password_len_bits = <span class="number">64</span></span><br><span class="line">  password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password_len_bits)</span><br><span class="line">  password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password_len_bits)</span><br><span class="line"></span><br><span class="line">  fake_heap_address0 = <span class="number">0x0804C100</span></span><br><span class="line">  pointer_to_malloc_memory_address0 = <span class="number">0x0BB9CE00</span></span><br><span class="line">  initial_state.memory.store(pointer_to_malloc_memory_address0, fake_heap_address0, endness=project.arch.memory_endness)</span><br><span class="line">  fake_heap_address1 = <span class="number">0x804C108</span></span><br><span class="line">  pointer_to_malloc_memory_address1 = <span class="number">0x0BB9CE08</span></span><br><span class="line">  initial_state.memory.store(pointer_to_malloc_memory_address1, fake_heap_address1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Store our symbolic values at our fake_heap_address. Look at the binary to</span></span><br><span class="line">  <span class="comment"># determine the offsets from the fake_heap_address where scanf writes.</span></span><br><span class="line"></span><br><span class="line">  initial_state.memory.store(fake_heap_address0, password0)</span><br><span class="line">  initial_state.memory.store(fake_heap_address1, password1)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(password0,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(password1,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line">    solution = solution0 + solution1</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="确定符号执行地址"><a href="#确定符号执行地址" class="headerlink" title="确定符号执行地址"></a>确定符号执行地址</h3><p>这个的思路跟上一关差不多, 可以参考上一关</p>
<h3 id="创建符号"><a href="#创建符号" class="headerlink" title="创建符号"></a>创建符号</h3><p>我们要找的flag是两个8字符的输入, 也就是说我们要创建两个64为的符号</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">password_len_bits = <span class="number">64</span></span><br><span class="line">password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password_len_bits)</span><br><span class="line">password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password_len_bits)</span><br></pre></td></tr></table></figure>

<h3 id="替换内存"><a href="#替换内存" class="headerlink" title="替换内存"></a>替换内存</h3><p>我们可以看到地址为0x0BB9CE00存储了malloc的地址, 我们将其替换为一个未被使用的内存地址0x0804C100, 后面使用内存的时候就不再使用malloc分配的内存, 而是我们伪造的内存. 下一个内存的替换也是同理.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fake_heap_address0 = <span class="number">0x0804C100</span></span><br><span class="line">pointer_to_malloc_memory_address0 = <span class="number">0x0BB9CE00</span></span><br><span class="line">initial_state.memory.store(pointer_to_malloc_memory_address0, fake_heap_address0, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">fake_heap_address1 = <span class="number">0x804C108</span></span><br><span class="line">pointer_to_malloc_memory_address1 = <span class="number">0x0BB9CE08</span></span><br><span class="line">initial_state.memory.store(pointer_to_malloc_memory_address1, fake_heap_address1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="注入符号"><a href="#注入符号" class="headerlink" title="注入符号"></a>注入符号</h3><p>向伪造的内存中注入符号</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">initial_state.memory.store(fake_heap_address0, password0)</span><br><span class="line">initial_state.memory.store(fake_heap_address1, password1)</span><br></pre></td></tr></table></figure>

<h3 id="符号执行-1"><a href="#符号执行-1" class="headerlink" title="符号执行"></a>符号执行</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">simulation.explore(find=is_successful, avoid=should_abort)</span><br></pre></td></tr></table></figure>

<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p>执行scaffold06时会报错, 但是会解得flag</p>
<p><img src="/2022/05/18/AngrLab2c872/image6.png" alt="image.png"></p>
<h1 id="07-angr-symbolic-file"><a href="#07-angr-symbolic-file" class="headerlink" title="07_angr_symbolic_file"></a>07_angr_symbolic_file</h1><h2 id="编译并运行-4"><a href="#编译并运行-4" class="headerlink" title="编译并运行"></a>编译并运行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/07_angr_symbolic_file$ python3 generate.py 1234 07_angr_symbolic_file</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/07_angr_symbolic_file$ ./07_angr_symbolic_file</span><br><span class="line">Enter the password: aaaaa</span><br><span class="line">Try again.</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/07_angr_symbolic_file$</span><br></pre></td></tr></table></figure>

<h2 id="分析-7"><a href="#分析-7" class="headerlink" title="分析"></a>分析</h2><p>使用IDA分析</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">080494F</span>1 ; <span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function">.text:080494F1 <span class="keyword">public</span> main</span></span><br><span class="line"><span class="function">.text:080494F1 main proc near                          </span>; DATA XREF: _start+<span class="number">2</span>A↑o</span><br><span class="line">.text:<span class="number">080494F</span>1</span><br><span class="line">.text:<span class="number">080494F</span>1 var_1C= dword ptr <span class="number">-1</span>Ch</span><br><span class="line">.text:<span class="number">080494F</span>1 argc= dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">080494F</span>1 argv= dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080494F</span>1 envp= dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080494F</span>1</span><br><span class="line">.text:<span class="number">080494F</span>1 ; __unwind &#123;</span><br><span class="line">.text:<span class="number">080494F</span>1 endbr32</span><br><span class="line">.text:<span class="number">080494F</span>5 lea     ecx, [esp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">080494F</span>9 <span class="keyword">and</span>     esp, <span class="number">0F</span>FFFFFF0h</span><br><span class="line">.text:<span class="number">080494F</span>C push    dword ptr [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">080494F</span>F push    ebp</span><br><span class="line">.text:<span class="number">08049500</span> mov     ebp, esp</span><br><span class="line">.text:<span class="number">08049502</span> push    edi</span><br><span class="line">.text:<span class="number">08049503</span> push    esi</span><br><span class="line">.text:<span class="number">08049504</span> push    ecx</span><br><span class="line">.text:<span class="number">08049505</span> sub     esp, <span class="number">1</span>Ch</span><br><span class="line">.text:<span class="number">08049508</span> sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">0804950B</span> push    <span class="number">40</span>h ; <span class="string">&#x27;@&#x27;</span>                       ; n</span><br><span class="line">.text:<span class="number">0804950</span>D push    <span class="number">0</span>                               ; c</span><br><span class="line">.text:<span class="number">0804950F</span> push    offset buffer                   ; s</span><br><span class="line">.text:<span class="number">08049514</span> call    _memset                         ; 初始化一段内存</span><br><span class="line">.text:<span class="number">08049519</span> add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804951</span>C sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804951F</span> push    offset aEnterThePasswo          ; <span class="string">&quot;Enter the password: &quot;</span></span><br><span class="line">.text:<span class="number">08049524</span> call    _printf                         ; 打印提示</span><br><span class="line">.text:<span class="number">08049529</span> add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804952</span>C sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">0804952F</span> push    offset buffer</span><br><span class="line">.text:<span class="number">08049534</span> push    offset a64s                     ; <span class="string">&quot;%64s&quot;</span></span><br><span class="line">.text:<span class="number">08049539</span> call    ___isoc99_scanf                 ; 读取字符串</span><br><span class="line">.text:<span class="number">0804953</span>E add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049541</span> sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">08049544</span> push    <span class="number">40</span>h ; <span class="string">&#x27;@&#x27;</span>                       ; n</span><br><span class="line">.text:<span class="number">08049546</span> push    offset buffer                   ; <span class="keyword">int</span></span><br><span class="line">.text:<span class="number">0804954B</span> call    ignore_me                       ; 这个函数在scaffold中有解释, 只是为了模拟一个读取文件的操作, 可以忽略</span><br><span class="line">.text:<span class="number">08049550</span> add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049553</span> sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">08049556</span> push    <span class="number">40</span>h ; <span class="string">&#x27;@&#x27;</span>                       ; n</span><br><span class="line">.text:<span class="number">08049558</span> push    <span class="number">0</span>                               ; c</span><br><span class="line">.text:<span class="number">0804955</span>A push    offset buffer                   ; s</span><br><span class="line">.text:<span class="number">0804955F</span> call    _memset                         ; 再次初始化内存</span><br><span class="line">.text:<span class="number">08049564</span> add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049567</span> sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">0804956</span>A push    offset aRb                      ; <span class="string">&quot;rb&quot;</span></span><br><span class="line">.text:<span class="number">0804956F</span> push    offset name                     ; <span class="string">&quot;PNESFFEG.txt&quot;</span></span><br><span class="line">.text:<span class="number">08049574</span> call    _fopen                          ; 打开文件PNESFFEG.txt</span><br><span class="line">.text:<span class="number">08049579</span> add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804957</span>C mov     ds:fp, eax</span><br><span class="line">.text:<span class="number">08049581</span> mov     eax, ds:fp</span><br><span class="line">.text:<span class="number">08049586</span> push    eax                             ; stream</span><br><span class="line">.text:<span class="number">08049587</span> push    <span class="number">40</span>h ; <span class="string">&#x27;@&#x27;</span>                       ; n</span><br><span class="line">.text:<span class="number">08049589</span> push    <span class="number">1</span>                               ; size</span><br><span class="line">.text:<span class="number">0804958B</span> push    offset buffer                   ; ptr</span><br><span class="line">.text:<span class="number">08049590</span> call    _fread                          ; 从文件PNESFFEG.txt中读取数据</span><br><span class="line">.text:<span class="number">08049595</span> add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049598</span> mov     eax, ds:fp</span><br><span class="line">.text:<span class="number">0804959</span>D sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080495</span>A0 push    eax                             ; stream</span><br><span class="line">.text:<span class="number">080495</span>A1 call    _fclose                         ; 关闭PNESFFEG.txt</span><br><span class="line">.text:<span class="number">080495</span>A6 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080495</span>A9 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080495</span>AC push    offset name                     ; <span class="string">&quot;PNESFFEG.txt&quot;</span></span><br><span class="line">.text:<span class="number">080495B</span>1 call    _unlink                         ; 删除PNESFFEG.txt该文件</span><br><span class="line">.text:<span class="number">080495B</span>6 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080495B</span>9 mov     [ebp+var_1C], <span class="number">0</span></span><br><span class="line">.text:<span class="number">080495</span>C0 jmp     <span class="keyword">short</span> loc_80495EF</span><br><span class="line">.text:<span class="number">080495</span>C2 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">080495</span>C2</span><br><span class="line">.text:<span class="number">080495</span>C2 loc_80495C2:                            ; CODE XREF: main+<span class="number">102</span>↓j</span><br><span class="line">.text:<span class="number">080495</span>C2 mov     eax, [ebp+var_1C]</span><br><span class="line">.text:<span class="number">080495</span>C5 add     eax, <span class="number">804</span>C0A0h</span><br><span class="line">.text:<span class="number">080495</span>CA movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">080495</span>CD movsx   eax, al</span><br><span class="line">.text:<span class="number">080495</span>D0 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080495</span>D3 push    [ebp+var_1C]</span><br><span class="line">.text:<span class="number">080495</span>D6 push    eax                             ; 将读取的前<span class="number">8</span>个字节的数据进行变换</span><br><span class="line">.text:<span class="number">080495</span>D7 call    complex_function</span><br><span class="line">.text:<span class="number">080495</span>DC add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080495</span>DF mov     edx, eax</span><br><span class="line">.text:<span class="number">080495E1</span> mov     eax, [ebp+var_1C]</span><br><span class="line">.text:<span class="number">080495E4</span> add     eax, <span class="number">804</span>C0A0h</span><br><span class="line">.text:<span class="number">080495E9</span> mov     [eax], dl</span><br><span class="line">.text:<span class="number">080495</span>EB add     [ebp+var_1C], <span class="number">1</span></span><br><span class="line">.text:<span class="number">080495</span>EF</span><br><span class="line">.text:<span class="number">080495</span>EF loc_80495EF:                            ; CODE XREF: main+CF↑j</span><br><span class="line">.text:<span class="number">080495</span>EF cmp     [ebp+var_1C], <span class="number">7</span></span><br><span class="line">.text:<span class="number">080495F</span>3 jle     <span class="keyword">short</span> loc_80495C2</span><br><span class="line">.text:<span class="number">080495F</span>5 mov     edx, offset buffer              ; 关键判断</span><br><span class="line">.text:<span class="number">080495F</span>A mov     eax, offset aHxuitwoa           ; <span class="string">&quot;HXUITWOA&quot;</span></span><br><span class="line">.text:<span class="number">080495F</span>F mov     ecx, <span class="number">9</span></span><br><span class="line">.text:<span class="number">08049604</span> mov     esi, edx</span><br><span class="line">.text:<span class="number">08049606</span> mov     edi, eax</span><br><span class="line">.text:<span class="number">08049608</span> repe cmpsb</span><br><span class="line">.text:<span class="number">0804960</span>A setnbe  dl</span><br><span class="line">.text:<span class="number">0804960</span>D setb    al</span><br><span class="line">.text:<span class="number">08049610</span> sub     edx, eax</span><br><span class="line">.text:<span class="number">08049612</span> mov     eax, edx</span><br><span class="line">.text:<span class="number">08049614</span> movsx   eax, al</span><br><span class="line">.text:<span class="number">08049617</span> test    eax, eax</span><br><span class="line">.text:<span class="number">08049619</span> jz      <span class="keyword">short</span> loc_8049635</span><br><span class="line">.text:<span class="number">0804961B</span> sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804961</span>E push    offset s                        ; <span class="string">&quot;Try again.&quot;</span></span><br><span class="line">.text:<span class="number">08049623</span> call    _puts</span><br><span class="line">.text:<span class="number">08049628</span> add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804962B</span> sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804962</span>E push    <span class="number">1</span>                               ; status</span><br><span class="line">.text:<span class="number">08049630</span> call    _exit</span><br><span class="line">.text:<span class="number">08049635</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049635</span></span><br><span class="line">.text:<span class="number">08049635</span> loc_8049635:                            ; CODE XREF: main+<span class="number">128</span>↑j</span><br><span class="line">.text:<span class="number">08049635</span> sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049638</span> push    offset aGoodJob                 ; <span class="string">&quot;Good Job.&quot;</span></span><br><span class="line">.text:<span class="number">0804963</span>D call    _puts</span><br><span class="line">.text:<span class="number">08049642</span> add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049645</span> sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049648</span> push    <span class="number">0</span>                               ; status</span><br><span class="line">.text:<span class="number">0804964</span>A call    _exit</span><br><span class="line">.text:<span class="number">0804964</span>A ; &#125; <span class="comment">// starts at 80494F1</span></span><br><span class="line">.text:<span class="number">0804964</span>A main endp</span><br><span class="line">.text:<span class="number">0804964</span>A</span><br><span class="line">.text:<span class="number">0804964</span>A ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0804964F</span> align <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049650</span></span><br><span class="line">.text:<span class="number">08049650</span> ; =============== S U B R O U T I N E =======================================</span><br></pre></td></tr></table></figure>

<p>起始有一个简单的解法就是直接获取固定的内存地址0x804C0A0h注入符号即可求解.</p>
<p>但是在scaffold07中有规定要使用模拟文件来解这道题</p>
<h2 id="使用Angr求解"><a href="#使用Angr求解" class="headerlink" title="使用Angr求解"></a>使用Angr求解</h2><h3 id="代码-5"><a href="#代码-5" class="headerlink" title="代码"></a>代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This challenge could, in theory, be solved in multiple ways. However, for the</span></span><br><span class="line"><span class="comment"># sake of learning how to simulate an alternate filesystem, please solve this</span></span><br><span class="line"><span class="comment"># challenge according to structure provided below. As a challenge, once you have</span></span><br><span class="line"><span class="comment"># an initial solution, try solving this in an alternate way.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Problem description and general solution strategy:</span></span><br><span class="line"><span class="comment"># The binary loads the password from a file using the fread function. If the</span></span><br><span class="line"><span class="comment"># password is correct, it prints &quot;Good Job.&quot; In order to keep consistency with</span></span><br><span class="line"><span class="comment"># the other challenges, the input from the console is written to a file in the </span></span><br><span class="line"><span class="comment"># ignore_me function. As the name suggests, ignore it, as it only exists to</span></span><br><span class="line"><span class="comment"># maintain consistency with other challenges.</span></span><br><span class="line"><span class="comment"># We want to:</span></span><br><span class="line"><span class="comment"># 1. Determine the file from which fread reads.</span></span><br><span class="line"><span class="comment"># 2. Use Angr to simulate a filesystem where that file is replaced with our own</span></span><br><span class="line"><span class="comment">#    simulated file.</span></span><br><span class="line"><span class="comment"># 3. Initialize the file with a symbolic value, which will be read with fread</span></span><br><span class="line"><span class="comment">#    and propogated through the program.</span></span><br><span class="line"><span class="comment"># 4. Solve for the symbolic input to determine the password.</span></span><br><span class="line"><span class="comment"># 从理论上来讲, 这一关可以通过多种方式来解决. 但是, 为了学习模拟备用文件系统, 请</span></span><br><span class="line"><span class="comment"># 根据下面提供的步骤来通过此关卡. 作为一个挑战, 一旦你有了一个初步的解决方案, 试</span></span><br><span class="line"><span class="comment"># 这用另一种方式解决这个挑战.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 问题描述和一般解决策略: 二进制文件使用fread函数从文件中加载密码. 如果密码正确,</span></span><br><span class="line"><span class="comment"># 它会打印&quot;Good Job&quot;. 为了与其他挑战保持一致, 来自控制台的输入被写入ignore_me函</span></span><br><span class="line"><span class="comment"># 中的文件.顾名思义, 忽略它, 它的存在只是为了与其他挑战保持一致</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#我们要:</span></span><br><span class="line"><span class="comment"># 1. 确定fread读取的文件</span></span><br><span class="line"><span class="comment"># 2. 使用Angr模拟一个文件系统, 该文件被我们自己的模拟文件替换</span></span><br><span class="line"><span class="comment"># 3. 用符号值初始化文件, 将用fread读取并通过程序传播</span></span><br><span class="line"><span class="comment"># 4. 求解符号输入以确定密码</span></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = <span class="number">0x08049564</span> <span class="comment"># 先设在memset后面</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Specify some information needed to construct a simulated file. For this</span></span><br><span class="line">  <span class="comment"># challenge, the filename is hardcoded, but in theory, it could be symbolic. </span></span><br><span class="line">  <span class="comment"># Note: to read from the file, the binary calls</span></span><br><span class="line">  <span class="comment"># &#x27;fread(buffer, sizeof(char), 64, file)&#x27;.</span></span><br><span class="line">  <span class="comment"># 指定构建模拟文件所需的一些信息. 对于这个挑战, 文件名是硬编码的, 但理论上它是可以是符号化的.</span></span><br><span class="line">  <span class="comment"># 注意: 要从文件中读取, 二进制文件调用&#x27;fread()&#x27;</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  filename = <span class="string">&quot;PNESFFEG.txt&quot;</span>  <span class="comment"># :string, 文件名</span></span><br><span class="line">  symbolic_file_size_bytes = <span class="number">64</span> <span class="comment"># 文件大小(字节)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Construct a bitvector for the password and then store it in the file&#x27;s</span></span><br><span class="line">  <span class="comment"># backing memory. For example, imagine a simple file, &#x27;hello.txt&#x27;:</span></span><br><span class="line">  <span class="comment"># 为flag构建一个符号位向量, 然后将其存储在文件的后背内存中.</span></span><br><span class="line">  <span class="comment"># Hello world, my name is John.</span></span><br><span class="line">  <span class="comment"># ^                       ^</span></span><br><span class="line">  <span class="comment"># ^ address 0             ^ address 24 (count the number of characters)</span></span><br><span class="line">  <span class="comment"># In order to represent this in memory, we would want to write the string to</span></span><br><span class="line">  <span class="comment"># the beginning of the file:</span></span><br><span class="line">  <span class="comment"># 为了在内存中表示它, 我们希望将字符串写入文件的开头</span></span><br><span class="line">  <span class="comment"># </span></span><br><span class="line">  <span class="comment"># hello_txt_contents = claripy.BVV(&#x27;Hello world, my name is John.&#x27;, 30*8)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Perhaps, then, we would want to replace John with a</span></span><br><span class="line">  <span class="comment"># symbolic variable. We would call:</span></span><br><span class="line">  <span class="comment"># 那么, 也许我们想用一个符号变量代替John, 我们可以使用下面的语句</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># name_bitvector = claripy.BVS(&#x27;symbolic_name&#x27;, 4*8)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Then, after the program calls fopen(&#x27;hello.txt&#x27;, &#x27;r&#x27;) and then</span></span><br><span class="line">  <span class="comment"># fread(buffer, sizeof(char), 30, hello_txt_file), the buffer would contain</span></span><br><span class="line">  <span class="comment"># the string from the file, except four symbolic bytes where the name would be</span></span><br><span class="line">  <span class="comment"># stored.</span></span><br><span class="line">  <span class="comment"># 然后系统调用fopen(&quot;hello.txt&quot;, &quot;r&quot;)和fread(buffer, sizeof(char), 30, hello_txt_file)</span></span><br><span class="line">  <span class="comment"># 在此之后, buffer将包含文件中的字符串, 除了那四个将保存名称的符号字节.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  <span class="comment"># 设定的符号大小等于文件的大小</span></span><br><span class="line">  password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, symbolic_file_size_bytes * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Construct the symbolic file. The file_options parameter specifies the Linux</span></span><br><span class="line">  <span class="comment"># file permissions (read, read/write, execute etc.) The content parameter</span></span><br><span class="line">  <span class="comment"># specifies from where the stream of data should be supplied. If content is</span></span><br><span class="line">  <span class="comment"># an instance of SimSymbolicMemory (we constructed one above), the stream will</span></span><br><span class="line">  <span class="comment"># contain the contents (including any symbolic contents) of the memory,</span></span><br><span class="line">  <span class="comment"># beginning from address zero.</span></span><br><span class="line">  <span class="comment"># Set the content parameter to our BVS instance that holds the symbolic data.</span></span><br><span class="line">  <span class="comment"># 构造符号文件. file_options参数将指定Linux文件权限(读, 写, 执行等).</span></span><br><span class="line">  <span class="comment"># content参数将指定从何处提供数据流. 如果content是SimSymbolicMemory的一个实例, </span></span><br><span class="line">  <span class="comment"># 则数据流将包含内存的内容, 从地址0开始. 将content参数设置为保存符号数据的BVS实例.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  password_file = angr.storage.SimFile(filename, content=password, size = symbolic_file_size_bytes)<span class="comment"># 这里多添加了一个size参数, 后面如果有错误的话就删了</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Add the symbolic file we created to the symbolic filesystem.</span></span><br><span class="line">  <span class="comment"># 将我们创建的符号文件添加到符号文件系统</span></span><br><span class="line">  initial_state.fs.insert(filename, password_file)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution = solution_state.solver.<span class="built_in">eval</span>(password,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后的代码-2"><a href="#去掉注释后的代码-2" class="headerlink" title="去掉注释后的代码"></a>去掉注释后的代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = <span class="number">0x08049564</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  filename = <span class="string">&quot;PNESFFEG.txt&quot;</span></span><br><span class="line">  symbolic_file_size_bytes = <span class="number">64</span></span><br><span class="line"></span><br><span class="line">  password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, symbolic_file_size_bytes * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">  password_file = angr.storage.SimFile(filename, content=password, size = symbolic_file_size_bytes)</span><br><span class="line"></span><br><span class="line">  initial_state.fs.insert(filename, password_file)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution = solution_state.solver.<span class="built_in">eval</span>(password,cast_to=<span class="built_in">bytes</span>).decode()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="构造模拟文件系统的步骤"><a href="#构造模拟文件系统的步骤" class="headerlink" title="构造模拟文件系统的步骤"></a>构造模拟文件系统的步骤</h2><h3 id="1-准备文件参数"><a href="#1-准备文件参数" class="headerlink" title="1. 准备文件参数"></a>1. 准备文件参数</h3><ul>
<li>文件名</li>
<li>文件大小</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filename = <span class="string">&quot;PNESFFEG.txt&quot;</span></span><br><span class="line">symbolic_file_size_bytes = <span class="number">64</span></span><br></pre></td></tr></table></figure>

<h3 id="2-创建符号位向量"><a href="#2-创建符号位向量" class="headerlink" title="2. 创建符号位向量"></a>2. 创建符号位向量</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, symbolic_file_size_bytes * <span class="number">8</span>)</span><br><span class="line"><span class="comment"># 本题的输入是64个字符, 虽然后面只检查前八个字符, 但是为了满足题目需求, 还是设置64个字符的符号位向量</span></span><br></pre></td></tr></table></figure>

<h3 id="3-创建符号文件"><a href="#3-创建符号文件" class="headerlink" title="3. 创建符号文件"></a>3. 创建符号文件</h3><p>利用我们上面的参数(文件名, 文件大小), 并将符号注入到文件中来充当文件的内容, 三个条件合在一起就可以创建一个文件.</p>
<p>同时, 作为符号文件, 我们最终条件约束的也是该文件中的符号内容.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password_file = angr.storage.SimFile(filename, content=password, size = symbolic_file_size_by</span><br></pre></td></tr></table></figure>

<h3 id="4-将符号文件添加到模拟系统中"><a href="#4-将符号文件添加到模拟系统中" class="headerlink" title="4. 将符号文件添加到模拟系统中"></a>4. 将符号文件添加到模拟系统中</h3><p>第一个参数是符号文件名, 第二个参数是符号文件本身</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">initial_state.fs.insert(filename, password_file)</span><br></pre></td></tr></table></figure>

<p>后面二进制文件中读取的文件将会从模拟的文件系统中读取, 读取到的文件数据中就含有我们的符号(对于这一关准确来说全部都是符号数据), 这些数据就是我们的未知数x.</p>
<h1 id="08-angr-constraints"><a href="#08-angr-constraints" class="headerlink" title="08_angr_constraints"></a>08_angr_constraints</h1><h2 id="编译并运行-5"><a href="#编译并运行-5" class="headerlink" title="编译并运行"></a>编译并运行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/08_angr_constraints$ python3 generate.py 1234</span><br><span class="line"> 08_angr_constraints</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/08_angr_constraints$ ./08_angr_constraints</span><br><span class="line">Enter the password: aaaaa</span><br><span class="line">Try again.</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/08_angr_constraints$</span><br></pre></td></tr></table></figure>

<h2 id="分析-8"><a href="#分析-8" class="headerlink" title="分析"></a>分析</h2><p>使用IDA进行分析</p>
<h3 id="主函数"><a href="#主函数" class="headerlink" title="主函数"></a>主函数</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">080492</span>EA ; <span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function">.text:080492EA                 <span class="keyword">public</span> main</span></span><br><span class="line"><span class="function">.text:080492EA main            proc near               </span>; DATA XREF: _start+<span class="number">2</span>A↑o</span><br><span class="line">.text:<span class="number">080492</span>EA</span><br><span class="line">.text:<span class="number">080492</span>EA var_C           = dword ptr <span class="number">-0</span>Ch</span><br><span class="line">.text:<span class="number">080492</span>EA var_4           = dword ptr <span class="number">-4</span></span><br><span class="line">.text:<span class="number">080492</span>EA argc            = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">080492</span>EA argv            = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080492</span>EA envp            = dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080492</span>EA</span><br><span class="line">.text:<span class="number">080492</span>EA ; __unwind &#123;</span><br><span class="line">.text:<span class="number">080492</span>EA                 endbr32</span><br><span class="line">.text:<span class="number">080492</span>EE                 lea     ecx, [esp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">080492F</span>2                 <span class="keyword">and</span>     esp, <span class="number">0F</span>FFFFFF0h</span><br><span class="line">.text:<span class="number">080492F</span>5                 push    dword ptr [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">080492F</span>8                 push    ebp</span><br><span class="line">.text:<span class="number">080492F</span>9                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">080492F</span>B                 push    ecx</span><br><span class="line">.text:<span class="number">080492F</span>C                 sub     esp, <span class="number">14</span>h</span><br><span class="line">.text:<span class="number">080492F</span>F                 mov     ds:password, <span class="number">49555848</span>h ; 都是password, IDA分析错误, 这里是对参考数据进行赋值</span><br><span class="line">.text:<span class="number">08049309</span>                 mov     ds:dword_804C034, <span class="number">414F</span>5754h</span><br><span class="line">.text:<span class="number">08049313</span>                 mov     ds:dword_804C038, <span class="number">53454E50</span>h</span><br><span class="line">.text:<span class="number">0804931</span>D                 mov     ds:dword_804C03C, <span class="number">47454646</span>h</span><br><span class="line">.text:<span class="number">08049327</span>                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">0804932</span>A                 push    <span class="number">11</span>h             ; n</span><br><span class="line">.text:<span class="number">0804932</span>C                 push    <span class="number">0</span>               ; c</span><br><span class="line">.text:<span class="number">0804932</span>E                 push    offset buffer   ; s</span><br><span class="line">.text:<span class="number">08049333</span>                 call    _memset         ; 初始化</span><br><span class="line">.text:<span class="number">08049338</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804933B</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804933</span>E                 push    offset aEnterThePasswo ; <span class="string">&quot;Enter the password: &quot;</span></span><br><span class="line">.text:<span class="number">08049343</span>                 call    _printf</span><br><span class="line">.text:<span class="number">08049348</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804934B</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">0804934</span>E                 push    offset buffer</span><br><span class="line">.text:<span class="number">08049353</span>                 push    offset a16s     ; <span class="string">&quot;%16s&quot;</span></span><br><span class="line">.text:<span class="number">08049358</span>                 call    ___isoc99_scanf ; 输入存放在buffer</span><br><span class="line">.text:<span class="number">0804935</span>D                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049360</span>                 mov     [ebp+var_C], <span class="number">0</span></span><br><span class="line">.text:<span class="number">08049367</span>                 jmp     <span class="keyword">short</span> loc_804939E</span><br><span class="line">.text:<span class="number">08049369</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049369</span></span><br><span class="line">.text:<span class="number">08049369</span> loc_8049369:                            ; CODE XREF: main+B8↓j</span><br><span class="line">.text:<span class="number">08049369</span>                 mov     eax, <span class="number">0F</span>h</span><br><span class="line">.text:<span class="number">0804936</span>E                 sub     eax, [ebp+var_C]</span><br><span class="line">.text:<span class="number">08049371</span>                 mov     edx, eax</span><br><span class="line">.text:<span class="number">08049373</span>                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:<span class="number">08049376</span>                 add     eax, <span class="number">804</span>C040h   ; 对输入进行变换</span><br><span class="line">.text:<span class="number">0804937B</span>                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">0804937</span>E                 movsx   eax, al</span><br><span class="line">.text:<span class="number">08049381</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">08049384</span>                 push    edx</span><br><span class="line">.text:<span class="number">08049385</span>                 push    eax</span><br><span class="line">.text:<span class="number">08049386</span>                 call    complex_function</span><br><span class="line">.text:<span class="number">0804938B</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804938</span>E                 mov     edx, eax</span><br><span class="line">.text:<span class="number">08049390</span>                 mov     eax, [ebp+var_C]</span><br><span class="line">.text:<span class="number">08049393</span>                 add     eax, <span class="number">804</span>C040h</span><br><span class="line">.text:<span class="number">08049398</span>                 mov     [eax], dl</span><br><span class="line">.text:<span class="number">0804939</span>A                 add     [ebp+var_C], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0804939</span>E</span><br><span class="line">.text:<span class="number">0804939</span>E loc_804939E:                            ; CODE XREF: main+<span class="number">7</span>D↑j</span><br><span class="line">.text:<span class="number">0804939</span>E                 cmp     [ebp+var_C], <span class="number">0F</span>h</span><br><span class="line">.text:<span class="number">080493</span>A2                 jle     <span class="keyword">short</span> loc_8049369</span><br><span class="line">.text:<span class="number">080493</span>A4                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080493</span>A7                 push    <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493</span>A9                 push    offset buffer</span><br><span class="line">.text:<span class="number">080493</span>AE                 call    check_equals_HXUITWOAPNESFFEG ; 这里是关键判断</span><br><span class="line">.text:<span class="number">080493B</span>3                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493B</span>6                 test    eax, eax        ; 测试返回值是否为１，　如果不为１则打印＂ｇｏｏｄ　ｊｏｂ＂</span><br><span class="line">.text:<span class="number">080493B</span>8                 jnz     <span class="keyword">short</span> loc_80493CC</span><br><span class="line">.text:<span class="number">080493B</span>A                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080493B</span>D                 push    offset s        ; <span class="string">&quot;Try again.&quot;</span></span><br><span class="line">.text:<span class="number">080493</span>C2                 call    _puts</span><br><span class="line">.text:<span class="number">080493</span>C7                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493</span>CA                 jmp     <span class="keyword">short</span> loc_80493DC</span><br><span class="line">.text:<span class="number">080493</span>CC ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">080493</span>CC</span><br><span class="line">.text:<span class="number">080493</span>CC loc_80493CC:                            ; CODE XREF: main+CE↑j</span><br><span class="line">.text:<span class="number">080493</span>CC                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080493</span>CF                 push    offset aGoodJob ; <span class="string">&quot;Good Job.&quot;</span></span><br><span class="line">.text:<span class="number">080493</span>D4                 call    _puts</span><br><span class="line">.text:<span class="number">080493</span>D9                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493</span>DC</span><br><span class="line">.text:<span class="number">080493</span>DC loc_80493DC:                            ; CODE XREF: main+E0↑j</span><br><span class="line">.text:<span class="number">080493</span>DC                 mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">080493E1</span>                 mov     ecx, [ebp+var_4]</span><br><span class="line">.text:<span class="number">080493E4</span>                 leave</span><br><span class="line">.text:<span class="number">080493E5</span>                 lea     esp, [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">080493E8</span>                 retn</span><br><span class="line">.text:<span class="number">080493E8</span> ; &#125; <span class="comment">// starts at 80492EA</span></span><br><span class="line">.text:<span class="number">080493E8</span> main            endp</span><br><span class="line">.text:<span class="number">080493E8</span></span><br><span class="line">.text:<span class="number">080493E8</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">080493E9</span>                 align <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493F</span>0</span><br><span class="line">.text:<span class="number">080493F</span>0 ; =============== S U B R O U T I N E =======================================</span><br></pre></td></tr></table></figure>

<h3 id="跟进check-equals-HXUITWOAPNESFFEG"><a href="#跟进check-equals-HXUITWOAPNESFFEG" class="headerlink" title="跟进check_equals_HXUITWOAPNESFFEG()"></a>跟进check_equals_HXUITWOAPNESFFEG()</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">08049298</span> ; <span class="function">_BOOL4 __cdecl <span class="title">check_equals_HXUITWOAPNESFFEG</span><span class="params">(<span class="keyword">int</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>)</span></span></span><br><span class="line"><span class="function">.text:08049298                 <span class="keyword">public</span> check_equals_HXUITWOAPNESFFEG</span></span><br><span class="line"><span class="function">.text:08049298 check_equals_HXUITWOAPNESFFEG proc near </span>; CODE XREF: main+C4↓p</span><br><span class="line">.text:<span class="number">08049298</span></span><br><span class="line">.text:<span class="number">08049298</span> var_8           = dword ptr <span class="number">-8</span></span><br><span class="line">.text:<span class="number">08049298</span> var_4           = dword ptr <span class="number">-4</span></span><br><span class="line">.text:<span class="number">08049298</span> arg_0           = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">08049298</span> arg_4           = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049298</span></span><br><span class="line">.text:<span class="number">08049298</span> ; __unwind &#123;</span><br><span class="line">.text:<span class="number">08049298</span>                 endbr32</span><br><span class="line">.text:<span class="number">0804929</span>C                 push    ebp</span><br><span class="line">.text:<span class="number">0804929</span>D                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">0804929F</span>                 sub     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080492</span>A2                 mov     [ebp+var_8], <span class="number">0</span></span><br><span class="line">.text:<span class="number">080492</span>A9                 mov     [ebp+var_4], <span class="number">0</span></span><br><span class="line">.text:<span class="number">080492B</span>0                 jmp     <span class="keyword">short</span> loc_80492D4</span><br><span class="line">.text:<span class="number">080492B</span>2 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">080492B</span>2</span><br><span class="line">.text:<span class="number">080492B</span>2 loc_80492B2:                            ; CODE XREF: check_equals_HXUITWOAPNESFFEG+<span class="number">42</span>↓j</span><br><span class="line">.text:<span class="number">080492B</span>2                 mov     edx, [ebp+var_4]</span><br><span class="line">.text:<span class="number">080492B</span>5                 mov     eax, [ebp+arg_0]</span><br><span class="line">.text:<span class="number">080492B</span>8                 add     eax, edx</span><br><span class="line">.text:<span class="number">080492B</span>A                 movzx   edx, byte ptr [eax]</span><br><span class="line">.text:<span class="number">080492B</span>D                 mov     eax, [ebp+var_4]</span><br><span class="line">.text:<span class="number">080492</span>C0                 add     eax, <span class="number">804</span>C030h   ; 这里就是参考数据</span><br><span class="line">.text:<span class="number">080492</span>C5                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">080492</span>C8                 cmp     dl, al          ; 参考数据跟变换后的输入进行比较</span><br><span class="line">.text:<span class="number">080492</span>CA                 jnz     <span class="keyword">short</span> loc_80492D0</span><br><span class="line">.text:<span class="number">080492</span>CC                 add     [ebp+var_8], <span class="number">1</span></span><br><span class="line">.text:<span class="number">080492</span>D0</span><br><span class="line">.text:<span class="number">080492</span>D0 loc_80492D0:                            ; CODE XREF: check_equals_HXUITWOAPNESFFEG+<span class="number">32</span>↑j</span><br><span class="line">.text:<span class="number">080492</span>D0                 add     [ebp+var_4], <span class="number">1</span></span><br><span class="line">.text:<span class="number">080492</span>D4</span><br><span class="line">.text:<span class="number">080492</span>D4 loc_80492D4:                            ; CODE XREF: check_equals_HXUITWOAPNESFFEG+<span class="number">18</span>↑j</span><br><span class="line">.text:<span class="number">080492</span>D4                 mov     eax, [ebp+var_4]</span><br><span class="line">.text:<span class="number">080492</span>D7                 cmp     [ebp+arg_4], eax</span><br><span class="line">.text:<span class="number">080492</span>DA                 ja      <span class="keyword">short</span> loc_80492B2</span><br><span class="line">.text:<span class="number">080492</span>DC                 mov     eax, [ebp+var_8]</span><br><span class="line">.text:<span class="number">080492</span>DF                 cmp     eax, [ebp+arg_4]</span><br><span class="line">.text:<span class="number">080492E2</span>                 setz    al</span><br><span class="line">.text:<span class="number">080492E5</span>                 movzx   eax, al</span><br><span class="line">.text:<span class="number">080492E8</span>                 leave</span><br><span class="line">.text:<span class="number">080492E9</span>                 retn</span><br><span class="line">.text:<span class="number">080492E9</span> ; &#125; <span class="comment">// starts at 8049298</span></span><br><span class="line">.text:<span class="number">080492E9</span> check_equals_HXUITWOAPNESFFEG endp</span><br><span class="line">.text:<span class="number">080492E9</span></span><br><span class="line">.text:<span class="number">080492</span>EA</span><br><span class="line">.text:<span class="number">080492</span>EA ; =============== S U B R O U T I N E =======================================</span><br></pre></td></tr></table></figure>

<p>其中0x804C030就是参考数据的地址, 位于buffer的上方</p>
<h2 id="使用Angr解题-8"><a href="#使用Angr解题-8" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><h3 id="代码-6"><a href="#代码-6" class="headerlink" title="代码"></a>代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The binary asks for a 16 character password to which is applies a complex</span></span><br><span class="line"><span class="comment"># function and then compares with a reference string with the function</span></span><br><span class="line"><span class="comment"># check_equals_[reference string]. (Decompile the binary and take a look at it!)</span></span><br><span class="line"><span class="comment"># The source code for this function is provided here. However, the reference</span></span><br><span class="line"><span class="comment"># string in your version will be different than AABBCCDDEEFFGGHH:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># #define REFERENCE_PASSWORD = &quot;AABBCCDDEEFFGGHH&quot;;</span></span><br><span class="line"><span class="comment"># int check_equals_AABBCCDDEEFFGGHH(char* to_check, size_t length) &#123;</span></span><br><span class="line"><span class="comment">#   uint32_t num_correct = 0;</span></span><br><span class="line"><span class="comment">#   for (int i=0; i&lt;length; ++i) &#123;</span></span><br><span class="line"><span class="comment">#     if (to_check[i] == REFERENCE_PASSWORD[i]) &#123;</span></span><br><span class="line"><span class="comment">#       num_correct += 1;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment">#   &#125;</span></span><br><span class="line"><span class="comment">#   return num_correct == length;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment"># 二进制文件要求输入16个字符的密码, 该密码应用了一个complex_function()进行变换</span></span><br><span class="line"><span class="comment"># 随后在check_equals_HXUITWOAPNESFFEG()中与参考数据进行比较</span></span><br><span class="line"><span class="comment"># 下面是源代码</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># char* input = user_input();</span></span><br><span class="line"><span class="comment"># char* encrypted_input = complex_function(input);</span></span><br><span class="line"><span class="comment"># if (check_equals_AABBCCDDEEFFGGHH(encrypted_input, 16)) &#123;</span></span><br><span class="line"><span class="comment">#   puts(&quot;Good Job.&quot;);</span></span><br><span class="line"><span class="comment"># &#125; else &#123;</span></span><br><span class="line"><span class="comment">#   puts(&quot;Try again.&quot;);</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The function checks if *to_check == &quot;AABBCCDDEEFFGGHH&quot;. Verify this yourself.</span></span><br><span class="line"><span class="comment"># While you, as a human, can easily determine that this function is equivalent</span></span><br><span class="line"><span class="comment"># to simply comparing the strings, the computer cannot. Instead the computer </span></span><br><span class="line"><span class="comment"># would need to branch every time the if statement in the loop was called (16 </span></span><br><span class="line"><span class="comment"># times), resulting in 2^16 = 65,536 branches, which will take too long of a </span></span><br><span class="line"><span class="comment"># time to evaluate for our needs.</span></span><br><span class="line"><span class="comment"># check_equals_HXUITWOAPNESFFEG()检查结果 == &quot;AABBCCDDEEFFGGHH&quot;, 人类可以轻松确定这是在比较字符串</span></span><br><span class="line"><span class="comment"># 但是计算机不能. 每次调用if时都需要进行分支, 导致了2^16 = 65536个分支, 这将花费很长时间来评估我们的需求</span></span><br><span class="line"><span class="comment"># 为什么会有这些分支, 阅读Angr给出的PPT教程, 可以知道在Angr的机制中, 一遇上if, state就会产生两个分支</span></span><br><span class="line"><span class="comment"># 多重的if叠加, 就造成了路径爆炸, 所以这一关的主要目标就是减少分支到我们可接受的范围内.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># We do not know how the complex_function works, but we want to find an input</span></span><br><span class="line"><span class="comment"># that, when modified by complex_function, will produce the string:</span></span><br><span class="line"><span class="comment"># AABBCCDDEEFFGGHH.</span></span><br><span class="line"><span class="comment"># 我们不知道complex_function()具体干了些什么, 但是我们知道我们的目的是然输入在被complex_function变换后的结果是: AABBCCDDEEFFGGHH</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In this puzzle, your goal will be to stop the program before this function is</span></span><br><span class="line"><span class="comment"># called and manually constrain the to_check variable to be equal to the</span></span><br><span class="line"><span class="comment"># password you identify by decompiling the binary. Since, you, as a human, know</span></span><br><span class="line"><span class="comment"># that if the strings are equal, the program will print &quot;Good Job.&quot;, you can</span></span><br><span class="line"><span class="comment"># be assured that if the program can solve for an input that makes them equal,</span></span><br><span class="line"><span class="comment"># the input will be the correct password.</span></span><br><span class="line"><span class="comment"># 在这个谜题中, 你的目标是在调用此函数之前停止程序, 并手动将to_check变量约束为你通过反编译二进制文件识别的密码.</span></span><br><span class="line"><span class="comment"># 因为, 作为人类, 你知道如果字符串相等, 程序将打印&quot;Good Job&quot;.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 设定符号执行起点, 因为使用的是固定的内存, 所以执行起点设在scanf后面, 如果不设在scanf, Angr复原的将是在调用scanf之前的内存数据, 即未初始化的垃圾数据</span></span><br><span class="line">  start_address = <span class="number">0x08049360</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 创建符号位向量</span></span><br><span class="line">  password_len_bits = <span class="number">16</span> * <span class="number">8</span>     <span class="comment">#总共十六个字符</span></span><br><span class="line">  password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, password_len_bits)<span class="comment"># 创建一个符号位向量</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 注入符号</span></span><br><span class="line">  password_address = <span class="number">0x0804C040</span>     <span class="comment"># buffer的地址</span></span><br><span class="line">  initial_state.memory.store(password_address, password)     <span class="comment"># 将符号注入到目标内存</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 创建模拟管理器</span></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Angr will not be able to reach the point at which the binary prints out</span></span><br><span class="line">  <span class="comment"># &#x27;Good Job.&#x27;. We cannot use that as the target anymore. </span></span><br><span class="line">  <span class="comment"># Angr将无法到达到达二进制打印出&quot;Good Job&quot;的点, 我们不能用它作为目标了</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 符号执行到这里便停下</span></span><br><span class="line">  address_to_check_constraint = <span class="number">0x080493AE</span>     <span class="comment">#题目要求的使在调用该函数之前停下来</span></span><br><span class="line">  simulation.explore(find=address_to_check_constraint)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 开始约束条件</span></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Recall that we need to constrain the to_check parameter (see top) of the </span></span><br><span class="line">    <span class="comment"># check_equals_ function. Determine the address that is being passed as the</span></span><br><span class="line">    <span class="comment"># parameter and load it into a bitvector so that we can constrain it.</span></span><br><span class="line">    <span class="comment"># 回想一下, 我们需要约束check_equals函数的to_check参数(上面的源码).</span></span><br><span class="line">    <span class="comment"># 确定作为参数传递的地址并将其加载到位向量中, 以便我们可以对其进行约束</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 约束参数</span></span><br><span class="line">    constrained_parameter_address = <span class="number">0x0804C040</span>     <span class="comment">#约束参数的地址</span></span><br><span class="line">    constrained_parameter_size_bytes = <span class="number">16</span>     <span class="comment">#约束参数的大小(以字节为单位)</span></span><br><span class="line">    constrained_parameter_bitvector = solution_state.memory.load(     <span class="comment">#将其加载到一个位向量中, 这个位向量存有该内存中的数据, 而这段内存已经被我们注入了符号</span></span><br><span class="line">      constrained_parameter_address,</span><br><span class="line">      constrained_parameter_size_bytes</span><br><span class="line">    )</span><br><span class="line">    <span class="comment"># We want to constrain the system to find an input that will make</span></span><br><span class="line">    <span class="comment"># constrained_parameter_bitvector equal the desired value.</span></span><br><span class="line">    <span class="comment"># 我们希望约束系统找到一个输入, 使得constrained_parameter_bitvector等于所需值</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    constrained_parameter_desired_value = <span class="string">&quot;HXUITWOAPNESFFEG&quot;</span> <span class="comment"># :string (encoded)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Specify a claripy expression (using Pythonic syntax) that tests whether</span></span><br><span class="line">    <span class="comment"># constrained_parameter_bitvector == constrained_parameter_desired_value.</span></span><br><span class="line">    <span class="comment"># Add the constraint to the state to let z3 attempt to find an input that</span></span><br><span class="line">    <span class="comment"># will make this expression true.</span></span><br><span class="line">    <span class="comment"># 指定一个清晰的表达式(使用Pythonic语法)来测试constrained_parameter_bitvector == constrained_parameter_desired_value.</span></span><br><span class="line">    <span class="comment"># 将约束添加到状态从而使z3尝试找到是该表达式满足的输入</span></span><br><span class="line">    solution_state.add_constraints(constrained_parameter_bitvector == constrained_parameter_desired_value)     <span class="comment"># 通过上面得到的位向量来添加约束条件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Solve for the constrained_parameter_bitvector.</span></span><br><span class="line">    <span class="comment"># 求解constrained_parameter_bitvector</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    solution = solution_state.solver.<span class="built_in">eval</span>(password, cast_to=<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后的代码-3"><a href="#去掉注释后的代码-3" class="headerlink" title="去掉注释后的代码"></a>去掉注释后的代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  start_address = <span class="number">0x08049360</span></span><br><span class="line">  initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  password_len_bits = <span class="number">16</span> * <span class="number">8</span></span><br><span class="line">  password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, password_len_bits)</span><br><span class="line"></span><br><span class="line">  password_address = <span class="number">0x0804C040</span></span><br><span class="line">  initial_state.memory.store(password_address, password)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  address_to_check_constraint = <span class="number">0x080493AE</span></span><br><span class="line">  simulation.explore(find=address_to_check_constraint)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    constrained_parameter_address = <span class="number">0x0804C040</span></span><br><span class="line">    constrained_parameter_size_bytes = <span class="number">16</span></span><br><span class="line">    constrained_parameter_bitvector = solution_state.memory.load(</span><br><span class="line">      constrained_parameter_address,</span><br><span class="line">      constrained_parameter_size_bytes</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    solution_state.add_constraints(constrained_parameter_bitvector == constrained_parameter_desired_value)     <span class="comment"># 通过上面得到的位向量来添加约束条件</span></span><br><span class="line"></span><br><span class="line">    solution = solution_state.solver.<span class="built_in">eval</span>(password, cast_to=<span class="built_in">bytes</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因为本题的约束条件是循环if, 一个if会分成两个state, 这样会造成指数级增长的分支, 所以我们要手动添加约束条件来解出flag. </p>
<h2 id="手动添加约束条件的步骤"><a href="#手动添加约束条件的步骤" class="headerlink" title="手动添加约束条件的步骤"></a>手动添加约束条件的步骤</h2><h3 id="1-确定约束什么-怎么约束"><a href="#1-确定约束什么-怎么约束" class="headerlink" title="1. 确定约束什么, 怎么约束"></a>1. 确定约束什么, 怎么约束</h3><p>在使用Angr实现约束之前, 我们要清楚的知道我们要约束什么, 怎么约束.</p>
<p>要约束什么, 我们就要按照关卡中的约束条件去模拟.</p>
<p>本关中约束的<strong>对象</strong>是经过<strong>complex_function加密过后的字符串</strong>, 约束的<strong>方法</strong>是<strong>跟一个参考数据进行比较</strong>, 相等则print”Good Job”. 这也就是我们要模拟的约束条件</p>
<h4 id="2-确定符号执行位置"><a href="#2-确定符号执行位置" class="headerlink" title="2. 确定符号执行位置"></a>2. 确定符号执行位置</h4><p>可以参考前两关, 应该在scanf之后开始符号执行</p>
<h3 id="3-创建符号并注入"><a href="#3-创建符号并注入" class="headerlink" title="3. 创建符号并注入"></a>3. 创建符号并注入</h3><p>这里使用的是全局变量, 直接注入即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">password_len_bits = <span class="number">16</span> * <span class="number">8</span></span><br><span class="line">password = claripy.BVS(<span class="string">&#x27;password&#x27;</span>, password_len_bits)</span><br><span class="line"></span><br><span class="line">password_address = <span class="number">0x0804C040</span>  <span class="comment"># 全局变量的地址</span></span><br><span class="line">initial_state.memory.store(password_address, password)</span><br></pre></td></tr></table></figure>

<h3 id="4-去掉原本的约束条件"><a href="#4-去掉原本的约束条件" class="headerlink" title="4. 去掉原本的约束条件"></a>4. 去掉原本的约束条件</h3><p>因为原本的约束条件难以实现, 所以我们才要自己添加约束条件来<strong>替换</strong>它. 所谓替换, 就是去掉(不执行)原本的约束语句, 只用我们自己的约束条件. 在本关中是<code>check_equals_HXUITWOAPNESFFEG()</code>函数.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">address_to_check_constraint = <span class="number">0x080493AE</span>     <span class="comment">#在调用check函数之前停下来</span></span><br><span class="line">simulation.explore(find=address_to_check_constraint)</span><br></pre></td></tr></table></figure>

<p>去掉原本的约束条件的实现是在check_equals_HXUITWOAPNESFFEG()之前停止符号执行</p>
<h3 id="5-添加自己的约束条件"><a href="#5-添加自己的约束条件" class="headerlink" title="5. 添加自己的约束条件"></a>5. 添加自己的约束条件</h3><p>我们<strong>读取</strong>此前注入了符号的内存(注意, 此时这段内存已经经过了complex_function的变换), 并通过<code>==</code>参考数据, 来添加约束条件.</p>
<p>因为这段内存注入了符号, 所以在当前的state中, 约束这段内存就相当于<strong>约束了complex_function变换后的符号位向量</strong>.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">  solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  constrained_parameter_address = <span class="number">0x0804C040</span>  <span class="comment">#从该地址开始读取内容</span></span><br><span class="line">  constrained_parameter_size_bytes = <span class="number">16</span>    <span class="comment"># 读取的字节长度</span></span><br><span class="line">  constrained_parameter_bitvector = solution_state.memory.load(</span><br><span class="line">    constrained_parameter_address,</span><br><span class="line">    constrained_parameter_size_bytes</span><br><span class="line">  )  <span class="comment"># 读取到constrained_parameter_bitvector位向量中去.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加约束条件</span></span><br><span class="line">constrained_parameter_desired_value = <span class="string">&quot;HXUITWOAPNESFFEG&quot;</span></span><br><span class="line">solution_state.add_constraints(constrained_parameter_bitvector == constrained_parameter_desired_value) </span><br></pre></td></tr></table></figure>

<h3 id="6-求解"><a href="#6-求解" class="headerlink" title="6. 求解"></a>6. 求解</h3><p>使用z3求解</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">solution = solution_state.solver.<span class="built_in">eval</span>(password, cast_to=<span class="built_in">bytes</span>)</span><br></pre></td></tr></table></figure>

<h1 id="09-angr-hooks"><a href="#09-angr-hooks" class="headerlink" title="09_angr_hooks"></a>09_angr_hooks</h1><h2 id="编译并运行-6"><a href="#编译并运行-6" class="headerlink" title="编译并运行"></a>编译并运行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/09_angr_hooks$ python3 generate.py 1234 09_angr_hooks</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/09_angr_hooks$ ./09_angr_hooks</span><br><span class="line">Enter the password: aaaaaaaaaa</span><br><span class="line">Try again.</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/09_angr_hooks$</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="分析-9"><a href="#分析-9" class="headerlink" title="分析"></a>分析</h2><p>使用IDA分析</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0804930</span>A                   ; <span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function">.text:0804930A                                   <span class="keyword">public</span> main</span></span><br><span class="line"><span class="function">.text:0804930A                   main            proc near               </span>; DATA XREF: _start+<span class="number">2</span>A↑o</span><br><span class="line">.text:<span class="number">0804930</span>A</span><br><span class="line">.text:<span class="number">0804930</span>A                   var_10          = dword ptr <span class="number">-10</span>h</span><br><span class="line">.text:<span class="number">0804930</span>A                   var_C           = dword ptr <span class="number">-0</span>Ch</span><br><span class="line">.text:<span class="number">0804930</span>A                   var_4           = dword ptr <span class="number">-4</span></span><br><span class="line">.text:<span class="number">0804930</span>A                   argc            = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">0804930</span>A                   argv            = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804930</span>A                   envp            = dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804930</span>A</span><br><span class="line">.text:<span class="number">0804930</span>A                   ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0804930</span>A F3 <span class="number">0F</span> <span class="number">1</span>E FB                       endbr32</span><br><span class="line">.text:<span class="number">0804930</span>E <span class="number">8</span>D <span class="number">4</span>C <span class="number">24</span> <span class="number">04</span>                       lea     ecx, [esp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">08049312</span> <span class="number">83</span> E4 F0                          <span class="keyword">and</span>     esp, <span class="number">0F</span>FFFFFF0h</span><br><span class="line">.text:<span class="number">08049315</span> FF <span class="number">71</span> FC                          push    dword ptr [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">08049318</span> <span class="number">55</span>                                push    ebp</span><br><span class="line">.text:<span class="number">08049319</span> <span class="number">89</span> E5                             mov     ebp, esp</span><br><span class="line">.text:<span class="number">0804931B</span> <span class="number">51</span>                                push    ecx</span><br><span class="line">.text:<span class="number">0804931</span>C <span class="number">83</span> EC <span class="number">14</span>                          sub     esp, <span class="number">14</span>h</span><br><span class="line">.text:<span class="number">0804931F</span> C7 <span class="number">05</span> <span class="number">34</span> C0 <span class="number">04</span> <span class="number">08</span>+                mov     ds:password, <span class="number">49555848</span>h ; 参考数据</span><br><span class="line">.text:<span class="number">0804931F</span> <span class="number">48</span> <span class="number">58</span> <span class="number">55</span> <span class="number">49</span></span><br><span class="line">.text:<span class="number">08049329</span> C7 <span class="number">05</span> <span class="number">38</span> C0 <span class="number">04</span> <span class="number">08</span>+                mov     ds:dword_804C038, <span class="number">414F</span>5754h</span><br><span class="line">.text:<span class="number">08049329</span> <span class="number">54</span> <span class="number">57</span> <span class="number">4F</span> <span class="number">41</span></span><br><span class="line">.text:<span class="number">08049333</span> C7 <span class="number">05</span> <span class="number">3</span>C C0 <span class="number">04</span> <span class="number">08</span>+                mov     ds:dword_804C03C, <span class="number">53454E50</span>h</span><br><span class="line">.text:<span class="number">08049333</span> <span class="number">50</span> <span class="number">4</span>E <span class="number">45</span> <span class="number">53</span></span><br><span class="line">.text:<span class="number">0804933</span>D C7 <span class="number">05</span> <span class="number">40</span> C0 <span class="number">04</span> <span class="number">08</span>+                mov     ds:dword_804C040, <span class="number">47454646</span>h</span><br><span class="line">.text:<span class="number">0804933</span>D <span class="number">46</span> <span class="number">46</span> <span class="number">45</span> <span class="number">47</span></span><br><span class="line">.text:<span class="number">08049347</span> <span class="number">83</span> EC <span class="number">04</span>                          sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">0804934</span>A <span class="number">6</span>A <span class="number">11</span>                             push    <span class="number">11</span>h             ; n</span><br><span class="line">.text:<span class="number">0804934</span>C <span class="number">6</span>A <span class="number">00</span>                             push    <span class="number">0</span>               ; c</span><br><span class="line">.text:<span class="number">0804934</span>E <span class="number">68</span> <span class="number">44</span> C0 <span class="number">04</span> <span class="number">08</span>                    push    offset buffer   ; s</span><br><span class="line">.text:<span class="number">08049353</span> E8 <span class="number">98</span> FD FF FF                    call    _memset         ; 初始化buffer</span><br><span class="line">.text:<span class="number">08049358</span> <span class="number">83</span> C4 <span class="number">10</span>                          add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804935B</span> <span class="number">83</span> EC <span class="number">0</span>C                          sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804935</span>E <span class="number">68</span> <span class="number">16</span> A0 <span class="number">04</span> <span class="number">08</span>                    push    offset aEnterThePasswo ; <span class="string">&quot;Enter the password: &quot;</span></span><br><span class="line">.text:<span class="number">08049363</span> E8 <span class="number">48</span> FD FF FF                    call    _printf</span><br><span class="line">.text:<span class="number">08049368</span> <span class="number">83</span> C4 <span class="number">10</span>                          add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804936B</span> <span class="number">83</span> EC <span class="number">08</span>                          sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">0804936</span>E <span class="number">68</span> <span class="number">44</span> C0 <span class="number">04</span> <span class="number">08</span>                    push    offset buffer</span><br><span class="line">.text:<span class="number">08049373</span> <span class="number">68</span> <span class="number">2B</span> A0 <span class="number">04</span> <span class="number">08</span>                    push    offset a16s     ; <span class="string">&quot;%16s&quot;</span></span><br><span class="line">.text:<span class="number">08049378</span> E8 <span class="number">83</span> FD FF FF                    call    ___isoc99_scanf ; 获取用户输入</span><br><span class="line">.text:<span class="number">0804937</span>D <span class="number">83</span> C4 <span class="number">10</span>                          add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049380</span> C7 <span class="number">45</span> F0 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>+                mov     [ebp+var_10], <span class="number">0</span></span><br><span class="line">.text:<span class="number">08049380</span> <span class="number">00</span></span><br><span class="line">.text:<span class="number">08049387</span> EB <span class="number">35</span>                             jmp     <span class="keyword">short</span> loc_80493BE</span><br><span class="line">.text:<span class="number">08049389</span>                   ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049389</span></span><br><span class="line">.text:<span class="number">08049389</span>                   loc_8049389:                            ; CODE XREF: main+B8↓j</span><br><span class="line">.text:<span class="number">08049389</span> B8 <span class="number">12</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                    mov     eax, <span class="number">12</span>h</span><br><span class="line">.text:<span class="number">0804938</span>E <span class="number">2B</span> <span class="number">45</span> F0                          sub     eax, [ebp+var_10]</span><br><span class="line">.text:<span class="number">08049391</span> <span class="number">89</span> C2                             mov     edx, eax</span><br><span class="line">.text:<span class="number">08049393</span> <span class="number">8B</span> <span class="number">45</span> F0                          mov     eax, [ebp+var_10]</span><br><span class="line">.text:<span class="number">08049396</span> <span class="number">05</span> <span class="number">44</span> C0 <span class="number">04</span> <span class="number">08</span>                    add     eax, <span class="number">804</span>C044h</span><br><span class="line">.text:<span class="number">0804939B</span> <span class="number">0F</span> B6 <span class="number">00</span>                          movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">0804939</span>E <span class="number">0F</span> BE C0                          movsx   eax, al</span><br><span class="line">.text:<span class="number">080493</span>A1 <span class="number">83</span> EC <span class="number">08</span>                          sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080493</span>A4 <span class="number">52</span>                                push    edx</span><br><span class="line">.text:<span class="number">080493</span>A5 <span class="number">50</span>                                push    eax</span><br><span class="line">.text:<span class="number">080493</span>A6 E8 AD FE FF FF                    call    complex_function ; 进行变换</span><br><span class="line">.text:<span class="number">080493</span>AB <span class="number">83</span> C4 <span class="number">10</span>                          add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493</span>AE <span class="number">89</span> C2                             mov     edx, eax</span><br><span class="line">.text:<span class="number">080493B</span>0 <span class="number">8B</span> <span class="number">45</span> F0                          mov     eax, [ebp+var_10]</span><br><span class="line">.text:<span class="number">080493B</span>3 <span class="number">05</span> <span class="number">44</span> C0 <span class="number">04</span> <span class="number">08</span>                    add     eax, <span class="number">804</span>C044h</span><br><span class="line">.text:<span class="number">080493B</span>8 <span class="number">88</span> <span class="number">10</span>                             mov     [eax], dl</span><br><span class="line">.text:<span class="number">080493B</span>A <span class="number">83</span> <span class="number">45</span> F0 <span class="number">01</span>                       add     [ebp+var_10], <span class="number">1</span></span><br><span class="line">.text:<span class="number">080493B</span>E</span><br><span class="line">.text:<span class="number">080493B</span>E                   loc_80493BE:                            ; CODE XREF: main+<span class="number">7</span>D↑j</span><br><span class="line">.text:<span class="number">080493B</span>E <span class="number">83</span> <span class="number">7</span>D F0 <span class="number">0F</span>                       cmp     [ebp+var_10], <span class="number">0F</span>h</span><br><span class="line">.text:<span class="number">080493</span>C2 <span class="number">7</span>E C5                             jle     <span class="keyword">short</span> loc_8049389</span><br><span class="line">.text:<span class="number">080493</span>C4 <span class="number">83</span> EC <span class="number">08</span>                          sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080493</span>C7 <span class="number">6</span>A <span class="number">10</span>                             push    <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493</span>C9 <span class="number">68</span> <span class="number">44</span> C0 <span class="number">04</span> <span class="number">08</span>                    push    offset buffer</span><br><span class="line">.text:<span class="number">080493</span>CE E8 E5 FE FF FF                    call    check_equals_HXUITWOAPNESFFEG ; 最终检查</span><br><span class="line">.text:<span class="number">080493</span>D3 <span class="number">83</span> C4 <span class="number">10</span>                          add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493</span>D6 A3 <span class="number">58</span> C0 <span class="number">04</span> <span class="number">08</span>                    mov     ds:equals, eax</span><br><span class="line">.text:<span class="number">080493</span>DB C7 <span class="number">45</span> F4 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>+                mov     [ebp+var_C], <span class="number">0</span></span><br><span class="line">.text:<span class="number">080493</span>DB <span class="number">00</span></span><br><span class="line">.text:<span class="number">080493E2</span> EB <span class="number">31</span>                             jmp     <span class="keyword">short</span> loc_8049415</span><br><span class="line">.text:<span class="number">080493E4</span>                   ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">080493E4</span></span><br><span class="line">.text:<span class="number">080493E4</span>                   loc_80493E4:                            ; CODE XREF: main+<span class="number">10F</span>↓j</span><br><span class="line">.text:<span class="number">080493E4</span> <span class="number">8B</span> <span class="number">45</span> F4                          mov     eax, [ebp+var_C]</span><br><span class="line">.text:<span class="number">080493E7</span> <span class="number">8</span>D <span class="number">50</span> <span class="number">09</span>                          lea     edx, [eax+<span class="number">9</span>]</span><br><span class="line">.text:<span class="number">080493</span>EA <span class="number">8B</span> <span class="number">45</span> F4                          mov     eax, [ebp+var_C]</span><br><span class="line">.text:<span class="number">080493</span>ED <span class="number">05</span> <span class="number">34</span> C0 <span class="number">04</span> <span class="number">08</span>                    add     eax, <span class="number">804</span>C034h</span><br><span class="line">.text:<span class="number">080493F</span>2 <span class="number">0F</span> B6 <span class="number">00</span>                          movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">080493F</span>5 <span class="number">0F</span> BE C0                          movsx   eax, al</span><br><span class="line">.text:<span class="number">080493F</span>8 <span class="number">83</span> EC <span class="number">08</span>                          sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080493F</span>B <span class="number">52</span>                                push    edx</span><br><span class="line">.text:<span class="number">080493F</span>C <span class="number">50</span>                                push    eax</span><br><span class="line">.text:<span class="number">080493F</span>D E8 <span class="number">56</span> FE FF FF                    call    complex_function</span><br><span class="line">.text:<span class="number">08049402</span> <span class="number">83</span> C4 <span class="number">10</span>                          add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049405</span> <span class="number">89</span> C2                             mov     edx, eax</span><br><span class="line">.text:<span class="number">08049407</span> <span class="number">8B</span> <span class="number">45</span> F4                          mov     eax, [ebp+var_C]</span><br><span class="line">.text:<span class="number">0804940</span>A <span class="number">05</span> <span class="number">34</span> C0 <span class="number">04</span> <span class="number">08</span>                    add     eax, <span class="number">804</span>C034h</span><br><span class="line">.text:<span class="number">0804940F</span> <span class="number">88</span> <span class="number">10</span>                             mov     [eax], dl</span><br><span class="line">.text:<span class="number">08049411</span> <span class="number">83</span> <span class="number">45</span> F4 <span class="number">01</span>                       add     [ebp+var_C], <span class="number">1</span></span><br><span class="line">.text:<span class="number">08049415</span></span><br><span class="line">.text:<span class="number">08049415</span>                   loc_8049415:                            ; CODE XREF: main+D8↑j</span><br><span class="line">.text:<span class="number">08049415</span> <span class="number">83</span> <span class="number">7</span>D F4 <span class="number">0F</span>                       cmp     [ebp+var_C], <span class="number">0F</span>h</span><br><span class="line">.text:<span class="number">08049419</span> <span class="number">7</span>E C9                             jle     <span class="keyword">short</span> loc_80493E4</span><br><span class="line">.text:<span class="number">0804941B</span> <span class="number">83</span> EC <span class="number">08</span>                          sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">0804941</span>E <span class="number">68</span> <span class="number">44</span> C0 <span class="number">04</span> <span class="number">08</span>                    push    offset buffer</span><br><span class="line">.text:<span class="number">08049423</span> <span class="number">68</span> <span class="number">2B</span> A0 <span class="number">04</span> <span class="number">08</span>                    push    offset a16s     ; <span class="string">&quot;%16s&quot;</span></span><br><span class="line">.text:<span class="number">08049428</span> E8 D3 FC FF FF                    call    ___isoc99_scanf</span><br><span class="line">.text:<span class="number">0804942</span>D <span class="number">83</span> C4 <span class="number">10</span>                          add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049430</span> A1 <span class="number">58</span> C0 <span class="number">04</span> <span class="number">08</span>                    mov     eax, ds:equals</span><br><span class="line">.text:<span class="number">08049435</span> <span class="number">85</span> C0                             test    eax, eax</span><br><span class="line">.text:<span class="number">08049437</span> <span class="number">74</span> <span class="number">22</span>                             jz      <span class="keyword">short</span> loc_804945B</span><br><span class="line">.text:<span class="number">08049439</span> <span class="number">83</span> EC <span class="number">04</span>                          sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">0804943</span>C <span class="number">6</span>A <span class="number">10</span>                             push    <span class="number">10</span>h             ; n</span><br><span class="line">.text:<span class="number">0804943</span>E <span class="number">68</span> <span class="number">34</span> C0 <span class="number">04</span> <span class="number">08</span>                    push    offset password ; s2</span><br><span class="line">.text:<span class="number">08049443</span> <span class="number">68</span> <span class="number">44</span> C0 <span class="number">04</span> <span class="number">08</span>                    push    offset buffer   ; s1</span><br><span class="line">.text:<span class="number">08049448</span> E8 C3 FC FF FF                    call    _strncmp</span><br><span class="line">.text:<span class="number">0804944</span>D <span class="number">83</span> C4 <span class="number">10</span>                          add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049450</span> <span class="number">85</span> C0                             test    eax, eax</span><br><span class="line">.text:<span class="number">08049452</span> <span class="number">75</span> <span class="number">07</span>                             jnz     <span class="keyword">short</span> loc_804945B</span><br><span class="line">.text:<span class="number">08049454</span> B8 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                    mov     eax, <span class="number">1</span></span><br><span class="line">.text:<span class="number">08049459</span> EB <span class="number">05</span>                             jmp     <span class="keyword">short</span> loc_8049460</span><br><span class="line">.text:<span class="number">0804945B</span>                   ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0804945B</span></span><br><span class="line">.text:<span class="number">0804945B</span>                   loc_804945B:                            ; CODE XREF: main+<span class="number">12</span>D↑j</span><br><span class="line">.text:<span class="number">0804945B</span>                                                           ; main+<span class="number">148</span>↑j</span><br><span class="line">.text:<span class="number">0804945B</span> B8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                    mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">08049460</span></span><br><span class="line">.text:<span class="number">08049460</span>                   loc_8049460:                            ; CODE XREF: main+<span class="number">14F</span>↑j</span><br><span class="line">.text:<span class="number">08049460</span> A3 <span class="number">58</span> C0 <span class="number">04</span> <span class="number">08</span>                    mov     ds:equals, eax</span><br><span class="line">.text:<span class="number">08049465</span> A1 <span class="number">58</span> C0 <span class="number">04</span> <span class="number">08</span>                    mov     eax, ds:equals</span><br><span class="line">.text:<span class="number">0804946</span>A <span class="number">85</span> C0                             test    eax, eax</span><br><span class="line">.text:<span class="number">0804946</span>C <span class="number">75</span> <span class="number">12</span>                             jnz     <span class="keyword">short</span> loc_8049480</span><br><span class="line">.text:<span class="number">0804946</span>E <span class="number">83</span> EC <span class="number">0</span>C                          sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049471</span> <span class="number">68</span> <span class="number">0B</span> A0 <span class="number">04</span> <span class="number">08</span>                    push    offset s        ; <span class="string">&quot;Try again.&quot;</span></span><br><span class="line">.text:<span class="number">08049476</span> E8 <span class="number">45</span> FC FF FF                    call    _puts</span><br><span class="line">.text:<span class="number">0804947B</span> <span class="number">83</span> C4 <span class="number">10</span>                          add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804947</span>E EB <span class="number">10</span>                             jmp     <span class="keyword">short</span> loc_8049490</span><br><span class="line">.text:<span class="number">08049480</span>                   ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049480</span></span><br><span class="line">.text:<span class="number">08049480</span>                   loc_8049480:                            ; CODE XREF: main+<span class="number">162</span>↑j</span><br><span class="line">.text:<span class="number">08049480</span> <span class="number">83</span> EC <span class="number">0</span>C                          sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049483</span> <span class="number">68</span> <span class="number">30</span> A0 <span class="number">04</span> <span class="number">08</span>                    push    offset aGoodJob ; <span class="string">&quot;Good Job.&quot;</span></span><br><span class="line">.text:<span class="number">08049488</span> E8 <span class="number">33</span> FC FF FF                    call    _puts</span><br><span class="line">.text:<span class="number">0804948</span>D <span class="number">83</span> C4 <span class="number">10</span>                          add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049490</span></span><br><span class="line">.text:<span class="number">08049490</span>                   loc_8049490:                            ; CODE XREF: main+<span class="number">174</span>↑j</span><br><span class="line">.text:<span class="number">08049490</span> B8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                    mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">08049495</span> <span class="number">8B</span> <span class="number">4</span>D FC                          mov     ecx, [ebp+var_4]</span><br><span class="line">.text:<span class="number">08049498</span> C9                                leave</span><br><span class="line">.text:<span class="number">08049499</span> <span class="number">8</span>D <span class="number">61</span> FC                          lea     esp, [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">0804949</span>C C3                                retn</span><br><span class="line">.text:<span class="number">0804949</span>C                   ; &#125; <span class="comment">// starts at 804930A</span></span><br><span class="line">.text:<span class="number">0804949</span>C                   main            endp</span><br><span class="line">.text:<span class="number">0804949</span>C</span><br><span class="line">.text:<span class="number">0804949</span>C                   ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0804949</span>D <span class="number">66</span> <span class="number">90</span> <span class="number">90</span>                          align <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080494</span>A0</span><br><span class="line">.text:<span class="number">080494</span>A0                   ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:<span class="number">080494</span>A0</span><br><span class="line">.text:<span class="number">080494</span>A0</span><br><span class="line">.text:<span class="number">080494</span>A0                                   <span class="keyword">public</span> __libc_csu_init</span><br><span class="line">.text:<span class="number">080494</span>A0                   __libc_csu_init proc near               ; DATA XREF: _start+<span class="number">21</span>↑o</span><br><span class="line">.text:<span class="number">080494</span>A0</span><br><span class="line">.text:<span class="number">080494</span>A0                   arg_0           = dword ptr  <span class="number">4</span></span><br><span class="line">.text:<span class="number">080494</span>A0                   arg_4           = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">080494</span>A0                   arg_8           = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080494</span>A0</span><br><span class="line">.text:<span class="number">080494</span>A0                   ; __unwind &#123;</span><br><span class="line">.text:<span class="number">080494</span>A0 F3 <span class="number">0F</span> <span class="number">1</span>E FB                       endbr32</span><br><span class="line">.text:<span class="number">080494</span>A4 <span class="number">55</span>                                push    ebp</span><br><span class="line">.text:<span class="number">080494</span>A5 E8 <span class="number">6B</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                    call    __x86_get_pc_thunk_bp</span><br><span class="line">.text:<span class="number">080494</span>AA <span class="number">81</span> C5 <span class="number">56</span> <span class="number">2B</span> <span class="number">00</span> <span class="number">00</span>                 add     ebp, (offset _GLOBAL_OFFSET_TABLE_ - $)</span><br><span class="line">.text:<span class="number">080494B</span>0 <span class="number">57</span>                                push    edi</span><br><span class="line">.text:<span class="number">080494B</span>1 <span class="number">56</span>                                push    esi</span><br><span class="line">.text:<span class="number">080494B</span>2 <span class="number">53</span>                                push    ebx</span><br><span class="line">.text:<span class="number">080494B</span>3 <span class="number">83</span> EC <span class="number">0</span>C                          sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080494B</span>6 <span class="number">89</span> EB                             mov     ebx, ebp</span><br><span class="line">.text:<span class="number">080494B</span>8 <span class="number">8B</span> <span class="number">7</span>C <span class="number">24</span> <span class="number">28</span>                       mov     edi, [esp+<span class="number">1</span>Ch+arg_8]</span><br><span class="line">.text:<span class="number">080494B</span>C E8 <span class="number">3F</span> FB FF FF                    call    _init_proc</span><br><span class="line">.text:<span class="number">080494</span>C1 <span class="number">8</span>D <span class="number">9</span>D <span class="number">10</span> FF FF FF                 lea     ebx, [ebp<span class="number">-0F</span>0h]</span><br><span class="line">.text:<span class="number">080494</span>C7 <span class="number">8</span>D <span class="number">85</span> <span class="number">0</span>C FF FF FF                 lea     eax, [ebp<span class="number">-0F</span>4h]</span><br><span class="line">.text:<span class="number">080494</span>CD <span class="number">29</span> C3                             sub     ebx, eax</span><br><span class="line">.text:<span class="number">080494</span>CF C1 FB <span class="number">02</span>                          sar     ebx, <span class="number">2</span></span><br><span class="line">.text:<span class="number">080494</span>D2 <span class="number">74</span> <span class="number">29</span>                             jz      <span class="keyword">short</span> loc_80494FD</span><br><span class="line">.text:<span class="number">080494</span>D4 <span class="number">31</span> F6                             <span class="keyword">xor</span>     esi, esi</span><br><span class="line">.text:<span class="number">080494</span>D6 <span class="number">8</span>D B4 <span class="number">26</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>+                lea     esi, [esi+<span class="number">0</span>]</span><br><span class="line">.text:<span class="number">080494</span>D6 <span class="number">00</span></span><br><span class="line">.text:<span class="number">080494</span>DD <span class="number">8</span>D <span class="number">76</span> <span class="number">00</span>                          lea     esi, [esi+<span class="number">0</span>]</span><br><span class="line">.text:<span class="number">080494E0</span></span><br><span class="line">.text:<span class="number">080494E0</span>                   loc_80494E0:                            ; CODE XREF: __libc_csu_init+<span class="number">5B</span>↓j</span><br><span class="line">.text:<span class="number">080494E0</span> <span class="number">83</span> EC <span class="number">04</span>                          sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">080494E3</span> <span class="number">57</span>                                push    edi</span><br><span class="line">.text:<span class="number">080494E4</span> FF <span class="number">74</span> <span class="number">24</span> <span class="number">2</span>C                       push    [esp+<span class="number">24</span>h+arg_4]</span><br><span class="line">.text:<span class="number">080494E8</span> FF <span class="number">74</span> <span class="number">24</span> <span class="number">2</span>C                       push    [esp+<span class="number">28</span>h+arg_0]</span><br><span class="line">.text:<span class="number">080494</span>EC FF <span class="number">94</span> B5 <span class="number">0</span>C FF FF+                call    ss:(__frame_dummy_init_array_entry - <span class="number">804</span>C000h)[ebp+esi*<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">080494</span>EC FF</span><br><span class="line">.text:<span class="number">080494F</span>3 <span class="number">83</span> C6 <span class="number">01</span>                          add     esi, <span class="number">1</span></span><br><span class="line">.text:<span class="number">080494F</span>6 <span class="number">83</span> C4 <span class="number">10</span>                          add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080494F</span>9 <span class="number">39</span> F3                             cmp     ebx, esi</span><br><span class="line">.text:<span class="number">080494F</span>B <span class="number">75</span> E3                             jnz     <span class="keyword">short</span> loc_80494E0</span><br><span class="line">.text:<span class="number">080494F</span>D</span><br><span class="line">.text:<span class="number">080494F</span>D                   loc_80494FD:                            ; CODE XREF: __libc_csu_init+<span class="number">32</span>↑j</span><br><span class="line">.text:<span class="number">080494F</span>D <span class="number">83</span> C4 <span class="number">0</span>C                          add     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049500</span> <span class="number">5B</span>                                pop     ebx</span><br><span class="line">.text:<span class="number">08049501</span> <span class="number">5</span>E                                pop     esi</span><br><span class="line">.text:<span class="number">08049502</span> <span class="number">5F</span>                                pop     edi</span><br><span class="line">.text:<span class="number">08049503</span> <span class="number">5</span>D                                pop     ebp</span><br><span class="line">.text:<span class="number">08049504</span> C3                                retn</span><br><span class="line">.text:<span class="number">08049504</span>                   ; &#125; <span class="comment">// starts at 80494A0</span></span><br><span class="line">.text:<span class="number">08049504</span>                   __libc_csu_init endp</span><br><span class="line">.text:<span class="number">08049504</span></span><br><span class="line">.text:<span class="number">08049504</span>                   ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049505</span> <span class="number">8</span>D B4 <span class="number">26</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>+                align <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049510</span></span><br><span class="line">.text:<span class="number">08049510</span>                   ; =============== S U B R O U T I N E =======================================</span><br></pre></td></tr></table></figure>

<p>进行了两次输入和检查:</p>
<ul>
<li>第一次输入后, 对输入进行加密, 然后与参考数据比较</li>
<li>第二次输入后, 对参考数据进行加密, 然后与输入进行比较</li>
</ul>
<p>其中我们需要修改的是第一次比较部分, 因为使用了check_equals_HXUITWOAPNESFFEG()函数, 而在这个函数中循环使用了if, 造成过多的分支, 第二次的检验用的是sctcmp所以不用修改.</p>
<p>所以我们要用Angr构建一个检查函数来替换掉check_equals_HXUITWOAPNESFFEG(), 这是一个Hook过程.</p>
<h2 id="使用Angr来解题"><a href="#使用Angr来解题" class="headerlink" title="使用Angr来解题"></a>使用Angr来解题</h2><h3 id="代码-7"><a href="#代码-7" class="headerlink" title="代码"></a>代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This level performs the following computations:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 1. Get 16 bytes of user input and encrypt it.</span></span><br><span class="line"><span class="comment"># 2. Save the result of check_equals_AABBCCDDEEFFGGHH (or similar)</span></span><br><span class="line"><span class="comment"># 3. Get another 16 bytes from the user and encrypt it.</span></span><br><span class="line"><span class="comment"># 4. Check that it&#x27;s equal to a predefined password.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The ONLY part of this program that we have to worry about is #2. We will be</span></span><br><span class="line"><span class="comment"># replacing the call to check_equals_ with our own version, using a hook, since</span></span><br><span class="line"><span class="comment"># check_equals_ will run too slowly otherwise.</span></span><br><span class="line"><span class="comment"># 这一关的流程:</span></span><br><span class="line"><span class="comment"># 1. 获取用户16字符输入并加密</span></span><br><span class="line"><span class="comment"># 2. 从check_equals_HXUITWOAPNESFFEG()检验并保存检验结果(相同则1, 不相同则0)</span></span><br><span class="line"><span class="comment"># 3. 再次获取用户输入, 并加密参考数据</span></span><br><span class="line"><span class="comment"># 4. 再次检查, 只不过用的是strcmp()进行检查</span></span><br><span class="line"><span class="comment"># 我们需要担心的只有第二步, 我们要使用自己的检查函数来替换原本的check_equals_HXUITWOAPNESFFEG(), 因为里面有太多的if分支了</span></span><br><span class="line"><span class="comment"># 我们替换的方法是使用钩子</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  <span class="comment"># 建立Angr项目</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Since Angr can handle the initial call to scanf, we can start from the</span></span><br><span class="line">  <span class="comment"># beginning.</span></span><br><span class="line">  <span class="comment"># 由于Angr可以处理对scanf的初始调用, 所以这里默认从mian函数开始即可</span></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Hook the address of where check_equals_ is called.</span></span><br><span class="line">  <span class="comment"># 钩取调用check_equals_HXUITWOAPNESFFEG()函数的地址</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  check_equals_called_address = <span class="number">0x080493CE</span> <span class="comment"># 调用check_equals_HXUITWOAPNESFFEG()的地址</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># The length parameter in angr.Hook specifies how many bytes the execution</span></span><br><span class="line">  <span class="comment"># engine should skip after completing the hook. This will allow hooks to</span></span><br><span class="line">  <span class="comment"># replace certain instructions (or groups of instructions). Determine the</span></span><br><span class="line">  <span class="comment"># instructions involved in calling check_equals_, and then determine how many</span></span><br><span class="line">  <span class="comment"># bytes are used to represent them in memory. This will be the skip length.</span></span><br><span class="line">  <span class="comment"># Angr.Hook中的lenth参数指定执行引擎在完成Hook后应该跳过多少字节.</span></span><br><span class="line">  <span class="comment"># 这将使Hook替换某些指令(call指令, 后面清理栈的指令)</span></span><br><span class="line">  <span class="comment"># 确定调用check_equals_HXUITWOAPNESFFEG()所涉及的指令, 然后确定在内存中使用多少字节来表示他们, 这就是lenth</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  instruction_to_skip_length = <span class="number">5</span> + <span class="number">3</span> <span class="comment"># call指令占5个字节, 下面清理参数栈的add指令占3字节</span></span><br><span class="line"><span class="meta">  @project.hook(<span class="params">check_equals_called_address, length=instruction_to_skip_length</span>)</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">skip_check_equals_</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="comment"># Determine the address where user input is stored. It is passed as a</span></span><br><span class="line">    <span class="comment"># parameter ot the check_equals_ function. Then, load the string. Reminder:</span></span><br><span class="line">    <span class="comment"># int check_equals_(char* to_check, int length) &#123; ...</span></span><br><span class="line">    <span class="comment"># 确定存储用户输入的地址. 它作为check_equals_HXUITWOAPNESFFEG()的参数传递</span></span><br><span class="line">    <span class="comment"># 然后加载字符串.</span></span><br><span class="line">    user_input_buffer_address = <span class="number">0x0804C044</span> <span class="comment"># :integer, probably hexadecimal</span></span><br><span class="line">    user_input_buffer_length = <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Reminder: state.memory.load will read the stored value at the address</span></span><br><span class="line">    <span class="comment"># user_input_buffer_address of byte length user_input_buffer_length.</span></span><br><span class="line">    <span class="comment"># It will return a bitvector holding the value. This value can either be</span></span><br><span class="line">    <span class="comment"># symbolic or concrete, depending on what was stored there in the program.</span></span><br><span class="line">    <span class="comment"># state.memry.load()会读取地址user_input+buffer_address处存储的值, 长度为user_input_buffer_lenth</span></span><br><span class="line">    <span class="comment"># 它将返回一个保存该值的位向量.这个值可以是符号位向量, 也可以是常数位向量.</span></span><br><span class="line">    <span class="comment"># 取决于程序中存储的内容</span></span><br><span class="line">    <span class="comment"># 这里加载的buffer中存储的是符号值, 虽然我们没有创建符号并注入, 但是开始时使用的时默认的执行起始状态</span></span><br><span class="line">    <span class="comment"># 所以会自动注入符号到scanf所指向的内存, 也就是上面的buffer</span></span><br><span class="line">    user_input_string = state.memory.load(</span><br><span class="line">      user_input_buffer_address,</span><br><span class="line">      user_input_buffer_length</span><br><span class="line">    )</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># Determine the string this function is checking the user input against.</span></span><br><span class="line">    <span class="comment"># It&#x27;s encoded in the name of this function; decompile the program to find</span></span><br><span class="line">    <span class="comment"># it.</span></span><br><span class="line">    <span class="comment"># 确定此函数正在检查的用户输入的字符串</span></span><br><span class="line">    <span class="comment"># 它以这个函数的名称编码</span></span><br><span class="line">    check_against_string = <span class="string">&quot;HXUITWOAPNESFFEG&quot;</span> <span class="comment"># :string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># gcc uses eax to store the return value, if it is an integer. We need to</span></span><br><span class="line">    <span class="comment"># set eax to 1 if check_against_string == user_input_string and 0 otherwise.</span></span><br><span class="line">    <span class="comment"># However, since we are describing an equation to be used by z3 (not to be</span></span><br><span class="line">    <span class="comment"># evaluated immediately), we cannot use Python if else syntax. Instead, we </span></span><br><span class="line">    <span class="comment"># have to use claripy&#x27;s built in function that deals with if statements.</span></span><br><span class="line">    <span class="comment"># claripy.If(expression, ret_if_true, ret_if_false) will output an</span></span><br><span class="line">    <span class="comment"># expression that evaluates to ret_if_true if expression is true and</span></span><br><span class="line">    <span class="comment"># ret_if_false otherwise.</span></span><br><span class="line">    <span class="comment"># Think of it like the Python &quot;value0 if expression else value1&quot;.</span></span><br><span class="line">    <span class="comment"># gcc使用eax来存储返回值, 如果它是一个整数.</span></span><br><span class="line">    <span class="comment"># 如果check_against_string == user_input_string, 就将eax设为1, 否则为0</span></span><br><span class="line">    <span class="comment"># 但是, 由于我们描述的是z3使用的方程(不立即计算), 我们不能使用Python的if else语法</span></span><br><span class="line">    <span class="comment"># 相反, 我们必须使用claripy的内置函数来处理if语句</span></span><br><span class="line">    <span class="comment"># claripy.if(expression, ret_if_true, ret_if_false)</span></span><br><span class="line">    <span class="comment"># 根据参数名可以知道第一个参数expression为真, 则返回第二个参数, 反之则返回第三个参数</span></span><br><span class="line">    state.regs.eax = claripy.If(</span><br><span class="line">      user_input_string == check_against_string, </span><br><span class="line">      claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), </span><br><span class="line">      claripy.BVV(<span class="number">0</span>, <span class="number">32</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Since we are allowing Angr to handle the input, retrieve it by printing</span></span><br><span class="line">    <span class="comment"># the contents of stdin. Use one of the early levels as a reference.</span></span><br><span class="line">    <span class="comment"># 因为我们允许Angr处理输入, 所以通过打印stdin的内容来查看它.</span></span><br><span class="line">    solution = solution_state.posix.dumps(sys.stdin.fileno())</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后的代码-4"><a href="#去掉注释后的代码-4" class="headerlink" title="去掉注释后的代码"></a>去掉注释后的代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  check_equals_called_address = <span class="number">0x080493CE</span> </span><br><span class="line"></span><br><span class="line">  instruction_to_skip_length = <span class="number">5</span> + <span class="number">3</span> </span><br><span class="line"><span class="meta">  @project.hook(<span class="params">check_equals_called_address, length=instruction_to_skip_length</span>)</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">skip_check_equals_</span>(<span class="params">state</span>):</span></span><br><span class="line"></span><br><span class="line">    user_input_buffer_address = <span class="number">0x0804C044</span></span><br><span class="line">    user_input_buffer_length = <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">    user_input_string = state.memory.load(</span><br><span class="line">      user_input_buffer_address,</span><br><span class="line">      user_input_buffer_length</span><br><span class="line">    )</span><br><span class="line">  </span><br><span class="line">    check_against_string = <span class="string">&quot;HXUITWOAPNESFFEG&quot;</span></span><br><span class="line"></span><br><span class="line">    state.regs.eax = claripy.If(</span><br><span class="line">      user_input_string == check_against_string, </span><br><span class="line">      claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), </span><br><span class="line">      claripy.BVV(<span class="number">0</span>, <span class="number">32</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution = solution_state.posix.dumps(sys.stdin.fileno())</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="使用Angr实现Hook过程"><a href="#使用Angr实现Hook过程" class="headerlink" title="使用Angr实现Hook过程"></a>使用Angr实现Hook过程</h2><h3 id="1-确定要Hook函数的调用地址"><a href="#1-确定要Hook函数的调用地址" class="headerlink" title="1. 确定要Hook函数的调用地址"></a>1. 确定要Hook函数的<strong>调用地址</strong></h3><p>我们的目标是替换掉check_equals_HXUITWOAPNESFFEG(), 并实现与其相同的功能, 所以要先知道在哪里调用了函数才能实现Hook</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">check_equals_called_address = <span class="number">0x080493CE</span></span><br></pre></td></tr></table></figure>

<h3 id="2-开始Hook-并保证Hook后程序能够正常运行"><a href="#2-开始Hook-并保证Hook后程序能够正常运行" class="headerlink" title="2. 开始Hook, 并保证Hook后程序能够正常运行"></a>2. 开始Hook, 并保证Hook后程序能够正常运行</h3><p>像是这道题, 如果我们不处理掉原本存在的call check_equals_HXUITWOAPNESFFEG的话, 仍会调用这个函数, 导致Angr不能解出题目, 所以我们还要把原本的call语句覆盖掉, 这个call指令长度为5字节.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  instruction_to_skip_length = <span class="number">5</span> <span class="comment"># call指令占5个字节, 下面清理参数栈的add指令占3字节</span></span><br><span class="line"><span class="meta">  @project.hook(<span class="params">check_equals_called_address, length=instruction_to_skip_length</span>)</span></span><br><span class="line"><span class="comment"># check_equals_called_address参数表示要Hook替换指令的起始地址</span></span><br><span class="line"><span class="comment"># length参数表示要Hook替换指令的指令长度</span></span><br></pre></td></tr></table></figure>

<h3 id="3-定义Hook函数"><a href="#3-定义Hook函数" class="headerlink" title="3. 定义Hook函数"></a>3. 定义Hook函数</h3><p>紧跟在Hook的下方</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">skip_check_equals_</span>(<span class="params">state</span>):</span></span><br><span class="line"></span><br><span class="line">  user_input_buffer_address = <span class="number">0x0804C044</span></span><br><span class="line">  user_input_buffer_length = <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">  user_input_string = state.memory.load(</span><br><span class="line">    user_input_buffer_address,</span><br><span class="line">    user_input_buffer_length</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  check_against_string = <span class="string">&quot;HXUITWOAPNESFFEG&quot;</span></span><br><span class="line"></span><br><span class="line">  state.regs.eax = claripy.If(</span><br><span class="line">    user_input_string == check_against_string, </span><br><span class="line">    claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), </span><br><span class="line">    claripy.BVV(<span class="number">0</span>, <span class="number">32</span>)</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<p>需要注意的是我们描述的是z3使用的方程, 所以不能直接使用if语句, 而是使用claripy内置的函数来表示if.</p>
<p>至此我们便完成了hook</p>
<h1 id="10-angr-simprocedures"><a href="#10-angr-simprocedures" class="headerlink" title="10_angr_simprocedures"></a>10_angr_simprocedures</h1><h2 id="编译并运行-7"><a href="#编译并运行-7" class="headerlink" title="编译并运行"></a>编译并运行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/10_angr_simprocedures$ python3 generate.py 12</span><br><span class="line">34 10_angr_simprocedures</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/10_angr_simprocedures$ ./10_angr_simprocedure</span><br><span class="line">s</span><br><span class="line">Enter the password: aaaaaaaaaaa</span><br><span class="line">Try again.</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/10_angr_simprocedures$</span><br></pre></td></tr></table></figure>

<h2 id="分析-10"><a href="#分析-10" class="headerlink" title="分析"></a>分析</h2><p>使用IDA分析</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0804932</span>A ; <span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function">.text:0804932A                 <span class="keyword">public</span> main</span></span><br><span class="line"><span class="function">.text:0804932A main            proc near               </span>; DATA XREF: _start+<span class="number">2</span>A↑o</span><br><span class="line">.text:<span class="number">0804932</span>A</span><br><span class="line">.text:<span class="number">0804932</span>A var_3C          = dword ptr <span class="number">-3</span>Ch</span><br><span class="line">.text:<span class="number">0804932</span>A var_2C          = dword ptr <span class="number">-2</span>Ch</span><br><span class="line">.text:<span class="number">0804932</span>A var_28          = dword ptr <span class="number">-28</span>h</span><br><span class="line">.text:<span class="number">0804932</span>A var_24          = dword ptr <span class="number">-24</span>h</span><br><span class="line">.text:<span class="number">0804932</span>A s               = byte ptr <span class="number">-1</span>Dh</span><br><span class="line">.text:<span class="number">0804932</span>A var_C           = dword ptr <span class="number">-0</span>Ch</span><br><span class="line">.text:<span class="number">0804932</span>A var_4           = dword ptr <span class="number">-4</span></span><br><span class="line">.text:<span class="number">0804932</span>A argc            = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">0804932</span>A argv            = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804932</span>A envp            = dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804932</span>A</span><br><span class="line">.text:<span class="number">0804932</span>A ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0804932</span>A                 endbr32</span><br><span class="line">.text:<span class="number">0804932</span>E                 lea     ecx, [esp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">08049332</span>                 <span class="keyword">and</span>     esp, <span class="number">0F</span>FFFFFF0h</span><br><span class="line">.text:<span class="number">08049335</span>                 push    dword ptr [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">08049338</span>                 push    ebp</span><br><span class="line">.text:<span class="number">08049339</span>                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">0804933B</span>                 push    ecx</span><br><span class="line">.text:<span class="number">0804933</span>C                 sub     esp, <span class="number">44</span>h</span><br><span class="line">.text:<span class="number">0804933F</span>                 mov     eax, ecx</span><br><span class="line">.text:<span class="number">08049341</span>                 mov     eax, [eax+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">08049344</span>                 mov     [ebp+var_3C], eax</span><br><span class="line">.text:<span class="number">08049347</span>                 mov     eax, large gs:<span class="number">14</span>h</span><br><span class="line">.text:<span class="number">0804934</span>D                 mov     [ebp+var_C], eax</span><br><span class="line">.text:<span class="number">08049350</span>                 <span class="keyword">xor</span>     eax, eax</span><br><span class="line">.text:<span class="number">08049352</span>                 mov     [ebp+var_24], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">08049359</span>                 mov     [ebp+var_2C], <span class="number">11</span>h</span><br><span class="line">.text:<span class="number">08049360</span>                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">08049363</span>                 push    <span class="number">10</span>h             ; n</span><br><span class="line">.text:<span class="number">08049365</span>                 push    offset aHxuitwoapnesff ; <span class="string">&quot;HXUITWOAPNESFFEG&quot;</span></span><br><span class="line">.text:<span class="number">0804936</span>A                 push    offset password ; dest</span><br><span class="line">.text:<span class="number">0804936F</span>                 call    _memcpy</span><br><span class="line">.text:<span class="number">08049374</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049377</span>                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">0804937</span>A                 push    <span class="number">11</span>h             ; n</span><br><span class="line">.text:<span class="number">0804937</span>C                 push    <span class="number">0</span>               ; c</span><br><span class="line">.text:<span class="number">0804937</span>E                 lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">08049381</span>                 push    eax             ; s</span><br><span class="line">.text:<span class="number">08049382</span>                 call    _memset</span><br><span class="line">.text:<span class="number">08049387</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804938</span>A                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">0804938</span>D                 push    offset aEnterThePasswo ; <span class="string">&quot;Enter the password: &quot;</span></span><br><span class="line">.text:<span class="number">08049392</span>                 call    _printf</span><br><span class="line">.text:<span class="number">08049397</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804939</span>A                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">0804939</span>D                 lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">080493</span>A0                 push    eax</span><br><span class="line">.text:<span class="number">080493</span>A1                 push    offset a16s     ; <span class="string">&quot;%16s&quot;</span></span><br><span class="line">.text:<span class="number">080493</span>A6                 call    ___isoc99_scanf</span><br><span class="line">.text:<span class="number">080493</span>AB                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493</span>AE                 mov     [ebp+var_28], <span class="number">0</span></span><br><span class="line">.text:<span class="number">080493B</span>5                 jmp     <span class="keyword">short</span> loc_80493EC</span><br><span class="line">.text:<span class="number">080493B</span>7 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">080493B</span>7</span><br><span class="line">.text:<span class="number">080493B</span>7 loc_80493B7:                            ; CODE XREF: main+C6↓j</span><br><span class="line">.text:<span class="number">080493B</span>7                 mov     eax, <span class="number">12</span>h</span><br><span class="line">.text:<span class="number">080493B</span>C                 sub     eax, [ebp+var_28]</span><br><span class="line">.text:<span class="number">080493B</span>F                 mov     edx, eax</span><br><span class="line">.text:<span class="number">080493</span>C1                 lea     ecx, [ebp+s]</span><br><span class="line">.text:<span class="number">080493</span>C4                 mov     eax, [ebp+var_28]</span><br><span class="line">.text:<span class="number">080493</span>C7                 add     eax, ecx</span><br><span class="line">.text:<span class="number">080493</span>C9                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">080493</span>CC                 movsx   eax, al</span><br><span class="line">.text:<span class="number">080493</span>CF                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080493</span>D2                 push    edx</span><br><span class="line">.text:<span class="number">080493</span>D3                 push    eax</span><br><span class="line">.text:<span class="number">080493</span>D4                 call    complex_function</span><br><span class="line">.text:<span class="number">080493</span>D9                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493</span>DC                 mov     ecx, eax</span><br><span class="line">.text:<span class="number">080493</span>DE                 lea     edx, [ebp+s]</span><br><span class="line">.text:<span class="number">080493E1</span>                 mov     eax, [ebp+var_28]</span><br><span class="line">.text:<span class="number">080493E4</span>                 add     eax, edx</span><br><span class="line">.text:<span class="number">080493E6</span>                 mov     [eax], cl</span><br><span class="line">.text:<span class="number">080493E8</span>                 add     [ebp+var_28], <span class="number">1</span></span><br><span class="line">.text:<span class="number">080493</span>EC</span><br><span class="line">.text:<span class="number">080493</span>EC loc_80493EC:                            ; CODE XREF: main+<span class="number">8B</span>↑j</span><br><span class="line">.text:<span class="number">080493</span>EC                 cmp     [ebp+var_28], <span class="number">0F</span>h</span><br><span class="line">.text:<span class="number">080493F</span>0                 jle     <span class="keyword">short</span> loc_80493B7</span><br><span class="line">.text:<span class="number">080493F</span>2                 cmp     [ebp+var_24], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">080493F</span>9                 jz      loc_804A532</span><br><span class="line">.text:<span class="number">080493F</span>F                 cmp     [ebp+var_24], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">08049406</span>                 jnz     loc_8049C9F</span><br><span class="line">.text:<span class="number">0804940</span>C                 cmp     [ebp+var_24], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">08049413</span>                 jnz     loc_804985C</span><br><span class="line">.text:<span class="number">08049419</span>                 cmp     [ebp+var_24], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">08049420</span>                 jz      loc_8049641</span><br><span class="line">.text:<span class="number">08049426</span>                 cmp     [ebp+var_24], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">0804942</span>D                 jnz     loc_804953A</span><br><span class="line">.text:<span class="number">08049433</span>                 cmp     [ebp+var_24], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">0804943</span>A                 jz      <span class="keyword">short</span> loc_80494BB</span><br><span class="line">.text:<span class="number">0804943</span>C                 cmp     [ebp+var_24], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">08049443</span>                 jz      <span class="keyword">short</span> loc_8049480</span><br><span class="line">.text:<span class="number">08049445</span>                 cmp     [ebp+var_24], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">0804944</span>C                 jz      <span class="keyword">short</span> loc_8049467</span><br><span class="line">.text:<span class="number">0804944</span>E                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">08049451</span>                 push    <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049453</span>                 lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">08049456</span>                 push    eax</span><br><span class="line">.text:<span class="number">08049457</span>                 call    check_equals_HXUITWOAPNESFFEG</span><br><span class="line">.text:<span class="number">0804945</span>C                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804945F</span>                 mov     [ebp+var_2C], eax</span><br><span class="line">.text:<span class="number">08049462</span>                 jmp     loc_804B654</span><br><span class="line">.text:<span class="number">08049467</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049467</span></span><br><span class="line">.text:<span class="number">08049467</span> loc_8049467:                            ; CODE XREF: main+<span class="number">122</span>↑j</span><br><span class="line">.text:<span class="number">08049467</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">0804946</span>A                 push    <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804946</span>C                 lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">0804946F</span>                 push    eax</span><br><span class="line">.text:<span class="number">08049470</span>                 call    check_equals_HXUITWOAPNESFFEG</span><br><span class="line">.text:<span class="number">08049475</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049478</span>                 mov     [ebp+var_2C], eax</span><br><span class="line">.text:<span class="number">0804947B</span>                 jmp     loc_804B654</span><br><span class="line">.text:<span class="number">08049480</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049480</span></span><br><span class="line">.text:<span class="number">08049480</span> loc_8049480:                            ; CODE XREF: main+<span class="number">119</span>↑j</span><br><span class="line">.text:<span class="number">08049480</span>                 cmp     [ebp+var_24], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">08049487</span>                 jnz     <span class="keyword">short</span> loc_80494A2</span><br><span class="line">.text:<span class="number">08049489</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">0804948</span>C                 push    <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804948</span>E                 lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">08049491</span>                 push    eax</span><br><span class="line">.text:<span class="number">08049492</span>                 call    check_equals_HXUITWOAPNESFFEG</span><br><span class="line">.text:<span class="number">08049497</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804949</span>A                 mov     [ebp+var_2C], eax</span><br><span class="line">.text:<span class="number">0804949</span>D                 jmp     loc_804B654</span><br><span class="line">.text:<span class="number">080494</span>A2 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">080494</span>A2</span><br><span class="line">.text:<span class="number">080494</span>A2 loc_80494A2:                            ; CODE XREF: main+<span class="number">15</span>D↑j</span><br><span class="line">.text:<span class="number">080494</span>A2                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080494</span>A5                 push    <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080494</span>A7                 lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">080494</span>AA                 push    eax</span><br><span class="line">.text:<span class="number">080494</span>AB                 call    check_equals_HXUITWOAPNESFFEG</span><br><span class="line">.text:<span class="number">080494B</span>0                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080494B</span>3                 mov     [ebp+var_2C], eax</span><br><span class="line">.text:<span class="number">080494B</span>6                 jmp     loc_804B654</span><br><span class="line">.text:<span class="number">080494B</span>B ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">080494B</span>B</span><br><span class="line">.text:<span class="number">080494B</span>B loc_80494BB:                            ; CODE XREF: main+<span class="number">110</span>↑j</span><br><span class="line">.text:<span class="number">080494B</span>B                 cmp     [ebp+var_24], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">080494</span>C2                 jnz     <span class="keyword">short</span> loc_80494FF</span><br><span class="line">.text:<span class="number">080494</span>C4                 cmp     [ebp+var_24], <span class="number">0</span>DEADBEEFh</span><br><span class="line">.text:<span class="number">080494</span>CB                 jz      <span class="keyword">short</span> loc_80494E6</span><br><span class="line">.text:<span class="number">080494</span>CD                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080494</span>D0                 push    <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080494</span>D2                 lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">080494</span>D5                 push    eax</span><br><span class="line">.text:<span class="number">080494</span>D6                 call    check_equals_HXUITWOAPNESFFEG</span><br><span class="line">.text:<span class="number">080494</span>DB                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080494</span>DE                 mov     [ebp+var_2C], eax</span><br><span class="line">.text:<span class="number">080494E1</span>                 jmp     loc_804B654</span><br><span class="line">.text:<span class="number">080494E6</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">080494E6</span></span><br><span class="line">.text:<span class="number">080494E6</span> loc_80494E6:                            ; CODE XREF: main+<span class="number">1</span>A1↑j</span><br><span class="line">.text:<span class="number">080494E6</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">080494E9</span>                 push    <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080494</span>EB                 lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">080494</span>EE                 push    eax</span><br><span class="line">.text:<span class="number">080494</span>EF                 call    check_equals_HXUITWOAPNESFFEG</span><br><span class="line">.text:<span class="number">080494F</span>4                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080494F</span>7                 mov     [ebp+var_2C], eax</span><br><span class="line">.text:<span class="number">080494F</span>A                 jmp     loc_804B654</span><br><span class="line">.text:<span class="number">080494F</span>F ; ---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<p>这一关跟上一关不一样的地方在于使用了非常多的check_equals_HXUITWOAPNESFFEG()函数, 大部分都是无用的代码, 但是能够加大我们Hook的难度, 我们的思路要从函数调用处Hook转换到在函数本身进行Hook才能提高效率, 而Angr提供了这样的功能</p>
<h2 id="使用Angr解题-9"><a href="#使用Angr解题-9" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><h3 id="代码-8"><a href="#代码-8" class="headerlink" title="代码"></a>代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This challenge is similar to the previous one. It operates under the same</span></span><br><span class="line"><span class="comment"># premise that you will have to replace the check_equals_ function. In this</span></span><br><span class="line"><span class="comment"># case, however, check_equals_ is called so many times that it wouldn&#x27;t make</span></span><br><span class="line"><span class="comment"># sense to hook where each one was called. Instead, use a SimProcedure to write</span></span><br><span class="line"><span class="comment"># your own check_equals_ implementation and then hook the check_equals_ symbol</span></span><br><span class="line"><span class="comment"># to replace all calls to scanf with a call to your SimProcedure.</span></span><br><span class="line"><span class="comment"># 本次挑战与上一次类似, 你必须替换掉check_equals_HXUITWOAPNESFFEG()它才能正常运行</span></span><br><span class="line"><span class="comment"># 但是, 在这一关中这个函数被调用非常多次, 以至于对每个调用的位置进行Hook是非常低效且无意义的</span></span><br><span class="line"><span class="comment"># 但是如果使用SimProcedure模拟管理器编写你自己的check函数实现, 然后Hook挂钩到check_equals_HXUITWOAPNESFFEG()符号</span></span><br><span class="line"><span class="comment"># 从而实现对所有输入的检查替换为对SimProcedure的调用</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># You may be thinking:</span></span><br><span class="line"><span class="comment">#   Why can&#x27;t I just use hooks? The function is called many times, but if I hook</span></span><br><span class="line"><span class="comment">#   the address of the function itself (rather than the addresses where it is</span></span><br><span class="line"><span class="comment">#   called), I can replace its behavior everywhere. Furthermore, I can get the</span></span><br><span class="line"><span class="comment">#   parameters by reading them off the stack (with memory.load(regs.esp + xx)),</span></span><br><span class="line"><span class="comment">#   and return a value by simply setting eax! Since I know the length of the</span></span><br><span class="line"><span class="comment">#   function in bytes, I can return from the hook just before the &#x27;ret&#x27;</span></span><br><span class="line"><span class="comment">#   instruction is called, which will allow the program to jump back to where it</span></span><br><span class="line"><span class="comment">#   was before it called my hook.</span></span><br><span class="line"><span class="comment"># If you thought that, then congratulations! You have just invented the idea of</span></span><br><span class="line"><span class="comment"># SimProcedures! Instead of doing all of that by hand, you can let the already-</span></span><br><span class="line"><span class="comment"># implemented SimProcedures do the boring work for you so that you can focus on</span></span><br><span class="line"><span class="comment"># writing a replacement function in a Pythonic way.</span></span><br><span class="line"><span class="comment"># As a bonus, SimProcedures allow you to specify custom calling conventions, but</span></span><br><span class="line"><span class="comment"># unfortunately it is not covered in this CTF.</span></span><br><span class="line"><span class="comment"># 你可能会想:</span></span><br><span class="line"><span class="comment"># 为什么我不能只使用Hook, 该函数被多次调用, 我们直接Hook函数本身即可</span></span><br><span class="line"><span class="comment"># 但是这个原理其实就是上面SimProcedure的想法, 只是SimProcedure替你解决大部分细节的实现, 让这个想法的实现变得更加简单</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  <span class="comment"># 建立Angr项目</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 由于使用的是scanf默认的输入, 所以可以使用默认方式从main开始进行符号执行</span></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Define a class that inherits angr.SimProcedure in order to take advantage</span></span><br><span class="line">  <span class="comment"># of Angr&#x27;s SimProcedures.</span></span><br><span class="line">  <span class="comment"># 定义一个继承angr.SimProcedure的类, 以便使用Angr的SimProcedures</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ReplacementCheckEquals</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line">    <span class="comment"># A SimProcedure replaces a function in the binary with a simulated one</span></span><br><span class="line">    <span class="comment"># written in Python. Other than it being written in Python, the function</span></span><br><span class="line">    <span class="comment"># acts largely the same as any function written in C. Any parameter after</span></span><br><span class="line">    <span class="comment"># &#x27;self&#x27; will be treated as a parameter to the function you are replacing.</span></span><br><span class="line">    <span class="comment"># The parameters will be bitvectors. Additionally, the Python can return in</span></span><br><span class="line">    <span class="comment"># the ususal Pythonic way. Angr will treat this in the same way it would</span></span><br><span class="line">    <span class="comment"># treat a native function in the binary returning. An example:</span></span><br><span class="line">    <span class="comment"># SimProcedure用Python编写的模拟函数替换二进制文件中的函数.</span></span><br><span class="line">    <span class="comment"># 除了它是用Python编写的之外, 该函数的行为与任何使用C编写的函数基本相同.</span></span><br><span class="line">    <span class="comment"># &quot;self&quot;之后的任何参数都将被视为您要替换的函数的参数, 参数将是位向量</span></span><br><span class="line">    <span class="comment"># 此外, Python可以以通常的Pythonic方式返回.</span></span><br><span class="line">    <span class="comment"># Angr将像对待二进制返回中的本机函数一样对待它, 下面是一个例子</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># int add_if_positive(int a, int b) &#123;</span></span><br><span class="line">    <span class="comment">#   if (a &gt;= 0 &amp;&amp; b &gt;= 0) return a + b;</span></span><br><span class="line">    <span class="comment">#   else return 0;</span></span><br><span class="line">    <span class="comment"># &#125;</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># could be simulated with...</span></span><br><span class="line">    <span class="comment"># 可以被模拟成</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># class ReplacementAddIfPositive(angr.SimProcedure):</span></span><br><span class="line">    <span class="comment">#   def run(self, a, b):</span></span><br><span class="line">    <span class="comment">#     if a &gt;= 0 and b &gt;=0:</span></span><br><span class="line">    <span class="comment">#       return a + b</span></span><br><span class="line">    <span class="comment">#     else:</span></span><br><span class="line">    <span class="comment">#       return 0</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Finish the parameters to the check_equals_ function. Reminder:</span></span><br><span class="line">    <span class="comment"># int check_equals_AABBCCDDEEFFGGHH(char* to_check, int length) &#123; ...</span></span><br><span class="line">    <span class="comment"># 完成check_equals_HXUITWOAPNESFFEG(), 提示: int check_equals_XXXXXXXXXXXXXXXX(char* to_check, int length)&#123;&#125;</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, to_check, <span class="built_in">len</span></span>):</span></span><br><span class="line">      <span class="comment"># We can almost copy and paste the solution from the previous challenge.</span></span><br><span class="line">      <span class="comment"># Hint: Don&#x27;t look up the address! It&#x27;s passed as a parameter.</span></span><br><span class="line">      <span class="comment"># 我们几乎可以复制上一关的解决方案</span></span><br><span class="line">      <span class="comment"># 提示: 不要查地址, 它作为参数传递</span></span><br><span class="line">      <span class="comment"># (!)</span></span><br><span class="line">      user_input_buffer_address = to_check</span><br><span class="line">      user_input_buffer_length = <span class="built_in">len</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Note the use of self.state to find the state of the system in a </span></span><br><span class="line">      <span class="comment"># SimProcedure.</span></span><br><span class="line">      <span class="comment"># 注意使用self.state在SimProcedure中查找系统状态</span></span><br><span class="line">      user_input_string = self.state.memory.load(</span><br><span class="line">        user_input_buffer_address,</span><br><span class="line">        user_input_buffer_length</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      check_against_string = <span class="string">&quot;HXUITWOAPNESFFEG&quot;</span></span><br><span class="line">    </span><br><span class="line">      <span class="comment"># Finally, instead of setting eax, we can use a Pythonic return statement</span></span><br><span class="line">      <span class="comment"># to return the output of this function. </span></span><br><span class="line">      <span class="comment"># Hint: Look at the previous solution.</span></span><br><span class="line">      <span class="keyword">return</span> claripy.If(user_input_string == check_against_string, claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), claripy.BVV(<span class="number">0</span>, <span class="number">32</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Hook the check_equals symbol. Angr automatically looks up the address </span></span><br><span class="line">  <span class="comment"># associated with the symbol. Alternatively, you can use &#x27;hook&#x27; instead</span></span><br><span class="line">  <span class="comment"># of &#x27;hook_symbol&#x27; and specify the address of the function. To find the </span></span><br><span class="line">  <span class="comment"># correct symbol, disassemble the binary.</span></span><br><span class="line">  <span class="comment"># Hook check_equals_HXUITWOAPNESFFEG()的符号. Angr自动查找与符号相关联的地址.</span></span><br><span class="line">  <span class="comment"># 或者, 你可以使用&quot;hook&quot;而不是&quot;hook_symbol&quot;并指定函数的地址</span></span><br><span class="line">  <span class="comment"># 要找到正确的符号, 请反汇编二进制文件</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  check_equals_symbol = <span class="string">&quot;check_equals_HXUITWOAPNESFFEG&quot;</span> <span class="comment"># :string</span></span><br><span class="line">  project.hook_symbol(check_equals_symbol, ReplacementCheckEquals())</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 创建模拟管理器</span></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution = solution_state.posix.dumps(sys.stdin.fileno())</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后的代码-5"><a href="#去掉注释后的代码-5" class="headerlink" title="去掉注释后的代码"></a>去掉注释后的代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ReplacementCheckEquals</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, to_check, <span class="built_in">len</span></span>):</span></span><br><span class="line">      user_input_buffer_address = to_check</span><br><span class="line">      user_input_buffer_length = <span class="built_in">len</span></span><br><span class="line"></span><br><span class="line">      user_input_string = self.state.memory.load(</span><br><span class="line">        user_input_buffer_address,</span><br><span class="line">        user_input_buffer_length</span><br><span class="line">      )</span><br><span class="line"></span><br><span class="line">      check_against_string = <span class="string">&quot;HXUITWOAPNESFFEG&quot;</span></span><br><span class="line">  </span><br><span class="line">      <span class="keyword">return</span> claripy.If(user_input_string == check_against_string, claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), claripy.BVV(<span class="number">0</span>, <span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">  check_equals_symbol = <span class="string">&quot;check_equals_HXUITWOAPNESFFEG&quot;</span></span><br><span class="line">  project.hook_symbol(check_equals_symbol, ReplacementCheckEquals())</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution = solution_state.posix.dumps(sys.stdin.fileno())</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="使用Angr实现Hook函数的过程"><a href="#使用Angr实现Hook函数的过程" class="headerlink" title="使用Angr实现Hook函数的过程"></a>使用Angr实现Hook函数的过程</h2><h3 id="1-定义一个继承angr-SimProcedure的类-以此使用SimProcedure"><a href="#1-定义一个继承angr-SimProcedure的类-以此使用SimProcedure" class="headerlink" title="1. 定义一个继承angr.SimProcedure的类, 以此使用SimProcedure"></a>1. 定义一个继承angr.SimProcedure的类, 以此使用SimProcedure</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReplacementCheckEquals</span>(<span class="params">angr.SimProcedure</span>):</span></span><br></pre></td></tr></table></figure>

<h3 id="2-定义我们自己的Hook函数"><a href="#2-定义我们自己的Hook函数" class="headerlink" title="2. 定义我们自己的Hook函数"></a>2. 定义我们自己的Hook函数</h3><p>注意缩进, 函数定义包含在类中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, to_check, <span class="built_in">len</span></span>):</span></span><br><span class="line">  user_input_buffer_address = to_check</span><br><span class="line">  user_input_buffer_length = <span class="built_in">len</span></span><br><span class="line"></span><br><span class="line">  user_input_string = self.state.memory.load(</span><br><span class="line">    user_input_buffer_address,</span><br><span class="line">    user_input_buffer_length</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  check_against_string = <span class="string">&quot;HXUITWOAPNESFFEG&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> claripy.If(user_input_string == check_against_string, claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), claripy.BVV(<span class="number">0</span>, <span class="number">32</span>))</span><br></pre></td></tr></table></figure>

<p>注意第一个self后面才是实际程序中传入的参数</p>
<p>我们从传入的参数中得到了用户输入的地址, 并读取相应的内容(这个内容是符号内容, 因为是默认符号执行)</p>
<p>然后使用claripy定义的if模拟原本函数的逻辑</p>
<h3 id="3-执行Hook函数"><a href="#3-执行Hook函数" class="headerlink" title="3. 执行Hook函数"></a>3. 执行Hook函数</h3><p>定义完Hook函数了, 就可以开始使用这个Hook函数替换原本的函数了</p>
<p>Angr提供的功能非常强大, 你只需要知道符号名, Angr就会自动查找到相应的位置进行Hook.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">check_equals_symbol = <span class="string">&quot;check_equals_HXUITWOAPNESFFEG&quot;</span></span><br><span class="line">project.hook_symbol(check_equals_symbol, ReplacementCheckEquals())</span><br></pre></td></tr></table></figure>

<h1 id="11-angr-sim-scanf"><a href="#11-angr-sim-scanf" class="headerlink" title="11_angr_sim_scanf"></a>11_angr_sim_scanf</h1><h2 id="编译并运行-8"><a href="#编译并运行-8" class="headerlink" title="编译并运行"></a>编译并运行</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/11_angr_sim_scanf$ python3 generate.py <span class="number">1234</span> <span class="number">1</span></span><br><span class="line">1_angr_sim_scanf</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/11_angr_sim_scanf$ ./11_angr_sim_scanf</span><br><span class="line">Enter the password: aaaaaaaaaaaaaaaa</span><br><span class="line">Try again.</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/11_angr_sim_scanf$</span><br></pre></td></tr></table></figure>

<h2 id="分析-11"><a href="#分析-11" class="headerlink" title="分析"></a>分析</h2><p>使用IDA分析</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> __cdecl main(<span class="built_in">int</span> argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">int</span> i; // [esp+20h] [ebp-28h]</span><br><span class="line">  char s[<span class="number">20</span>]; // [esp+28h] [ebp-20h] BYREF</span><br><span class="line">  unsigned <span class="built_in">int</span> v7; // [esp+3Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v7 = __readgsdword(0x14u);</span><br><span class="line">  memset(s, <span class="number">0</span>, sizeof(s));</span><br><span class="line">  qmemcpy(s, <span class="string">&quot;HXUITWOA&quot;</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">    s[i] = complex_function(s[i], i);           // 对参考数据进行加密</span><br><span class="line">  printf(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u %u&quot;</span>, buffer0, buffer1);    // 输入的格式是无符号整数</span><br><span class="line">  <span class="keyword">if</span> ( !strncmp(buffer0, s, 4u) &amp;&amp; !strncmp(buffer1, &amp;s[<span class="number">4</span>], 4u) )</span><br><span class="line">    puts(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    puts(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这一关scanf有两个输入, 之前我们是在后面注入符号, 在这一关我们Hook掉scanf()函数</p>
<h2 id="使用Angr解题-10"><a href="#使用Angr解题-10" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><h3 id="代码-9"><a href="#代码-9" class="headerlink" title="代码"></a>代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This time, the solution involves simply replacing scanf with our own version,</span></span><br><span class="line"><span class="comment"># since Angr does not support requesting multiple parameters with scanf.</span></span><br><span class="line"><span class="comment"># 这一次, 通关方法是将scanf替换为我们自己的版本, 因为Angr 不支持scanf输入多个参数</span></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  <span class="comment"># 建立Angr项目</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 默认执行起始状态, 从main开始</span></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># 这一次我们用的是上一关的Hook, 不过Hook掉的是scanf函数</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ReplacementScanf</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line">    <span class="comment"># Finish the parameters to the scanf function. Hint: &#x27;scanf(&quot;%u %u&quot;, ...)&#x27;.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, format_string, scanf0_address, scanf1_address</span>):</span></span><br><span class="line">      <span class="comment"># Hint: scanf0_address is passed as a parameter, isn&#x27;t it?</span></span><br><span class="line">      scanf_data_len = <span class="number">4</span> * <span class="number">8</span></span><br><span class="line">      scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>, scanf_data_len)<span class="comment">#一个无符号整型长度为4字节, 32位</span></span><br><span class="line">      scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>, scanf_data_len)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># The scanf function writes user input to the buffers to which the </span></span><br><span class="line">      <span class="comment"># parameters point.</span></span><br><span class="line">      <span class="comment"># scanf函数将用户输入写入参数指向的缓冲区</span></span><br><span class="line">      <span class="comment"># 就是将我们创建的符号位向量载入我们变量的位置, 变量的位置通过参数获得</span></span><br><span class="line">      self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)</span><br><span class="line">      self.state.memory.store(scanf1_address, scanf1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Now, we want to &#x27;set aside&#x27; references to our symbolic values in the</span></span><br><span class="line">      <span class="comment"># globals plugin included by default with a state. You will need to</span></span><br><span class="line">      <span class="comment"># store multiple bitvectors. You can either use a list, tuple, or multiple</span></span><br><span class="line">      <span class="comment"># keys to reference the different bitvectors.</span></span><br><span class="line">      <span class="comment"># 现在, 我们要在默认情况下包含在状态中的globals插件</span></span><br><span class="line">      <span class="comment"># (!)</span></span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>] = scanf0</span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>] = scanf1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  scanf_symbol = <span class="string">&quot;__isoc99_scanf&quot;</span></span><br><span class="line">  project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Grab whatever you set aside in the globals dict.</span></span><br><span class="line">    <span class="comment"># 获取你在globals dict中放置的东西</span></span><br><span class="line">    stored_solutions0 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>]</span><br><span class="line">    stored_solutions1 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>]</span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(stored_solutions0)</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(stored_solutions1)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution0)</span><br><span class="line">    <span class="built_in">print</span>(solution1)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后的代码-6"><a href="#去掉注释后的代码-6" class="headerlink" title="去掉注释后的代码"></a>去掉注释后的代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ReplacementScanf</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, format_string, scanf0_address, scanf1_address</span>):</span></span><br><span class="line">      scanf_data_len = <span class="number">4</span> * <span class="number">8</span></span><br><span class="line">      scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>, scanf_data_len)</span><br><span class="line">      scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>, scanf_data_len)</span><br><span class="line"></span><br><span class="line">      self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)</span><br><span class="line">      self.state.memory.store(scanf1_address, scanf1, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>] = scanf0</span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>] = scanf1</span><br><span class="line"></span><br><span class="line">  scanf_symbol = <span class="string">&quot;__isoc99_scanf&quot;</span></span><br><span class="line">  project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">    stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful, avoid=should_abort)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    stored_solutions0 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>]</span><br><span class="line">    stored_solutions1 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>]</span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(stored_solutions0)</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(stored_solutions1)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(solution0)</span><br><span class="line">    <span class="built_in">print</span>(solution1)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Hook流程"><a href="#Hook流程" class="headerlink" title="Hook流程"></a>Hook流程</h2><p>整体的hook流程跟上一个关卡差不多, 但是这里多了一个对globals的存取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#存入globals中</span></span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>] = scanf0</span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>] = scanf1</span><br><span class="line"><span class="comment">#从globals中取出</span></span><br><span class="line">    stored_solutions0 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>]</span><br><span class="line">    stored_solutions1 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="存入"><a href="#存入" class="headerlink" title="存入"></a>存入</h3><p>首先我们要知道存入的对象是谁, scanf0和scanf1是我们创建的符号位向量</p>
<p>但是这两个符号都是在对象声明, 但是我们最终对这两个符号进行约束是在对象外部的, 而两个符号对于外部是不可见的, 所以我们需要一个全局的变量对这两个符号进行存储, 以便在外部能对其进行约束.</p>
<h3 id="取出并约束"><a href="#取出并约束" class="headerlink" title="取出并约束"></a>取出并约束</h3><p>取出后进行约束, 还是跟前面的关卡一样使用eval进行约束, 最终得到答案</p>
<h1 id="12-angr-veritesting"><a href="#12-angr-veritesting" class="headerlink" title="12_angr_veritesting"></a>12_angr_veritesting</h1><h2 id="编译并运行-9"><a href="#编译并运行-9" class="headerlink" title="编译并运行"></a>编译并运行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/12_angr_veritesting$ python3 generate.py 1234 12_angr_veritesting</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/12_angr_veritesting$ ./12_angr_veritesting</span><br><span class="line">Enter the password: aaaaaaaaaaaaaaaa</span><br><span class="line">Try again.</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/12_angr_veritesting$</span><br></pre></td></tr></table></figure>

<h2 id="分析-12"><a href="#分析-12" class="headerlink" title="分析"></a>分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">080492B</span>8 ; <span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function">.text:080492B8                 <span class="keyword">public</span> main</span></span><br><span class="line"><span class="function">.text:080492B8 main            proc near               </span>; DATA XREF: _start+<span class="number">2</span>A↑o</span><br><span class="line">.text:<span class="number">080492B</span>8</span><br><span class="line">.text:<span class="number">080492B</span>8 var_4C          = dword ptr <span class="number">-4</span>Ch</span><br><span class="line">.text:<span class="number">080492B</span>8 var_3C          = dword ptr <span class="number">-3</span>Ch</span><br><span class="line">.text:<span class="number">080492B</span>8 var_38          = dword ptr <span class="number">-38</span>h</span><br><span class="line">.text:<span class="number">080492B</span>8 var_34          = dword ptr <span class="number">-34</span>h</span><br><span class="line">.text:<span class="number">080492B</span>8 s               = byte ptr <span class="number">-2</span>Dh</span><br><span class="line">.text:<span class="number">080492B</span>8 var_C           = dword ptr <span class="number">-0</span>Ch</span><br><span class="line">.text:<span class="number">080492B</span>8 anonymous_0     = dword ptr <span class="number">-8</span></span><br><span class="line">.text:<span class="number">080492B</span>8 argc            = dword ptr  <span class="number">8</span></span><br><span class="line">.text:<span class="number">080492B</span>8 argv            = dword ptr  <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080492B</span>8 envp            = dword ptr  <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080492B</span>8</span><br><span class="line">.text:<span class="number">080492B</span>8 ; __unwind &#123;</span><br><span class="line">.text:<span class="number">080492B</span>8                 endbr32</span><br><span class="line">.text:<span class="number">080492B</span>C                 lea     ecx, [esp+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">080492</span>C0                 <span class="keyword">and</span>     esp, <span class="number">0F</span>FFFFFF0h</span><br><span class="line">.text:<span class="number">080492</span>C3                 push    dword ptr [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">080492</span>C6                 push    ebp</span><br><span class="line">.text:<span class="number">080492</span>C7                 mov     ebp, esp</span><br><span class="line">.text:<span class="number">080492</span>C9                 push    ebx</span><br><span class="line">.text:<span class="number">080492</span>CA                 push    ecx</span><br><span class="line">.text:<span class="number">080492</span>CB                 sub     esp, <span class="number">50</span>h</span><br><span class="line">.text:<span class="number">080492</span>CE                 mov     eax, ecx</span><br><span class="line">.text:<span class="number">080492</span>D0                 mov     eax, [eax+<span class="number">4</span>]</span><br><span class="line">.text:<span class="number">080492</span>D3                 mov     [ebp+var_4C], eax</span><br><span class="line">.text:<span class="number">080492</span>D6                 mov     eax, large gs:<span class="number">14</span>h</span><br><span class="line">.text:<span class="number">080492</span>DC                 mov     [ebp+var_C], eax</span><br><span class="line">.text:<span class="number">080492</span>DF                 <span class="keyword">xor</span>     eax, eax</span><br><span class="line">.text:<span class="number">080492E1</span>                 sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">080492E4</span>                 push    <span class="number">21</span>h ; <span class="string">&#x27;!&#x27;</span>       ; n</span><br><span class="line">.text:<span class="number">080492E6</span>                 push    <span class="number">0</span>               ; c</span><br><span class="line">.text:<span class="number">080492E8</span>                 lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">080492</span>EB                 push    eax             ; s</span><br><span class="line">.text:<span class="number">080492</span>EC                 call    _memset</span><br><span class="line">.text:<span class="number">080492F</span>1                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080492F</span>4                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">080492F</span>7                 push    offset aEnterThePasswo ; <span class="string">&quot;Enter the password: &quot;</span></span><br><span class="line">.text:<span class="number">080492F</span>C                 call    _printf</span><br><span class="line">.text:<span class="number">08049301</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049304</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">08049307</span>                 lea     eax, [ebp+s]</span><br><span class="line">.text:<span class="number">0804930</span>A                 push    eax</span><br><span class="line">.text:<span class="number">0804930B</span>                 push    offset a32s     ; <span class="string">&quot;%32s&quot;</span></span><br><span class="line">.text:<span class="number">08049310</span>                 call    ___isoc99_scanf</span><br><span class="line">.text:<span class="number">08049315</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049318</span>                 mov     [ebp+var_3C], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0804931F</span>                 mov     [ebp+var_34], <span class="number">0</span></span><br><span class="line">.text:<span class="number">08049326</span>                 mov     [ebp+var_38], <span class="number">0</span></span><br><span class="line">.text:<span class="number">0804932</span>D                 jmp     <span class="keyword">short</span> loc_804935F</span><br><span class="line">.text:<span class="number">0804932F</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">0804932F</span></span><br><span class="line">.text:<span class="number">0804932F</span> loc_804932F:                            ; CODE XREF: main+AB↓j</span><br><span class="line">.text:<span class="number">0804932F</span>                 lea     edx, [ebp+s]</span><br><span class="line">.text:<span class="number">08049332</span>                 mov     eax, [ebp+var_38]</span><br><span class="line">.text:<span class="number">08049335</span>                 add     eax, edx</span><br><span class="line">.text:<span class="number">08049337</span>                 movzx   eax, byte ptr [eax]</span><br><span class="line">.text:<span class="number">0804933</span>A                 movsx   ebx, al</span><br><span class="line">.text:<span class="number">0804933</span>D                 mov     eax, [ebp+var_38]</span><br><span class="line">.text:<span class="number">08049340</span>                 add     eax, <span class="number">85</span>h</span><br><span class="line">.text:<span class="number">08049345</span>                 sub     esp, <span class="number">8</span></span><br><span class="line">.text:<span class="number">08049348</span>                 push    eax</span><br><span class="line">.text:<span class="number">08049349</span>                 push    <span class="number">48</span>h ; <span class="string">&#x27;H&#x27;</span></span><br><span class="line">.text:<span class="number">0804934B</span>                 call    complex_function</span><br><span class="line">.text:<span class="number">08049350</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049353</span>                 cmp     ebx, eax</span><br><span class="line">.text:<span class="number">08049355</span>                 jnz     <span class="keyword">short</span> loc_804935B</span><br><span class="line">.text:<span class="number">08049357</span>                 add     [ebp+var_3C], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0804935B</span></span><br><span class="line">.text:<span class="number">0804935B</span> loc_804935B:                            ; CODE XREF: main+<span class="number">9</span>D↑j</span><br><span class="line">.text:<span class="number">0804935B</span>                 add     [ebp+var_38], <span class="number">1</span></span><br><span class="line">.text:<span class="number">0804935F</span></span><br><span class="line">.text:<span class="number">0804935F</span> loc_804935F:                            ; CODE XREF: main+<span class="number">75</span>↑j</span><br><span class="line">.text:<span class="number">0804935F</span>                 cmp     [ebp+var_38], <span class="number">1F</span>h</span><br><span class="line">.text:<span class="number">08049363</span>                 jle     <span class="keyword">short</span> loc_804932F</span><br><span class="line">.text:<span class="number">08049365</span>                 cmp     [ebp+var_3C], <span class="number">20</span>h ; <span class="string">&#x27; &#x27;</span></span><br><span class="line">.text:<span class="number">08049369</span>                 jnz     <span class="keyword">short</span> loc_8049385</span><br><span class="line">.text:<span class="number">0804936B</span>                 movzx   eax, byte ptr [ebp+var_C]</span><br><span class="line">.text:<span class="number">0804936F</span>                 test    al, al</span><br><span class="line">.text:<span class="number">08049371</span>                 jnz     <span class="keyword">short</span> loc_8049385</span><br><span class="line">.text:<span class="number">08049373</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049376</span>                 push    offset aGoodJob ; <span class="string">&quot;Good Job.&quot;</span></span><br><span class="line">.text:<span class="number">0804937B</span>                 call    _puts</span><br><span class="line">.text:<span class="number">08049380</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049383</span>                 jmp     <span class="keyword">short</span> loc_8049395</span><br><span class="line">.text:<span class="number">08049385</span> ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">08049385</span></span><br><span class="line">.text:<span class="number">08049385</span> loc_8049385:                            ; CODE XREF: main+B1↑j</span><br><span class="line">.text:<span class="number">08049385</span>                                         ; main+B9↑j</span><br><span class="line">.text:<span class="number">08049385</span>                 sub     esp, <span class="number">0</span>Ch</span><br><span class="line">.text:<span class="number">08049388</span>                 push    offset s        ; <span class="string">&quot;Try again.&quot;</span></span><br><span class="line">.text:<span class="number">0804938</span>D                 call    _puts</span><br><span class="line">.text:<span class="number">08049392</span>                 add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">08049395</span></span><br><span class="line">.text:<span class="number">08049395</span> loc_8049395:                            ; CODE XREF: main+CB↑j</span><br><span class="line">.text:<span class="number">08049395</span>                 mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">0804939</span>A                 mov     ecx, [ebp+var_C]</span><br><span class="line">.text:<span class="number">0804939</span>D                 <span class="keyword">xor</span>     ecx, large gs:<span class="number">14</span>h</span><br><span class="line">.text:<span class="number">080493</span>A4                 jz      <span class="keyword">short</span> loc_80493AB</span><br><span class="line">.text:<span class="number">080493</span>A6                 call    ___stack_chk_fail</span><br><span class="line">.text:<span class="number">080493</span>AB ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">080493</span>AB</span><br><span class="line">.text:<span class="number">080493</span>AB loc_80493AB:                            ; CODE XREF: main+EC↑j</span><br><span class="line">.text:<span class="number">080493</span>AB                 lea     esp, [ebp<span class="number">-8</span>]</span><br><span class="line">.text:<span class="number">080493</span>AE                 pop     ecx</span><br><span class="line">.text:<span class="number">080493</span>AF                 pop     ebx</span><br><span class="line">.text:<span class="number">080493B</span>0                 pop     ebp</span><br><span class="line">.text:<span class="number">080493B</span>1                 lea     esp, [ecx<span class="number">-4</span>]</span><br><span class="line">.text:<span class="number">080493B</span>4                 retn</span><br><span class="line">.text:<span class="number">080493B</span>4 ; &#125; <span class="comment">// starts at 80492B8</span></span><br><span class="line">.text:<span class="number">080493B</span>4 main            endp</span><br><span class="line">.text:<span class="number">080493B</span>4</span><br><span class="line">.text:<span class="number">080493B</span>4 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">080493B</span>5                 align <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">080493</span>C0</span><br><span class="line">.text:<span class="number">080493</span>C0 ; =============== S U B R O U T I N E =======================================</span><br></pre></td></tr></table></figure>

<p>这道题有一个循环的if语句, 会导致路径爆炸, 但是与前面不同的是输入加密跟检验是同时进行的, 不想是之前单独用一个函数来检验了.这样会加大的Hook的难度.</p>
<h3 id="veritesting"><a href="#veritesting" class="headerlink" title="veritesting"></a>veritesting</h3><p>但是题目给了提示就是使用Veritesting, 百度一下可以知道这个方法就是解决路径爆炸的, 采用的是: 结合静态符号执行以及动态符号执行的方式.</p>
<p>什么是静态符号执行, 什么是动态符号执行</p>
<ul>
<li>动态符号执行: <strong>以具体数值作为输入</strong>来模拟执行程序代码, 启动代码模拟执行器, 并从当前路径的分支语句的为此中搜集所有符号约束. 然后修改该符号约束内容,构造出一条新的可行路径约束, 并用约束求解器求解出一个可行的新的具体输入, 然后进行新的一轮分析. 我简单的理解为走一步看一步.</li>
<li>静态符号执行: 使用的是抽象的符号代替具体值**(不是具体值)**, 在遇到分支语句是, 会探索每一个分支, 将分支条件加入到相应的路径约束中. 最终通过路径约束找出具体值.</li>
</ul>
<p>关于二者之间的区别, 用一个例子来讲会更便于理解:</p>
<ul>
<li>动态符号执行像是毛利小五郎, 他老是根据<strong>一个线索</strong>就随意指认一个嫌疑人是凶手(往往是错的), 然后这个嫌疑人就会向他解释并提供一个新的线索, 这样毛利小五郎就有<strong>两个线索</strong>了. 这时他在根据这两个线索武断另一个嫌疑人是凶手, 这样下一个嫌疑人也会解释自己不是凶手并提供第三个线索, 以此类推.虽然不能一下子就得到真正的凶手, 但<strong>至少能缩小凶手的范围</strong>.(只不过嫌疑人不再是经典三选一, 很可能是2^16个嫌疑人)</li>
<li>而静态符号执行像是柯南, 他会冷静的搜索每一个线索, 最终整理这些线索, 一下子就找到凶手.</li>
</ul>
<p>而Veritesting结合了二者: 先使用动态执行, 遇到简单的代码就切换到静态执行(不含系统调用, 简介跳转, 或难以精准推断的语句), 在静态模式下, 首先动态恢复控制流图, 找到静态执行容易分析的语句和难以分析的语句. 然后换回动态执行去处理静态不好解决的情况(复杂的情况用具体值来”猜测”会更好解决)</p>
<h2 id="使用Angr解题-11"><a href="#使用Angr解题-11" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><h3 id="代码-10"><a href="#代码-10" class="headerlink" title="代码"></a>代码</h3><p>直接用第一关的代码, 不同的是在创建模拟执行器的时候添加一个参数veritesting = True, <code>simulation = project.factory.simgr(initial_state, veritesting = True)</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># When you construct a simulation manager, you will want to enable Veritesting:</span></span><br><span class="line"><span class="comment"># project.factory.simgr(initial_state, veritesting=True)</span></span><br><span class="line"><span class="comment"># Hint: use one of the first few levels&#x27; solutions as a reference.</span></span><br><span class="line"><span class="comment"># 当你构建一个模拟管理器时, 你会想要启用Veritesting:</span></span><br><span class="line"><span class="comment"># 提示: 使用前面几个关卡的其中一个解决方案</span></span><br><span class="line"><span class="comment"># 这一道题有一个循环if, 来检验加密后的字符串, 这会导致路径指数级增长.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">    <span class="comment"># 建立Angr项目</span></span><br><span class="line">    file_path = argv[<span class="number">1</span>]</span><br><span class="line">    project = angr.Project(file_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 确定符号执行的起始状态, 只有一个参数, 正常进入main函数开始即可</span></span><br><span class="line">    initial_state = project.factory.entry_state(</span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY, </span><br><span class="line">                        angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    simulation = project.factory.simgr(initial_state, veritesting = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 暂且先试试直接符号执行, 因为有了Veritesting符号增强</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_false</span>(<span class="params">state</span>):</span></span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">    simulation.explore(find = is_successful, avoid = is_false)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后的代码-7"><a href="#去掉注释后的代码-7" class="headerlink" title="去掉注释后的代码"></a>去掉注释后的代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">    file_path = argv[<span class="number">1</span>]</span><br><span class="line">    project = angr.Project(file_path)</span><br><span class="line"></span><br><span class="line">    initial_state = project.factory.entry_state(</span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY, </span><br><span class="line">                        angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    simulation = project.factory.simgr(initial_state, veritesting = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_false</span>(<span class="params">state</span>):</span></span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">    simulation.explore(find = is_successful, avoid = is_false)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h1 id="13-angr-static-binary"><a href="#13-angr-static-binary" class="headerlink" title="13_angr_static_binary"></a>13_angr_static_binary</h1><h2 id="编译并运行-10"><a href="#编译并运行-10" class="headerlink" title="编译并运行"></a>编译并运行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/13_angr_static_binary$ python3 generate.py 1234 13_angr_static_binary</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/13_angr_static_binary$ ./13_angr_static_binary</span><br><span class="line">Enter the password: aaaaaaaaaaaaaaaa</span><br><span class="line">Try again.</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/13_angr_static_binary$</span><br></pre></td></tr></table></figure>

<h2 id="分析-13"><a href="#分析-13" class="headerlink" title="分析"></a>分析</h2><p>使用伪代码会更清楚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+1Ch] [ebp-3Ch]</span></span><br><span class="line">  <span class="keyword">int</span> j; <span class="comment">// [esp+20h] [ebp-38h]</span></span><br><span class="line">  <span class="keyword">char</span> v6[<span class="number">20</span>]; <span class="comment">// [esp+24h] [ebp-34h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> v7[<span class="number">20</span>]; <span class="comment">// [esp+38h] [ebp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v8; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">19</span>; ++i )</span><br><span class="line">    v7[i] = <span class="number">0</span>;</span><br><span class="line">  qmemcpy(v7, <span class="string">&quot;HXUITWOA&quot;</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%8s&quot;</span>, v6);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">7</span>; ++j )</span><br><span class="line">    v6[j] = complex_function(v6[j], j);</span><br><span class="line">  <span class="keyword">if</span> ( j_strcmp_ifunc(v6, v7) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>是一个正常的单个输入flag, 然后经过内置函数strcmp检验的程序</p>
<h2 id="使用Angr解题-12"><a href="#使用Angr解题-12" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><p>根据题目要求需要使用内置的<code>SimProceures</code>函数替换原本的一些库函数, 这样会让Angr的运行速度更快</p>
<h3 id="代码-11"><a href="#代码-11" class="headerlink" title="代码"></a>代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This challenge is the exact same as the first challenge, except that it was</span></span><br><span class="line"><span class="comment"># compiled as a static binary. Normally, Angr automatically replaces standard</span></span><br><span class="line"><span class="comment"># library functions with SimProcedures that work much more quickly.</span></span><br><span class="line"><span class="comment"># 这一关与第一关完全相同, 只是它被编译为静态二进制文件.</span></span><br><span class="line"><span class="comment"># 通常, Angr会自动将标准库函数替换为运行速度更快的SimProceures</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># To solve the challenge, manually hook any standard library c functions that</span></span><br><span class="line"><span class="comment"># are used. Then, ensure that you begin the execution at the beginning of the</span></span><br><span class="line"><span class="comment"># main function. Do not use entry_state.</span></span><br><span class="line"><span class="comment"># 要通过这一关, 手动Hook任何使用标准C函数. 然后确保在main函数的开头开始执行.</span></span><br><span class="line"><span class="comment"># 不要使用entry_state</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Here are a few SimProcedures Angr has already written for you. They implement</span></span><br><span class="line"><span class="comment"># standard library functions. You will not need all of them:</span></span><br><span class="line"><span class="comment"># 这里有一些Angr已经为你编写好了的SimProcedures. 它们相当于标准库函数</span></span><br><span class="line"><span class="comment"># 你不需要全部的函数, 一部分就可以了</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;malloc&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;fopen&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;fclose&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;fwrite&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;getchar&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;strncmp&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;strcmp&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;scanf&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;printf&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;puts&#x27;]</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;exit&#x27;]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># As a reminder, you can hook functions with something similar to:</span></span><br><span class="line"><span class="comment"># project.hook(malloc_address, angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;malloc&#x27;]())</span></span><br><span class="line"><span class="comment"># 提醒一下, 你可以使用下面的语句来实现Hook</span></span><br><span class="line"><span class="comment"># project.hook(函数地址, angr.SIM_PROCEDURES[&#x27;libc&#x27;][&#x27;要替换的内置函数名&#x27;]())</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># There are many more, see:</span></span><br><span class="line"><span class="comment"># 了解更多, 请看下面的网站</span></span><br><span class="line"><span class="comment"># https://github.com/angr/angr/tree/master/angr/procedures/libc</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Additionally, note that, when the binary is executed, the main function is not</span></span><br><span class="line"><span class="comment"># the first piece of code called. In the _start function, __libc_start_main is</span></span><br><span class="line"><span class="comment"># called to start your program. The initialization that occurs in this function</span></span><br><span class="line"><span class="comment"># can take a long time with Angr, so you should replace it with a SimProcedure.</span></span><br><span class="line"><span class="comment"># angr.SIM_PROCEDURES[&#x27;glibc&#x27;][&#x27;__libc_start_main&#x27;]</span></span><br><span class="line"><span class="comment"># Note &#x27;glibc&#x27; instead of &#x27;libc&#x27;.</span></span><br><span class="line"><span class="comment"># 另外, 请注意, 执行二进制文件时, 主函数不是最先被调用的代码,.</span></span><br><span class="line"><span class="comment"># 而是在_start函数中, 通过调用__libc_start_main来启动main函数</span></span><br><span class="line"><span class="comment"># 使用Angr在此函数中进行的初始化可能需要很长的时间, 因此你需要将其替换为SimPorcedure</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># 注意是&#x27;glibc&#x27;而不是&#x27;libc&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">    binary_path = argv[<span class="number">1</span>]</span><br><span class="line">    project = angr.Project(binary_path)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 符号执行初始状态在main函数的开头</span></span><br><span class="line">    start_address = <span class="number">0x08049E0F</span></span><br><span class="line">    initial_state = project.factory.blank_state(</span><br><span class="line">        addr = start_address, </span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                        angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">#开始Hook</span></span><br><span class="line">    start_main_address = <span class="number">0x0804A240</span></span><br><span class="line">    project.hook(start_main_address, angr.SIM_PROCEDURES[<span class="string">&#x27;glibc&#x27;</span>][<span class="string">&#x27;__libc_start_main&#x27;</span>]())</span><br><span class="line">    strcmp_address = <span class="number">0x080490D0</span></span><br><span class="line">    project.hook(strcmp_address, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;strcmp&#x27;</span>]())</span><br><span class="line">    scanf_address = <span class="number">0x08051330</span></span><br><span class="line">    project.hook(scanf_address, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;scanf&#x27;</span>]())</span><br><span class="line">    puts_address = <span class="number">0x0805EC90</span></span><br><span class="line">    project.hook(puts_address, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;puts&#x27;</span>]())</span><br><span class="line"></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建模拟执行器</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_false</span>(<span class="params">state</span>):</span></span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">    simulation.explore(find = is_successful, avoid = is_false)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后的代码-8"><a href="#去掉注释后的代码-8" class="headerlink" title="去掉注释后的代码"></a>去掉注释后的代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">    binary_path = argv[<span class="number">1</span>]</span><br><span class="line">    project = angr.Project(binary_path)</span><br><span class="line"></span><br><span class="line">    start_address = <span class="number">0x08049E0F</span></span><br><span class="line">    initial_state = project.factory.blank_state(</span><br><span class="line">        addr = start_address, </span><br><span class="line">        add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                        angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    start_main_address = <span class="number">0x0804A240</span></span><br><span class="line">    project.hook(start_main_address, angr.SIM_PROCEDURES[<span class="string">&#x27;glibc&#x27;</span>][<span class="string">&#x27;__libc_start_main&#x27;</span>]())</span><br><span class="line">    strcmp_address = <span class="number">0x080490D0</span></span><br><span class="line">    project.hook(strcmp_address, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;strcmp&#x27;</span>]())</span><br><span class="line">    scanf_address = <span class="number">0x08051330</span></span><br><span class="line">    project.hook(scanf_address, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;scanf&#x27;</span>]())</span><br><span class="line">    puts_address = <span class="number">0x0805EC90</span></span><br><span class="line">    project.hook(puts_address, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;puts&#x27;</span>]())</span><br><span class="line"></span><br><span class="line">    simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_false</span>(<span class="params">state</span>):</span></span><br><span class="line">        stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output</span><br><span class="line"></span><br><span class="line">    simulation.explore(find = is_successful, avoid = is_false)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> simulation.found:</span><br><span class="line">        solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h1 id="14-angr-shared-library"><a href="#14-angr-shared-library" class="headerlink" title="14_angr_shared_library"></a>14_angr_shared_library</h1><h2 id="编译-动态库直接运行不了"><a href="#编译-动态库直接运行不了" class="headerlink" title="编译(动态库直接运行不了)"></a>编译(动态库直接运行不了)</h2><p>运行不了后面就没法验证自己解出的flag是不是对的, 可以自己照着加密函数写一个test程序, 也可以直接载入so文件调用validate函数, 第一个方法更简单一些.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/14_angr_shared_library$ python3 generate.py 1234 14_angr_shared_library_so.c</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/14_angr_shared_library$ </span><br></pre></td></tr></table></figure>

<h2 id="分析-14"><a href="#分析-14" class="headerlink" title="分析"></a>分析</h2><p>是一个so文件根据提示找到我们需要的函数validate</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BOOL4 __cdecl <span class="title">validate</span><span class="params">(<span class="keyword">char</span> *s1, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">char</span> s2[<span class="number">20</span>]; <span class="comment">// [esp+4h] [ebp-24h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> j; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 &lt;= <span class="number">7</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">19</span>; ++i )</span><br><span class="line">    s2[i] = <span class="number">0</span>;</span><br><span class="line">  qmemcpy(s2, <span class="string">&quot;HXUITWOA&quot;</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">7</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = complex_function(s1[j], j);</span><br><span class="line">    s1[j] = v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strcmp</span>(s1, s2) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用Angr解题-13"><a href="#使用Angr解题-13" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><h3 id="代码-12"><a href="#代码-12" class="headerlink" title="代码"></a>代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The shared library has the function validate, which takes a string and returns</span></span><br><span class="line"><span class="comment"># either true (1) or false (0). The binary calls this function. If it returns</span></span><br><span class="line"><span class="comment"># true, the program prints &quot;Good Job.&quot; otherwise, it prints &quot;Try again.&quot;</span></span><br><span class="line"><span class="comment"># 共享库有函数validate, 它接受一个字符串并返回true(1)或false(0).</span></span><br><span class="line"><span class="comment"># 二进制文件调用此函数, 如果返回True, 程序将打印&quot;Good Job&quot;, 否则打印&quot;Tyr again&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note: When you run this script, make sure you run it on</span></span><br><span class="line"><span class="comment"># lib14_angr_shared_library.so, not the executable. This level is intended to</span></span><br><span class="line"><span class="comment"># teach how to analyse binary formats that are not typical executables.</span></span><br><span class="line"><span class="comment"># 注意: 运行此脚本是, 请确保在lib14_angr_shared_library.so上运行</span></span><br><span class="line"><span class="comment"># 而不是在可以执行文件上运行</span></span><br><span class="line"><span class="comment"># 这个关卡的目的在于如何分析非典型可执行文件的二进制格式</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">  <span class="comment"># The shared library is compiled with position-independent code. You will need</span></span><br><span class="line">  <span class="comment"># to specify the base address. All addresses in the shared library will be</span></span><br><span class="line">  <span class="comment"># base + offset, where offset is their address in the file.</span></span><br><span class="line">  <span class="comment"># 共享库用的是与位置无关代码编译的, 你需要指定基地址.</span></span><br><span class="line">  <span class="comment"># 共享库中的所有地址都是base + offset, 其中offset是它们在文件中的偏移</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  base = <span class="number">0x400000</span></span><br><span class="line">  project = angr.Project(path_to_binary, load_options=&#123;</span><br><span class="line">    <span class="string">&#x27;main_opts&#x27;</span> : &#123;</span><br><span class="line">      <span class="string">&#x27;base_addr&#x27;</span> : base</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Initialize any symbolic values here; you will need at least one to pass to</span></span><br><span class="line">  <span class="comment"># the validate function.</span></span><br><span class="line">  <span class="comment"># 在这里初始化任何符号值, 你至少需要传递一个符号给验证函数</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  buffer_pointer = claripy.BVV(<span class="number">0x500000</span>, <span class="number">32</span>)  <span class="comment"># 指针指向一段内存</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Begin the state at the beginning of the validate function, as if it was</span></span><br><span class="line">  <span class="comment"># called by the program. Determine the parameters needed to call validate and</span></span><br><span class="line">  <span class="comment"># replace &#x27;parameters...&#x27; with bitvectors holding the values you wish to pass.</span></span><br><span class="line">  <span class="comment"># Recall that &#x27;claripy.BVV(value, size_in_bits)&#x27; constructs a bitvector</span></span><br><span class="line">  <span class="comment"># initialized to a single value.</span></span><br><span class="line">  <span class="comment"># Remember to add the base value you specified at the beginning to the</span></span><br><span class="line">  <span class="comment"># function address!</span></span><br><span class="line">  <span class="comment"># Hint: int validate(char* buffer, int length) &#123; ...</span></span><br><span class="line">  <span class="comment"># Another hint: the password is 8 bytes long.</span></span><br><span class="line">  <span class="comment"># 从验证函数起始状态开始, 就像是它被程序调用了. 确定调用验证所需的参数,</span></span><br><span class="line">  <span class="comment"># 并将&quot;参数&quot;替换为你像传递的值的位向量.</span></span><br><span class="line">  <span class="comment"># 回想一下, &#x27;claripy.BVV(value.size_in_bits)&#x27;构造了一个初始化为单个值的位向量.</span></span><br><span class="line">  <span class="comment"># 不要忘记将你在开头指定的基址放在函数地址</span></span><br><span class="line">  <span class="comment"># 提示: int validate(char * buffer, int lenth)&#123;...&#125;</span></span><br><span class="line">  <span class="comment"># 另一个提示: 密码长度为8字节</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  validate_function_address = base + <span class="number">0x0000129C</span></span><br><span class="line">  initial_state = project.factory.call_state(validate_function_address, buffer_pointer, <span class="number">8</span>) <span class="comment"># 八个字符</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># You will need to add code to inject a symbolic value into the program. Also,</span></span><br><span class="line">  <span class="comment"># at the end of the function, constrain eax to equal true (value of 1) just</span></span><br><span class="line">  <span class="comment"># before the function returns. There are multiple ways to do this:</span></span><br><span class="line">  <span class="comment"># 1. Use a hook.</span></span><br><span class="line">  <span class="comment"># 2. Search for the address just before the function returns and then</span></span><br><span class="line">  <span class="comment">#    constrain eax (this may require putting code elsewhere)</span></span><br><span class="line">  <span class="comment"># 你需要添加代码从而将符号值注入程序.</span></span><br><span class="line">  <span class="comment"># 此外, 在函数结束时, 在函数返回之前将eax约束为等于True, 有很多方法可以做到: </span></span><br><span class="line">  <span class="comment"># 1. 使用钩子</span></span><br><span class="line">  <span class="comment"># 2. 搜索函数返回前的地址, 然后约束eax</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  <span class="comment"># 创建符号</span></span><br><span class="line">  password_len_bits = <span class="number">8</span> * <span class="number">8</span></span><br><span class="line">  password = claripy.BVS(<span class="string">&quot;password&quot;</span>, password_len_bits)</span><br><span class="line">  <span class="comment"># 符号化</span></span><br><span class="line">  initial_state.memory.store( buffer_pointer,  password)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  success_address = base + <span class="number">0x0000134C</span></span><br><span class="line">  simulation.explore(find=success_address)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Determine where the program places the return value, and constrain it so</span></span><br><span class="line">    <span class="comment"># that it is true. Then, solve for the solution and print it.</span></span><br><span class="line">    <span class="comment"># 确定程序将返回值放在哪里, 并对其进行约束, 使其为真, 然后求解并打印</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line"></span><br><span class="line">    solution_state.add_constraints( solution_state.regs.eax != <span class="number">0</span> )</span><br><span class="line">    solution = solution_state.solver.<span class="built_in">eval</span>(password, cast_to = <span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后的代码-9"><a href="#去掉注释后的代码-9" class="headerlink" title="去掉注释后的代码"></a>去掉注释后的代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">  base = <span class="number">0x400000</span></span><br><span class="line">  project = angr.Project(path_to_binary, load_options=&#123;</span><br><span class="line">    <span class="string">&#x27;main_opts&#x27;</span> : &#123;</span><br><span class="line">      <span class="string">&#x27;base_addr&#x27;</span> : base</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  buffer_pointer = claripy.BVV(<span class="number">0x500000</span>, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">  validate_function_address = base + <span class="number">0x0000129C</span></span><br><span class="line">  initial_state = project.factory.call_state(validate_function_address, buffer_pointer, <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">  password_len_bits = <span class="number">8</span> * <span class="number">8</span></span><br><span class="line">  password = claripy.BVS(<span class="string">&quot;password&quot;</span>, password_len_bits)</span><br><span class="line"></span><br><span class="line">  initial_state.memory.store( buffer_pointer,  password)</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  success_address = base + <span class="number">0x0000134C</span></span><br><span class="line">  simulation.explore(find=success_address)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution_state.add_constraints( solution_state.regs.eax != <span class="number">0</span> )</span><br><span class="line">    solution = solution_state.solver.<span class="built_in">eval</span>(password, cast_to = <span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure>

<h2 id="符号执行so文件的过程"><a href="#符号执行so文件的过程" class="headerlink" title="符号执行so文件的过程"></a>符号执行so文件的过程</h2><p>因为so文件无法执行其函数, 所以我们需要通过Angr来符号执行它</p>
<h3 id="找到要符号执行的函数的地址-记得加上基址"><a href="#找到要符号执行的函数的地址-记得加上基址" class="headerlink" title="找到要符号执行的函数的地址(记得加上基址)"></a>找到要符号执行的函数的地址(记得加上基址)</h3><p>要知道函数在哪里才能符号执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">validate_function_address = base + <span class="number">0x0000129C</span></span><br></pre></td></tr></table></figure>

<h3 id="创建参数-符号位向量-并模拟调用validate"><a href="#创建参数-符号位向量-并模拟调用validate" class="headerlink" title="创建参数(符号位向量), 并模拟调用validate"></a>创建参数(符号位向量), 并模拟调用validate</h3><p>原函数int validate(char * input, int n);</p>
<ul>
<li>第一个参数: 该函数的地址(base + offset)</li>
<li>第二个参数(从这个参数开始就是原函数应有的参数): input也得是一个符号位向量, 大小为4个字节</li>
<li>第三个参数: 因为n只能是8, 所以直接传入一个常量就行了</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">validate_function_address = base + <span class="number">0x0000129C</span></span><br><span class="line">initial_state = project.factory.call_state(validate_function_address, buffer_pointer, <span class="number">8</span>)</span><br></pre></td></tr></table></figure>

<h3 id="注入buffer的符号位向量"><a href="#注入buffer的符号位向量" class="headerlink" title="注入buffer的符号位向量"></a>注入buffer的符号位向量</h3><p>因为前面已经给出了指向buffer的指针input了, 所以我们符号注入的地址自然也是input</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">password_len_bits = <span class="number">8</span> * <span class="number">8</span></span><br><span class="line">password = claripy.BVS(<span class="string">&quot;password&quot;</span>, password_len_bits) <span class="comment"># 创建符号</span></span><br><span class="line"></span><br><span class="line">initial_state.memory.store( buffer_pointer,  password) <span class="comment"># 注入符号</span></span><br></pre></td></tr></table></figure>

<h3 id="符号执行-2"><a href="#符号执行-2" class="headerlink" title="符号执行"></a>符号执行</h3><p>我们的目标是返回值为1, 所以我们必须让state在return的位置时结束符号执行, 然后再这个state约束eax寄存器, 从而实现约束返回值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">success_address = base + <span class="number">0x0000134C</span> <span class="comment"># retn汇编指令</span></span><br><span class="line">simulation.explore(find=success_address)</span><br><span class="line"></span><br><span class="line">solution_state.add_constraints( solution_state.regs.eax != <span class="number">0</span> ) <span class="comment"># 在该状态下约束此时的eax为1即可解得flag</span></span><br></pre></td></tr></table></figure>

<h1 id="15-angr-arbitrary-read"><a href="#15-angr-arbitrary-read" class="headerlink" title="15_angr_arbitrary_read"></a>15_angr_arbitrary_read</h1><h2 id="编译并运行-11"><a href="#编译并运行-11" class="headerlink" title="编译并运行"></a>编译并运行</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/15_angr_arbitrary_read$ python3 generate.py <span class="number">1234</span> 15_angr_arbitrary_read</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/15_angr_arbitrary_read$ ./15_angr_arbitrary_read</span><br><span class="line">Enter the password: aaaaa</span><br><span class="line">Try again.</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/15_angr_arbitrary_read$</span><br></pre></td></tr></table></figure>

<h2 id="分析-15"><a href="#分析-15" class="headerlink" title="分析"></a>分析</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> __cdecl main(<span class="built_in">int</span> argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  char v4; // [esp+Ch] [ebp-1Ch] BYREF</span><br><span class="line">  char *s; // [esp+1Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  s = try_again;</span><br><span class="line">  printf(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u %20s&quot;</span>, &amp;key, &amp;v4);</span><br><span class="line">  <span class="keyword">if</span> ( key == <span class="number">41217380</span> )</span><br><span class="line">    puts(s);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    puts(try_again);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本题我们要利用栈溢出, 实现打印”Good Job”</p>
<h2 id="使用Angr解题-14"><a href="#使用Angr解题-14" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><h3 id="代码-13"><a href="#代码-13" class="headerlink" title="代码"></a>代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This binary takes both an integer and a string as a parameter. A certain</span></span><br><span class="line"><span class="comment"># integer input causes the program to reach a buffer overflow with which we can</span></span><br><span class="line"><span class="comment"># read a string from an arbitrary memory location. Our goal is to use Angr to</span></span><br><span class="line"><span class="comment"># search the program for this buffer overflow and then automatically generate</span></span><br><span class="line"><span class="comment"># an exploit to read the string &quot;Good Job.&quot;</span></span><br><span class="line"><span class="comment"># 这个二进制接受一个整数和一个字符串输入, 某个整数输入会导致程序达到缓冲区溢出</span></span><br><span class="line"><span class="comment"># 我们可以使用该缓冲区从任意内存位置读取字符串. 我们的目标是使用Angr在程序搜索</span></span><br><span class="line"><span class="comment"># 缓冲区溢出, 然后自动生成一个漏洞利用来读取字符串&quot;Good Job&quot;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># What is the point of reading the string &quot;Good Job.&quot;?</span></span><br><span class="line"><span class="comment"># This CTF attempts to replicate a simplified version of a possible vulnerability</span></span><br><span class="line"><span class="comment"># where a user can exploit the program to print a secret, such as a password or</span></span><br><span class="line"><span class="comment"># a private key. In order to keep consistency with the other challenges and to</span></span><br><span class="line"><span class="comment"># simplify the challenge, the goal of this program will be to print &quot;Good Job.&quot;</span></span><br><span class="line"><span class="comment"># instead.</span></span><br><span class="line"><span class="comment"># 读取字符串&quot;Good Job&quot;有什么意义?</span></span><br><span class="line"><span class="comment"># 这个关卡试图复现一个漏洞的简化版本, 用户可以利用这个漏洞打印一个自己想要打印的东西</span></span><br><span class="line"><span class="comment"># 为了与其他挑战保持一直并简化挑战, 我们需要打印&quot;Good Job&quot;来证明自己已经通关</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The general strategy for crafting this script will be to:</span></span><br><span class="line"><span class="comment"># 制作此脚本的通用策略是: </span></span><br><span class="line"><span class="comment"># 1) Search for calls of the &#x27;puts&#x27; function, which will eventually be exploited</span></span><br><span class="line"><span class="comment">#    to print out &quot;Good Job.&quot;</span></span><br><span class="line"><span class="comment"># 1. 搜索&quot;puts&quot;函数的调用, 最终利用这个函数并打印出&quot;Good Job&quot;</span></span><br><span class="line"><span class="comment"># 2) Determine if the first parameter of &#x27;puts&#x27;, a pointer to the string to be</span></span><br><span class="line"><span class="comment">#    printed, can be controlled by the user to be set to the location of the</span></span><br><span class="line"><span class="comment">#    &quot;Good Job.&quot; string.</span></span><br><span class="line"><span class="comment"># 2. 确定&quot;puts&quot;的第一个参数: 一个指向要打印的字符串的指针. 是否可以由用户控制并设为&quot;Good Job&quot;</span></span><br><span class="line"><span class="comment"># 3) Solve for the input that prints &quot;Good Job.&quot;</span></span><br><span class="line"><span class="comment"># 3. 求解打印&quot;Good Job&quot;的输入</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note: The script is structured to implement step #2 before #1.</span></span><br><span class="line"><span class="comment"># 提示: 在脚本中2.的实现早于1.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Some of the source code for this challenge:</span></span><br><span class="line"><span class="comment"># 这个关卡的部分源代码</span></span><br><span class="line"><span class="comment"># #include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment"># #include &lt;stdlib.h&gt;</span></span><br><span class="line"><span class="comment"># #include &lt;string.h&gt;</span></span><br><span class="line"><span class="comment"># #include &lt;stdint.h&gt;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># // This will all be in .rodata</span></span><br><span class="line"><span class="comment"># 这都会放在.rodata段区中</span></span><br><span class="line"><span class="comment"># char msg[] = &quot;$&#123; description &#125;$&quot;;</span></span><br><span class="line"><span class="comment"># char* try_again = &quot;Try again.&quot;;</span></span><br><span class="line"><span class="comment"># char* good_job = &quot;Good Job.&quot;;</span></span><br><span class="line"><span class="comment"># uint32_t key;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># void print_msg() &#123;</span></span><br><span class="line"><span class="comment">#   printf(&quot;%s&quot;, msg);</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># uint32_t complex_function(uint32_t input) &#123;</span></span><br><span class="line"><span class="comment">#   ...</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># struct overflow_me &#123;</span></span><br><span class="line"><span class="comment">#   char buffer[16];# 上一个输入造成溢出到print的地址, 如果输入的是&quot;Good Job&quot;的地址那么就会导致最终打印的是&quot;Good Job&quot;</span></span><br><span class="line"><span class="comment">#   char* to_print;</span></span><br><span class="line"><span class="comment"># &#125;; </span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># int main(int argc, char* argv[]) &#123;</span></span><br><span class="line"><span class="comment">#   struct overflow_me locals;</span></span><br><span class="line"><span class="comment">#   locals.to_print = try_again;# 初始化为&quot;Try again&quot;的地址</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#   print_msg();</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#   printf(&quot;Enter the password: &quot;);</span></span><br><span class="line"><span class="comment">#   scanf(&quot;%u %20s&quot;, &amp;key, locals.buffer);注意这里是%20s, 剩下的四个字节就是我们要填入&quot;Good Job&quot;地址的地方</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#   key = complex_function(key);</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#   switch (key) &#123;</span></span><br><span class="line"><span class="comment">#     case ?:</span></span><br><span class="line"><span class="comment">#       puts(try_again);</span></span><br><span class="line"><span class="comment">#       break;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     ...</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     case ?:</span></span><br><span class="line"><span class="comment">#       // Our goal is to trick this call to puts to print the &quot;secret</span></span><br><span class="line"><span class="comment">#       // password&quot; (which happens, in our case, to be the string</span></span><br><span class="line"><span class="comment">#       // &quot;Good Job.&quot;)</span></span><br><span class="line"><span class="comment"># 我们的目标是骗过puts的调用, 并打印&quot;Good Job&quot;</span></span><br><span class="line"><span class="comment">#       puts(locals.to_print);</span></span><br><span class="line"><span class="comment">#       break;</span></span><br><span class="line"><span class="comment">#   </span></span><br><span class="line"><span class="comment">#     ...</span></span><br><span class="line"><span class="comment">#   &#125;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#   return 0;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># You can either use a blank state or an entry state; just make sure to start</span></span><br><span class="line">  <span class="comment"># at the beginning of the program.</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123;angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY, </span><br><span class="line">                   angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Again, scanf needs to be replaced.</span></span><br><span class="line">  <span class="comment"># scanf需要再一次被替代</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ReplacementScanf</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line">    <span class="comment"># Hint: scanf(&quot;%u %20s&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, format_string, scanf0_address, scanf1_address</span>):</span></span><br><span class="line">      <span class="comment"># %u</span></span><br><span class="line">      scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>, <span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line">    </span><br><span class="line">      <span class="comment"># %20s</span></span><br><span class="line">      scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>, <span class="number">20</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># The bitvector.chop(bits=n) function splits the bitvector into a Python</span></span><br><span class="line">      <span class="comment"># list containing the bitvector in segments of n bits each. In this case,</span></span><br><span class="line">      <span class="comment"># we are splitting them into segments of 8 bits (one byte.)</span></span><br><span class="line">      <span class="comment"># bitvector.chop(bits = n)函数将位向量拆分为一个Python列表, 其中很多个包含n位小节的位向量元素</span></span><br><span class="line">      <span class="comment">#  我们现在将其分为8位一字节的小结</span></span><br><span class="line">      <span class="keyword">for</span> char <span class="keyword">in</span> scanf1.chop(bits=<span class="number">8</span>):</span><br><span class="line">        <span class="comment"># Ensure that each character in the string is printable. An interesting</span></span><br><span class="line">        <span class="comment"># experiment, once you have a working solution, would be to run the code</span></span><br><span class="line">        <span class="comment"># without constraining the characters to the printable range of ASCII.</span></span><br><span class="line">        <span class="comment"># Even though the solution will technically work without this, it&#x27;s more</span></span><br><span class="line">        <span class="comment"># difficult to enter in a solution that contains character you can&#x27;t</span></span><br><span class="line">        <span class="comment"># copy, paste, or type into your terminal or the web form that checks </span></span><br><span class="line">        <span class="comment"># your solution.</span></span><br><span class="line">        <span class="comment"># 确保字符串中的每个字符都是可打印的.</span></span><br><span class="line">        <span class="comment"># 保证你的解决方案的有效简洁</span></span><br><span class="line">        <span class="comment"># (!)</span></span><br><span class="line">        self.state.add_constraints(char &gt;= <span class="number">0x21</span>, char &lt;= <span class="number">126</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Warning: Endianness only applies to integers. If you store a string in</span></span><br><span class="line">      <span class="comment"># memory and treat it as a little-endian integer, it will be backwards.</span></span><br><span class="line">      <span class="comment"># 警告: 大小端字节序仅适用于整数, 字符串还是正常排列</span></span><br><span class="line">      <span class="comment"># key是全局变量所以可以直接用地址来注入符号</span></span><br><span class="line">      <span class="comment">#scanf0_address = 0x48587030</span></span><br><span class="line">      self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)</span><br><span class="line">      self.state.memory.store(scanf1_address, scanf1)</span><br><span class="line"></span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>] = scanf0</span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>] = scanf1</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Hook该scanf()函数</span></span><br><span class="line">  scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span>  <span class="comment"># :string</span></span><br><span class="line">  project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br><span class="line"></span><br><span class="line">  <span class="comment"># We will call this whenever puts is called. The goal of this function is to</span></span><br><span class="line">  <span class="comment"># determine if the pointer passed to puts is controllable by the user, such</span></span><br><span class="line">  <span class="comment"># that we can rewrite it to point to the string &quot;Good Job.&quot;</span></span><br><span class="line">  <span class="comment"># 只要puts被调用, 我们就会调用它, 此函数的目标是确定传递给puts的指针是否可由用户控制</span></span><br><span class="line">  <span class="comment"># 以便我们可以重写为指向字符串&quot;Good Job&quot;的地址</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">check_puts</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="comment"># Recall that puts takes one parameter, a pointer to the string it will</span></span><br><span class="line">    <span class="comment"># print. If we load that pointer from memory, we can analyse it to determine</span></span><br><span class="line">    <span class="comment"># if it can be controlled by the user input in order to point it to the</span></span><br><span class="line">    <span class="comment"># location of the &quot;Good Job.&quot; string.</span></span><br><span class="line">    <span class="comment"># 回想一下, puts有一个参数: 指向字符串的指针.</span></span><br><span class="line">    <span class="comment"># 如果我们从内存中找到这个指针,</span></span><br><span class="line">    <span class="comment"># 我们可以分析它以确定它是否可以由用户输入控制</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Treat the implementation of this function as if puts was just called.</span></span><br><span class="line">    <span class="comment"># The stack, registers, memory, etc should be set up as if the x86 call</span></span><br><span class="line">    <span class="comment"># instruction was just invoked (but, of course, the function hasn&#x27;t copied</span></span><br><span class="line">    <span class="comment"># the buffers yet.)</span></span><br><span class="line">    <span class="comment"># The stack will look as follows:</span></span><br><span class="line">    <span class="comment"># 将此函数代替puts</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="comment"># esp + 7 -&gt; /----------------\</span></span><br><span class="line">    <span class="comment"># esp + 6 -&gt; |      puts      |</span></span><br><span class="line">    <span class="comment"># esp + 5 -&gt; |    parameter   |     参数先压入栈中</span></span><br><span class="line">    <span class="comment"># esp + 4 -&gt; \----------------/</span></span><br><span class="line">    <span class="comment"># esp + 3 -&gt; /----------------\</span></span><br><span class="line">    <span class="comment"># esp + 2 -&gt; |     return     |</span></span><br><span class="line">    <span class="comment"># esp + 1 -&gt; |     address    |     调用puts时的call指令会将返回地址压入栈中</span></span><br><span class="line">    <span class="comment">#     esp -&gt; \----------------/</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Hint: Look at level 08, 09, or 10 to review how to load a value from a</span></span><br><span class="line">    <span class="comment"># memory address. Remember to use the correct endianness in the future when</span></span><br><span class="line">    <span class="comment"># loading integers; it has been included for you here.</span></span><br><span class="line">    <span class="comment"># 查看第8, 9, 10关如何从内存地址加载值</span></span><br><span class="line">    <span class="comment"># 记住以后再加载整数时要使用正确的大小端字节序, 这个已经被包含在下面的参数中了</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    puts_parameter = state.memory.load(state.regs.esp + <span class="number">4</span>, <span class="number">4</span>, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># The following function takes a bitvector as a parameter and checks if it</span></span><br><span class="line">    <span class="comment"># can take on more than one value. While this does not necessary tell us we</span></span><br><span class="line">    <span class="comment"># have found an exploitable state, it is a strong indication that the </span></span><br><span class="line">    <span class="comment"># bitvector we checked may be controllable by the user.</span></span><br><span class="line">    <span class="comment"># Use it to determine if the pointer passed to puts is symbolic.</span></span><br><span class="line">    <span class="comment"># 下面的函数将用一个位向量作为参数, 并检查它是否可以接受多个值</span></span><br><span class="line">    <span class="comment"># 虽然这并不一定代表我们发现漏洞, 但是这强烈表明我们检查的位向量可能由用户控制</span></span><br><span class="line">    <span class="comment"># 使用它来确定传递给puts的指针是否是符号的</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    <span class="keyword">if</span> state.solver.symbolic(puts_parameter):</span><br><span class="line">      <span class="comment"># Determine the location of the &quot;Good Job.&quot; string. We want to print it</span></span><br><span class="line">      <span class="comment"># out, and we will do so by attempting to constrain the puts parameter to</span></span><br><span class="line">      <span class="comment"># equal it. Hint: use &#x27;objdump -s &lt;binary&gt;&#x27; to look for the string&#x27;s</span></span><br><span class="line">      <span class="comment"># address in .rodata.</span></span><br><span class="line">      <span class="comment"># 确定好&quot;Good Job&quot;的地址 我们想要将其输出, 我们通过对puts参数约束为&quot;Good Job&quot;的地址来实现</span></span><br><span class="line">      <span class="comment"># 使用objdump -s &lt;二进制文件&gt;来查看&quot;Good Job&quot;的地址</span></span><br><span class="line">      <span class="comment"># (!)</span></span><br><span class="line">      good_job_string_address = <span class="number">0x4858554B</span> <span class="comment"># :integer, probably hexadecimal</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Create an expression that will test if puts_parameter equals</span></span><br><span class="line">      <span class="comment"># good_job_string_address. If we add this as a constraint to our solver,</span></span><br><span class="line">      <span class="comment"># it will try and find an input to make this expression true. Take a look</span></span><br><span class="line">      <span class="comment"># at level 08 to remind yourself of the syntax of this.</span></span><br><span class="line">      <span class="comment"># 创建一个表达式来测试puts_parameter是否等于&quot;Good Job&quot;的地址</span></span><br><span class="line">      <span class="comment"># 如果我们将此作为约束添加到求解器, 它将尝试找到一个输入以使得该表达式为真</span></span><br><span class="line">      <span class="comment"># 看一下第八关, 看看怎么使用该语法</span></span><br><span class="line">      <span class="comment"># (!)</span></span><br><span class="line">      is_vulnerable_expression = puts_parameter == good_job_string_address <span class="comment"># :boolean bitvector expression</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Have Angr evaluate the state to determine if all the constraints can</span></span><br><span class="line">      <span class="comment"># be met, including the one we specified above. If it can be satisfied,</span></span><br><span class="line">      <span class="comment"># we have found our exploit!</span></span><br><span class="line">      <span class="comment">#</span></span><br><span class="line">      <span class="comment"># When doing this, however, we do not want to edit our state in case we</span></span><br><span class="line">      <span class="comment"># have not yet found what we are looking for. To test if our expression</span></span><br><span class="line">      <span class="comment"># is satisfiable without editing the original, we need to clone the state.</span></span><br><span class="line">      <span class="comment"># 让Angr评估状态从而确定是否可以满足所有约束, 包括我们上面指定的约束. 如果可以满足, 我们就可以找到漏洞</span></span><br><span class="line">      <span class="comment"># 但是当我们这样做时, 我们不希望编辑我们的状态, 因为我们还没有找到想要的东西.</span></span><br><span class="line">      <span class="comment"># 为了此时我们的表达式是否可以再不编辑原始内容的情况下满足, 我们需要克隆状态</span></span><br><span class="line">      copied_state = state.copy()</span><br><span class="line"></span><br><span class="line">      <span class="comment"># We can now play around with the copied state without changing the</span></span><br><span class="line">      <span class="comment"># original. We need to add our vulnerable expression as a state to test it.</span></span><br><span class="line">      <span class="comment"># Look at level 08 and compare this call to how it is called there.</span></span><br><span class="line">      <span class="comment"># 我们现在可以在不改变原始状态的情况下使用克隆状态.</span></span><br><span class="line">      <span class="comment"># 我们需要添加易受攻击的表达式作为state从而测试他.</span></span><br><span class="line">      copied_state.add_constraints(is_vulnerable_expression)</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Finally, we test if we can satisfy the constraints of the state.</span></span><br><span class="line">      <span class="comment"># 最后, 我们测试可以满足条件的约束</span></span><br><span class="line">      <span class="keyword">if</span> copied_state.satisfiable():</span><br><span class="line">        <span class="comment"># Before we return, let&#x27;s add the constraint to the solver for real,</span></span><br><span class="line">        <span class="comment"># instead of just querying whether the constraint _could_ be added.</span></span><br><span class="line">        <span class="comment"># 在我们返回之前, 我们要将约束添加到求解其中, 而不仅仅只是查看是否可以约束</span></span><br><span class="line">        state.add_constraints(is_vulnerable_expression)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>: <span class="comment"># not state.solver.symbolic(???)</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># In order to determine if we have found a vulnerable call to &#x27;puts&#x27;,  we need</span></span><br><span class="line">  <span class="comment"># to run the function check_puts (defined above) whenever we reach a &#x27;puts&#x27;</span></span><br><span class="line">  <span class="comment"># call. To do this, we will look for the place where the instruction pointer,</span></span><br><span class="line">  <span class="comment"># state.addr, is equal to the beginning of the puts function.</span></span><br><span class="line">  <span class="comment"># 为了确定我们是否发现了对&quot;puts&quot;函数的易受攻击的调用, 我们需要在调用&quot;puts&quot;调用运行时运行上面定义阿check_ptus</span></span><br><span class="line">  <span class="comment"># 为此, 我们将IP指针state.addr变成puts函数开头的地址.</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="comment"># We are looking for puts. Check that the address is at the (very) beginning</span></span><br><span class="line">    <span class="comment"># of the puts function. Warning: while, in theory, you could look for</span></span><br><span class="line">    <span class="comment"># any address in puts, if you execute any instruction that adjusts the stack</span></span><br><span class="line">    <span class="comment"># pointer, the stack diagram above will be incorrect. Therefore, it is</span></span><br><span class="line">    <span class="comment"># recommended that you check for the very beginning of puts.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    puts_address = <span class="number">0x08049090</span></span><br><span class="line">    <span class="keyword">if</span> state.addr == puts_address:</span><br><span class="line">      <span class="comment"># Return True if we determine this call to puts is exploitable.</span></span><br><span class="line">      <span class="keyword">return</span> check_puts(state)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="comment"># We have not yet found a call to puts; we should continue!</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    stored_solutions0 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>]</span><br><span class="line">    stored_solutions1 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>]</span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(stored_solutions0)</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(stored_solutions1, cast_to = <span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(solution0)</span><br><span class="line">    <span class="built_in">print</span>(solution1)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后的代码-10"><a href="#去掉注释后的代码-10" class="headerlink" title="去掉注释后的代码"></a>去掉注释后的代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123;angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY, </span><br><span class="line">                   angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ReplacementScanf</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, format_string, scanf0_address, scanf1_address</span>):</span></span><br><span class="line">      scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>, <span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line">  </span><br><span class="line">      scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>, <span class="number">20</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> char <span class="keyword">in</span> scanf1.chop(bits=<span class="number">8</span>):</span><br><span class="line">        self.state.add_constraints(char &gt;= <span class="number">0x21</span>, char &lt;= <span class="number">126</span>)</span><br><span class="line"></span><br><span class="line">      self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)</span><br><span class="line">      self.state.memory.store(scanf1_address, scanf1)</span><br><span class="line"></span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>] = scanf0</span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>] = scanf1</span><br><span class="line"></span><br><span class="line">  scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span>  <span class="comment"># :string</span></span><br><span class="line">  project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">check_puts</span>(<span class="params">state</span>):</span></span><br><span class="line">    puts_parameter = state.memory.load(state.regs.esp + <span class="number">4</span>, <span class="number">4</span>, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> state.solver.symbolic(puts_parameter):</span><br><span class="line">      good_job_string_address = <span class="number">0x4858554B</span></span><br><span class="line"></span><br><span class="line">      is_vulnerable_expression = puts_parameter == good_job_string_address</span><br><span class="line"></span><br><span class="line">      copied_state = state.copy()</span><br><span class="line"></span><br><span class="line">      copied_state.add_constraints(is_vulnerable_expression)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> copied_state.satisfiable():</span><br><span class="line"></span><br><span class="line">        state.add_constraints(is_vulnerable_expression)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    puts_address = <span class="number">0x08049090</span></span><br><span class="line">    <span class="keyword">if</span> state.addr == puts_address:</span><br><span class="line">      <span class="keyword">return</span> check_puts(state)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    stored_solutions0 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>]</span><br><span class="line">    stored_solutions1 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>]</span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(stored_solutions0)</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(stored_solutions1, cast_to = <span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(solution0)</span><br><span class="line">    <span class="built_in">print</span>(solution1)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="查找漏洞思路"><a href="#查找漏洞思路" class="headerlink" title="查找漏洞思路"></a>查找漏洞思路</h2><h3 id="Hook-scanf"><a href="#Hook-scanf" class="headerlink" title="Hook scanf()"></a>Hook scanf()</h3><p>因为这道题有两个输入, 所以我们需要先进行Hook</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReplacementScanf</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, format_string, scanf0_address, scanf1_address</span>):</span></span><br><span class="line">    scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>, <span class="number">4</span> * <span class="number">8</span>)</span><br><span class="line">  </span><br><span class="line">    scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>, <span class="number">20</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> scanf1.chop(bits=<span class="number">8</span>):</span><br><span class="line">      self.state.add_constraints(char &gt;= <span class="number">0x21</span>, char &lt;= <span class="number">126</span>)</span><br><span class="line"></span><br><span class="line">    self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)</span><br><span class="line">    self.state.memory.store(scanf1_address, scanf1)</span><br><span class="line"></span><br><span class="line">    self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>] = scanf0</span><br><span class="line">    self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>] = scanf1</span><br><span class="line"></span><br><span class="line">scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span>  <span class="comment"># :string</span></span><br><span class="line">project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br></pre></td></tr></table></figure>

<p>注意在这时我们创建了两个符号scanf0和scanf1, 并且存入了globals中, 存入golbal中是因为后面对符号的约束求解是在该&lt;类&gt;的外部的, 所以需要将符号值存入全局变量中.</p>
<h3 id="定义check-puts"><a href="#定义check-puts" class="headerlink" title="定义check_puts()"></a>定义check_puts()</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_puts</span>(<span class="params">state</span>):</span></span><br><span class="line">  puts_parameter = state.memory.load(state.regs.esp + <span class="number">4</span>, <span class="number">4</span>, endness=project.arch.memory_endness)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> state.solver.symbolic(puts_parameter):</span><br><span class="line">    good_job_string_address = <span class="number">0x4858554B</span></span><br><span class="line"></span><br><span class="line">    is_vulnerable_expression = puts_parameter == good_job_string_address</span><br><span class="line"></span><br><span class="line">    copied_state = state.copy()</span><br><span class="line"></span><br><span class="line">    copied_state.add_constraints(is_vulnerable_expression)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> copied_state.satisfiable():</span><br><span class="line"></span><br><span class="line">      state.add_constraints(is_vulnerable_expression)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>该函数的是在找到puts函数的时候调用的, 也就是说此时符号执行已经到达了puts开头.我们将此时的state传入check_puts中.</p>
<p>这时就可以获取该状态(刚进入puts的上下文)下esp的值, 从而获取参数值(要打印的字符串的指针).</p>
<h3 id="找到目标打印字符串"><a href="#找到目标打印字符串" class="headerlink" title="找到目标打印字符串"></a>找到目标打印字符串</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> state.solver.symbolic(puts_parameter):</span><br><span class="line">  good_job_string_address = <span class="number">0x4858554B</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="复制状态-检验是否满足条件"><a href="#复制状态-检验是否满足条件" class="headerlink" title="复制状态, 检验是否满足条件"></a>复制状态, 检验是否满足条件</h3><p>因为要对状态进行修改, 我们需要先”测试”能不能满足条件得到我们想要的结果</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">is_vulnerable_expression = puts_parameter == good_job_string_address</span><br><span class="line"></span><br><span class="line">copied_state = state.copy()</span><br><span class="line"></span><br><span class="line">copied_state.add_constraints(is_vulnerable_expression)</span><br></pre></td></tr></table></figure>

<h3 id="如果可满足-则给当前状态添加约束"><a href="#如果可满足-则给当前状态添加约束" class="headerlink" title="如果可满足, 则给当前状态添加约束"></a>如果可满足, 则给当前状态添加约束</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> copied_state.satisfiable():</span><br><span class="line">  state.add_constraints(is_vulnerable_expression)</span><br></pre></td></tr></table></figure>

<h3 id="外部符号执行-并约束求解"><a href="#外部符号执行-并约束求解" class="headerlink" title="外部符号执行, 并约束求解"></a>外部符号执行, 并约束求解</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">  puts_address = <span class="number">0x08049090</span></span><br><span class="line">  <span class="keyword">if</span> state.addr == puts_address:</span><br><span class="line">    <span class="keyword">return</span> check_puts(state)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">simulation.explore(find=is_successful)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">  solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  stored_solutions0 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution0&#x27;</span>]</span><br><span class="line">  stored_solutions1 = solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solution1&#x27;</span>]</span><br><span class="line">  solution0 = solution_state.solver.<span class="built_in">eval</span>(stored_solutions0)</span><br><span class="line">  solution1 = solution_state.solver.<span class="built_in">eval</span>(stored_solutions1, cast_to = <span class="built_in">bytes</span>)</span><br><span class="line">  <span class="built_in">print</span>(solution0)</span><br><span class="line">  <span class="built_in">print</span>(solution1)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">  <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="16-angr-arbitrary-write"><a href="#16-angr-arbitrary-write" class="headerlink" title="16_angr_arbitrary_write"></a>16_angr_arbitrary_write</h1><h2 id="编译并执行-2"><a href="#编译并执行-2" class="headerlink" title="编译并执行"></a>编译并执行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/16_angr_arbitrary_write$ python3 generate.py</span><br><span class="line">1234 16_angr_arbitrary_write</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/16_angr_arbitrary_write$ ./16_angr_arbitrary_</span><br><span class="line">write</span><br><span class="line">Enter the password: aaaaaaa</span><br><span class="line">Try again.</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/16_angr_arbitrary_write$</span><br></pre></td></tr></table></figure>

<h2 id="分析-16"><a href="#分析-16" class="headerlink" title="分析"></a>分析</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  char s[16]; // [esp+Ch] [ebp-1Ch] BYREF</span><br><span class="line">  char *dest; // [esp+1Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  dest = unimportant_buffer;</span><br><span class="line">  memset(s, 0, sizeof(s));</span><br><span class="line">  strncpy(password_buffer, <span class="string">&quot;PASSWORD&quot;</span>, 0xCu);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u %20s&quot;</span>, &amp;key, s);</span><br><span class="line">  <span class="keyword">if</span> ( key == 0xA95593 )</span><br><span class="line">    strncpy(dest, s, 0x10u);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    strncpy(unimportant_buffer, s, 0x10u);</span><br><span class="line">  <span class="keyword">if</span> ( !strncmp(password_buffer, <span class="string">&quot;TWOAPNES&quot;</span>, 8u) )</span><br><span class="line">    puts(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    puts(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="built_in">return</span> 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到不论我们按照规定输入什么字符都无法使得程序输出”Good Job”, 所以我们仍然需要利用栈溢出的原理得到”Good Job”</p>
<p>我们先看看栈区图</p>
<p><img src="/2022/05/18/AngrLab2c872/image7.png" alt="image.png"></p>
<p>所以只要我们输入的20个字符的最后四个覆盖dest的字符是unimportant_buffer的地址的话, 后面<code>strncpy(dest, s, 0x10u);</code>实际上就是给unimportant_buffer赋值, 注意第二个参数s也是我们可以控制的, 因为这个就是我们的input, 只要input = “TWOAPNES”, 我们就可以实现输出Good Job了.</p>
<h2 id="使用Angr解题-15"><a href="#使用Angr解题-15" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><h3 id="代码-14"><a href="#代码-14" class="headerlink" title="代码"></a>代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Essentially, the program does the following:</span></span><br><span class="line"><span class="comment"># 本质上, 程序执行以下操作: </span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># scanf(&quot;%d %20s&quot;, &amp;key, user_input);</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment">#   // if certain unknown conditions are true...</span></span><br><span class="line"><span class="comment">#   // 如果某些未知条件为真</span></span><br><span class="line"><span class="comment">#   strncpy(random_buffer, user_input);</span></span><br><span class="line"><span class="comment">#                  ^</span></span><br><span class="line"><span class="comment"># ...              |</span></span><br><span class="line"><span class="comment"># if (strncmp(secure_buffer, reference_string)) &#123;</span></span><br><span class="line"><span class="comment">#   // The secure_buffer does not equal the reference string.</span></span><br><span class="line"><span class="comment">#   // secure_buffer不等于reference_string</span></span><br><span class="line"><span class="comment">#   puts(&quot;Try again.&quot;);</span></span><br><span class="line"><span class="comment"># &#125; else &#123;</span></span><br><span class="line"><span class="comment">#   // The two are equal.</span></span><br><span class="line"><span class="comment">#   // 如果二者相等就打印Good Job</span></span><br><span class="line"><span class="comment">#   puts(&quot;Good Job.&quot;);</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If this program has no bugs in it, it would _always_ print &quot;Try again.&quot; since</span></span><br><span class="line"><span class="comment"># user_input copies into random_buffer, not secure_buffer.</span></span><br><span class="line"><span class="comment"># 如果程序正常运行, 它只会打印&quot;Try again&quot;, 因为输入无法影响到secure_buffer</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The question is: can we find a buffer overflow that will allow us to overwrite</span></span><br><span class="line"><span class="comment"># the random_buffer pointer to point to secure_buffer? (Spoiler: we can, but we</span></span><br><span class="line"><span class="comment"># will need to use Angr.)</span></span><br><span class="line"><span class="comment"># 问题是: 我们是否可以找到一个缓冲区溢出, 让我们可以覆盖random_buffer指针指向secure_buffer</span></span><br><span class="line"><span class="comment"># 提示: 我们可以使用Angr实现</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># We want to identify a place in the binary, when strncpy is called, when we can:</span></span><br><span class="line"><span class="comment"># 我们想在二进制文件中确定一个位置, 当调用strncpy时, 我们可以:</span></span><br><span class="line"><span class="comment">#  1) Control the source contents (not the source pointer!)</span></span><br><span class="line"><span class="comment">#  1) 控制源内容</span></span><br><span class="line"><span class="comment">#     * This will allow us to write arbitrary data to the destination.</span></span><br><span class="line"><span class="comment">#     * 这将允许我们将任何数据写入目的地</span></span><br><span class="line"><span class="comment">#  2) Control the destination pointer</span></span><br><span class="line"><span class="comment">#  2) 控制目标指针</span></span><br><span class="line"><span class="comment">#     * This will allow us to write to an arbitrary location.</span></span><br><span class="line"><span class="comment">#     * 这将允许我们写入任何位置</span></span><br><span class="line"><span class="comment"># If we can meet both of those requirements, we can write arbitrary data to an</span></span><br><span class="line"><span class="comment"># arbitrary location. Finally, we need to contrain the source contents to be</span></span><br><span class="line"><span class="comment"># equal to the reference_string and the destination pointer to be equal to the</span></span><br><span class="line"><span class="comment"># secure_buffer.</span></span><br><span class="line"><span class="comment"># 如果我们能同时满足这两个要求, 我们就可以将任意数据写入任意位置</span></span><br><span class="line"><span class="comment"># 最后, 我们需要约束源内容等于reference_string, 目标指针等于secur_buffer</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># You can either use a blank state or an entry state; just make sure to start</span></span><br><span class="line">  <span class="comment"># at the beginning of the program.</span></span><br><span class="line">  <span class="comment"># entry_state和blank_state都行, 只需保证在程序开头</span></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123;angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY, </span><br><span class="line">                   angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ReplacementScanf</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line">    <span class="comment"># Hint: scanf(&quot;%u %20s&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, format_string, scanf0_address, scanf1_address</span>):</span></span><br><span class="line">      <span class="comment"># %u</span></span><br><span class="line">      scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">    </span><br><span class="line">      <span class="comment"># %20s</span></span><br><span class="line">      scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>, <span class="number">20</span>* <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> char <span class="keyword">in</span> scanf1.chop(bits=<span class="number">8</span>):</span><br><span class="line">        self.state.add_constraints(char &gt;= <span class="number">0x21</span>, char &lt;= <span class="number">0x7A</span>)</span><br><span class="line"></span><br><span class="line">      scanf0_address = <span class="number">0x4858554C</span></span><br><span class="line">      self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)</span><br><span class="line">      self.state.memory.store(scanf1_address, scanf1)<span class="comment"># 因为是字符串, 所以不用考虑字节序的问题</span></span><br><span class="line"></span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions0&#x27;</span>] = scanf0</span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions1&#x27;</span>] = scanf1</span><br><span class="line"></span><br><span class="line">  scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span>  <span class="comment"># :string</span></span><br><span class="line">  project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br><span class="line"></span><br><span class="line">  <span class="comment"># In this challenge, we want to check strncpy to determine if we can control</span></span><br><span class="line">  <span class="comment"># both the source and the destination. It is common that we will be able to</span></span><br><span class="line">  <span class="comment"># control at least one of the parameters, (such as when the program copies a</span></span><br><span class="line">  <span class="comment"># string that it received via stdin).</span></span><br><span class="line">  <span class="comment"># 在这个挑战中, 我们要检查strcpy来确定我们是否可以同时控制src和dest.</span></span><br><span class="line">  <span class="comment"># 通常我们能够至少控制一个参数()</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">check_strncpy</span>(<span class="params">state</span>):</span></span><br><span class="line">    <span class="comment"># The stack will look as follows:</span></span><br><span class="line">    <span class="comment"># 栈空间如下图所示</span></span><br><span class="line">    <span class="comment"># ...          ________________</span></span><br><span class="line">    <span class="comment"># esp + 15 -&gt; /                \</span></span><br><span class="line">    <span class="comment"># esp + 14 -&gt; |     param2     |</span></span><br><span class="line">    <span class="comment"># esp + 13 -&gt; |      len       |</span></span><br><span class="line">    <span class="comment"># esp + 12 -&gt; \________________/</span></span><br><span class="line">    <span class="comment"># esp + 11 -&gt; /                \</span></span><br><span class="line">    <span class="comment"># esp + 10 -&gt; |     param1     |</span></span><br><span class="line">    <span class="comment">#  esp + 9 -&gt; |      src       |</span></span><br><span class="line">    <span class="comment">#  esp + 8 -&gt; \________________/</span></span><br><span class="line">    <span class="comment">#  esp + 7 -&gt; /                \</span></span><br><span class="line">    <span class="comment">#  esp + 6 -&gt; |     param0     |</span></span><br><span class="line">    <span class="comment">#  esp + 5 -&gt; |      dest      |</span></span><br><span class="line">    <span class="comment">#  esp + 4 -&gt; \________________/</span></span><br><span class="line">    <span class="comment">#  esp + 3 -&gt; /                \</span></span><br><span class="line">    <span class="comment">#  esp + 2 -&gt; |     return     |</span></span><br><span class="line">    <span class="comment">#  esp + 1 -&gt; |     address    |</span></span><br><span class="line">    <span class="comment">#      esp -&gt; \________________/</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    strncpy_src = state.memory.load(state.regs.esp + <span class="number">8</span>, <span class="number">4</span>, endness = project.arch.memory_endness)    <span class="comment">#这里读错了, 4字节当成位了</span></span><br><span class="line">    strncpy_dest = state.memory.load(state.regs.esp + <span class="number">4</span>, <span class="number">4</span>, endness = project.arch.memory_endness)  <span class="comment"># </span></span><br><span class="line">    strncpy_len = state.memory.load(state.regs.esp + <span class="number">12</span>, <span class="number">4</span>, endness = project.arch.memory_endness) </span><br><span class="line"></span><br><span class="line">    <span class="comment"># We need to find out if src is symbolic, however, we care about the</span></span><br><span class="line">    <span class="comment"># contents, rather than the pointer itself. Therefore, we have to load the</span></span><br><span class="line">    <span class="comment"># the contents of src to determine if they are symbolic.</span></span><br><span class="line">    <span class="comment"># Hint: How many bytes is strncpy copying?</span></span><br><span class="line">    <span class="comment"># 我们需要确定src是否是符号, 然而我们关心的是内容, 而不是指针本身</span></span><br><span class="line">    <span class="comment"># 因此, 我们必须加载src的内容来确定它们是否是符号.</span></span><br><span class="line">    <span class="comment"># 提示: strncpy复制了多少字节</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    src_contents = state.memory.load(strncpy_src, strncpy_len)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Our goal is to determine if we can write arbitrary data to an arbitrary</span></span><br><span class="line">    <span class="comment"># location. This means determining if the source contents are symbolic</span></span><br><span class="line">    <span class="comment"># (arbitrary data) and the destination pointer is symbolic (arbitrary</span></span><br><span class="line">    <span class="comment"># destination).</span></span><br><span class="line">    <span class="comment"># 我们的目标是确定我们是否可以将任意数据写入任意位置.</span></span><br><span class="line">    <span class="comment"># 这意味着必须确定src内容是符号, 以及目标指针是符号的.</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    <span class="keyword">if</span> state.solver.symbolic(strncpy_dest) <span class="keyword">and</span> state.solver.symbolic(src_contents):</span><br><span class="line">      <span class="comment"># Use ltrace to determine the password. Decompile the binary to determine</span></span><br><span class="line">      <span class="comment"># the address of the buffer it checks the password against. Our goal is to</span></span><br><span class="line">      <span class="comment"># overwrite that buffer to store the password.</span></span><br><span class="line">      <span class="comment"># 使用ltrace确定密码, 反编译二进制文件来确定它检查密码的缓冲区的地址</span></span><br><span class="line">      <span class="comment"># 我们的目标是覆盖该缓冲区用来存储密码</span></span><br><span class="line">      <span class="comment"># (!)</span></span><br><span class="line">      password_string = <span class="string">&#x27;TWOAPNES&#x27;</span> <span class="comment"># :string</span></span><br><span class="line">      buffer_address = <span class="number">0x4858553C</span> <span class="comment"># :integer, probably in hexadecimal</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Create an expression that tests if the first n bytes is length. Warning:</span></span><br><span class="line">      <span class="comment"># while typical Python slices (array[start:end]) will work with bitvectors,</span></span><br><span class="line">      <span class="comment"># they are indexed in an odd way. The ranges must start with a high value</span></span><br><span class="line">      <span class="comment"># and end with a low value. Additionally, the bits are indexed from right</span></span><br><span class="line">      <span class="comment"># to left. For example, let a bitvector, b, equal &#x27;ABCDEFGH&#x27;, (64 bits).</span></span><br><span class="line">      <span class="comment"># The following will read bit 0-7 (total of 1 byte) from the right-most</span></span><br><span class="line">      <span class="comment"># bit (the end of the string).</span></span><br><span class="line">      <span class="comment">#  b[7:0] == &#x27;H&#x27;</span></span><br><span class="line">      <span class="comment"># To access the beginning of the string, we need to access the last 16</span></span><br><span class="line">      <span class="comment"># bits, or bits 48-63:</span></span><br><span class="line">      <span class="comment">#  b[63:48] == &#x27;AB&#x27;</span></span><br><span class="line">      <span class="comment"># In this specific case, since we don&#x27;t necessarily know the length of the</span></span><br><span class="line">      <span class="comment"># contents (unless you look at the binary), we can use the following:</span></span><br><span class="line">      <span class="comment">#  b[-1:-16] == &#x27;AB&#x27;, since, in Python, -1 is the end of the list, and -16</span></span><br><span class="line">      <span class="comment"># is the 16th element from the end of the list. The actual numbers should</span></span><br><span class="line">      <span class="comment"># correspond with the length of password_string.</span></span><br><span class="line">      <span class="comment"># (!)</span></span><br><span class="line">      does_src_hold_password = src_contents[-<span class="number">1</span>:-<span class="number">64</span>] == password_string</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Create an expression to check if the dest parameter can be set to</span></span><br><span class="line">      <span class="comment"># buffer_address. If this is true, then we have found our exploit!</span></span><br><span class="line">      <span class="comment"># 创建一个表达式来检查dest参数是否可以设置为buffer_address</span></span><br><span class="line">      <span class="comment"># 如果为真, 我们就找到了漏洞</span></span><br><span class="line">      <span class="comment"># (!)</span></span><br><span class="line">      does_dest_equal_buffer_address = strncpy_dest == buffer_address</span><br><span class="line"></span><br><span class="line">      <span class="comment"># In the previous challenge, we copied the state, added constraints to the</span></span><br><span class="line">      <span class="comment"># copied state, and then determined if the constraints of the new state</span></span><br><span class="line">      <span class="comment"># were satisfiable. Since that pattern is so common, Angr implemented a</span></span><br><span class="line">      <span class="comment"># parameter &#x27;extra_constraints&#x27; for the satisfiable function that does the</span></span><br><span class="line">      <span class="comment"># exact same thing.  Note that we can pass multiple expressions to</span></span><br><span class="line">      <span class="comment"># extra_constraints.</span></span><br><span class="line">      <span class="comment"># 在之前的挑战中, 我们复制了状态, 并给复制的状态添加了约束, 然后判断&lt;复制状态&gt;的约束是否满足</span></span><br><span class="line">      <span class="comment"># 由于这种方法很常见, 所以Angr为可满足函数事项了一个参数&quot;extra_constraints&quot;, 它具有相同的功能</span></span><br><span class="line">      <span class="keyword">if</span> state.satisfiable(extra_constraints=(does_src_hold_password, does_dest_equal_buffer_address)):</span><br><span class="line">        state.add_constraints(does_src_hold_password, does_dest_equal_buffer_address)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>: <span class="comment"># not state.solver.symbolic(???)</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    strncpy_address = <span class="number">0x080490F0</span></span><br><span class="line">    <span class="keyword">if</span> state.addr == strncpy_address:</span><br><span class="line">      <span class="keyword">return</span> check_strncpy(state)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions0&#x27;</span>])</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions1&#x27;</span>], cast_to = <span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(solution0)</span><br><span class="line">    <span class="built_in">print</span>(solution1)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后的代码-11"><a href="#去掉注释后的代码-11" class="headerlink" title="去掉注释后的代码"></a>去掉注释后的代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"><span class="keyword">import</span> claripy</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">  path_to_binary = argv[<span class="number">1</span>]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">    add_options = &#123;angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY, </span><br><span class="line">                   angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">ReplacementScanf</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, format_string, scanf0_address, scanf1_address</span>):</span></span><br><span class="line">      scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">      scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>, <span class="number">20</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> char <span class="keyword">in</span> scanf1.chop(bits=<span class="number">8</span>):</span><br><span class="line">        self.state.add_constraints(char &gt;= <span class="number">0x21</span>, char &lt;= <span class="number">0x7A</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">#scanf0_address = 0x4858554C</span></span><br><span class="line">      self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)</span><br><span class="line">      self.state.memory.store(scanf1_address, scanf1)</span><br><span class="line"></span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions0&#x27;</span>] = scanf0</span><br><span class="line">      self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions1&#x27;</span>] = scanf1</span><br><span class="line"></span><br><span class="line">  scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span>  <span class="comment"># :string</span></span><br><span class="line">  project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">check_strncpy</span>(<span class="params">state</span>):</span></span><br><span class="line">    strncpy_src = state.memory.load(state.regs.esp + <span class="number">8</span>, <span class="number">4</span>, endness = project.arch.memory_endness)    <span class="comment">#这里读错了, 4字节当成位了</span></span><br><span class="line">    strncpy_dest = state.memory.load(state.regs.esp + <span class="number">4</span>, <span class="number">4</span>, endness = project.arch.memory_endness)  <span class="comment"># </span></span><br><span class="line">    strncpy_len = state.memory.load(state.regs.esp + <span class="number">12</span>, <span class="number">4</span>, endness = project.arch.memory_endness) </span><br><span class="line"></span><br><span class="line">    src_contents = state.memory.load(strncpy_src, strncpy_len)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> state.solver.symbolic(strncpy_dest) <span class="keyword">and</span> state.solver.symbolic(src_contents):</span><br><span class="line">      password_string = <span class="string">&#x27;TWOAPNES&#x27;</span> <span class="comment"># :string</span></span><br><span class="line">      buffer_address = <span class="number">0x4858553C</span> <span class="comment"># :integer, probably in hexadecimal</span></span><br><span class="line">      does_src_hold_password = src_contents[-<span class="number">1</span>:-<span class="number">64</span>] == password_string</span><br><span class="line"></span><br><span class="line">      does_dest_equal_buffer_address = strncpy_dest == buffer_address</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> state.satisfiable(extra_constraints=(does_src_hold_password, does_dest_equal_buffer_address)):</span><br><span class="line">        state.add_constraints(does_src_hold_password, does_dest_equal_buffer_address)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(initial_state)</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">    strncpy_address = <span class="number">0x080490F0</span></span><br><span class="line">    <span class="keyword">if</span> state.addr == strncpy_address:</span><br><span class="line">      <span class="keyword">return</span> check_strncpy(state)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  simulation.explore(find=is_successful)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    solution0 = solution_state.solver.<span class="built_in">eval</span>(solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions0&#x27;</span>])</span><br><span class="line">    solution1 = solution_state.solver.<span class="built_in">eval</span>(solution_state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions1&#x27;</span>], cast_to = <span class="built_in">bytes</span>)</span><br><span class="line">    <span class="built_in">print</span>(solution0)</span><br><span class="line">    <span class="built_in">print</span>(solution1)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程:"></a>解题过程:</h2><h3 id="1-Hook掉scanf-实现两个参数的符号化"><a href="#1-Hook掉scanf-实现两个参数的符号化" class="headerlink" title="1. Hook掉scanf, 实现两个参数的符号化"></a>1. Hook掉scanf, 实现两个参数的符号化</h3><p>前几关都有相关的过程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReplacementScanf</span>(<span class="params">angr.SimProcedure</span>):</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, format_string, scanf0_address, scanf1_address</span>):</span></span><br><span class="line">    scanf0 = claripy.BVS(<span class="string">&#x27;scanf0&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">    scanf1 = claripy.BVS(<span class="string">&#x27;scanf1&#x27;</span>, <span class="number">20</span> * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> scanf1.chop(bits=<span class="number">8</span>):</span><br><span class="line">      self.state.add_constraints(char &gt;= <span class="number">0x21</span>, char &lt;= <span class="number">0x7A</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#scanf0_address = 0x4858554C</span></span><br><span class="line">    self.state.memory.store(scanf0_address, scanf0, endness=project.arch.memory_endness)</span><br><span class="line">    self.state.memory.store(scanf1_address, scanf1)</span><br><span class="line"></span><br><span class="line">    self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions0&#x27;</span>] = scanf0</span><br><span class="line">    self.state.<span class="built_in">globals</span>[<span class="string">&#x27;solutions1&#x27;</span>] = scanf1</span><br><span class="line"></span><br><span class="line">scanf_symbol = <span class="string">&#x27;__isoc99_scanf&#x27;</span>  <span class="comment"># :string</span></span><br><span class="line">project.hook_symbol(scanf_symbol, ReplacementScanf())</span><br></pre></td></tr></table></figure>

<h3 id="2-定义check-strncpy-state"><a href="#2-定义check-strncpy-state" class="headerlink" title="2. 定义check_strncpy(state)"></a>2. 定义check_strncpy(state)</h3><p>这一步我们先往下看, 调用了这个函数的地方</p>
<p>可以看到只要我们一调用strncpy, 就会调用这个函数, 也就是说传入check_strncpy的state是刚进入strncpy的state</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">  strncpy_address = <span class="number">0x080490F0</span></span><br><span class="line">  <span class="keyword">if</span> state.addr == strncpy_address:</span><br><span class="line">    <span class="keyword">return</span> check_strncpy(state)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<h3 id="3-根据当前的state获取esp-从而获取参数值"><a href="#3-根据当前的state获取esp-从而获取参数值" class="headerlink" title="3. 根据当前的state获取esp, 从而获取参数值"></a>3. 根据当前的state获取esp, 从而获取参数值</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">strncpy_src = state.memory.load(state.regs.esp + <span class="number">8</span>, <span class="number">4</span>, endness = project.arch.memory_endness)    <span class="comment">#这里读错了, 4字节当成位了</span></span><br><span class="line">strncpy_dest = state.memory.load(state.regs.esp + <span class="number">4</span>, <span class="number">4</span>, endness = project.arch.memory_endness)  <span class="comment"># </span></span><br><span class="line">strncpy_len = state.memory.load(state.regs.esp + <span class="number">12</span>, <span class="number">4</span>, endness = project.arch.memory_endness) </span><br></pre></td></tr></table></figure>

<p>分别获取的源字符串地址, 目标缓冲区地址, 长度变量</p>
<h3 id="4-获取src的内容-即我们为溢出的输入"><a href="#4-获取src的内容-即我们为溢出的输入" class="headerlink" title="4. 获取src的内容(即我们为溢出的输入)"></a>4. 获取src的内容(即我们为溢出的输入)</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">src_contents = state.memory.load(strncpy_src, strncpy_len)</span><br></pre></td></tr></table></figure>

<h3 id="5-验证符号化-验证是否溢出"><a href="#5-验证符号化-验证是否溢出" class="headerlink" title="5. 验证符号化(验证是否溢出)"></a>5. 验证符号化(验证是否溢出)</h3><p>如果我们找到了漏洞的话, 那么此时目标缓冲区地址应该是我们的输入溢出所覆盖的内容, 而前面我们的输入已经符号化了, 所以这个地址应该也是符号化的未知数.同理源字符串地址就是我们的scanf1, 也应该是符号化的.我们就可以根据这两个特征来进行约束, 表示我们成功造成了栈溢出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> state.satisfiable(extra_constraints=(does_src_hold_password, does_dest_equal_buffer_address)):</span><br><span class="line">  state.add_constraints(does_src_hold_password, does_dest_equal_buffer_address)</span><br></pre></td></tr></table></figure>

<h3 id="6-进一步约束"><a href="#6-进一步约束" class="headerlink" title="6. 进一步约束"></a>6. 进一步约束</h3><p>在验证我们了已经造成了栈溢出后, 我们要进行进一步的约束, 以求达到输出”Good Job”的目标</p>
<p>进行了两个约束:</p>
<ul>
<li>约束src(也就是我们的scanf1)的内容为: TWOAPNES</li>
<li>约束dest(栈溢出到dest的那部分)的地址是: secure_buffer的地址</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">password_string = <span class="string">&#x27;TWOAPNES&#x27;</span> <span class="comment"># :string</span></span><br><span class="line">buffer_address = <span class="number">0x4858553C</span> <span class="comment"># :integer, probably in hexadecimal</span></span><br><span class="line">does_src_hold_password = src_contents[-<span class="number">1</span>:-<span class="number">64</span>] == password_string</span><br><span class="line"></span><br><span class="line">does_dest_equal_buffer_address = strncpy_dest == buffer_address</span><br></pre></td></tr></table></figure>

<h3 id="7-检验是否满足条件"><a href="#7-检验是否满足条件" class="headerlink" title="7. 检验是否满足条件"></a>7. 检验是否满足条件</h3><p>见上一关的描述</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> state.satisfiable(extra_constraints=(does_src_hold_password, does_dest_equal_buffer_address)):</span><br><span class="line">  state.add_constraints(does_src_hold_password, does_dest_equal_buffer_address)</span><br></pre></td></tr></table></figure>

<h1 id="17-angr-arbitrary-jump"><a href="#17-angr-arbitrary-jump" class="headerlink" title="17_angr_arbitrary_jump"></a>17_angr_arbitrary_jump</h1><h2 id="编译并运行-12"><a href="#编译并运行-12" class="headerlink" title="编译并运行"></a>编译并运行</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/17_angr_arbitrary_jump$ python3 generate.py 1234 17_angr_arbitrary_jump</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/17_angr_arbitrary_jump$ ./17_angr_arbitrary_j</span><br><span class="line">ump</span><br><span class="line">Enter the password: aaaaa</span><br><span class="line">Try again.</span><br><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/d/TRY/SYC_TODOLIST/angr_ctf/17_angr_arbitrary_jump$</span><br></pre></td></tr></table></figure>

<h2 id="分析-17"><a href="#分析-17" class="headerlink" title="分析"></a>分析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  read_input();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到主函数中没有任何跟”Good Job”相关的函数, 我们使用字符串查找找到了一个print_good()函数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void __noreturn <span class="function"><span class="title">print_good</span></span>()</span><br><span class="line">&#123;</span><br><span class="line">  puts(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是没有任何引用, 这一关要求我们自己构造Jmp实现调用该函数</p>
<p>在read_input()的栈空间中return的地址是紧贴在v1后面的, v1造成栈溢出并将覆盖return的地址就可以实现调用print_good()</p>
<h2 id="使用Angr解题-16"><a href="#使用Angr解题-16" class="headerlink" title="使用Angr解题"></a>使用Angr解题</h2><h3 id="代码-15"><a href="#代码-15" class="headerlink" title="代码"></a>代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># An unconstrained state occurs when there are too many</span></span><br><span class="line"><span class="comment"># possible branches from a single instruction. This occurs, among other ways,</span></span><br><span class="line"><span class="comment"># when the instruction pointer (on x86, eip) is completely symbolic, meaning</span></span><br><span class="line"><span class="comment"># that user input can control the address of code the computer executes.</span></span><br><span class="line"><span class="comment"># For example, imagine the following pseudo assembly:</span></span><br><span class="line"><span class="comment"># 当一条指令有太多分支时, 就会出现不受约束的状态.</span></span><br><span class="line"><span class="comment"># 当指令指针eip成为符号时, 就会发生这种情况, 这意味着用户输入可以控制计算机执行的代码的地址</span></span><br><span class="line"><span class="comment"># 通常Angr遇到不受约束的情况时, 它会将其抛出.</span></span><br><span class="line"><span class="comment"># 而在这一观众我们想利用这种不受约束的情况来条状到我们想要的位置</span></span><br><span class="line"><span class="comment"># 稍后我们将讨论如何禁用Angr的默认行为</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># mov user_input, eax</span></span><br><span class="line"><span class="comment"># jmp eax</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The value of what the user entered dictates the next instruction. This</span></span><br><span class="line"><span class="comment"># is an unconstrained state. It wouldn&#x27;t usually make sense for the execution</span></span><br><span class="line"><span class="comment"># engine to continue. (Where should the program jump to if eax could be</span></span><br><span class="line"><span class="comment"># anything?) Normally, when Angr encounters an unconstrained state, it throws</span></span><br><span class="line"><span class="comment"># it out. In our case, we want to exploit the unconstrained state to jump to</span></span><br><span class="line"><span class="comment"># a location of our choosing. We will get to how to disable Angr&#x27;s default</span></span><br><span class="line"><span class="comment"># behavior later.</span></span><br><span class="line"><span class="comment"># 用户输入的值决定下一条指令, 这是一个不受约束的状态.</span></span><br><span class="line"><span class="comment"># 执行引擎继续运行通常没有意义.</span></span><br><span class="line"><span class="comment"># (如果eax可以是任何东西, 程序应该跳转到哪里)</span></span><br><span class="line"><span class="comment"># 本关我们利用不受约束的状态跳转到我们选择的位置.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This challenge represents a classic stack-based buffer overflow attack to</span></span><br><span class="line"><span class="comment"># overwrite the return address and jump to a function that prints &quot;Good Job.&quot;</span></span><br><span class="line"><span class="comment"># Our strategy for solving the challenge is as follows:</span></span><br><span class="line"><span class="comment"># 1. Initialize the simulation and ask Angr to record unconstrained states.</span></span><br><span class="line"><span class="comment"># 2. Step through the simulation until we have found a state where eip is</span></span><br><span class="line"><span class="comment">#    symbolic.</span></span><br><span class="line"><span class="comment"># 3. Constrain eip to equal the address of the &quot;print_good&quot; function.</span></span><br><span class="line"><span class="comment"># 这一关代表了一个经典的基于堆栈的缓冲区溢出攻击, 覆盖返回值并跳转到打印&quot;Good Job&quot;的函数</span></span><br><span class="line"><span class="comment"># 步骤: </span></span><br><span class="line"><span class="comment"># 1. 初始化模拟并要求Angr记录无状态</span></span><br><span class="line"><span class="comment"># 2. 逐步模拟, 知道我们找到eip变成符号的状态</span></span><br><span class="line"><span class="comment"># 3. 约束eip等于&quot;print_good&quot;函数的地址</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">import angr</span><br><span class="line">import claripy</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">def main(argv):</span><br><span class="line">  path_to_binary = argv[1]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Make a symbolic input that has a decent size to trigger overflow</span></span><br><span class="line">  <span class="comment"># 创建一个合适大小的符号来触发溢出</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  symbolic_input = claripy.BVS(<span class="string">&quot;input&quot;</span>, 8 * 59)</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Create initial state and set stdin to the symbolic input</span></span><br><span class="line">  <span class="comment"># 创建初始状态并将标准输入设置为符号输入</span></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">          stdin=symbolic_input,<span class="comment">#!!!!!!!!!!!!!!!!!!!!!!!!</span></span><br><span class="line">          add_options = &#123;</span><br><span class="line">              angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">              angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS</span><br><span class="line">              &#125;</span><br><span class="line">          )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Ensure that every byte of input is within the acceptable ASCII range (A..Z)</span></span><br><span class="line">  <span class="comment"># 确保输入的每个字符都时可见字符(题目限制的时A到Z)</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  <span class="keyword">for</span> byte <span class="keyword">in</span> symbolic_input.chop(bits=8):</span><br><span class="line">    initial_state.add_constraints(</span><br><span class="line">      claripy.And(</span><br><span class="line">        byte &gt;= <span class="string">&#x27;A&#x27;</span>,</span><br><span class="line">        byte &lt;= <span class="string">&#x27;Z&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># The save_unconstrained=True parameter specifies to Angr to not throw out</span></span><br><span class="line">  <span class="comment"># unconstrained states. Instead, it will move them to the list called</span></span><br><span class="line">  <span class="comment"># &#x27;simulation.unconstrained&#x27;.  Additionally, we will be using a few stashes</span></span><br><span class="line">  <span class="comment"># that are not included by default, such as &#x27;found&#x27; and &#x27;not_needed&#x27;. You will</span></span><br><span class="line">  <span class="comment"># see how these are used later.</span></span><br><span class="line">  <span class="comment"># save_unconstrained = True参数指定Angr不抛出不受约束的状态</span></span><br><span class="line">  <span class="comment"># 相对应, 它将会将这些状态添加到&quot;simulation.unconstrained&quot;列表中</span></span><br><span class="line">  <span class="comment"># 此外, 我们将使用一些默认情况下不包含的存储, 例如&quot;found&quot;和&quot;not_needed&quot;</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  simulation = project.factory.simgr(</span><br><span class="line">    initial_state,</span><br><span class="line">    save_unconstrained=True,</span><br><span class="line">    stashes=&#123;</span><br><span class="line">      <span class="string">&#x27;active&#x27;</span> : [initial_state],</span><br><span class="line">      <span class="string">&#x27;unconstrained&#x27;</span> : [],</span><br><span class="line">      <span class="string">&#x27;found&#x27;</span> : [],</span><br><span class="line">      <span class="string">&#x27;not_needed&#x27;</span> : []</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment"># Explore will not work for us, since the method specified with the &#x27;find&#x27;</span></span><br><span class="line">  <span class="comment"># parameter will not be called on an unconstrained state. Instead, we want to</span></span><br><span class="line">  <span class="comment"># explore the binary ourselves. To get started, construct an exit condition</span></span><br><span class="line">  <span class="comment"># to know when the simulation has found a solution. We will later move</span></span><br><span class="line">  <span class="comment"># states from the unconstrained list to the simulation.found list.</span></span><br><span class="line">  <span class="comment"># Create a boolean value that indicates a state has been found.</span></span><br><span class="line">  <span class="comment"># 负责约束的explore不再起作用了, 因为find参数指定的方法在不受约束的情况下失效</span></span><br><span class="line">  <span class="comment"># 我们需要自己探索二进制文件</span></span><br><span class="line">  <span class="comment"># 首先, 构造退出条件, 当simulation发现解决方案时我们就可以知道这一消息.</span></span><br><span class="line">  <span class="comment"># 我们稍后会将state从不受约束的列表移动到simulation.found列表</span></span><br><span class="line">  <span class="comment"># 并创建一个bool值标识一个被找到的state</span></span><br><span class="line">  def has_found_solution():</span><br><span class="line">    <span class="built_in">return</span> simulation.found</span><br><span class="line"></span><br><span class="line">  <span class="comment"># An unconstrained state occurs when there are too many possible branches</span></span><br><span class="line">  <span class="comment"># from a single instruction. This occurs, among other ways, when the</span></span><br><span class="line">  <span class="comment"># instruction pointer (on x86, eip) is completely symbolic, meaning</span></span><br><span class="line">  <span class="comment"># that user input can control the address of code the computer executes.</span></span><br><span class="line">  <span class="comment"># For example, imagine the following pseudo assembly:</span></span><br><span class="line">  <span class="comment"># 当一条指令有太多&lt;可能分支&gt;时, 就会出现不受约束的状态(比如JMP 可以跳转的地址有太多了)</span></span><br><span class="line">  <span class="comment"># 当EIP时符号时就会出现这种情况, 这意味着用户输入可以控制计算机执行代码的地址.</span></span><br><span class="line">  <span class="comment"># 例如下面的汇编(ATT风格的)</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># mov user_input, eax</span></span><br><span class="line">  <span class="comment"># jmp eax</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># The value of what the user entered dictates the next instruction. This</span></span><br><span class="line">  <span class="comment"># is an unconstrained state. It wouldn&#x27;t usually make sense for the execution</span></span><br><span class="line">  <span class="comment"># engine to continue. (Where should the program jump to if eax could be</span></span><br><span class="line">  <span class="comment"># anything?) Normally, when Angr encounters an unconstrained state, it throws</span></span><br><span class="line">  <span class="comment"># it out. In our case, we want to exploit the unconstrained state to jump to</span></span><br><span class="line">  <span class="comment"># a location of our choosing.  Check if there are still unconstrained states</span></span><br><span class="line">  <span class="comment"># by examining the simulation.unconstrained list.</span></span><br><span class="line">  <span class="comment"># 用户输入的数据决定了下一条指令的. 这就是一个不受约束的state</span></span><br><span class="line">  <span class="comment"># 执行引擎继续运行通常没有意义(如果eax可以是任何值, 程序应该跳到哪里)</span></span><br><span class="line">  <span class="comment"># Angr遇见这种情况, 通常会抛出异常</span></span><br><span class="line">  <span class="comment"># 而在这一关中, 我们想利用这个不受约束的状态来跳转到我们的print_good()函数</span></span><br><span class="line">  <span class="comment"># 通过检查Simultion.unconstrained列表检查是否仍然存在不受约束的状态</span></span><br><span class="line">  <span class="comment"># </span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  def has_unconstrained_to_check():</span><br><span class="line">    <span class="built_in">return</span> simulation.unconstrained</span><br><span class="line"></span><br><span class="line">  <span class="comment"># The list simulation.active is a list of all states that can be explored</span></span><br><span class="line">  <span class="comment"># further.</span></span><br><span class="line">  <span class="comment"># 列表simulation.active是可以进一步探索所有状态的列表</span></span><br><span class="line">  <span class="comment"># (!)</span></span><br><span class="line">  def has_active():</span><br><span class="line">    <span class="built_in">return</span> simulation.active</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (has_active() or has_unconstrained_to_check()) and (not has_found_solution()):</span><br><span class="line">    <span class="keyword">for</span> unconstrained_state <span class="keyword">in</span> simulation.unconstrained:</span><br><span class="line">      def should_move(s):</span><br><span class="line">        <span class="built_in">return</span> s is unconstrained_state</span><br><span class="line">        <span class="comment"># Look for unconstrained states and move them to the &#x27;found&#x27; stash.</span></span><br><span class="line">        <span class="comment"># A &#x27;stash&#x27; should be a string that corresponds to a list that stores</span></span><br><span class="line">        <span class="comment"># all the states that the state group keeps. Values include:</span></span><br><span class="line">        <span class="comment">#  &#x27;active&#x27; = states that can be stepped</span></span><br><span class="line">        <span class="comment">#  &#x27;deadended&#x27; = states that have exited the program</span></span><br><span class="line">        <span class="comment">#  &#x27;errored&#x27; = states that encountered an error with Angr</span></span><br><span class="line">        <span class="comment">#  &#x27;unconstrained&#x27; = states that are unconstrained</span></span><br><span class="line">        <span class="comment">#  &#x27;found&#x27; = solutions</span></span><br><span class="line">        <span class="comment">#  anything else = whatever you want, perhaps you want a &#x27;not_needed&#x27;,</span></span><br><span class="line">        <span class="comment">#                  you can call it whatever you want</span></span><br><span class="line">        <span class="comment"># (!)</span></span><br><span class="line">        <span class="comment"># 寻找不受约束的状态并将它们移动到&#x27;found&#x27;stash中, &#x27;stash&#x27;应该是一个字符串, 对应于一个存储state组所保留的所有state的列表</span></span><br><span class="line">      simulation.move(<span class="string">&#x27;unconstrained&#x27;</span>, <span class="string">&#x27;found&#x27;</span>, filter_func = should_move)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Advance the simulation.</span></span><br><span class="line">    simulation.step()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[0]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Constrain the instruction pointer to target the print_good function and</span></span><br><span class="line">    <span class="comment"># then solve for the user input (recall that this is</span></span><br><span class="line">    <span class="comment"># &#x27;solution_state.posix.dumps(sys.stdin.fileno())&#x27;)</span></span><br><span class="line">    <span class="comment"># 约束指令指针指向print_good函数, 然后求解用户输入</span></span><br><span class="line">    <span class="comment"># (!)</span></span><br><span class="line">    solution_state.add_constraints(solution_state.regs.eip == 0x48585558)</span><br><span class="line"></span><br><span class="line">    solution = solution_state.posix.dumps(sys.stdin.fileno()).decode()</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    raise Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="去掉注释后的代码-12"><a href="#去掉注释后的代码-12" class="headerlink" title="去掉注释后的代码"></a>去掉注释后的代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">import angr</span><br><span class="line">import claripy</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">def main(argv):</span><br><span class="line">  path_to_binary = argv[1]</span><br><span class="line">  project = angr.Project(path_to_binary)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  symbolic_input = claripy.BVS(<span class="string">&quot;input&quot;</span>, 8 * 59)</span><br><span class="line"></span><br><span class="line">  initial_state = project.factory.entry_state(</span><br><span class="line">          stdin=symbolic_input,</span><br><span class="line">          add_options = &#123;</span><br><span class="line">              angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">              angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS</span><br><span class="line">              &#125;</span><br><span class="line">          )</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> byte <span class="keyword">in</span> symbolic_input.chop(bits=8):</span><br><span class="line">    initial_state.add_constraints(</span><br><span class="line">      claripy.And(</span><br><span class="line">        byte &gt;= <span class="string">&#x27;A&#x27;</span>,</span><br><span class="line">        byte &lt;= <span class="string">&#x27;Z&#x27;</span></span><br><span class="line">      )</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">  simulation = project.factory.simgr(</span><br><span class="line">    initial_state,</span><br><span class="line">    save_unconstrained=True,</span><br><span class="line">    stashes=&#123;</span><br><span class="line">      <span class="string">&#x27;active&#x27;</span> : [initial_state],</span><br><span class="line">      <span class="string">&#x27;unconstrained&#x27;</span> : [],</span><br><span class="line">      <span class="string">&#x27;found&#x27;</span> : [],</span><br><span class="line">      <span class="string">&#x27;not_needed&#x27;</span> : []</span><br><span class="line">    &#125;</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  def has_found_solution():</span><br><span class="line">    <span class="built_in">return</span> simulation.found</span><br><span class="line"></span><br><span class="line">  def has_unconstrained_to_check():</span><br><span class="line">    <span class="built_in">return</span> simulation.unconstrained</span><br><span class="line"></span><br><span class="line">  def has_active():</span><br><span class="line">    <span class="built_in">return</span> simulation.active</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (has_active() or has_unconstrained_to_check()) and (not has_found_solution()):</span><br><span class="line">    <span class="keyword">for</span> unconstrained_state <span class="keyword">in</span> simulation.unconstrained:</span><br><span class="line">      def should_move(s):</span><br><span class="line">        <span class="built_in">return</span> s is unconstrained_state</span><br><span class="line"></span><br><span class="line">      simulation.move(<span class="string">&#x27;unconstrained&#x27;</span>, <span class="string">&#x27;found&#x27;</span>, filter_func = should_move)</span><br><span class="line"></span><br><span class="line">    simulation.step()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> simulation.found:</span><br><span class="line">    solution_state = simulation.found[0]</span><br><span class="line"></span><br><span class="line">    solution_state.add_constraints(solution_state.regs.eip == 0x48585558)</span><br><span class="line"></span><br><span class="line">    solution = solution_state.posix.dumps(sys.stdin.fileno()).decode()</span><br><span class="line">    <span class="built_in">print</span>(solution)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    raise Exception(<span class="string">&#x27;Could not find the solution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">  main(sys.argv)</span><br></pre></td></tr></table></figure>

<p>有点奇怪的就是符号的长度试了只能是59字节及其以上, 但是我们实际溢出所需要的字节数只是52个字节</p>
<p><img src="/2022/05/18/AngrLab2c872/image8.png" alt="image.png"></p>
<p>而且得到的输出后面的也是无用的字符</p>
<p><code>AAAABAABBAAAABAABBBABBBBBBBABBBAAABBAABABABBABBBXUXHBABAABB</code></p>
<p>只有XUXH是我们要覆盖的返回地址, 后面的<code>ABAABB</code>都没有用, 但是不使用长度为&gt;=59bytes的符号就跑不出来.</p>
<h1 id="Angr-Lab常用的函数"><a href="#Angr-Lab常用的函数" class="headerlink" title="Angr_Lab常用的函数"></a>Angr_Lab常用的函数</h1><h2 id="angr-Project-path-to-binary"><a href="#angr-Project-path-to-binary" class="headerlink" title="angr.Project(path_to_binary)"></a>angr.Project(path_to_binary)</h2><p>这个函数的作用是建立Angr项目, 参数path_to_binary是二进制文件的路径</p>
<h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">path_to_binary = argv[<span class="number">1</span>] <span class="comment">#用执行参数得到文件路径</span></span><br><span class="line">project = angr.Project(path_to_binary) <span class="comment">#在该二进制文件上建立Angr项目</span></span><br></pre></td></tr></table></figure>

<h2 id="project-factory-entry-state-add-options"><a href="#project-factory-entry-state-add-options" class="headerlink" title="project.factory.entry_state(add_options = {})"></a>project.factory.entry_state(add_options = {})</h2><p>设置执行起始状态, 指示Angr从main函数开始执行</p>
<h3 id="使用示例-1"><a href="#使用示例-1" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">initial_state = project.factory.entry_state(</span><br><span class="line">  add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                  angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="project-factory-blank-state-addr-add-options"><a href="#project-factory-blank-state-addr-add-options" class="headerlink" title="project.factory.blank_state(addr = , add_options = {})"></a>project.factory.blank_state(addr = , add_options = {})</h2><p>设置执行起始状态, 指示Angr从指定的地址处开始执行. </p>
<p>注意容易和上一个函数混淆: 一个是<code>entry_state</code>, 一个是<code>blank_state</code></p>
<h3 id="使用示例-2"><a href="#使用示例-2" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">initial_state = project.factory.blank_state(</span><br><span class="line">    addr=start_address,</span><br><span class="line">    add_options = &#123; angr.options.SYMBOL_FILL_UNCONSTRAINED_MEMORY,</span><br><span class="line">                    angr.options.SYMBOL_FILL_UNCONSTRAINED_REGISTERS&#125;</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>

<h2 id="claripy-BVS-‘’-num"><a href="#claripy-BVS-‘’-num" class="headerlink" title="claripy.BVS(‘’, num)"></a>claripy.BVS(‘’, num)</h2><p>创建符号位向量, 第一个参数是符号名, 第二个参数是符号位向量的长度(bit为单位)</p>
<h3 id="使用示例-3"><a href="#使用示例-3" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">password_size_bits = <span class="number">32</span></span><br><span class="line">password0 = claripy.BVS(<span class="string">&#x27;password0&#x27;</span>, password_size_bits)</span><br><span class="line">password1 = claripy.BVS(<span class="string">&#x27;password1&#x27;</span>, password_size_bits)</span><br></pre></td></tr></table></figure>

<h2 id="simulation-explore-find-avoid"><a href="#simulation-explore-find-avoid" class="headerlink" title="simulation.explore(find= , avoid=)"></a>simulation.explore(find= , avoid=)</h2><p>符号执行, find表示&lt;接受路径&gt;, avoid表示&lt;避免路径&gt;</p>
<p>两个参数的形式是多样的</p>
<h3 id="使用地址为参数"><a href="#使用地址为参数" class="headerlink" title="使用地址为参数"></a>使用地址为参数</h3><p>当用地址为参数时, find和avoid都接受地址来作为&lt;接受/避免路径&gt;</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print_good_address = <span class="number">0x080492F3</span></span><br><span class="line">simulation.explore(find=print_good_address)</span><br></pre></td></tr></table></figure>

<h3 id="使用回调函数作为参数"><a href="#使用回调函数作为参数" class="headerlink" title="使用回调函数作为参数"></a>使用回调函数作为参数</h3><p>当使用回到函数作为参数时, 其函数返回值要为True或False, 而不是地址.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_successful</span>(<span class="params">state</span>):</span></span><br><span class="line">  stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;Good Job&quot;</span>.encode() <span class="keyword">in</span> stdout_output<span class="comment">#如果&quot;Good Job.&quot;字符串在标准输出中, 则返回真</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">should_abort</span>(<span class="params">state</span>):</span></span><br><span class="line">  stdout_output = state.posix.dumps(sys.stdout.fileno())</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="string">&quot;Try again&quot;</span>.encode() <span class="keyword">in</span> stdout_output<span class="comment">#如果&quot;Tyr again.&quot;字符串在标准输出中, 则返回真</span></span><br><span class="line"></span><br><span class="line">simulation.explore(find=is_successful, avoid=should_abort)</span><br></pre></td></tr></table></figure>

<h2 id="solution-state-posix-dumps-sys-stdin-fileno"><a href="#solution-state-posix-dumps-sys-stdin-fileno" class="headerlink" title="solution_state.posix.dumps(sys.stdin.fileno())"></a>solution_state.posix.dumps(sys.stdin.fileno())</h2><p>当使用默认的符号注入时, 最终得到的符号就是sys.stdin.fileno()</p>
<h3 id="使用示例-4"><a href="#使用示例-4" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(solution_state.posix.dumps(sys.stdin.fileno()).decode())<span class="comment"># 解码为unicode并打印</span></span><br></pre></td></tr></table></figure>

<h2 id="solution-state-add-constraints-solution-state-xx"><a href="#solution-state-add-constraints-solution-state-xx" class="headerlink" title="solution_state.add_constraints( solution_state.xx)"></a>solution_state.add_constraints( solution_state.xx)</h2><p>添加约束条件, 注意这个状态一定要用solution_state(之前用成了initial_state)</p>
<h3 id="使用示例-5"><a href="#使用示例-5" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">solution_state = simulation.found[<span class="number">0</span>]  </span><br><span class="line">solution_state.add_constraints( solution_state.regs.eax != <span class="number">0</span> )</span><br><span class="line">solution = solution_state.solver.eval(password, cast_to = bytes)</span><br></pre></td></tr></table></figure>

<h2 id="solution-state-solver-eval-symbol"><a href="#solution-state-solver-eval-symbol" class="headerlink" title="solution_state.solver.eval(symbol)"></a>solution_state.solver.eval(symbol)</h2><p>我们自己创建符号并求解的时候, 就需要使用这个函数来约束求解符号的值.</p>
<h3 id="使用示例-6"><a href="#使用示例-6" class="headerlink" title="使用示例"></a>使用示例</h3><h4 id="整数"><a href="#整数" class="headerlink" title="整数"></a>整数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> simulation.found:</span><br><span class="line">  solution_state = simulation.found[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">  solution0 = solution_state.solver.<span class="built_in">eval</span>(password0)</span><br><span class="line">  solution1 = solution_state.solver.<span class="built_in">eval</span>(password1)</span><br><span class="line">  solution2 = solution_state.solver.<span class="built_in">eval</span>(password2)</span><br><span class="line"></span><br><span class="line">  solution = <span class="built_in">str</span>(<span class="built_in">hex</span>(solution0)) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(solution1)) + <span class="string">&#x27; &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">hex</span>(solution2))   <span class="comment"># :string, 注意这里要转换成十六进制, 因为scanf用的是%x</span></span><br><span class="line">  <span class="built_in">print</span>(solution)</span><br></pre></td></tr></table></figure>

<h4 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">solution = solution_state.solver.eval(password,cast_to=bytes)</span><br></pre></td></tr></table></figure>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">LamのCrow</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/05/18/AngrLab2c872/">http://example.com/2022/05/18/AngrLab2c872/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com">LamのCrow</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E9%80%86%E5%90%91/">逆向</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2023/05/13/flagio/"><i class="fa fa-chevron-left">  </i><span>XCTF2023 flagio</span></a></div><div class="next-post pull-right"><a href="/2022/05/08/%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E5%99%A8%E7%BC%96%E5%86%99and375a52cb87b22005816fe7a418ec6660/"><span>文件解析器编写</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s4.ax1x.com/2021/12/06/oy2VdH.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2023 By LamのCrow</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">追求幸福</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"right","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>