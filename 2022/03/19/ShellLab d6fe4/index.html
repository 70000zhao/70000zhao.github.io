<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="CSAPP-ShellLab"><meta name="keywords" content="CSAPP"><meta name="author" content="LamのCrow"><meta name="copyright" content="LamのCrow"><title>CSAPP-ShellLab | LamのCrow</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ShellLab"><span class="toc-number">1.</span> <span class="toc-text">ShellLab</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%99%E8%AE%AD"><span class="toc-number">2.</span> <span class="toc-text">教训</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E5%85%B3"><span class="toc-number">3.</span> <span class="toc-text">第一关</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%85%B3"><span class="toc-number">4.</span> <span class="toc-text">第二关</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E5%85%B3"><span class="toc-number">5.</span> <span class="toc-text">第三关</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E5%85%B3"><span class="toc-number">6.</span> <span class="toc-text">第四关</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E5%85%B3"><span class="toc-number">7.</span> <span class="toc-text">第五关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%AD%A3"><span class="toc-number">7.1.</span> <span class="toc-text">修正</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%E4%BF%AE%E6%AD%A3"><span class="toc-number">7.1.1.</span> <span class="toc-text">第一步修正</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%E4%BF%AE%E6%AD%A3"><span class="toc-number">7.1.2.</span> <span class="toc-text">第二步修正</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5%E4%BF%AE%E6%94%B9"><span class="toc-number">7.1.3.</span> <span class="toc-text">第三步修改</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AD%E5%85%B3"><span class="toc-number">8.</span> <span class="toc-text">第六关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E9%AA%8C"><span class="toc-number">8.1.</span> <span class="toc-text">检验</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%83%E5%85%B3"><span class="toc-number">9.</span> <span class="toc-text">第七关</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%85%AB%E5%85%B3"><span class="toc-number">10.</span> <span class="toc-text">第八关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E9%AA%8C-1"><span class="toc-number">10.1.</span> <span class="toc-text">检验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%9A%84%E7%BB%93%E6%9E%9C"><span class="toc-number">10.2.</span> <span class="toc-text">实现的结果</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E5%AE%A4%E6%8F%90%E4%BE%9B%E7%9A%84%E7%BB%93%E6%9E%9C"><span class="toc-number">10.3.</span> <span class="toc-text">实验室提供的结果</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B9%9D%E5%85%B3"><span class="toc-number">11.</span> <span class="toc-text">第九关</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A3%80%E9%AA%8C-2"><span class="toc-number">12.</span> <span class="toc-text">检验</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E5%85%B3"><span class="toc-number">13.</span> <span class="toc-text">第十关</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A3%80%E9%AA%8C-3"><span class="toc-number">14.</span> <span class="toc-text">检验</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%80%E5%85%B3"><span class="toc-number">15.</span> <span class="toc-text">第十一关</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A3%80%E9%AA%8C-4"><span class="toc-number">16.</span> <span class="toc-text">检验</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%BA%8C%E5%85%B3"><span class="toc-number">17.</span> <span class="toc-text">第十二关</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%B8%89%E5%85%B3"><span class="toc-number">18.</span> <span class="toc-text">第十三关</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E5%9B%9B%E5%85%B3"><span class="toc-number">19.</span> <span class="toc-text">第十四关</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E9%AA%8C-5"><span class="toc-number">19.1.</span> <span class="toc-text">检验</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E5%8D%81%E4%BA%94%E5%85%B3-%E7%AC%AC%E5%8D%81%E5%85%AD%E5%85%B3"><span class="toc-number">20.</span> <span class="toc-text">第十五关,  第十六关</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AD%A6%E6%83%95"><span class="toc-number">21.</span> <span class="toc-text">警惕</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://s4.ax1x.com/2021/12/07/oyWTJA.jpg"></div><div class="author-info__name text-center">LamのCrow</div><div class="author-info__description text-center">欢迎交流!!!</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">30</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">2</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://space.bilibili.com/202089320">MyBIlibili</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://sma11cc.github.io/">smallcc</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s4.ax1x.com/2021/12/06/oy2VdH.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">LamのCrow</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">CSAPP-ShellLab</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-03-19</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="ShellLab"><a href="#ShellLab" class="headerlink" title="ShellLab"></a>ShellLab</h1><span id="more"></span>

<h1 id="教训"><a href="#教训" class="headerlink" title="教训"></a>教训</h1><p>一开始并没有仔细看题目,  没有按照关卡一步一步完善shell,  把什么父子进程竞争,  前台进程挂起shell,  作业添加删除………杂七杂八的东西一股脑全写上去,  最终导致的结果就是拿去运行了一下,  连最基本的quit指令都运行不了,  提示是段错误(核心已转储).  忙活两天还是个小丑.</p>
<p>所以还是得扎扎实实一步一步来.  先把书看明白了,  然后把实验说明书看完了(虽然是英文的,  但是还得看).  再来做这个shell lab.</p>
<h1 id="第一关"><a href="#第一关" class="headerlink" title="第一关"></a>第一关</h1><p>不用做任何调整都是对的</p>
<p><img src="/2022/03/19/ShellLab%20d6fe4/Untitled.png" alt="Untitled"></p>
<h1 id="第二关"><a href="#第二关" class="headerlink" title="第二关"></a>第二关</h1><p>测试quit指令,  直接在builtin_cmd里修改即可</p>
<p><img src="/2022/03/19/ShellLab%20d6fe4/Untitled%201.png" alt="Untitled"></p>
<p>测试一下, 是正确的</p>
<p><img src="/2022/03/19/ShellLab%20d6fe4/Untitled%202.png" alt="Untitled"></p>
<h1 id="第三关"><a href="#第三关" class="headerlink" title="第三关"></a>第三关</h1><p>这一关是运行一个前台作业, 这就要求对shell建立起一个基本框架了.</p>
<p>我是在第四关的时候才想起来要写WP,  所以这里的代码没有粘贴下来,  但是大部分都是参考书中P525的代码.  这一道题的前台进程不用挂起shell也是正确的,  所以照抄应该也能过.</p>
<h1 id="第四关"><a href="#第四关" class="headerlink" title="第四关"></a>第四关</h1><p>这一关是先运行一个前台进程(第一条指令用的是Linux的绝对路径,  一开始没看出来,  后来参考别人的实验博客才知道是运行一个打印字符串的前台进程),  然后再运行一个后台进程.</p>
<p>涉及到的知识点:</p>
<ul>
<li>因为运行后台进程后要打印作业信息,  所以我们要添加和删除作业信息</li>
<li>前台进程需要挂起</li>
<li>父子进程之间的race</li>
</ul>
<p>贴一下代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> <span class="keyword">pid_t</span> hangpid;<span class="comment">//用于挂起的while循环判断</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">eval</span><span class="params">(<span class="keyword">char</span> *cmdline)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *argv[MAXARGS];</span><br><span class="line">    <span class="keyword">char</span> buf[MAXLINE];</span><br><span class="line">    <span class="keyword">int</span> bg;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> bgjid;</span><br><span class="line">    <span class="keyword">sigset_t</span> mask_all_job, prev_all_job;<span class="comment">//为作业设置而成立的信号集合</span></span><br><span class="line">    <span class="keyword">sigset_t</span> mask_hang, prev_hang;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*这里的信号设置针对工作添加*/</span></span><br><span class="line">    sigfillset(&amp;mask_all_job);</span><br><span class="line">    signal(SIGCHLD, sigchld_handler);</span><br><span class="line">    <span class="built_in">strcpy</span>(buf, cmdline);</span><br><span class="line">    <span class="comment">/*这里的信号针对父子进程race*/</span></span><br><span class="line">    sigemptyset(&amp;mask_hang);</span><br><span class="line">    sigaddset(&amp;mask_hang, SIGCHLD);</span><br><span class="line"></span><br><span class="line">    bg = parseline(cmdline, argv);</span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">0</span>] == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!builtin_cmd(argv))</span><br><span class="line">    &#123;   </span><br><span class="line">        sigprocmask(SIG_BLOCK, &amp;mask_hang, &amp;prev_hang);<span class="comment">//这里阻塞是为了防止父子进程间的竞争,  防止先delete后add</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (execve(argv[<span class="number">0</span>], argv, environ) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Command not found.\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!bg)&#123;</span><br><span class="line">            hangpid = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">/*这里针对job的信号阻塞是防止addjob被中断, 但是我看其他人的博客并没有这样的操作, 所以后面可能会修改*/</span></span><br><span class="line">            sigprocmask(SIG_BLOCK, &amp;mask_all_job, &amp;prev_all_job);</span><br><span class="line">            addjob(jobs, pid, <span class="number">1</span>, cmdline);</span><br><span class="line">            sigprocmask(SIG_SETMASK, &amp;prev_all_job, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="comment">/*挂起父进程,  等待SIGCHLD*/</span></span><br><span class="line">            waitfg(hangpid);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>&#123;   <span class="comment">/*这里针对job的信号阻塞是防止addjob被中断, 但是我看其他人的博客并没有这样的操作, 所以后面可能会修改*/</span></span><br><span class="line">            sigprocmask(SIG_BLOCK, &amp;mask_all_job, &amp;prev_all_job);</span><br><span class="line">            addjob(jobs, pid, <span class="number">2</span>, cmdline);</span><br><span class="line">            sigprocmask(SIG_SETMASK, &amp;prev_all_job, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">            bgjid = pid2jid(pid);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, bgjid, pid, cmdline);</span><br><span class="line">        &#125;      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">waitfg</span><span class="params">(<span class="keyword">pid_t</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">sigset_t</span> prev_hang;</span><br><span class="line"></span><br><span class="line">    sigemptyset(&amp;prev_hang);</span><br><span class="line">    <span class="keyword">while</span> (!hangpid)</span><br><span class="line">        sigsuspend(&amp;prev_hang);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigchld_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> olderrno = errno;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">sigset_t</span> mask_all_job, prev_all_job;<span class="comment">//为job创建的信号集合</span></span><br><span class="line"></span><br><span class="line">    sigfillset(&amp;mask_all_job);</span><br><span class="line">    <span class="comment">/*1.hangpid使得父进程不再挂起;  2.删除作业*/</span></span><br><span class="line">    <span class="keyword">while</span> ((hangpid = waitpid(<span class="number">-1</span>, <span class="literal">NULL</span>, <span class="number">0</span>)) &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sigprocmask(SIG_BLOCK, &amp;mask_all_job, &amp;prev_all_job);</span><br><span class="line">        deletejob(jobs, hangpid);</span><br><span class="line">        sigprocmask(SIG_SETMASK, &amp;prev_all_job, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (errno != ECHILD)</span><br><span class="line">        unix_error(<span class="string">&quot;waitpid error&quot;</span>);</span><br><span class="line">    errno = olderrno;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">中间有个错误没注意,  导致shell一直被挂起.</span><br><span class="line">就是waitfg的形式参数设置为hangpid跟全局变量hangpid冲突.</span><br></pre></td></tr></table></figure>

<p>最后检验一下</p>
<p><img src="/2022/03/19/ShellLab%20d6fe4/Untitled%203.png" alt="Untitled"></p>
<h1 id="第五关"><a href="#第五关" class="headerlink" title="第五关"></a>第五关</h1><p>这一关是运行两个后台作业,  并用jobs内置指令打印出两个作业的信息.  (但其实是运行了三个前台进程,  两个后台进程.  这个检验指令的机制应该是屏蔽掉了我们对shell的输入,  只保留了shell对我们的输出.  总而言之,  我们是可以把这个这些行为当成是运行两个后台作业,  然后打印作业信息.)</p>
<p>这道题的涉及的知识点:</p>
<ul>
<li>waitpid的option的选择</li>
<li>如何使用fgpid来实现前台进程挂起,  而不是我们之前用到的全局变量hangpid</li>
<li>对于我个人而言(因为前面eval有漏洞),  我还要考虑到修改hangpid的影响</li>
<li>jobs内置指令的实现</li>
</ul>
<p>关于前台进程挂起的实现,  在第四关是使用书上的方法,  但是在书中的情景没有题目那么复杂:  书中的挂起是单个前台作业,  而没有后台作业;  但是在我们实现第五关时却有两个后台作业. </p>
<h2 id="修正"><a href="#修正" class="headerlink" title="修正"></a>修正</h2><p>首先要知道我在哪里错了,  在我的调试中:  我的后台进程会使得shell挂起,  直到终止,  最终导致了我在使用jobs指令后什么都没有打印出来.</p>
<h3 id="第一步修正"><a href="#第一步修正" class="headerlink" title="第一步修正"></a>第一步修正</h3><p>我首先发现的是<code>sigchld_handler()</code>中的<code>while ((hangpid = waitpid(-1, NULL, 0)) &gt; 0)</code>的存在错误,  我们假设有两个后台进程在同一个进程组中,  当第一个后台进程终止时会发送SIGCHLD信号给内核,  然后进入<code>sigchld_handler()</code>中,  回收完第一个后台进程后,  又会继续循环,  但是我们的第三个参数为0,  也就是默认行为,  waitpid会等待第二个后台进程结束发送信号.  而我们这道题一个后台作业的实际实现是:  先运行一个前台作业打印我们的输入,  然后再运行我们的后台作业,  我认为这两个作业的父进程都是shell(虽然它们的作业组不一样),  这样当第一个前台进程结束的时候,  waitpid会等待后台进程结束.  所以我们修改掉waitpid的默认行为为对停止和终止不等待<code>WNOHANG | WUNTRACED</code></p>
<p>修改完了以后,  发现还是不行, 甚至连第五关的整个流程都跑不完了.</p>
<h3 id="第二步修正"><a href="#第二步修正" class="headerlink" title="第二步修正"></a>第二步修正</h3><p>然后发现的是hangpid的问题,  经过检验发现实际实现用到的前台进程再改完了以后,  用于判断是否挂起的全局变量hangpid再最终判断处<code>while (!hangpid)</code>一直都是0,  也就导致了前台进程一直挂起.原因是:  </p>
<ul>
<li>在我们修改waitpid默认行为前,  <code>sigchld_handler()</code>的实际处理方式是一直等待SIGCHLD信号,  直到不再有子进程;  也就是说返回值给hangpid只会是非零数(即便发生错误,  也返回的是负数而不是零),  这导致了不管怎样到了最后挂起都会被终止.</li>
<li>而我们将waitpid的默认行为修改后,  <code>sigchld_handler()</code>的处理方式是不等待了,  当处理完了一个僵死进程后,  如果后面没有更多的僵死进程了,  那就直接返回0;  再结合while循环,  也就是说到了循环的最后hangpid都会是零.  在题目的情境下,  挂起了第一个前台作业, 然后前台作业终止,   进入<code>sigchld_handler()</code>中,  第一次循环hangpid为回收的pid,  然后回到循环检查,  第二次检查hangpid被赋值为0.  离开<code>sigchld_handler()</code>函数,  来到挂起判断那里,  就一直挂起了</li>
</ul>
<p>所以我们的第一部修正是没有问题的,  问题在于我们不应该使用hangpid来作为挂起判断依据.</p>
<p>我们将用fgpid()函数来代替hangpid判断是否需要挂起.(这里是参考了别人的博客的,  其实博客里的一些东西实验说明书有.  才发现读实验说明书是真的很重要!!!!!,  里面会教你使用实验室,  给你hint,  给你更详细的实验要求.)</p>
<p>fgpid()函数是直接查找你的作业列表里面没有前台作业,  如果有就挂起, 如果没有就取消挂起.  在<code>sigchld_handler()</code>中我们就删除了第一个前台作业了,  所以使用这个就可以不用管waitpid的返回值是什么了.非常好用.</p>
<h3 id="第三步修改"><a href="#第三步修改" class="headerlink" title="第三步修改"></a>第三步修改</h3><p>前面的两步修改其实已经完成了我们的主要工作了,  这个第三步修改主要是清理掉已经没有用处的hangpid,  详细的就是在<code>sigchld_handler()</code>中把所有的hangpid换成局部变量pid,  然后删除掉在eval中的hangpid,  以及hangpid的定义</p>
<p>一下是我的代码:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">eval</span><span class="params">(<span class="keyword">char</span> *cmdline)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *argv[MAXARGS];</span><br><span class="line">    <span class="keyword">char</span> buf[MAXLINE];</span><br><span class="line">    <span class="keyword">int</span> bg;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> bgjid;</span><br><span class="line">    <span class="keyword">sigset_t</span> mask_all_job, prev_all_job;<span class="comment">//为作业设置而成立的信号集合</span></span><br><span class="line">    <span class="keyword">sigset_t</span> mask_hang, prev_hang;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*这里的信号设置针对工作添加*/</span></span><br><span class="line">    sigfillset(&amp;mask_all_job);</span><br><span class="line">    signal(SIGCHLD, sigchld_handler);</span><br><span class="line">    <span class="built_in">strcpy</span>(buf, cmdline);</span><br><span class="line">    <span class="comment">/*这里的信号针对父子进程race*/</span></span><br><span class="line">    sigemptyset(&amp;mask_hang);</span><br><span class="line">    sigaddset(&amp;mask_hang, SIGCHLD);</span><br><span class="line"></span><br><span class="line">    bg = parseline(cmdline, argv);</span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">0</span>] == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!builtin_cmd(argv))&#123;   </span><br><span class="line">        sigprocmask(SIG_BLOCK, &amp;mask_hang, &amp;prev_hang);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span> (execve(argv[<span class="number">0</span>], argv, environ) &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Command not found.\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!bg)&#123;</span><br><span class="line">            sigprocmask(SIG_BLOCK, &amp;mask_all_job, &amp;prev_all_job);</span><br><span class="line">            addjob(jobs, pid, <span class="number">1</span>, cmdline);</span><br><span class="line">            sigprocmask(SIG_SETMASK, &amp;prev_all_job, <span class="literal">NULL</span>);</span><br><span class="line">            waitfg(pid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            sigprocmask(SIG_BLOCK, &amp;mask_all_job, &amp;prev_all_job);</span><br><span class="line">            addjob(jobs, pid, <span class="number">2</span>, cmdline);</span><br><span class="line">            sigprocmask(SIG_SETMASK, &amp;prev_all_job, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">            bgjid = pid2jid(pid);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, bgjid, pid, cmdline);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">waitfg</span><span class="params">(<span class="keyword">pid_t</span> pid)</span></span>&#123;</span><br><span class="line">    <span class="keyword">sigset_t</span> prev_hang;</span><br><span class="line">    sigemptyset(&amp;prev_hang);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (pid == fgpid(jobs))</span><br><span class="line">        sigsuspend(&amp;prev_hang);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigchld_handler</span><span class="params">(<span class="keyword">int</span> sig)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> olderrno = errno;</span><br><span class="line">    <span class="keyword">sigset_t</span> mask_all_job, prev_all_job;</span><br><span class="line"></span><br><span class="line">    sigfillset(&amp;mask_all_job);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((pid = waitpid(<span class="number">-1</span>, &amp;status, WNOHANG | WUNTRACED)) &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        sigprocmask(SIG_BLOCK, &amp;mask_all_job, &amp;prev_all_job);</span><br><span class="line">        deletejob(jobs, pid);</span><br><span class="line">        sigprocmask(SIG_SETMASK, &amp;prev_all_job, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    errno = olderrno;</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终的检验</p>
<p><img src="/2022/03/19/ShellLab%20d6fe4/Untitled%204.png" alt="Untitled"></p>
<h1 id="第六关"><a href="#第六关" class="headerlink" title="第六关"></a>第六关</h1><p>这一关是用Ctrl + c(对应的信号是SIGINT)来结束一个前台作业(注意,  是前台!!!)</p>
<p>知识点考察:</p>
<ul>
<li>如何分辨前台和后台作业:  fgpid()</li>
<li>如何发送SIGINT信号:  kill()</li>
</ul>
<p>这一关还是比较直接的,  我们只用修改<code>sigint_handler()</code>即可.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigint_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> int_fg_pid;</span><br><span class="line">    <span class="keyword">int</span> int_jid;</span><br><span class="line">    <span class="keyword">sigset_t</span> mask_all_int, prev_all_int;</span><br><span class="line">    sigfillset(&amp;mask_all_int);</span><br><span class="line">    <span class="comment">/*保护赋值操作不被中断*/</span></span><br><span class="line">    sigprocmask(SIG_BLOCK, &amp;mask_all_int, &amp;prev_all_int);</span><br><span class="line">    int_fg_pid = fgpid(jobs);</span><br><span class="line">    int_jid = pid2jid(int_fg_pid);</span><br><span class="line">    sigprocmask(SIG_SETMASK, &amp;prev_all_int, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">/*如果存在前台作业的话,  就发送SIGINT信号给那个前台作业*/</span></span><br><span class="line">    <span class="keyword">if</span>(int_fg_pid)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Job [%d] (%d) terminated by signal 2\n&quot;</span>, int_jid, int_fg_pid);</span><br><span class="line">        kill(-int_fg_pid, SIGINT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="检验"><a href="#检验" class="headerlink" title="检验"></a>检验</h2><p><img src="/2022/03/19/ShellLab%20d6fe4/Untitled%205.png" alt="Untitled"></p>
<h1 id="第七关"><a href="#第七关" class="headerlink" title="第七关"></a>第七关</h1><p>要求是只将SIGINT信号发送给前台进程,  中断前台进程</p>
<p>知识点考察:</p>
<ul>
<li>使用status状态来处理不同的情况(进程正常终止,  进程因SIGINT中止)</li>
</ul>
<p>才知道上面的sigint处理函数是错的,  printf要放在sigint函数中去</p>
<p>在进行第七关的修改的同时,  前面的eval()和sigchld处理函数中信号阻塞太乱了,  所以接着第六关的三个修改我们再次添加一个第四次修改.</p>
<p>此外还修改了sigchld_handler中的情况分类,  感觉在这里对sigchld_handler有了更加清楚的认识,  这个信号处理不仅仅只是针对一个信号,  而是对多种信号进行分类处理,  通过status来区别</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigchld_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> olderrno = errno;</span><br><span class="line">    <span class="keyword">sigset_t</span> mask_all, mask_prev;</span><br><span class="line">    sigfillset(&amp;mask_all);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*删除作业*/</span></span><br><span class="line">    <span class="keyword">while</span> ((pid = waitpid(<span class="number">-1</span>, &amp;status, WNOHANG|WUNTRACED)) &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sigprocmask(SIG_BLOCK, &amp;mask_all, &amp;mask_prev);<span class="comment">//下面的情况都需要信号屏蔽,所以直接在开头和结尾处屏蔽和取消屏蔽信号即可</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (WIFEXITED(status))</span><br><span class="line">        &#123;</span><br><span class="line">            deletejob(jobs, pid);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (WIFSIGNALED(status))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Job [%d] (%d) terminated by signal 2\n&quot;</span>, pid2jid(pid), pid);</span><br><span class="line">            deletejob(jobs, pid);</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sigprocmask(SIG_SETMASK, &amp;mask_prev, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    errno = olderrno;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">eval</span><span class="params">(<span class="keyword">char</span> *cmdline)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *argv[MAXARGS];</span><br><span class="line">    <span class="keyword">char</span> buf[MAXLINE];</span><br><span class="line">    <span class="keyword">int</span> bg;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">sigset_t</span> mask_all, mask, mask_prev;</span><br><span class="line"></span><br><span class="line">    sigemptyset(&amp;mask);</span><br><span class="line">    sigaddset(&amp;mask, SIGCHLD);</span><br><span class="line">    sigfillset(&amp;mask_all);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(buf, cmdline);</span><br><span class="line"></span><br><span class="line">    bg = parseline(buf, argv);</span><br><span class="line">    <span class="keyword">if</span> (argv[<span class="number">0</span>] == <span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!builtin_cmd(argv))</span><br><span class="line">    &#123;   </span><br><span class="line">        sigprocmask(SIG_BLOCK, &amp;mask, &amp;mask_prev);<span class="comment">//这里阻塞是为了防止父子进程间的竞争,  防止先delete后add</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((pid = fork()) == <span class="number">0</span>)<span class="comment">//对于子进程</span></span><br><span class="line">        &#123;</span><br><span class="line">            sigprocmask(SIG_SETMASK, &amp;mask_prev, <span class="literal">NULL</span>);</span><br><span class="line">            setpgid(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">if</span> (execve(argv[<span class="number">0</span>], argv, environ) &lt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Command not found.\n&quot;</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!bg)</span><br><span class="line">        &#123;</span><br><span class="line">            sigprocmask(SIG_BLOCK, &amp;mask_all, <span class="literal">NULL</span>);</span><br><span class="line">            addjob(jobs, pid, <span class="number">1</span>, cmdline);</span><br><span class="line">            sigprocmask(SIG_SETMASK, &amp;mask, <span class="literal">NULL</span>);</span><br><span class="line">            waitfg(pid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            sigprocmask(SIG_BLOCK, &amp;mask_all, <span class="literal">NULL</span>);</span><br><span class="line">            addjob(jobs, pid, <span class="number">2</span>, cmdline);</span><br><span class="line">            sigprocmask(SIG_SETMASK, &amp;mask, <span class="literal">NULL</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, pid2jid(pid), pid, cmdline);</span><br><span class="line">        &#125;</span><br><span class="line">        sigprocmask(SIG_SETMASK, &amp;mask_prev, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigint_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> int_fg_pid = fgpid(jobs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(int_fg_pid)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// printf(&quot;即将发送SIGINT信号\n&quot;);</span></span><br><span class="line">        kill(-int_fg_pid, SIGINT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="第八关"><a href="#第八关" class="headerlink" title="第八关"></a>第八关</h1><p>要求:    使用SIGSTP信号只(!!!!)让前台作业停止</p>
<p>考察知识点:</p>
<ul>
<li>前台后台作业的区别</li>
<li>sigtstp_handler的编写</li>
<li>WIFSTOPPED(status)来区别信号情况</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigchld_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">pid_t</span> pid;</span><br><span class="line">    <span class="keyword">int</span> olderrno = errno;</span><br><span class="line">    <span class="keyword">sigset_t</span> mask_all, mask_prev;</span><br><span class="line">    sigfillset(&amp;mask_all);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span> *<span class="title">job</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/*删除作业*/</span></span><br><span class="line">    <span class="keyword">while</span> ((pid = waitpid(<span class="number">-1</span>, &amp;status, WNOHANG|WUNTRACED)) &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sigprocmask(SIG_BLOCK, &amp;mask_all, &amp;mask_prev);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (WIFEXITED(status))</span><br><span class="line">        &#123;</span><br><span class="line">            deletejob(jobs, pid);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (WIFSIGNALED(status))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Job [%d] (%d) terminated by signal 2\n&quot;</span>, pid2jid(pid), pid);</span><br><span class="line">            deletejob(jobs, pid);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (WIFSTOPPED(status))</span><br><span class="line">        &#123;</span><br><span class="line">              job = getjobpid(jobs, pid);</span><br><span class="line">              job-&gt;state = ST;</span><br><span class="line">              <span class="built_in">printf</span>(<span class="string">&quot;Job [%d] (%d) stopped by signal %d\n&quot;</span>, pid2jid(pid), pid, WSTOPSIG(status));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sigprocmask(SIG_SETMASK, &amp;mask_prev, <span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    errno = olderrno;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sigtstp_handler</span><span class="params">(<span class="keyword">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pid_t</span> pid = fgpid(jobs);</span><br><span class="line">    <span class="keyword">if</span> (pid)</span><br><span class="line">        kill(-pid, SIGTSTP);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="检验-1"><a href="#检验-1" class="headerlink" title="检验"></a>检验</h2><h2 id="实现的结果"><a href="#实现的结果" class="headerlink" title="实现的结果"></a>实现的结果</h2><p><img src="/2022/03/19/ShellLab%20d6fe4/Untitled%206.png" alt="Untitled"></p>
<h2 id="实验室提供的结果"><a href="#实验室提供的结果" class="headerlink" title="实验室提供的结果"></a>实验室提供的结果</h2><p><img src="/2022/03/19/ShellLab%20d6fe4/Untitled%207.png" alt="Untitled"></p>
<h1 id="第九关"><a href="#第九关" class="headerlink" title="第九关"></a>第九关</h1><p>实现内置指令bg(讲挂起的进程转入后台运行)和fg(讲挂起的进程转入前台进行)</p>
<p>知识点:  就是重新编写biltin_cmd函数和do_bgfg函数</p>
<p>贴上代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">builtin_cmd</span><span class="params">(<span class="keyword">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">sigset_t</span> mask_all, mask_prev;</span><br><span class="line">    sigfillset(&amp;mask_all);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;quit&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">&quot;jobs&quot;</span>))&#123;</span><br><span class="line">        sigprocmask(SIG_BLOCK, &amp;mask_all, &amp;mask_prev);</span><br><span class="line">        listjobs(jobs);</span><br><span class="line">        sigprocmask(SIG_SETMASK, &amp;mask_prev, <span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;bg&quot;</span>) || !<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;fg&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        do_bgfg(argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * do_bgfg - Execute the builtin bg and fg commands</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="keyword">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> jid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span> *<span class="title">job</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;bg&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        jid = atoi(&amp;argv[<span class="number">1</span>][<span class="number">1</span>]);<span class="comment">//atoi函数:  获取参数字符串, 并返回其字符串所代表的数字</span></span><br><span class="line">        job = getjobjid(jobs, jid);</span><br><span class="line">        job-&gt;state = BG;<span class="comment">//将其状态改为后台进程,  这样shell就不会挂起等待该进程了</span></span><br><span class="line">        kill(-(job-&gt;pid), SIGCONT);<span class="comment">//发送继续运行信号给该进程</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, jid, job-&gt;pid, job-&gt;cmdline);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;fg&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        jid = atoi(&amp;argv[<span class="number">1</span>][<span class="number">1</span>]);<span class="comment">//atoi函数:  获取参数字符串, 并返回其字符串所代表的数字</span></span><br><span class="line">        job = getjobjid(jobs, jid);</span><br><span class="line">        job-&gt;state = FG;<span class="comment">//将其状态改为前台进程,  shell挂起等待该进程</span></span><br><span class="line">				waitfg(job-&gt;pid);</span><br><span class="line">        kill(-(job-&gt;pid), SIGCONT);<span class="comment">//发送继续运行信号给该进程</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, jid, job-&gt;pid, job-&gt;cmdline);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="检验-2"><a href="#检验-2" class="headerlink" title="检验"></a>检验</h1><p><img src="/2022/03/19/ShellLab%20d6fe4/Untitled%208.png" alt="Untitled"></p>
<h1 id="第十关"><a href="#第十关" class="headerlink" title="第十关"></a>第十关</h1><p>fg内置指令的更加全面的实现:</p>
<ul>
<li>将挂起的进程转到前台运行(上一个关卡已经实现了)</li>
<li>讲一个后台运行的进程转到前台</li>
</ul>
<p>而挂起的进程跟一个后台运行的进程最直观(对于shell来说)的不同就是其结构体成员的state不同,  所以我们的根据state再次分情况讨论即可.关于fg的第一个情况的处理有错误的地方:  1.waitfg要放在kill后面,  否则进程会先挂起shell,  然后再发送kill的时候已经发送不了了,  因为已经挂起了,  shell就会卡死.2.  fg不用printf打印</p>
<p>贴一下代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="keyword">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> jid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span> *<span class="title">job</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;bg&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        jid = atoi(&amp;argv[<span class="number">1</span>][<span class="number">1</span>]);<span class="comment">//atoi函数:  获取参数字符串, 并返回其字符串所代表的数字</span></span><br><span class="line">        job = getjobjid(jobs, jid);</span><br><span class="line">        job-&gt;state = BG;<span class="comment">//将其状态改为后台进程,  这样shell就不会挂起等待该进程了</span></span><br><span class="line">        kill(-(job-&gt;pid), SIGCONT);<span class="comment">//发送继续运行信号给该进程</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, jid, job-&gt;pid, job-&gt;cmdline);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;fg&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        jid = atoi(&amp;argv[<span class="number">1</span>][<span class="number">1</span>]);<span class="comment">//atoi函数:  获取参数字符串, 并返回其字符串所代表的数字</span></span><br><span class="line">        job = getjobjid(jobs, jid);</span><br><span class="line">        <span class="keyword">if</span> (job-&gt;state == ST)</span><br><span class="line">        &#123;</span><br><span class="line">            job-&gt;state = FG;<span class="comment">//将其状态改为前台进程,  shell挂起等待该进程</span></span><br><span class="line">            kill(-(job-&gt;pid), SIGCONT);<span class="comment">//发送继续运行信号给该进程</span></span><br><span class="line">            waitfg(job-&gt;pid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (job-&gt;state == BG)</span><br><span class="line">        &#123;</span><br><span class="line">            job-&gt;state = FG;</span><br><span class="line">            waitfg(job-&gt;pid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="检验-3"><a href="#检验-3" class="headerlink" title="检验"></a>检验</h1><p><img src="/2022/03/19/ShellLab%20d6fe4/Untitled%209.png" alt="Untitled"></p>
<h1 id="第十一关"><a href="#第十一关" class="headerlink" title="第十一关"></a>第十一关</h1><p>这一关是发送SIGINT给前台进程组的每一个进程</p>
<h1 id="检验-4"><a href="#检验-4" class="headerlink" title="检验"></a>检验</h1><p>即便不做修改,  结果跟参考是一样</p>
<p><img src="/2022/03/19/ShellLab%20d6fe4/Untitled%2010.png" alt="Untitled"></p>
<p><img src="/2022/03/19/ShellLab%20d6fe4/Untitled%2011.png" alt="Untitled"></p>
<h1 id="第十二关"><a href="#第十二关" class="headerlink" title="第十二关"></a>第十二关</h1><p>跟上面差不多,  不做修改也可以过</p>
<p><img src="/2022/03/19/ShellLab%20d6fe4/Untitled%2012.png" alt="Untitled"></p>
<p><img src="/2022/03/19/ShellLab%20d6fe4/Untitled%2013.png" alt="Untitled"></p>
<h1 id="第十三关"><a href="#第十三关" class="headerlink" title="第十三关"></a>第十三关</h1><p>跟上面一样,  不做修改也可以通过</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">这个是tsh的:</span><br><span class="line">./sdriver.pl -t trace13.txt -s ./tsh -a <span class="string">&quot;-p&quot;</span></span><br><span class="line">#</span><br><span class="line"># trace13.txt - Restart every stopped process in process group</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">tsh&gt; ./mysplit 4</span></span><br><span class="line">Job [<span class="number">1</span>] (<span class="number">9578</span>) stopped by signal <span class="number">20</span></span><br><span class="line">tsh&gt; jobs</span><br><span class="line">[<span class="number">1</span>] (<span class="number">9578</span>) Stopped ./mysplit <span class="number">4</span> </span><br><span class="line">tsh&gt; /bin/ps a</span><br><span class="line">    PID TTY      STAT   TIME COMMAND</span><br><span class="line">   <span class="number">1214</span> tty2     Ssl+   <span class="number">0</span>:<span class="number">00</span> /usr/libexec/gdm-wayland-session env GNOME_SHELL_SESSION_MODE=ubuntu /usr/bin/gnome-session --session=ubuntu</span><br><span class="line">   <span class="number">1229</span> tty2     Sl+    <span class="number">0</span>:<span class="number">00</span> /usr/libexec/gnome-session-binary --systemd --session=ubuntu</span><br><span class="line">   <span class="number">4709</span> pts/<span class="number">0</span>    Ss     <span class="number">0</span>:<span class="number">00</span> bash</span><br><span class="line">   <span class="number">9084</span> pts/<span class="number">0</span>    S      <span class="number">0</span>:<span class="number">00</span> ./tsh -p</span><br><span class="line">   <span class="number">9086</span> pts/<span class="number">0</span>    T      <span class="number">0</span>:<span class="number">00</span> ./myspin <span class="number">4</span></span><br><span class="line">   <span class="number">9156</span> pts/<span class="number">0</span>    S      <span class="number">0</span>:<span class="number">00</span> ./tsh -p</span><br><span class="line">   <span class="number">9158</span> pts/<span class="number">0</span>    T      <span class="number">0</span>:<span class="number">00</span> ./myspin <span class="number">4</span></span><br><span class="line">   <span class="number">9573</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> make test13</span><br><span class="line">   <span class="number">9574</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> /bin/sh -c ./sdriver.pl -t trace13.txt -s ./tsh -a <span class="string">&quot;-p&quot;</span></span><br><span class="line">   <span class="number">9575</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> /usr/bin/perl ./sdriver.pl -t trace13.txt -s ./tsh -a -p</span><br><span class="line">   <span class="number">9576</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> ./tsh -p</span><br><span class="line">   <span class="number">9578</span> pts/<span class="number">0</span>    T      <span class="number">0</span>:<span class="number">00</span> ./mysplit <span class="number">4</span></span><br><span class="line">   <span class="number">9579</span> pts/<span class="number">0</span>    T      <span class="number">0</span>:<span class="number">00</span> ./mysplit <span class="number">4</span></span><br><span class="line">   <span class="number">9582</span> pts/<span class="number">0</span>    R      <span class="number">0</span>:<span class="number">00</span> /bin/ps a</span><br><span class="line">tsh&gt; fg %<span class="number">1</span></span><br><span class="line">tsh&gt; /bin/ps a</span><br><span class="line">    PID TTY      STAT   TIME COMMAND</span><br><span class="line">   <span class="number">1214</span> tty2     Ssl+   <span class="number">0</span>:<span class="number">00</span> /usr/libexec/gdm-wayland-session env GNOME_SHELL_SESSION_MODE=ubuntu /usr/bin/gnome-session --session=ubuntu</span><br><span class="line">   <span class="number">1229</span> tty2     Sl+    <span class="number">0</span>:<span class="number">00</span> /usr/libexec/gnome-session-binary --systemd --session=ubuntu</span><br><span class="line">   <span class="number">4709</span> pts/<span class="number">0</span>    Ss     <span class="number">0</span>:<span class="number">00</span> bash</span><br><span class="line">   <span class="number">9084</span> pts/<span class="number">0</span>    S      <span class="number">0</span>:<span class="number">00</span> ./tsh -p</span><br><span class="line">   <span class="number">9086</span> pts/<span class="number">0</span>    T      <span class="number">0</span>:<span class="number">00</span> ./myspin <span class="number">4</span></span><br><span class="line">   <span class="number">9156</span> pts/<span class="number">0</span>    S      <span class="number">0</span>:<span class="number">00</span> ./tsh -p</span><br><span class="line">   <span class="number">9158</span> pts/<span class="number">0</span>    T      <span class="number">0</span>:<span class="number">00</span> ./myspin <span class="number">4</span></span><br><span class="line">   <span class="number">9573</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> make test13</span><br><span class="line">   <span class="number">9574</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> /bin/sh -c ./sdriver.pl -t trace13.txt -s ./tsh -a <span class="string">&quot;-p&quot;</span></span><br><span class="line">   <span class="number">9575</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> /usr/bin/perl ./sdriver.pl -t trace13.txt -s ./tsh -a -p</span><br><span class="line">   <span class="number">9576</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> ./tsh -p</span><br><span class="line">   <span class="number">9585</span> pts/<span class="number">0</span>    R      <span class="number">0</span>:<span class="number">00</span> /bin/ps a</span><br><span class="line"></span><br><span class="line">这个是tshref的:</span><br><span class="line">make rtest13</span><br><span class="line">./sdriver.pl -t trace13.txt -s ./tshref -a <span class="string">&quot;-p&quot;</span></span><br><span class="line">#</span><br><span class="line"># trace13.txt - Restart every stopped process in process group</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">tsh&gt; ./mysplit 4</span></span><br><span class="line">Job [<span class="number">1</span>] (<span class="number">9591</span>) stopped by signal <span class="number">20</span></span><br><span class="line">tsh&gt; jobs</span><br><span class="line">[<span class="number">1</span>] (<span class="number">9591</span>) Stopped ./mysplit <span class="number">4</span> </span><br><span class="line">tsh&gt; /bin/ps a</span><br><span class="line">    PID TTY      STAT   TIME COMMAND</span><br><span class="line">   <span class="number">1214</span> tty2     Ssl+   <span class="number">0</span>:<span class="number">00</span> /usr/libexec/gdm-wayland-session env GNOME_SHELL_SESSION_MODE=ubuntu /usr/bin/gnome-session --session=ubuntu</span><br><span class="line">   <span class="number">1229</span> tty2     Sl+    <span class="number">0</span>:<span class="number">00</span> /usr/libexec/gnome-session-binary --systemd --session=ubuntu</span><br><span class="line">   <span class="number">4709</span> pts/<span class="number">0</span>    Ss     <span class="number">0</span>:<span class="number">00</span> bash</span><br><span class="line">   <span class="number">9084</span> pts/<span class="number">0</span>    S      <span class="number">0</span>:<span class="number">00</span> ./tsh -p</span><br><span class="line">   <span class="number">9086</span> pts/<span class="number">0</span>    T      <span class="number">0</span>:<span class="number">00</span> ./myspin <span class="number">4</span></span><br><span class="line">   <span class="number">9156</span> pts/<span class="number">0</span>    S      <span class="number">0</span>:<span class="number">00</span> ./tsh -p</span><br><span class="line">   <span class="number">9158</span> pts/<span class="number">0</span>    T      <span class="number">0</span>:<span class="number">00</span> ./myspin <span class="number">4</span></span><br><span class="line">   <span class="number">9586</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> make rtest13</span><br><span class="line">   <span class="number">9587</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> /bin/sh -c ./sdriver.pl -t trace13.txt -s ./tshref -a <span class="string">&quot;-p&quot;</span></span><br><span class="line">   <span class="number">9588</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> /usr/bin/perl ./sdriver.pl -t trace13.txt -s ./tshref -a -p</span><br><span class="line">   <span class="number">9589</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> ./tshref -p</span><br><span class="line">   <span class="number">9591</span> pts/<span class="number">0</span>    T      <span class="number">0</span>:<span class="number">00</span> ./mysplit <span class="number">4</span></span><br><span class="line">   <span class="number">9592</span> pts/<span class="number">0</span>    T      <span class="number">0</span>:<span class="number">00</span> ./mysplit <span class="number">4</span></span><br><span class="line">   <span class="number">9595</span> pts/<span class="number">0</span>    R      <span class="number">0</span>:<span class="number">00</span> /bin/ps a</span><br><span class="line">tsh&gt; fg %<span class="number">1</span></span><br><span class="line">tsh&gt; /bin/ps a</span><br><span class="line">    PID TTY      STAT   TIME COMMAND</span><br><span class="line">   <span class="number">1214</span> tty2     Ssl+   <span class="number">0</span>:<span class="number">00</span> /usr/libexec/gdm-wayland-session env GNOME_SHELL_SESSION_MODE=ubuntu /usr/bin/gnome-session --session=ubuntu</span><br><span class="line">   <span class="number">1229</span> tty2     Sl+    <span class="number">0</span>:<span class="number">00</span> /usr/libexec/gnome-session-binary --systemd --session=ubuntu</span><br><span class="line">   <span class="number">4709</span> pts/<span class="number">0</span>    Ss     <span class="number">0</span>:<span class="number">00</span> bash</span><br><span class="line">   <span class="number">9084</span> pts/<span class="number">0</span>    S      <span class="number">0</span>:<span class="number">00</span> ./tsh -p</span><br><span class="line">   <span class="number">9086</span> pts/<span class="number">0</span>    T      <span class="number">0</span>:<span class="number">00</span> ./myspin <span class="number">4</span></span><br><span class="line">   <span class="number">9156</span> pts/<span class="number">0</span>    S      <span class="number">0</span>:<span class="number">00</span> ./tsh -p</span><br><span class="line">   <span class="number">9158</span> pts/<span class="number">0</span>    T      <span class="number">0</span>:<span class="number">00</span> ./myspin <span class="number">4</span></span><br><span class="line">   <span class="number">9586</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> make rtest13</span><br><span class="line">   <span class="number">9587</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> /bin/sh -c ./sdriver.pl -t trace13.txt -s ./tshref -a <span class="string">&quot;-p&quot;</span></span><br><span class="line">   <span class="number">9588</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> /usr/bin/perl ./sdriver.pl -t trace13.txt -s ./tshref -a -p</span><br><span class="line">   <span class="number">9589</span> pts/<span class="number">0</span>    S+     <span class="number">0</span>:<span class="number">00</span> ./tshref -p</span><br><span class="line">   <span class="number">9598</span> pts/<span class="number">0</span>    R      <span class="number">0</span>:<span class="number">00</span> /bin/ps a</span><br></pre></td></tr></table></figure>

<h1 id="第十四关"><a href="#第十四关" class="headerlink" title="第十四关"></a>第十四关</h1><p>这道题是针对不同的输入错误情况,  shell能正确识别并指出错误</p>
<p>主要是情况的分类,  参考了博客:  <a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_45475106/article/details/111766734">https://blog.csdn.net/qq_45475106/article/details/111766734</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="keyword">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> jid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">job_t</span> *<span class="title">job</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;bg&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (argv[<span class="number">1</span>] == <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;bg command requires PID or %%jobid argument\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        jid = atoi(&amp;argv[<span class="number">1</span>][<span class="number">1</span>]);<span class="comment">//atoi函数:  获取参数字符串, 并返回其字符串所代表的数字</span></span><br><span class="line">        job = getjobjid(jobs, jid);</span><br><span class="line">        job-&gt;state = BG;<span class="comment">//将其状态改为后台进程,  这样shell就不会挂起等待该进程了</span></span><br><span class="line">        kill(-(job-&gt;pid), SIGCONT);<span class="comment">//发送继续运行信号给该进程</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;[%d] (%d) %s&quot;</span>, jid, job-&gt;pid, job-&gt;cmdline);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>], <span class="string">&quot;fg&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (argv[<span class="number">1</span>] = <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;fg command requires PID or %%jobid argument\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (argv[<span class="number">1</span>][<span class="number">0</span>] == <span class="string">&#x27;%&#x27;</span>)&#123;</span><br><span class="line">            jid = atoi(&amp;argv[<span class="number">1</span>][<span class="number">1</span>]);</span><br><span class="line">            job = getjobjid(jobs, jid);</span><br><span class="line">            <span class="keyword">if</span> (job == <span class="literal">NULL</span>)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%%%d: No such job\n&quot;</span>, jid);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">isdigit</span>(argv[<span class="number">1</span>][<span class="number">0</span>]))</span><br><span class="line">        &#123;</span><br><span class="line">            jid = atoi(argv[<span class="number">1</span>]);</span><br><span class="line">            job = getjobjid(jobs, jid);</span><br><span class="line">            <span class="keyword">if</span> (job == <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;(%d): Nosuch process\n&quot;</span>, jid);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s: argument must be a PID or %%jobid\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span> ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        jid = atoi(&amp;argv[<span class="number">1</span>][<span class="number">1</span>]);<span class="comment">//atoi函数:  获取参数字符串, 并返回其字符串所代表的数字</span></span><br><span class="line">        job = getjobjid(jobs, jid);</span><br><span class="line">        <span class="keyword">if</span> (job-&gt;state == ST)</span><br><span class="line">        &#123;</span><br><span class="line">            job-&gt;state = FG;<span class="comment">//将其状态改为前台进程,  shell挂起等待该进程</span></span><br><span class="line">            kill(-(job-&gt;pid), SIGCONT);<span class="comment">//发送继续运行信号给该进程</span></span><br><span class="line">            waitfg(job-&gt;pid);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (job-&gt;state == BG)</span><br><span class="line">        &#123;</span><br><span class="line">            job-&gt;state = FG;</span><br><span class="line">            waitfg(job-&gt;pid);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="检验-5"><a href="#检验-5" class="headerlink" title="检验"></a>检验</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">tsh:</span><br><span class="line">crow@crow-<span class="keyword">virtual</span>-machine:~/CSAPP/CSAPP/Shell Lab/shlab-handout (<span class="number">2</span>)$ make test14</span><br><span class="line">./sdriver.pl -t trace14.txt -s ./tsh -a <span class="string">&quot;-p&quot;</span></span><br><span class="line">#</span><br><span class="line"># trace14.txt - Simple error handling</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">tsh&gt; ./bogus</span></span><br><span class="line">./bogus: Command <span class="keyword">not</span> found.</span><br><span class="line">tsh&gt; ./myspin <span class="number">4</span> &amp;</span><br><span class="line">[<span class="number">1</span>] (<span class="number">2124</span>) ./myspin <span class="number">4</span> &amp;</span><br><span class="line">tsh&gt; fg</span><br><span class="line">fg command <span class="keyword">requires</span> PID <span class="keyword">or</span> %jobid argument</span><br><span class="line">tsh&gt; bg</span><br><span class="line">fg command <span class="keyword">requires</span> PID <span class="keyword">or</span> %jobid argument</span><br><span class="line">tsh&gt; fg a</span><br><span class="line">fg: argument must be a PID <span class="keyword">or</span> %jobid</span><br><span class="line">tsh&gt; bg a</span><br><span class="line">bg: argument must be a PID <span class="keyword">or</span> %jobid</span><br><span class="line">tsh&gt; fg <span class="number">9999999</span></span><br><span class="line">(<span class="number">9999999</span>): Nosuch process</span><br><span class="line">tsh&gt; bg <span class="number">9999999</span></span><br><span class="line">(<span class="number">9999999</span>): Nosuch process</span><br><span class="line">tsh&gt; fg %<span class="number">2</span></span><br><span class="line">%<span class="number">2</span>: No such job</span><br><span class="line">tsh&gt; fg %<span class="number">1</span></span><br><span class="line">Job [<span class="number">1</span>] (<span class="number">2124</span>) stopped by signal <span class="number">20</span></span><br><span class="line">tsh&gt; bg %<span class="number">2</span></span><br><span class="line">%<span class="number">2</span>: No such job</span><br><span class="line">tsh&gt; bg %<span class="number">1</span></span><br><span class="line">[<span class="number">1</span>] (<span class="number">2124</span>) ./myspin <span class="number">4</span> &amp;</span><br><span class="line">tsh&gt; jobs</span><br><span class="line">[<span class="number">1</span>] (<span class="number">2124</span>) Running ./myspin <span class="number">4</span> &amp;</span><br><span class="line"></span><br><span class="line">rtsh:</span><br><span class="line">crow@crow-<span class="keyword">virtual</span>-machine:~/CSAPP/CSAPP/Shell Lab/shlab-handout (<span class="number">2</span>)$ make rtest14</span><br><span class="line">./sdriver.pl -t trace14.txt -s ./tshref -a <span class="string">&quot;-p&quot;</span></span><br><span class="line">#</span><br><span class="line"># trace14.txt - Simple error handling</span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="meta">tsh&gt; ./bogus</span></span><br><span class="line">./bogus: Command <span class="keyword">not</span> found</span><br><span class="line">tsh&gt; ./myspin <span class="number">4</span> &amp;</span><br><span class="line">[<span class="number">1</span>] (<span class="number">2146</span>) ./myspin <span class="number">4</span> &amp;</span><br><span class="line">tsh&gt; fg</span><br><span class="line">fg command <span class="keyword">requires</span> PID <span class="keyword">or</span> %jobid argument</span><br><span class="line">tsh&gt; bg</span><br><span class="line">bg command <span class="keyword">requires</span> PID <span class="keyword">or</span> %jobid argument</span><br><span class="line">tsh&gt; fg a</span><br><span class="line">fg: argument must be a PID <span class="keyword">or</span> %jobid</span><br><span class="line">tsh&gt; bg a</span><br><span class="line">bg: argument must be a PID <span class="keyword">or</span> %jobid</span><br><span class="line">tsh&gt; fg <span class="number">9999999</span></span><br><span class="line">(<span class="number">9999999</span>): No such process</span><br><span class="line">tsh&gt; bg <span class="number">9999999</span></span><br><span class="line">(<span class="number">9999999</span>): No such process</span><br><span class="line">tsh&gt; fg %<span class="number">2</span></span><br><span class="line">%<span class="number">2</span>: No such job</span><br><span class="line">tsh&gt; fg %<span class="number">1</span></span><br><span class="line">Job [<span class="number">1</span>] (<span class="number">2146</span>) stopped by signal <span class="number">20</span></span><br><span class="line">tsh&gt; bg %<span class="number">2</span></span><br><span class="line">%<span class="number">2</span>: No such job</span><br><span class="line">tsh&gt; bg %<span class="number">1</span></span><br><span class="line">[<span class="number">1</span>] (<span class="number">2146</span>) ./myspin <span class="number">4</span> &amp;</span><br><span class="line">tsh&gt; jobs</span><br><span class="line">[<span class="number">1</span>] (<span class="number">2146</span>) Running ./myspin <span class="number">4</span> &amp;</span><br></pre></td></tr></table></figure>

<h1 id="第十五关-第十六关"><a href="#第十五关-第十六关" class="headerlink" title="第十五关,  第十六关"></a>第十五关,  第十六关</h1><p>不用修改直接过</p>
<h1 id="警惕"><a href="#警惕" class="headerlink" title="警惕"></a>警惕</h1><p>后面的waitpid跟各种信号bgfg的混合使用还是有点混乱,  然后是后面的错误情况提示等等……</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">LamのCrow</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/03/19/ShellLab d6fe4/">http://example.com/2022/03/19/ShellLab d6fe4/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com">LamのCrow</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CSAPP/">CSAPP</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/03/21/ReMain-%E7%AC%AC%E5%8D%81%E4%B8%80%202486d/"><i class="fa fa-chevron-left">  </i><span>逆向工程核心原理-11</span></a></div><div class="next-post pull-right"><a href="/2022/03/18/%E7%AC%AC%E5%85%AB%E7%AB%A0%E2%80%94%E5%BC%82%E5%B8%B8%E6%8E%A7%E5%88%B6%E6%B5%81%201526b/"><span>CSAPP-8</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s4.ax1x.com/2021/12/06/oy2VdH.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2022 By LamのCrow</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">追求幸福</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"right","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>