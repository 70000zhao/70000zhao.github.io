<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="starCTF部分题解"><meta name="keywords" content="CTF"><meta name="author" content="LamのCrow"><meta name="copyright" content="LamのCrow"><title>starCTF部分题解 | LamのCrow</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#StarCTF"><span class="toc-number">1.</span> <span class="toc-text">StarCTF</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RE-NaCl-%E6%B1%87%E7%BC%96-XTEA%E5%8A%A0%E5%AF%86-%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">RE_NaCl(汇编,  XTEA加密, 可逆加密算法)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E8%BD%AE%E5%8A%A0%E5%AF%86%E7%9A%84data-%E7%94%9F%E6%88%90"><span class="toc-number">2.1.</span> <span class="toc-text">第一轮加密的data[]生成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E9%83%A8%E5%88%86%E5%8A%A0%E5%AF%86"><span class="toc-number">2.2.</span> <span class="toc-text">第一部分加密</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E9%83%A8%E5%88%86%E5%8A%A0%E5%AF%86"><span class="toc-number">2.3.</span> <span class="toc-text">第二部分加密</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%88%A4%E6%96%AD"><span class="toc-number">2.4.</span> <span class="toc-text">关键判断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95"><span class="toc-number">2.5.</span> <span class="toc-text">解密算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#input"><span class="toc-number">2.6.</span> <span class="toc-text">input</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flag"><span class="toc-number">2.7.</span> <span class="toc-text">flag</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RE-SimpleFileSystem-%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-number">3.</span> <span class="toc-text">RE_SimpleFileSystem(可逆加密算法, 文件系统)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#flag-1"><span class="toc-number">3.1.</span> <span class="toc-text">flag</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#RE-Jump-setjump%E5%92%8Clongjump%E6%89%93%E4%B9%B1%E9%80%BB%E8%BE%91%E9%A1%BA%E5%BA%8F-Burrows-Wheeler%E5%8E%8B%E7%BC%A9%E7%AE%97%E6%B3%95"><span class="toc-number">4.</span> <span class="toc-text">RE_Jump(setjump和longjump打乱逻辑顺序,  Burrows-Wheeler压缩算法)</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://s4.ax1x.com/2021/12/07/oyWTJA.jpg"></div><div class="author-info__name text-center">LamのCrow</div><div class="author-info__description text-center">欢迎交流!!!</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">39</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">4</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://space.bilibili.com/202089320">MyBIlibili</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://sma11cc.github.io/">smallcc</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s4.ax1x.com/2021/12/06/oy2VdH.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">LamのCrow</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">starCTF部分题解</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-23</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="StarCTF"><a href="#StarCTF" class="headerlink" title="StarCTF"></a>StarCTF</h1><span id="more"></span>

<h1 id="RE-NaCl-汇编-XTEA加密-可逆加密算法"><a href="#RE-NaCl-汇编-XTEA加密-可逆加密算法" class="headerlink" title="RE_NaCl(汇编,  XTEA加密, 可逆加密算法)"></a>RE_NaCl(汇编,  XTEA加密, 可逆加密算法)</h1><p>这道题只看反编译很难看懂,  所以需要汇编 + 调试得到题目的大致逻辑</p>
<p>我们按照逻辑逐步调试</p>
<h2 id="第一轮加密的data-生成"><a href="#第一轮加密的data-生成" class="headerlink" title="第一轮加密的data[]生成"></a>第一轮加密的data[]生成</h2><p>首先是生成第一轮加密所需的data数组(元素类型为DWORD),  </p>
<p><img src="/2022/04/23/StarCTF(%E6%B1%87%E7%BC%96,%20XTEA%E5%8A%A0%E5%AF%86,%20%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95)%20d2c4611ee19c445694e9c66ea5eb4eb6/Untitled.png" alt="Untitled"></p>
<p>然后跳转到生成data数组的代码块</p>
<p><img src="/2022/04/23/StarCTF(%E6%B1%87%E7%BC%96,%20XTEA%E5%8A%A0%E5%AF%86,%20%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95)%20d2c4611ee19c445694e9c66ea5eb4eb6/Untitled%201.png" alt="Untitled"></p>
<p>data生成完成后会有一个输入字符串分组逆序处理</p>
<p>随后来到第一部分的加密区域</p>
<h2 id="第一部分加密"><a href="#第一部分加密" class="headerlink" title="第一部分加密"></a>第一部分加密</h2><p><img src="/2022/04/23/StarCTF(%E6%B1%87%E7%BC%96,%20XTEA%E5%8A%A0%E5%AF%86,%20%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95)%20d2c4611ee19c445694e9c66ea5eb4eb6/Untitled%202.png" alt="Untitled"></p>
<p>可以看到循环左移的次数都是固定的,  将算法逻辑写下来就是</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">输入: abcdefgh</span><br><span class="line"></span><br><span class="line">分大组: abcdefgh  八个一组</span><br><span class="line"></span><br><span class="line">分小组: abcd    efgh</span><br><span class="line"></span><br><span class="line">小组逆序:   dcba(倒序一组)    hgfe(倒序二组)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2b</span>):注意左移是循环左移</span><br><span class="line">结果<span class="number">1</span> = (倒序一组 &lt;&lt; <span class="number">1</span>) &amp; (倒序一组 &lt;&lt; <span class="number">8</span>) ^ (倒序一组 &lt;&lt; <span class="number">2</span>) ^ 倒序二组(无左移) ^ (data + <span class="number">4</span> * i)    </span><br><span class="line"></span><br><span class="line">结果<span class="number">2</span> = (结果<span class="number">1</span> &lt;&lt; <span class="number">1</span>)     &amp; (结果<span class="number">1</span> &lt;&lt; <span class="number">8</span>)      ^ (结果<span class="number">1</span> &lt;&lt; <span class="number">2</span>)     ^ 倒序一组(无左移) ^ (data + <span class="number">4</span> * i)</span><br><span class="line"></span><br><span class="line">结果<span class="number">3</span> = (结果<span class="number">2</span> &lt;&lt; <span class="number">1</span>)     &amp; (结果<span class="number">2</span> &lt;&lt; <span class="number">8</span>)      ^ (结果<span class="number">2</span> &lt;&lt; <span class="number">2</span>)     ^ 结果<span class="number">1</span> ^ (data + <span class="number">4</span> * i)</span><br><span class="line"></span><br><span class="line">结果<span class="number">4</span> = (结果<span class="number">3</span> &lt;&lt; <span class="number">1</span>)     &amp; (结果<span class="number">3</span> &lt;&lt; <span class="number">8</span>)      ^ (结果<span class="number">3</span> &lt;&lt; <span class="number">2</span>)     ^ 结果<span class="number">2</span> ^ (data + <span class="number">4</span> * i)</span><br><span class="line"></span><br><span class="line">以此类推</span><br><span class="line">.........</span><br><span class="line">进行<span class="number">0x2b</span>次</span><br></pre></td></tr></table></figure>

<p>其中的data就是前面生成的</p>
<p><img src="/2022/04/23/StarCTF(%E6%B1%87%E7%BC%96,%20XTEA%E5%8A%A0%E5%AF%86,%20%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95)%20d2c4611ee19c445694e9c66ea5eb4eb6/Untitled%203.png" alt="Untitled"></p>
<p>随后来到第二部分的加密</p>
<h2 id="第二部分加密"><a href="#第二部分加密" class="headerlink" title="第二部分加密"></a>第二部分加密</h2><p>其实就是XTEA加密,  但是当时只照着XXTEA的算法看了一下发现不是就没管了.(主要想着有TEA特征delta值,  但是这道题把delta给改了)</p>
<p>下面是一些分析</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">SFI:0000000008080180 ; START OF FUNCTION CHUNK FOR sub_8080900</span><br><span class="line">SFI:0000000008080180</span><br><span class="line">SFI:0000000008080180 loc_8080180:            ; 加密结果高<span class="number">32</span>位</span><br><span class="line">SFI:0000000008080180 mov     eax, [r15-0Ch]  ; 上次加密的结果B562C653</span><br><span class="line">SFI:0000000008080184 shl     eax, <span class="number">4</span>          ; 高密 &lt;&lt; <span class="number">4</span>, 注意这里不是逻辑左移了, 溢出<span class="number">32</span>直接没了</span><br><span class="line">SFI:0000000008080184                         ; 密文 &lt;&lt; <span class="number">4</span></span><br><span class="line">SFI:0000000008080187 mov     edx, eax</span><br><span class="line">SFI:0000000008080189 mov     eax, [r15-0Ch]</span><br><span class="line">SFI:000000000808018D shr     eax, <span class="number">5</span>          ; 高密 &gt;&gt; <span class="number">5</span></span><br><span class="line">SFI:000000000808018D                         ; 密文 &gt;&gt; <span class="number">5</span></span><br><span class="line">SFI:0000000008080190 xor     edx, eax        ; (高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>)</span><br><span class="line">SFI:0000000008080190                         ; (密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>)</span><br><span class="line">SFI:0000000008080192 mov     eax, [r15-0Ch]</span><br><span class="line">SFI:0000000008080196 lea     ecx, [rdx+rax]  ; 高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))</span><br><span class="line">SFI:0000000008080196                         ; 密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>))</span><br><span class="line">SFI:0000000008080199 mov     eax, [r15-10h]  ; <span class="number">0</span></span><br><span class="line">SFI:0000000008080199                         ; <span class="number">10325476</span></span><br><span class="line">SFI:000000000808019D <span class="keyword">and</span>     eax, <span class="number">3</span>          ; <span class="number">0</span></span><br><span class="line">SFI:000000000808019D                         ; eax = <span class="number">2</span></span><br><span class="line">SFI:00000000080801A0 lea     rdx, ds:<span class="number">0</span>[rax*<span class="number">4</span>]</span><br><span class="line">SFI:00000000080801A8 mov     rax, [r15-18h]  ; 这是一个内存存有000102030405060708090A....注意小端排序</span><br><span class="line">SFI:00000000080801AC add     rax, rdx</span><br><span class="line">SFI:00000000080801AF mov     eax, eax</span><br><span class="line">SFI:00000000080801B1 mov     edx, [r13+rax+<span class="number">0</span>] ; rdx = 03020100</span><br><span class="line">SFI:00000000080801B1                         ; rdx = B0A09080</span><br><span class="line">SFI:00000000080801B6 mov     eax, [r15-10h]  ; <span class="number">0</span></span><br><span class="line">SFI:00000000080801B6                         ; <span class="number">10325476</span></span><br><span class="line">SFI:00000000080801BA add     eax, edx        ; 03020100</span><br><span class="line">SFI:00000000080801BA                         ; 1B3C5D7E</span><br><span class="line">SFI:00000000080801BC xor     eax, ecx        ; 03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>)))</span><br><span class="line">SFI:00000000080801BC                         ; 1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>)))</span><br><span class="line">SFI:00000000080801BE xchg    ax, ax</span><br><span class="line">SFI:00000000080801C0 add     [r15-<span class="number">8</span>], eax    ; 低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))</span><br><span class="line">SFI:00000000080801C0                         ; (低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>))))</span><br><span class="line">SFI:00000000080801C4 mov     eax, [r15-1Ch]  ; 01234567,  小端排序rax = <span class="number">10325476</span></span><br><span class="line">SFI:00000000080801C4                         ; 同上rax = <span class="number">10325476</span></span><br><span class="line">SFI:00000000080801C8 add     [r15-10h], eax  ;</span><br><span class="line">SFI:00000000080801C8                         ; [r15 - 10h] = <span class="number">2</span> * <span class="number">10325476</span> = 2064A8EC</span><br><span class="line">SFI:00000000080801CC mov     eax, [r15-<span class="number">8</span>]</span><br><span class="line">SFI:00000000080801D0 shl     eax, <span class="number">4</span>          ; (低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) &lt;&lt; <span class="number">4</span></span><br><span class="line">SFI:00000000080801D0                         ; ((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>))))) &lt;&lt; <span class="number">4</span></span><br><span class="line">SFI:00000000080801D3 mov     edx, eax</span><br><span class="line">SFI:00000000080801D5 mov     eax, [r15-<span class="number">8</span>]</span><br><span class="line">SFI:00000000080801D9 shr     eax, <span class="number">5</span>          ; (低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) &gt;&gt; <span class="number">5</span></span><br><span class="line">SFI:00000000080801D9                         ; ((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>))))) &gt;&gt; <span class="number">5</span></span><br><span class="line">SFI:00000000080801DC xor     edx, eax        ; ((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) &gt;&gt; <span class="number">5</span>) ^ ((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) &lt;&lt; <span class="number">4</span>)</span><br><span class="line">SFI:00000000080801DC                         ; (((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>))))) &gt;&gt; <span class="number">5</span>) ^ (((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>))))) &lt;&lt; <span class="number">4</span>)</span><br><span class="line">SFI:00000000080801DE xchg    ax, ax</span><br><span class="line">SFI:<span class="number">00000000080801E0</span> mov     eax, [r15-<span class="number">8</span>]    ; 低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))</span><br><span class="line">SFI:<span class="number">00000000080801E0</span>                         ; (低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>))))</span><br><span class="line">SFI:<span class="number">00000000080801E4</span> lea     ecx, [rdx+rax]  ; (低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) +(((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) &gt;&gt; <span class="number">5</span>) ^ ((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) &lt;&lt; <span class="number">4</span>))</span><br><span class="line">SFI:<span class="number">00000000080801E4</span>                         ; ((((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>))))) &gt;&gt; <span class="number">5</span>) ^ (((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>))))) &lt;&lt; <span class="number">4</span>)) + ((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>)))))</span><br><span class="line">SFI:<span class="number">00000000080801E7</span> mov     eax, [r15-10h]  ; <span class="number">10325476</span></span><br><span class="line">SFI:<span class="number">00000000080801E7</span>                         ; 2064A8EC</span><br><span class="line">SFI:00000000080801EB shr     eax, 0Bh        ; 2064A</span><br><span class="line">SFI:00000000080801EB                         ; 40C95</span><br><span class="line">SFI:00000000080801EE mov     eax, eax</span><br><span class="line">SFI:00000000080801F0 <span class="keyword">and</span>     eax, <span class="number">3</span>          ; EAX = <span class="number">2</span></span><br><span class="line">SFI:00000000080801F0                         ; EAX = <span class="number">1</span></span><br><span class="line">SFI:00000000080801F3 lea     rdx, ds:<span class="number">0</span>[rax*<span class="number">4</span>] ; RDX = <span class="number">8</span></span><br><span class="line">SFI:00000000080801F3                         ; RDX = <span class="number">4</span></span><br><span class="line">SFI:00000000080801FB mov     rax, [r15-18h]</span><br><span class="line">SFI:00000000080801FF nop</span><br><span class="line">SFI:0000000008080200 add     rax, rdx        ; 数组地址 + <span class="number">8</span></span><br><span class="line">SFI:0000000008080200                         ; 数组地址 + <span class="number">4</span></span><br><span class="line">SFI:0000000008080203 mov     eax, eax</span><br><span class="line">SFI:0000000008080205 mov     edx, [r13+rax+<span class="number">0</span>] ; 0B0A0908</span><br><span class="line">SFI:0000000008080205                         ; 07060504</span><br><span class="line">SFI:000000000808020A mov     eax, [r15-10h]  ; <span class="number">10325476</span></span><br><span class="line">SFI:000000000808020A                         ; 2064A8EC</span><br><span class="line">SFI:000000000808020E add     eax, edx        ; <span class="number">10325476</span> + 0B0A0908</span><br><span class="line">SFI:000000000808020E                         ; 2064A8EC + 07060504</span><br><span class="line">SFI:0000000008080210 xor     eax, ecx        ; ((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) +(((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) &gt;&gt; <span class="number">5</span>) ^ ((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) &lt;&lt; <span class="number">4</span>))) ^ (<span class="number">10325476</span> + 0B0A0908)</span><br><span class="line">SFI:0000000008080210                         ; (((((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>))))) &gt;&gt; <span class="number">5</span>) ^ (((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>))))) &lt;&lt; <span class="number">4</span>)) + ((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>)))))) ^ (2064A8EC + 07060504)</span><br><span class="line">SFI:0000000008080212 add     [r15-0Ch], eax  ; 高密 + (((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) +(((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) &gt;&gt; <span class="number">5</span>) ^ ((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) &lt;&lt; <span class="number">4</span>))) ^ (<span class="number">10325476</span> + 0B0A0908))</span><br><span class="line">SFI:0000000008080212                         ; (高密 + (((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) +(((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) &gt;&gt; <span class="number">5</span>) ^ ((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) &lt;&lt; <span class="number">4</span>))) ^ (<span class="number">10325476</span> + 0B0A0908))) + ((((((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>))))) &gt;&gt; <span class="number">5</span>) ^ (((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>))))) &lt;&lt; <span class="number">4</span>)) + ((低密 + (03020100 ^ (高密 + ((高密 &lt;&lt; <span class="number">4</span>) ^ (高密 &gt;&gt; <span class="number">5</span>))))) + (1B3C5D7E ^ (密文 + ((密文 &lt;&lt; <span class="number">4</span>) ^ (密文 &gt;&gt; <span class="number">5</span>)))))) ^ (2064A8EC + 07060504))</span><br><span class="line">SFI:0000000008080216 inc     dword ptr [r15-<span class="number">4</span>] ; i++</span><br><span class="line">SFI:000000000808021A nop     word ptr [rax+rax+00h]</span><br></pre></td></tr></table></figure>

<p>我们需要抽取其中最关键的特征</p>
<ul>
<li>(高密 &lt;&lt; 4)</li>
<li>(高密 &gt;&gt; 5)</li>
<li>and     eax, 3</li>
<li>mov eax, [r15-10h]  和  add eax, edx,  传给eax的是10325476,  这个就是delta</li>
</ul>
<p>综上是可以判断其为XTEA算法,  有没有魔改可以通过调试验证.  这道题是没有魔改过的</p>
<p>最后是关键判断</p>
<h2 id="关键判断"><a href="#关键判断" class="headerlink" title="关键判断"></a>关键判断</h2><p><img src="/2022/04/23/StarCTF(%E6%B1%87%E7%BC%96,%20XTEA%E5%8A%A0%E5%AF%86,%20%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95)%20d2c4611ee19c445694e9c66ea5eb4eb6/Untitled%204.png" alt="Untitled"></p>
<p>查看一下</p>
<p><img src="/2022/04/23/StarCTF(%E6%B1%87%E7%BC%96,%20XTEA%E5%8A%A0%E5%AF%86,%20%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95)%20d2c4611ee19c445694e9c66ea5eb4eb6/Untitled%205.png" alt="Untitled"></p>
<p>通过调试得到了大体的逻辑,  接下来复现算法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#if 1</span></span><br><span class="line"><span class="comment">#define _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="comment">#include &lt;stdint.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;math.h&gt;</span></span><br><span class="line"></span><br><span class="line">uint32_t rol(uint32_t num, uint32_t n);</span><br><span class="line">void encode(uint32_t n1, uint32_t n2, uint32_t *mid);</span><br><span class="line">void encipher(unsigned <span class="built_in">int</span> num_rounds, uint32_t* high, uint32_t* low);</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> main(void)</span><br><span class="line">&#123;</span><br><span class="line">	uint32_t <span class="built_in">input</span>[<span class="number">8</span>] = &#123; <span class="number">0x61626364</span>, <span class="number">0x65666768</span>, <span class="number">0x61626364</span>, <span class="number">0x65666768</span>,</span><br><span class="line">							<span class="number">0x61626364</span>, <span class="number">0x65666768</span>, <span class="number">0x61626364</span>, <span class="number">0x65666768</span> &#125;;</span><br><span class="line"></span><br><span class="line">	uint32_t midput[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">	uint32_t i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i += <span class="number">2</span>) &#123;</span><br><span class="line">		encode(<span class="built_in">input</span>[i], <span class="built_in">input</span>[i + <span class="number">1</span>], midput + i);</span><br><span class="line">		//printf(<span class="string">&quot;第一部分加密:组%d:0x%x%x\n&quot;</span>, i, tmp[i / <span class="number">2</span>] &amp; <span class="number">0xffff0000</span>, tmp[i /<span class="number">2</span>] &amp; <span class="number">0xffff</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">		encipher(<span class="built_in">pow</span>(<span class="number">2</span>, i + <span class="number">1</span>), midput + (i * <span class="number">2</span>), midput + ((i * <span class="number">2</span>) + <span class="number">1</span>));</span><br><span class="line">	</span><br><span class="line">		printf(<span class="string">&quot;0x%08x%08x\n&quot;</span>, midput[i * <span class="number">2</span>], midput[(i * <span class="number">2</span>) + <span class="number">1</span>]);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint32_t rol(uint32_t num, uint32_t n)</span><br><span class="line">&#123;</span><br><span class="line">	//uint32_t tmp = (num &gt;&gt; (<span class="number">32</span> - n));</span><br><span class="line">	//<span class="keyword">return</span> ((num &lt;&lt; n) &amp; tmp);</span><br><span class="line">	<span class="keyword">return</span> ((num &lt;&lt; n) | ((num &gt;&gt; (<span class="number">32</span> - n))));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//可逆加密</span><br><span class="line">void encode(uint32_t n1, uint32_t n2, uint32_t *mid)</span><br><span class="line">&#123;</span><br><span class="line">	uint32_t data[] = &#123; <span class="number">0x04050607</span>, <span class="number">0x00010203</span>, <span class="number">0x0C0D0E0F</span>, <span class="number">0x08090A0B</span>, </span><br><span class="line">			<span class="number">0xCD3FE81B</span>, <span class="number">0xD7C45477</span>, <span class="number">0x9F3E9236</span>, <span class="number">0x0107F187</span>, <span class="number">0xF993CB81</span>, </span><br><span class="line">			<span class="number">0xBF74166C</span>, <span class="number">0xDA198427</span>, <span class="number">0x1A05ABFF</span>, <span class="number">0x9307E5E4</span>, <span class="number">0xCB8B0E45</span>, </span><br><span class="line">			<span class="number">0x306DF7F5</span>, <span class="number">0xAD300197</span>, <span class="number">0xAA86B056</span>, <span class="number">0x449263BA</span>, <span class="number">0x3FA4401B</span>, </span><br><span class="line">			<span class="number">0x1E41F917</span>, <span class="number">0xC6CB1E7D</span>, <span class="number">0x18EB0D7A</span>, <span class="number">0xD4EC4800</span>, <span class="number">0xB486F92B</span>, </span><br><span class="line">			<span class="number">0x8737F9F3</span>, <span class="number">0x765E3D25</span>, <span class="number">0xDB3D3537</span>, <span class="number">0xEE44552B</span>, <span class="number">0x11D0C94C</span>, </span><br><span class="line">			<span class="number">0x9B605BCB</span>, <span class="number">0x903B98B3</span>, <span class="number">0x24C2EEA3</span>, <span class="number">0x896E10A2</span>, <span class="number">0x2247F0C0</span>, </span><br><span class="line">			<span class="number">0xB84E5CAA</span>, <span class="number">0x8D2C04F0</span>, <span class="number">0x3BC7842C</span>, <span class="number">0x1A50D606</span>, <span class="number">0x49A1917C</span>, </span><br><span class="line">			<span class="number">0x7E1CB50C</span>, <span class="number">0xFC27B826</span>, <span class="number">0x5FDDDFBC</span>, <span class="number">0xDE0FC404</span>, <span class="number">0xB2B30907</span> &#125;;</span><br><span class="line"></span><br><span class="line">	uint64_t result, i;</span><br><span class="line"></span><br><span class="line">	uint32_t xordata[<span class="number">2</span>] = &#123; n2, n1 &#125;;//初始化运算中轮换的异或数据</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= <span class="number">0x2b</span>; i++) &#123;</span><br><span class="line">		result = ((rol(xordata[<span class="number">1</span>], <span class="number">1</span>) &amp; rol(xordata[<span class="number">1</span>], <span class="number">8</span>)) ^ rol(xordata[<span class="number">1</span>], <span class="number">2</span>)) ^ xordata[<span class="number">0</span>] ^ data[i];</span><br><span class="line">		xordata[<span class="number">0</span>] = xordata[<span class="number">1</span>];</span><br><span class="line">		xordata[<span class="number">1</span>] = result;</span><br><span class="line">	&#125;</span><br><span class="line">	printf(<span class="string">&quot;0x%x%x\n&quot;</span>, xordata[<span class="number">1</span>], xordata[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">	*mid = xordata[<span class="number">0</span>];//这里是顺序变了</span><br><span class="line">	*(mid + <span class="number">1</span>) = xordata[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void encipher(unsigned <span class="built_in">int</span> num_rounds, uint32_t *high, uint32_t *low) &#123;</span><br><span class="line">	unsigned <span class="built_in">int</span> i;</span><br><span class="line"></span><br><span class="line">	uint32_t key[<span class="number">4</span>] = &#123;<span class="number">0x03020100</span>, <span class="number">0x07060504</span>, <span class="number">0x0B0A0908</span>, <span class="number">0x0F0E0D0C</span>&#125;;</span><br><span class="line"></span><br><span class="line">	uint32_t v0 = *high, v1 = *low;</span><br><span class="line">	uint32_t <span class="built_in">sum</span> = <span class="number">0</span>, delta = <span class="number">0x10325476</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_rounds; i++) &#123;</span><br><span class="line">		v0 += (((v1 &lt;&lt; <span class="number">4</span>) ^ (v1 &gt;&gt; <span class="number">5</span>)) + v1) ^ (<span class="built_in">sum</span> + key[<span class="built_in">sum</span> &amp; <span class="number">3</span>]);</span><br><span class="line">		<span class="built_in">sum</span> += delta;</span><br><span class="line">		v1 += (((v0 &lt;&lt; <span class="number">4</span>) ^ (v0 &gt;&gt; <span class="number">5</span>)) + v0) ^ (<span class="built_in">sum</span> + key[(<span class="built_in">sum</span> &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span>]);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	*high = v0; *low = v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来是解密算法</p>
<h2 id="解密算法"><a href="#解密算法" class="headerlink" title="解密算法"></a>解密算法</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#define _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdint.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;math.h&gt;</span></span><br><span class="line"></span><br><span class="line">uint32_t rol(uint32_t num, uint32_t n);</span><br><span class="line">void decipther(unsigned <span class="built_in">int</span> num_runds, uint32_t* high, uint32_t* low);</span><br><span class="line">void decode(uint32_t* mid);</span><br><span class="line">void re_chr(uint32_t num);</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> main(void)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t en_data[<span class="number">8</span>] = &#123;<span class="number">0xFDF5C266</span>, <span class="number">0x7A328286</span>, <span class="number">0xCE944004</span>, <span class="number">0x5DE08ADC</span>, <span class="number">0xA6E4BD0A</span>, <span class="number">0x16CAADDC</span>, <span class="number">0x13CD6F0C</span>, <span class="number">0x1A75D936</span>&#125;;</span><br><span class="line">    unsigned <span class="built_in">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">        decipther(<span class="built_in">pow</span>(<span class="number">2</span>, i + <span class="number">1</span>), en_data + (<span class="number">2</span> * i), en_data + ((<span class="number">2</span> * i) + <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i+=<span class="number">2</span>) &#123;</span><br><span class="line">        decode(en_data + i);</span><br><span class="line">        printf(<span class="string">&quot;0x%x%x\n&quot;</span>, en_data[i], en_data[i + <span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">        re_chr(en_data[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">uint32_t rol(uint32_t num, uint32_t n)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ((num &lt;&lt; n) | ((num &gt;&gt; (<span class="number">32</span> - n))));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void decipther(unsigned <span class="built_in">int</span> num_rounds, uint32_t* high, uint32_t* low) </span><br><span class="line">&#123;</span><br><span class="line">    unsigned <span class="built_in">int</span> i;</span><br><span class="line"></span><br><span class="line">    uint32_t key[<span class="number">4</span>] = &#123; <span class="number">0x03020100</span>, <span class="number">0x07060504</span>, <span class="number">0x0B0A0908</span>, <span class="number">0x0F0E0D0C</span> &#125;;</span><br><span class="line"></span><br><span class="line">    uint32_t v0 = *high, v1 = *low, delta = <span class="number">0x10325476</span>, <span class="built_in">sum</span> = delta * num_rounds;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_rounds; i++) &#123;</span><br><span class="line">        v1 -= (((v0 &lt;&lt; <span class="number">4</span>) ^ (v0 &gt;&gt; <span class="number">5</span>)) + v0) ^ (<span class="built_in">sum</span> + key[(<span class="built_in">sum</span> &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span>]);</span><br><span class="line">        <span class="built_in">sum</span> -= delta;</span><br><span class="line">        v0 -= (((v1 &lt;&lt; <span class="number">4</span>) ^ (v1 &gt;&gt; <span class="number">5</span>)) + v1) ^ (<span class="built_in">sum</span> + key[<span class="built_in">sum</span> &amp; <span class="number">3</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    *high = v0; *low = v1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void decode(uint32_t* mid)</span><br><span class="line">&#123;</span><br><span class="line">    uint32_t result, i;</span><br><span class="line"></span><br><span class="line">    uint32_t data[] = &#123; <span class="number">0x04050607</span>, <span class="number">0x00010203</span>, <span class="number">0x0C0D0E0F</span>, <span class="number">0x08090A0B</span>,</span><br><span class="line">            <span class="number">0xCD3FE81B</span>, <span class="number">0xD7C45477</span>, <span class="number">0x9F3E9236</span>, <span class="number">0x0107F187</span>, <span class="number">0xF993CB81</span>,</span><br><span class="line">            <span class="number">0xBF74166C</span>, <span class="number">0xDA198427</span>, <span class="number">0x1A05ABFF</span>, <span class="number">0x9307E5E4</span>, <span class="number">0xCB8B0E45</span>,</span><br><span class="line">            <span class="number">0x306DF7F5</span>, <span class="number">0xAD300197</span>, <span class="number">0xAA86B056</span>, <span class="number">0x449263BA</span>, <span class="number">0x3FA4401B</span>,</span><br><span class="line">            <span class="number">0x1E41F917</span>, <span class="number">0xC6CB1E7D</span>, <span class="number">0x18EB0D7A</span>, <span class="number">0xD4EC4800</span>, <span class="number">0xB486F92B</span>,</span><br><span class="line">            <span class="number">0x8737F9F3</span>, <span class="number">0x765E3D25</span>, <span class="number">0xDB3D3537</span>, <span class="number">0xEE44552B</span>, <span class="number">0x11D0C94C</span>,</span><br><span class="line">            <span class="number">0x9B605BCB</span>, <span class="number">0x903B98B3</span>, <span class="number">0x24C2EEA3</span>, <span class="number">0x896E10A2</span>, <span class="number">0x2247F0C0</span>,</span><br><span class="line">            <span class="number">0xB84E5CAA</span>, <span class="number">0x8D2C04F0</span>, <span class="number">0x3BC7842C</span>, <span class="number">0x1A50D606</span>, <span class="number">0x49A1917C</span>,</span><br><span class="line">            <span class="number">0x7E1CB50C</span>, <span class="number">0xFC27B826</span>, <span class="number">0x5FDDDFBC</span>, <span class="number">0xDE0FC404</span>, <span class="number">0xB2B30907</span> &#125;;</span><br><span class="line"></span><br><span class="line">    uint32_t xordata[<span class="number">2</span>] = &#123;*mid, *(mid + <span class="number">1</span>)&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= <span class="number">0x2b</span>; i++) &#123;</span><br><span class="line">        result = ((rol(xordata[<span class="number">0</span>], <span class="number">1</span>) &amp; rol(xordata[<span class="number">0</span>], <span class="number">8</span>)) ^ rol(xordata[<span class="number">0</span>], <span class="number">2</span>)) ^ xordata[<span class="number">1</span>] ^ data[<span class="number">0x2b</span> - i];</span><br><span class="line">        xordata[<span class="number">1</span>] = xordata[<span class="number">0</span>];</span><br><span class="line">        xordata[<span class="number">0</span>] = result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mid[<span class="number">0</span>] = xordata[<span class="number">1</span>];</span><br><span class="line">    mid[<span class="number">1</span>] = xordata[<span class="number">0</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void re_chr(uint32_t num)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">24</span>; i &gt;= <span class="number">0</span>; i -= <span class="number">8</span>)</span><br><span class="line">        printf(<span class="string">&quot;%c&quot;</span>, (num &amp; (<span class="number">0xff</span> &lt;&lt; i)) &gt;&gt; i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="input"><a href="#input" class="headerlink" title="input"></a>input</h2><p>得到了input<code>mM7pJIobsCTQPO6R0g-L8kFExhYuivBN</code></p>
<h2 id="flag"><a href="#flag" class="headerlink" title="flag"></a>flag</h2><p><code>CTF&#123;mM7pJIobsCTQPO6R0g-L8kFExhYuivBN&#125;</code></p>
<h1 id="RE-SimpleFileSystem-可逆加密算法-文件系统"><a href="#RE-SimpleFileSystem-可逆加密算法-文件系统" class="headerlink" title="RE_SimpleFileSystem(可逆加密算法, 文件系统)"></a>RE_SimpleFileSystem(可逆加密算法, 文件系统)</h1><p>txt文档初始化后可以看到有很多的inode(译成中文为<strong>索引节点</strong>,  用于存放档案及目录的基本信息, 包含时间, 档名, 使用者及其群组,  只不过这道题简化成了编号)</p>
<p>使用IDA分析</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall main(<span class="built_in">int</span> a1, char **a2, char **a3)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">int</span> v4; // eax</span><br><span class="line">  <span class="built_in">int</span> *v5; // rax</span><br><span class="line">  char *v6; // rax</span><br><span class="line">  unsigned <span class="built_in">int</span> v7; // eax</span><br><span class="line">  unsigned <span class="built_in">int</span> v8; // eax</span><br><span class="line">  <span class="built_in">int</span> i; // [rsp+18h] [rbp-1038h]</span><br><span class="line">  <span class="built_in">int</span> j; // [rsp+1Ch] [rbp-1034h]</span><br><span class="line">  <span class="built_in">int</span> v11; // [rsp+20h] [rbp-1030h]</span><br><span class="line">  <span class="built_in">int</span> v12; // [rsp+24h] [rbp-102Ch]</span><br><span class="line">  unsigned <span class="built_in">int</span> v13; // [rsp+28h] [rbp-1028h]</span><br><span class="line">  unsigned <span class="built_in">int</span> v14; // [rsp+28h] [rbp-1028h]</span><br><span class="line">  <span class="built_in">int</span> v15; // [rsp+28h] [rbp-1028h]</span><br><span class="line">  unsigned <span class="built_in">int</span> v16; // [rsp+28h] [rbp-1028h]</span><br><span class="line">  unsigned <span class="built_in">int</span> v17; // [rsp+28h] [rbp-1028h]</span><br><span class="line">  unsigned <span class="built_in">int</span> v18; // [rsp+28h] [rbp-1028h]</span><br><span class="line">  unsigned <span class="built_in">int</span> v19; // [rsp+28h] [rbp-1028h]</span><br><span class="line">  unsigned <span class="built_in">int</span> v20; // [rsp+28h] [rbp-1028h]</span><br><span class="line">  <span class="built_in">int</span> r_num1; // [rsp+2Ch] [rbp-1024h]</span><br><span class="line">  <span class="built_in">int</span> r_num2; // [rsp+30h] [rbp-1020h]</span><br><span class="line">  time_t timer; // [rsp+38h] [rbp-1018h] BYREF</span><br><span class="line">  char s[<span class="number">16</span>]; // [rsp+40h] [rbp-1010h] BYREF</span><br><span class="line">  char s1[<span class="number">1024</span>]; // [rsp+440h] [rbp-C10h] BYREF</span><br><span class="line">  char nptr[<span class="number">1024</span>]; // [rsp+840h] [rbp-810h] BYREF</span><br><span class="line">  char v27[<span class="number">1032</span>]; // [rsp+C40h] [rbp-410h] BYREF</span><br><span class="line">  unsigned __int64 v28; // [rsp+1048h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v28 = __readfsqword(0x28u);</span><br><span class="line">  <span class="keyword">if</span> ( a1 != <span class="number">3</span> )                                // 如果参数不是三个则提示输入的格式</span><br><span class="line">  &#123;</span><br><span class="line">    printf(<span class="string">&quot;use: %s &lt;diskfile&gt; &lt;nblocks&gt;\n&quot;</span>, *a2);</span><br><span class="line">    <span class="keyword">return</span> 1LL;</span><br><span class="line">  &#125;</span><br><span class="line">  v4 = atoi(a2[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( !(unsigned <span class="built_in">int</span>)sub_55A3FD5D9BEC(a2[<span class="number">1</span>], v4) )// 打开文件image.flag</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = __errno_location();</span><br><span class="line">    v6 = strerror(*v5);</span><br><span class="line">    printf(<span class="string">&quot;couldn&#x27;t initialize %s: %s\n&quot;</span>, a2[<span class="number">1</span>], v6);</span><br><span class="line">    <span class="keyword">return</span> 1LL;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  v7 = sub_55A3FD5D9C9E();</span><br><span class="line">  printf(<span class="string">&quot;opened emulated disk image %s with %d blocks\n&quot;</span>, a2[<span class="number">1</span>], v7);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )                                   // shell的<span class="keyword">while</span>循环</span><br><span class="line">  &#123;</span><br><span class="line">    printf(<span class="string">&quot; simplefs&gt; &quot;</span>);                      // 打印输入提示符</span><br><span class="line">    fflush(stdout);</span><br><span class="line">    <span class="keyword">if</span> ( !fgets(s, <span class="number">1024</span>, stdin) )               // 输入指令</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( s[<span class="number">0</span>] != <span class="string">&#x27;\n&#x27;</span> )                         // 如果有输入内容</span><br><span class="line">    &#123;</span><br><span class="line">      s[strlen(s) - <span class="number">1</span>] = <span class="number">0</span>;                     // 把结尾的<span class="string">&#x27;\n&#x27;</span>改为<span class="string">&#x27;\0&#x27;</span></span><br><span class="line">      v11 = __isoc99_sscanf(s, <span class="string">&quot;%s %s %s&quot;</span>, s1, nptr, v27);// 输入三个参数(也可以不输入这么多, 这个只是最大值), 从<span class="number">0</span>号开始检验</span><br><span class="line">      <span class="keyword">if</span> ( v11 )                                // 其中v11是成功录入的变量数量, 根据这个判断输入是否有效</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;format&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v11 == <span class="number">1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( (unsigned <span class="built_in">int</span>)sub_55A3FD5D8357() )// 这里应该是为该系统分配磁盘, 在这里初始化了</span><br><span class="line">              puts(<span class="string">&quot;disk formatted.&quot;</span>);          // 磁盘格式化</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              puts(<span class="string">&quot;format failed!&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            puts(<span class="string">&quot;use: format&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;mount&quot;</span>) )        // 挂载: 是指由操作系统使一个存储设备（诸如硬盘、CD-ROM或共享资源）上的计算机文件和目录可供用户通过计算机的文件系统访问的一个过程</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v11 == <span class="number">1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( (unsigned <span class="built_in">int</span>)sub_55A3FD5D87C2() )// 这里设置了inode_index为<span class="number">1</span></span><br><span class="line">              puts(<span class="string">&quot;disk mounted.&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              puts(<span class="string">&quot;mount failed!&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            puts(<span class="string">&quot;use: mount&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;debug&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v11 == <span class="number">1</span> )</span><br><span class="line">            sub_55A3FD5D84BB();</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            puts(<span class="string">&quot;use: debug&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;getsize&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v11 == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v13 = atoi(nptr);</span><br><span class="line">            v12 = sub_55A3FD5D9014(v13);</span><br><span class="line">            <span class="keyword">if</span> ( v12 &lt; <span class="number">0</span> )</span><br><span class="line">              puts(<span class="string">&quot;getsize failed!&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              printf(<span class="string">&quot;inode %d has size %d\n&quot;</span>, v13, (unsigned <span class="built_in">int</span>)v12);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            puts(<span class="string">&quot;use: getsize &lt;inumber&gt;&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;create&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v11 == <span class="number">1</span> )</span><br><span class="line">            sub_55A3FD5D816A();</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            puts(<span class="string">&quot;use: create&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;delete&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v11 == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v14 = atoi(nptr);</span><br><span class="line">            <span class="keyword">if</span> ( (unsigned <span class="built_in">int</span>)sub_55A3FD5D8DD1(v14) )</span><br><span class="line">              printf(<span class="string">&quot;inode %d deleted.\n&quot;</span>, v14);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              puts(<span class="string">&quot;delete failed!&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            puts(<span class="string">&quot;use: delete &lt;inumber&gt;&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;cat&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v11 == <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v15 = atoi(nptr);</span><br><span class="line">            <span class="keyword">if</span> ( !(unsigned <span class="built_in">int</span>)sub_55A3FD5D8017(v15, <span class="string">&quot;/dev/stdout&quot;</span>) )</span><br><span class="line">              puts(<span class="string">&quot;cat failed!&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            puts(<span class="string">&quot;use: cat &lt;inumber&gt;&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;captureflag&quot;</span>) )  // 这个应该是个无用指令</span><br><span class="line">        &#123;</span><br><span class="line">          puts(<span class="string">&quot;Are you kidding?&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;plantflag&quot;</span>) )    // 可疑代码</span><br><span class="line">        &#123;</span><br><span class="line">          v8 = time(&amp;timer);                    // 记录现在的时间戳到v8和timer中</span><br><span class="line">          srand(v8);                            // 随机数播种</span><br><span class="line">          r_num1 = rand() % <span class="number">100</span>;                // <span class="number">100</span>以内的随机数</span><br><span class="line">          r_num2 = rand() % <span class="number">100</span>;                // 同上</span><br><span class="line">          <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; r_num1; ++i )        // 循环随机的次数</span><br><span class="line">          &#123;</span><br><span class="line">            v16 = sub_55A3FD5D816A();</span><br><span class="line">            <span class="keyword">if</span> ( (unsigned <span class="built_in">int</span>)sub_55A3FD5D7E16(<span class="string">&quot;flag&quot;</span>, v16, <span class="number">2</span>) )</span><br><span class="line">              printf(<span class="string">&quot;copied file %s to inode %d\n&quot;</span>, nptr, v16);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              puts(<span class="string">&quot;copy failed!&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          v17 = sub_55A3FD5D816A();</span><br><span class="line">          <span class="keyword">if</span> ( (unsigned <span class="built_in">int</span>)sub_55A3FD5D7E16(<span class="string">&quot;flag&quot;</span>, v17, <span class="number">1</span>) )</span><br><span class="line">            printf(<span class="string">&quot;plant flag to inode %d!\n&quot;</span>, v17);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            puts(<span class="string">&quot;copy failed!&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; r_num2; ++j )</span><br><span class="line">          &#123;</span><br><span class="line">            v18 = sub_55A3FD5D816A();</span><br><span class="line">            <span class="keyword">if</span> ( (unsigned <span class="built_in">int</span>)sub_55A3FD5D7E16(<span class="string">&quot;flag&quot;</span>, v18, <span class="number">2</span>) )</span><br><span class="line">              printf(<span class="string">&quot;copied file %s to inode %d\n&quot;</span>, nptr, v18);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              puts(<span class="string">&quot;copy failed!&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;copyin&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v11 == <span class="number">3</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v19 = atoi(v27);</span><br><span class="line">            <span class="keyword">if</span> ( !(unsigned <span class="built_in">int</span>)sub_55A3FD5D7E16(nptr, v19, <span class="number">0</span>) )</span><br><span class="line">              goto LABEL_69;</span><br><span class="line">            printf(<span class="string">&quot;copied file %s to inode %d\n&quot;</span>, nptr, v19);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            puts(<span class="string">&quot;use: copyin &lt;filename&gt; &lt;inumber&gt;&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;copyout&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( v11 == <span class="number">3</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v20 = atoi(nptr);</span><br><span class="line">            <span class="keyword">if</span> ( (unsigned <span class="built_in">int</span>)sub_55A3FD5D8017(v20, v27) )</span><br><span class="line">              printf(<span class="string">&quot;copied inode %d to file %s\n&quot;</span>, v20, v27);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">LABEL_69:</span><br><span class="line">              puts(<span class="string">&quot;copy failed!&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            puts(<span class="string">&quot;use: copyout &lt;inumber&gt; &lt;filename&gt;&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;help&quot;</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          puts(<span class="string">&quot;Commands are:&quot;</span>);</span><br><span class="line">          puts(<span class="string">&quot;    format&quot;</span>);</span><br><span class="line">          puts(<span class="string">&quot;    mount&quot;</span>);</span><br><span class="line">          puts(<span class="string">&quot;    debug&quot;</span>);</span><br><span class="line">          puts(<span class="string">&quot;    create&quot;</span>);</span><br><span class="line">          puts(<span class="string">&quot;    delete  &lt;inode&gt;&quot;</span>);</span><br><span class="line">          puts(<span class="string">&quot;    cat     &lt;inode&gt;&quot;</span>);</span><br><span class="line">          puts(<span class="string">&quot;    captureflag&quot;</span>);</span><br><span class="line">          puts(<span class="string">&quot;    plantflag&quot;</span>);</span><br><span class="line">          puts(<span class="string">&quot;    copyin  &lt;file&gt; &lt;inode&gt;&quot;</span>);</span><br><span class="line">          puts(<span class="string">&quot;    copyout &lt;inode&gt; &lt;file&gt;&quot;</span>);</span><br><span class="line">          puts(<span class="string">&quot;    help&quot;</span>);</span><br><span class="line">          puts(<span class="string">&quot;    quit&quot;</span>);</span><br><span class="line">          puts(<span class="string">&quot;    exit&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;quit&quot;</span>) || !strcmp(s1, <span class="string">&quot;exit&quot;</span>) )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          printf(<span class="string">&quot;unknown command: %s\n&quot;</span>, s1);</span><br><span class="line">          puts(<span class="string">&quot;type &#x27;help&#x27; for a list of commands.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  puts(<span class="string">&quot;closing emulated disk.&quot;</span>);</span><br><span class="line">  sub_55A3FD5D9E6B();</span><br><span class="line">  <span class="keyword">return</span> 0LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到跟shell一样,  我们要确定大致的分析方向,  知道哪个指令是比较关键</p>
<p>可以看到前两个指令都是初始化,  后面的debug,  create,  delete,  cat,  copyin,  copyout,  help,  quit,  exit都是关于文件操作的指令,  不重要.  所以排除法得到了两个关键的指令captureflag  和  plantflag.  而通过分析法相captureflag是一个无用指令,  所以我们可以锁定关键的指令就是plantflag.</p>
<p>同时我们通过调试发现所有索引上的数据都是通过flag文本文件经过加密后随机生成的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( !strcmp(s1, <span class="string">&quot;plantflag&quot;</span>) )    // 可疑代码</span><br><span class="line">        &#123;</span><br><span class="line">          v8 = time(&amp;timer);                    // 记录现在的时间戳到v8和timer中</span><br><span class="line">          srand(v8);                            // 随机数播种</span><br><span class="line">          r_num1 = rand() % <span class="number">100</span>;                // <span class="number">100</span>以内的随机数</span><br><span class="line">          r_num2 = rand() % <span class="number">100</span>;                // 同上</span><br><span class="line">          <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; r_num1; ++i )        // 循环随机的次数</span><br><span class="line">          &#123;</span><br><span class="line">            v16 = sub_55A3FD5D816A();</span><br><span class="line">            <span class="keyword">if</span> ( (unsigned <span class="built_in">int</span>)sub_55A3FD5D7E16(<span class="string">&quot;flag&quot;</span>, v16, <span class="number">2</span>) )</span><br><span class="line">              printf(<span class="string">&quot;copied file %s to inode %d\n&quot;</span>, nptr, v16);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              puts(<span class="string">&quot;copy failed!&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          v17 = sub_55A3FD5D816A();</span><br><span class="line">          <span class="keyword">if</span> ( (unsigned <span class="built_in">int</span>)sub_55A3FD5D7E16(<span class="string">&quot;flag&quot;</span>, v17, <span class="number">1</span>) )</span><br><span class="line">            printf(<span class="string">&quot;plant flag to inode %d!\n&quot;</span>, v17);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            puts(<span class="string">&quot;copy failed!&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; r_num2; ++j )</span><br><span class="line">          &#123;</span><br><span class="line">            v18 = sub_55A3FD5D816A();</span><br><span class="line">            <span class="keyword">if</span> ( (unsigned <span class="built_in">int</span>)sub_55A3FD5D7E16(<span class="string">&quot;flag&quot;</span>, v18, <span class="number">2</span>) )</span><br><span class="line">              printf(<span class="string">&quot;copied file %s to inode %d\n&quot;</span>, nptr, v18);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              puts(<span class="string">&quot;copy failed!&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>而查看其代码内部可以发现两个可疑函数<code>sub_55A3FD5D816A()</code>和<code>sub_55A3FD5D7E16()</code>.</p>
<p>经过调试以后我们在<code>sub_55A3FD5D7E16()</code>中发现一个加密函数<code>sub_55A3FD5D81B2((__int64)str, len);</code></p>
<p><img src="/2022/04/23/StarCTF(%E6%B1%87%E7%BC%96,%20XTEA%E5%8A%A0%E5%AF%86,%20%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95)%20d2c4611ee19c445694e9c66ea5eb4eb6/Untitled%206.png" alt="Untitled"></p>
<p>跟进查看</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall sub_55A3FD5D81B2(__int64 a1, <span class="built_in">int</span> a2)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">int</span> i; // [rsp+10h] [rbp-10h]</span><br><span class="line">  <span class="built_in">int</span> xordata; // [rsp+14h] [rbp-Ch]</span><br><span class="line">  _BYTE *str2; // [rsp+18h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  xordata = sub_55A3FD5D90A3();</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    str2 = (_BYTE *)(i + a1);</span><br><span class="line">    *str2 = (*str2 &gt;&gt; <span class="number">1</span>) | (*str2 &lt;&lt; <span class="number">7</span>);</span><br><span class="line">    *str2 ^= xordata;</span><br><span class="line">    *str2 = ((unsigned __int8)*str2 &gt;&gt; <span class="number">2</span>) | (*str2 &lt;&lt; <span class="number">6</span>);</span><br><span class="line">    *str2 ^= BYTE1(xordata);</span><br><span class="line">    *str2 = ((unsigned __int8)*str2 &gt;&gt; <span class="number">3</span>) | (<span class="number">32</span> * *str2);</span><br><span class="line">    *str2 ^= BYTE2(xordata);</span><br><span class="line">    *str2 = ((unsigned __int8)*str2 &gt;&gt; <span class="number">4</span>) | (<span class="number">16</span> * *str2);</span><br><span class="line">    *str2 ^= HIBYTE(xordata);</span><br><span class="line">    *str2 = (*str2 &gt;&gt; <span class="number">5</span>) | (<span class="number">8</span> * *str2);         // str2 &lt;&lt; <span class="number">3</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> 0LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在这个函数下下断点</p>
<p>可以看到加密的过程</p>
<p><img src="/2022/04/23/StarCTF(%E6%B1%87%E7%BC%96,%20XTEA%E5%8A%A0%E5%AF%86,%20%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95)%20d2c4611ee19c445694e9c66ea5eb4eb6/Untitled%207.png" alt="Untitled"></p>
<p>经过加密后的数据</p>
<p><img src="/2022/04/23/StarCTF(%E6%B1%87%E7%BC%96,%20XTEA%E5%8A%A0%E5%AF%86,%20%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95)%20d2c4611ee19c445694e9c66ea5eb4eb6/Untitled%208.png" alt="Untitled"></p>
<p>我们知道flag的前四个字符就是*CTF,  所以可以通过这四个字符加密过后的数据在image文件中查找并得到加密后的flag</p>
<p>我们在HexEditor中查找0x00, 0xd2, 0xfc, 0xd8</p>
<p><img src="/2022/04/23/StarCTF(%E6%B1%87%E7%BC%96,%20XTEA%E5%8A%A0%E5%AF%86,%20%E5%8F%AF%E9%80%86%E5%8A%A0%E5%AF%86%E7%AE%97%E6%B3%95)%20d2c4611ee19c445694e9c66ea5eb4eb6/Untitled%209.png" alt="Untitled"></p>
<p>将数据dump下来并解密</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#if 1</span></span><br><span class="line"><span class="comment">#define _CRT_SECURE_NO_WARNINGS</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdint.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;string.h&gt;</span></span><br><span class="line"></span><br><span class="line">void decode(uint8_t* output, unsigned <span class="built_in">int</span> n);</span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> main(void)</span><br><span class="line">&#123;</span><br><span class="line">	uint8_t output[] = &#123; <span class="number">0x00</span>, <span class="number">0xd2</span>, <span class="number">0xfc</span>, <span class="number">0xd8</span>, <span class="number">0xa2</span>, <span class="number">0xda</span>, <span class="number">0xba</span>, <span class="number">0x9e</span>, <span class="number">0x9c</span>, <span class="number">0x26</span>,</span><br><span class="line">						 <span class="number">0xf8</span>, <span class="number">0xf6</span>, <span class="number">0xb4</span>, <span class="number">0xce</span>, <span class="number">0x3c</span>, <span class="number">0xcc</span>,<span class="number">0x96</span>, <span class="number">0x88</span>, <span class="number">0x98</span>, <span class="number">0x34</span>,</span><br><span class="line">						 <span class="number">0x82</span>, <span class="number">0xde</span>, <span class="number">0x80</span>, <span class="number">0x36</span>, <span class="number">0x8a</span>, <span class="number">0xd8</span>, <span class="number">0xc0</span>, <span class="number">0xf0</span>, <span class="number">0x38</span>, <span class="number">0xae</span>,</span><br><span class="line">						 <span class="number">0x40</span> &#125;;</span><br><span class="line">	decode(output, sizeof(output));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void decode(uint8_t* output, unsigned <span class="built_in">int</span> n)</span><br><span class="line">&#123;</span><br><span class="line">	uint32_t xordata[<span class="number">4</span>] = &#123; <span class="number">0xDEEDBEEF</span>, <span class="number">0xDEEDBE</span>,  <span class="number">0xDEED</span>, <span class="number">0xDE</span>&#125;;</span><br><span class="line">	uint8_t tmp;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">		tmp = *(output + i);</span><br><span class="line">		tmp = (tmp &lt;&lt; <span class="number">5</span>) | (tmp &gt;&gt; <span class="number">3</span>);</span><br><span class="line">		tmp ^= xordata[<span class="number">3</span>];</span><br><span class="line">		tmp = (tmp &lt;&lt; <span class="number">4</span>) | (tmp &gt;&gt; <span class="number">4</span>);</span><br><span class="line">		tmp ^= xordata[<span class="number">2</span>];</span><br><span class="line">		tmp = (tmp &lt;&lt; <span class="number">3</span>) | (tmp &gt;&gt; <span class="number">5</span>);</span><br><span class="line">		tmp ^= xordata[<span class="number">1</span>];</span><br><span class="line">		tmp = (tmp &lt;&lt; <span class="number">2</span>) | (tmp &gt;&gt; <span class="number">6</span>);</span><br><span class="line">		tmp ^= xordata[<span class="number">0</span>];</span><br><span class="line">		tmp = (tmp &lt;&lt; <span class="number">1</span>) | (tmp &gt;&gt; <span class="number">7</span>);</span><br><span class="line">		printf(<span class="string">&quot;%c&quot;</span>, tmp);</span><br><span class="line">	&#125;</span><br><span class="line">	printf(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#endif</span></span><br></pre></td></tr></table></figure>

<p>即可得到flag</p>
<h2 id="flag-1"><a href="#flag-1" class="headerlink" title="flag"></a>flag</h2><p><code>CTF&#123;Gwed9VQpM4Lanf0kEj1oFJR6&#125;</code></p>
<h1 id="RE-Jump-setjump和longjump打乱逻辑顺序-Burrows-Wheeler压缩算法"><a href="#RE-Jump-setjump和longjump打乱逻辑顺序-Burrows-Wheeler压缩算法" class="headerlink" title="RE_Jump(setjump和longjump打乱逻辑顺序,  Burrows-Wheeler压缩算法)"></a>RE_Jump(setjump和longjump打乱逻辑顺序,  Burrows-Wheeler压缩算法)</h1><p>关于setjump和longjump更加详细的介绍可以看CSAPP第八章的最靠后的部分,  里面有讲到setjump和longjump</p>
<p>进入IDA分析可以发现是去符号表了,  但是还是可以分析的.</p>
<p>我们同通过字符串查找找到了核心函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall sub_40293E(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">int</span> v2; // edx</span><br><span class="line">  <span class="built_in">int</span> v3; // ecx</span><br><span class="line">  <span class="built_in">int</span> v4; // r8d</span><br><span class="line">  <span class="built_in">int</span> v5; // r9d</span><br><span class="line">  <span class="built_in">int</span> v7; // edx</span><br><span class="line">  <span class="built_in">int</span> v8; // ecx</span><br><span class="line">  <span class="built_in">int</span> v9; // r8d</span><br><span class="line">  <span class="built_in">int</span> v10; // r9d</span><br><span class="line">  __int64 v11; // rdx</span><br><span class="line">  <span class="built_in">int</span> v12; // edx</span><br><span class="line">  <span class="built_in">int</span> v13; // ecx</span><br><span class="line">  <span class="built_in">int</span> v14; // r8d</span><br><span class="line">  <span class="built_in">int</span> v15; // r9d</span><br><span class="line">  <span class="built_in">int</span> v16; // edx</span><br><span class="line">  <span class="built_in">int</span> v17; // ecx</span><br><span class="line">  <span class="built_in">int</span> v18; // r8d</span><br><span class="line">  <span class="built_in">int</span> v19; // r9d</span><br><span class="line">  __int64 v20; // rdx</span><br><span class="line">  <span class="built_in">int</span> v21; // ecx</span><br><span class="line">  <span class="built_in">int</span> v22; // r8d</span><br><span class="line">  <span class="built_in">int</span> v23; // r9d</span><br><span class="line">  __int64 v24; // rdx</span><br><span class="line">  <span class="built_in">int</span> v25; // edx</span><br><span class="line">  <span class="built_in">int</span> v26; // ecx</span><br><span class="line">  <span class="built_in">int</span> v27; // r8d</span><br><span class="line">  <span class="built_in">int</span> v28; // r9d</span><br><span class="line">  <span class="built_in">int</span> v29; // edx</span><br><span class="line">  <span class="built_in">int</span> v30; // ecx</span><br><span class="line">  <span class="built_in">int</span> v31; // r8d</span><br><span class="line">  <span class="built_in">int</span> v32; // r9d</span><br><span class="line">  char v33; // [rsp+0h] [rbp-10h]</span><br><span class="line">  char v34; // [rsp+0h] [rbp-10h]</span><br><span class="line">  char v35; // [rsp+0h] [rbp-10h]</span><br><span class="line">  char v36; // [rsp+0h] [rbp-10h]</span><br><span class="line">  char v37; // [rsp+0h] [rbp-10h]</span><br><span class="line">  <span class="built_in">int</span> v38; // [rsp+Ch] [rbp-4h]</span><br><span class="line">  <span class="built_in">int</span> v39; // [rsp+Ch] [rbp-4h]</span><br><span class="line">  <span class="built_in">int</span> v40; // [rsp+Ch] [rbp-4h]</span><br><span class="line">  <span class="built_in">int</span> v41; // [rsp+Ch] [rbp-4h]</span><br><span class="line"></span><br><span class="line">  sub_419570(&amp;<span class="built_in">input</span>);                           // scanf</span><br><span class="line">  v38 = setjmp(&amp;status, a2, v2, v3, v4, v5, v33);</span><br><span class="line">  <span class="keyword">if</span> ( !v38 )</span><br><span class="line">    sub_402689();                               // (<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">if</span> ( v38 == <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> 1LL;</span><br><span class="line">  input23_addr = mb_malloc(<span class="built_in">len</span> + <span class="number">1</span>, 1uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !setjmp(&amp;status, 1LL, v7, v8, v9, v10, v34) )// (<span class="number">1</span>) 运行到了这里随后向下继续运行到了下一个setjmp</span><br><span class="line">    longjmp(&amp;off_4C9460);</span><br><span class="line">  qword_4C9408 = sub_427140(8LL * <span class="built_in">len</span>, 1LL, v11);</span><br><span class="line"></span><br><span class="line">  v39 = setjmp(&amp;status, 1LL, v12, v13, v14, v15, v35);// (<span class="number">2</span>) 设下坐标setjmp, 初始化了<span class="number">1</span></span><br><span class="line">                                                // (<span class="number">4</span>) 在为input_change申请完内存空间后又回到了这里</span><br><span class="line">  <span class="keyword">if</span> ( !v39 )</span><br><span class="line">    longjmp(&amp;off_4C9460);</span><br><span class="line">  <span class="keyword">if</span> ( v39 &lt;= <span class="built_in">len</span> )</span><br><span class="line">    longjmp(&amp;off_4C9460);</span><br><span class="line">  sub_401F62(qword_4C9408, 1uLL);</span><br><span class="line">  v40 = setjmp(&amp;status, 1LL, v16, v17, v18, v19, v36);</span><br><span class="line">  <span class="keyword">if</span> ( !v40 )</span><br><span class="line">    sub_402826(&amp;status, 1LL, v20, v21, v22, v23);// ******</span><br><span class="line">  <span class="keyword">if</span> ( v40 &lt;= <span class="built_in">len</span> )</span><br><span class="line">    longjmp(&amp;off_4C9540);</span><br><span class="line">  sub_427730(qword_4C9408, 1LL, v20);</span><br><span class="line">  sub_427730(input23_addr, 1LL, v24);           // 真正的变换在这里</span><br><span class="line">  v41 = setjmp(&amp;status, 1LL, v25, v26, v27, v28, v37);</span><br><span class="line">  <span class="keyword">if</span> ( !v41 )</span><br><span class="line">    longjmp(&amp;off_4C9540);</span><br><span class="line">  <span class="keyword">if</span> ( v41 == <span class="number">1</span> )</span><br><span class="line">    sub_411920(<span class="string">&quot;*CTF&#123;%s&#125;\n&quot;</span>, &amp;<span class="built_in">input</span>, v29, v30, v31, v32);// 其实看到这里的时候就不应该把关注的重点放在<span class="built_in">input</span>上面了, 因为如果对其变换的话这里的打印就不是我们输入的明文了</span><br><span class="line">  <span class="keyword">return</span> 0LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>setjmp会将当前的上下文保存在status中,  而longjmp会跳回最近一次的setjmp并将其参数作为setjmp的返回值.</p>
<p>所以看起来这个函数中只有if语句,  其实是有很多的for语句的.</p>
<p>还需要注意的是longjmp不能F8步过,  相当于把直接跳过了for循环的所有语句了,  只能F7步入然后跳转到相应的地方才能进行分析</p>
<p>最后得到了其加密算法是Burrows-Wheeler,  是单纯的换序算法.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&#x27;\03jmGn_=uaSZLvN4wFxE6R+p\02D2qV1CBTck&#x27;</span></span><br><span class="line">lst = [[<span class="number">0</span>]] * <span class="number">34</span></span><br><span class="line"><span class="comment">#定义最后一列</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">34</span>):</span><br><span class="line">    lst[i] = s[i]</span><br><span class="line"></span><br><span class="line">tmp = [[<span class="number">0</span>]] * <span class="number">34</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">34</span>):</span><br><span class="line">    tmp[i] = s[i]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">34</span>):</span><br><span class="line">    lst.sort()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">34</span>):</span><br><span class="line">        lst[i] = tmp[i] + lst[i]</span><br><span class="line"><span class="comment">#最后是按行打印</span></span><br><span class="line"><span class="built_in">print</span>(lst)</span><br></pre></td></tr></table></figure></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">LamのCrow</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2022/04/23/StarCTF(汇编, XTEA加密, 可逆加密算法) d2c4611ee19c445694e9c66ea5eb4eb6/">http://example.com/2022/04/23/StarCTF(汇编, XTEA加密, 可逆加密算法) d2c4611ee19c445694e9c66ea5eb4eb6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com">LamのCrow</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/CTF/">CTF</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/04/27/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86-%E7%AC%AC33%E7%AB%A0-%E9%9A%90%E8%97%8F%E8%BF%9B%E7%A8%8B%2095cea6f6be2c470783b612eb9258314c/"><i class="fa fa-chevron-left">  </i><span>逆向工程核心原理-33</span></a></div><div class="next-post pull-right"><a href="/2022/04/19/%E9%80%86%E5%90%91%E5%B7%A5%E7%A8%8B%E6%A0%B8%E5%BF%83%E5%8E%9F%E7%90%86-%E7%AC%AC%20e28be/"><span>逆向工程核心原理-32</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s4.ax1x.com/2021/12/06/oy2VdH.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2023 By LamのCrow</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">追求幸福</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"right","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>